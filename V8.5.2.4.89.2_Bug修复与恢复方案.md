# V8.5.2.4.89.2 - Bug修复与数据恢复方案

**时间**: 2025-11-20  
**版本**: V8.5.2.4.89.2  
**类型**: Bug修复 + 数据恢复策略

---

## 📊 当前成果

### ✅ 回测成功完成！
- **内存峰值**: 79.86MB（非常健康！）
- **全流程**: Phase 1-4 全部成功执行
- **数据量**: 5天/300机会/4组合/400采样
- **结果**: 
  - Phase 1识别4000个机会
  - Phase 2捕获率62.9%
  - Phase 3/4优化验证完成
  - Bark推送成功

---

## 🐛 Bug修复

### 问题描述
**邮件生成阶段变量引用错误**：
```python
⚠️ 邮件发送失败: cannot access local variable 'iter_result' 
where it is not associated with a value
```

### 根本原因
```python
# ds/deepseek_多币种智能版.py (行11630)
iterative_history_html = ""
if config.get('_iterative_history'):
    iter_result = config['_iterative_history']  # ← 只在if内部定义
    ...

# 行11727 - 在外部使用，导致变量未定义
if iter_result and 'phase2' in iter_result:  # ← 变量未定义！
    ...
```

### 修复方案
```python
# 在外部初始化变量
iterative_history_html = ""
iter_result = None  # 【V8.5.2.4.89.2】初始化变量，避免后续引用错误
if config.get('_iterative_history'):
    iter_result = config['_iterative_history']
```

### 影响范围
- ✅ `ds/deepseek_多币种智能版.py`
- ✅ `ds/qwen_多币种智能版.py`

---

## 🎯 数据恢复策略

### 为什么需要逐步恢复？
当前数据量（5天/300机会）是为了解决OOM问题而大幅降低的。现在系统稳定，内存峰值仅79MB，有足够空间逐步恢复。

### 三阶段恢复计划

#### 🟢 阶段1：小幅增加（保守）
**目标参数**：
```python
lookback_days = 5 → 7
max_opportunities = 300 → 500
max_combinations = 4 → 6
sample_size = 400 → 500
```

**预计内存**: 400-500MB  
**判定标准**:
- ✅ 成功: 内存 < 500MB → 继续阶段2
- ❌ 失败: 内存 > 800MB → 保持当前

---

#### 🟡 阶段2：中等增加
**目标参数**：
```python
lookback_days = 7 → 10
max_opportunities = 500 → 1000
max_combinations = 6 → 7
sample_size = 500 → 600
```

**预计内存**: 500-700MB  
**判定标准**:
- ✅ 成功: 内存 < 700MB → 继续阶段3
- ❌ 失败: 内存 > 800MB → 回退到阶段1

---

#### 🔴 阶段3：完全恢复
**目标参数**：
```python
lookback_days = 10 → 14
max_opportunities = 1000 → 2000
max_combinations = 7 → 8
sample_size = 600 → 800
```

**预计内存**: 700-900MB  
**判定标准**:
- ✅ 成功: 内存 < 900MB → 完全恢复成功！
- ❌ 失败: 内存 > 900MB → 回退到阶段2

---

## 🛠️ 工具与脚本

### 1. 数据恢复脚本
**文件**: `ds/restore_data_volume.py`

**用法**:
```bash
cd /root/10-23-bot/ds

# 恢复到阶段1
python3 restore_data_volume.py stage1

# 恢复到阶段2
python3 restore_data_volume.py stage2

# 恢复到阶段3（完全恢复）
python3 restore_data_volume.py stage3
```

**功能**:
- ✅ 自动修改两个主文件的参数
- ✅ 自动备份原文件（`.before_restore_*`）
- ✅ 显示预计内存占用
- ✅ 提供操作指南

---

### 2. 服务器操作文档
**文件**: `ds/服务器操作_V8.5.2.4.89.2_Bug修复与数据恢复.txt`

**包含内容**:
- 📦 文件上传命令
- 🎯 三阶段详细操作步骤
- 📊 内存监控命令
- 🔄 回退操作方法
- 🔍 故障排查指南

---

## 📝 操作步骤（快速版）

### 步骤1: 上传文件到服务器
```bash
# 在本地终端（Mac）
cd ~/Downloads/10-23-bot

scp ds/deepseek_多币种智能版.py root@<服务器IP>:/root/10-23-bot/ds/
scp ds/qwen_多币种智能版.py root@<服务器IP>:/root/10-23-bot/ds/
scp ds/restore_data_volume.py root@<服务器IP>:/root/10-23-bot/ds/
```

### 步骤2: 测试阶段1
```bash
# 在服务器终端
cd /root/10-23-bot/ds

# 恢复到阶段1
python3 restore_data_volume.py stage1

# 停止supervisor
supervisorctl stop deepseek qwen

# 运行回测（带内存监控）
MANUAL_BACKTEST=true python3 run_with_memory_monitor.py > /tmp/backtest_stage1.txt 2>&1 &
tail -f /tmp/backtest_stage1.txt

# 查看内存峰值
cat memory_monitor_simple.log | awk -F',' '{print $2,$3}' | sort -n | tail -5
```

### 步骤3: 根据结果决定下一步
- ✅ 成功（< 500MB）→ 第二天测试阶段2
- ❌ 失败（> 800MB）→ 回退，保持当前配置

---

## 🔍 内存监控指标

### 当前基准（5天/300机会）
```
时间,当前内存(MB),峰值内存(MB)
2025-11-20 12:29:43,0.99,0.99
2025-11-20 12:29:50,4.53,62.30
2025-11-20 12:29:55,36.62,62.30
2025-11-20 12:30:00,79.85,79.86  ← 峰值
```

### 预期目标
| 阶段 | 参数 | 预计内存 | 目标上限 |
|------|------|----------|----------|
| 当前 | 5天/300机会 | 79MB | - |
| 阶段1 | 7天/500机会 | 400-500MB | 500MB |
| 阶段2 | 10天/1000机会 | 500-700MB | 800MB |
| 阶段3 | 14天/2000机会 | 700-900MB | 900MB |

---

## 💡 建议与注意事项

### ✅ 推荐做法
1. **保守恢复**: 每天测试一个阶段
2. **充分监控**: 使用 `run_with_memory_monitor.py`
3. **及时回退**: 一旦OOM立即回退
4. **保留备份**: 每次恢复前自动备份

### ⚠️ 注意事项
1. 如果阶段2稳定（10天/1000机会），可以长期保持
2. 不必强求完全恢复到14天，稳定性优先
3. 如果qwen占用内存较多，可以暂时停止（`supervisorctl stop qwen`）
4. 建议在低峰期（凌晨）进行测试

### 🔧 系统优化（已应用）
```bash
# 确保swap可用
vm.swappiness = 80
vm.overcommit_memory = 1
vm.drop_caches = 3
```

---

## 📊 成功标志

### 最终目标（理想状态）
- ✅ 回测天数: 14天
- ✅ Phase 1机会: 2000个
- ✅ Phase 2组合: 8组
- ✅ Phase 3采样: 800个
- ✅ 内存峰值: < 900MB
- ✅ 全流程稳定: 无OOM

### 可接受状态（次优）
- ✅ 回测天数: 10天
- ✅ Phase 1机会: 1000个
- ✅ Phase 2组合: 7组
- ✅ Phase 3采样: 600个
- ✅ 内存峰值: < 700MB
- ✅ 全流程稳定: 无OOM

---

## 🔄 Git历史

```bash
# V8.5.2.4.89.2 提交
commit 910ca15
Author: Leo202403
Date: 2025-11-20

修改:
  - ds/deepseek_多币种智能版.py: 修复iter_result变量初始化
  - ds/qwen_多币种智能版.py: 修复iter_result变量初始化
  
新增:
  - ds/restore_data_volume.py: 数据恢复工具
  - ds/服务器操作_V8.5.2.4.89.2_Bug修复与数据恢复.txt: 操作文档
```

---

## 📞 下一步

1. ✅ Bug已修复，代码已提交
2. 📤 上传文件到服务器
3. 🧪 测试阶段1（建议明天执行）
4. 📊 根据内存监控结果决定是否继续

---

**版本**: V8.5.2.4.89.2  
**状态**: ✅ 已完成  
**代码**: 已提交到GitHub  
**文档**: 完整  
**工具**: 已准备

