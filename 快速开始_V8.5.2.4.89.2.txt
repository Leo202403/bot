======================================================================
【V8.5.2.4.89.2】快速开始指南
======================================================================
时间: 2025-11-20
版本: V8.5.2.4.89.2
状态: ✅ 所有问题已修复，可以开始测试

======================================================================
✅ 本次修复内容
======================================================================
1. ✅ 修复邮件生成 iter_result 变量错误
2. ✅ 修复Bark推送格式化错误
3. ✅ 优化Phase 3 AI辅助决策失败提示
4. ✅ 优化Phase 4 SCALPING验证跳过提示
5. ✅ 新增数据恢复工具 restore_data_volume.py
6. ✅ 新增快速上传脚本 upload_to_server.sh
7. ✅ 所有代码已通过Python语法检查
8. ✅ 所有更改已提交到GitHub（commit: c12a3b9）

======================================================================
📤 步骤1: 上传文件到服务器
======================================================================
# 在本地终端（Mac）
cd ~/Downloads/10-23-bot

# 使用快速上传脚本（推荐）
./upload_to_server.sh <你的服务器IP>

# 或手动上传（如果脚本失败）
scp ds/deepseek_多币种智能版.py root@<IP>:/root/10-23-bot/ds/
scp ds/qwen_多币种智能版.py root@<IP>:/root/10-23-bot/ds/
scp ds/restore_data_volume.py root@<IP>:/root/10-23-bot/ds/
scp ds/email_bark_formatter.py root@<IP>:/root/10-23-bot/ds/
scp ds/phase3_enhanced_optimizer.py root@<IP>:/root/10-23-bot/ds/
scp ds/phase4_validator.py root@<IP>:/root/10-23-bot/ds/
scp ds/服务器操作_V8.5.2.4.89.2_Bug修复与数据恢复.txt root@<IP>:/root/10-23-bot/ds/

======================================================================
🧪 步骤2: 测试当前配置（可选）
======================================================================
# SSH到服务器
ssh root@<服务器IP>

# 停止supervisor
supervisorctl stop deepseek qwen

# 测试当前配置（5天/300机会）
cd /root/10-23-bot/ds
MANUAL_BACKTEST=true python3 run_with_memory_monitor.py > /tmp/backtest_test.txt 2>&1 &

# 查看输出
tail -f /tmp/backtest_test.txt

# 完成后检查修复效果
grep -E "Bark推送|SCALPING参数验证|AI辅助决策" /tmp/backtest_test.txt

# 查看内存峰值
cat memory_monitor_simple.log | awk -F',' '{print $2,$3}' | sort -n | tail -5

======================================================================
预期输出（修复后）
======================================================================
✅ Bark推送:
[Bark推送] 准备发送到 3 个设备
[Bark推送] ✅ 推送成功
[V8.5.2.4.81] Bark推送已发送（新格式）  ← 应该成功

✅ SCALPING参数验证:
📊 【SCALPING参数验证】
⚠️  无scalping机会数据，跳过验证
💡 可能原因: 当前数据量较小或市场条件不符合scalping特征  ← 更清晰

✅ AI辅助决策:
🤖 【AI辅助决策】
⚠️  AI辅助决策跳过: 未配置API密钥（fallback到默认参数）
💡 此功能可选，不影响回测完成  ← 更清晰

======================================================================
🎯 步骤3: 开始数据恢复（阶段1）
======================================================================
# 在服务器终端
cd /root/10-23-bot/ds

# 恢复到阶段1（7天/500机会）
python3 restore_data_volume.py stage1

# 验证修改
grep -E "lookback_days|max_opportunities|max_combinations|sample_size" deepseek_多币种智能版.py | head -20

# 应该看到:
# lookback_days = 7
# max_opportunities = 500
# max_combinations = 6
# sample_size = 500

# 停止supervisor
supervisorctl stop deepseek qwen

# 运行回测（带内存监控）
MANUAL_BACKTEST=true python3 run_with_memory_monitor.py > /tmp/backtest_stage1.txt 2>&1 &

# 实时查看输出
tail -f /tmp/backtest_stage1.txt

# 另开窗口监控内存
watch -n 2 'free -h && echo "---" && tail -3 memory_monitor_simple.log'

======================================================================
📊 步骤4: 评估阶段1结果
======================================================================
# 回测完成后，查看内存峰值
echo "=== 阶段1内存峰值 ==="
cat memory_monitor_simple.log | awk -F',' '{print $2,$3}' | sort -n | tail -5

# 判定标准:
# ✅ 成功: 内存峰值 < 500MB → 第二天继续阶段2
# ⚠️  接近上限: 内存峰值 400-500MB → 保持阶段1配置
# ❌ 失败: 内存峰值 > 800MB 或 OOM → 回退到5天/300机会

======================================================================
🔄 步骤5: 根据结果决定下一步
======================================================================

成功（< 500MB）:
-----------------
# 第二天测试阶段2
cd /root/10-23-bot/ds
python3 restore_data_volume.py stage2

# 运行回测
supervisorctl stop deepseek qwen
MANUAL_BACKTEST=true python3 run_with_memory_monitor.py > /tmp/backtest_stage2.txt 2>&1 &
tail -f /tmp/backtest_stage2.txt

接近上限（400-500MB）:
-----------------------
# 保持阶段1配置，长期运行
supervisorctl start deepseek qwen

# 监控内存
tail -20 /root/memory_monitor.log

失败（> 800MB 或 OOM）:
-------------------------
# 回退到原始配置（5天/300机会）
cd /root/10-23-bot
git checkout -- ds/deepseek_多币种智能版.py ds/qwen_多币种智能版.py

# 或使用备份文件
cd /root/10-23-bot/ds
cp deepseek_多币种智能版.py.before_restore_stage1 deepseek_多币种智能版.py
cp qwen_多币种智能版.py.before_restore_stage1 qwen_多币种智能版.py

# 重启supervisor
supervisorctl start deepseek qwen

======================================================================
📖 详细文档
======================================================================
完整操作指南: ds/服务器操作_V8.5.2.4.89.2_Bug修复与数据恢复.txt
修复总结: V8.5.2.4.89.2_问题修复总结.md
恢复方案: V8.5.2.4.89.2_Bug修复与恢复方案.md

======================================================================
🔍 故障排查
======================================================================

如果Bark推送失败:
-----------------
grep -i "bark" /tmp/backtest_*.txt
# 检查是否有其他错误信息

如果仍然OOM:
-------------
# 查看OOM killer日志
dmesg | grep -i "killed process"

# 查看swap使用
swapon --show
free -h

# 检查swappiness
cat /proc/sys/vm/swappiness
# 应该是80，如果不是：
echo 80 > /proc/sys/vm/swappiness

如果回测卡住:
--------------
# 检查进程
ps aux | grep python3

# 查看最后的日志
tail -50 /tmp/backtest_*.txt

# 如果需要强制停止
pkill -9 -f "python3.*多币种智能版"

======================================================================
💡 建议与提醒
======================================================================
1. ✅ 每天只测试一个阶段
2. ✅ 充分监控内存（使用run_with_memory_monitor.py）
3. ✅ 及时回退（OOM立即回退）
4. ✅ 保留备份（restore脚本自动备份）
5. ✅ 稳定优先（阶段2稳定就可以长期运行）
6. ✅ 低峰测试（建议凌晨进行测试）
7. ❌ 不要强求完全恢复到14天
8. ❌ 不要同时运行deepseek和qwen进行回测

======================================================================
📞 联系与反馈
======================================================================
如果遇到问题:
1. 查看日志: tail -100 /tmp/backtest_*.txt
2. 查看内存监控: tail -50 memory_monitor_simple.log
3. 查看系统日志: journalctl -xe | grep -i memory

所有代码已开源到GitHub，commit: c12a3b9

======================================================================
🎉 开始测试！
======================================================================
现在可以开始上传文件并测试了！

1️⃣ ./upload_to_server.sh <服务器IP>
2️⃣ SSH到服务器
3️⃣ 运行测试或直接进入阶段1

祝测试顺利！🚀

