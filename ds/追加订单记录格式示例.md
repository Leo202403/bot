# 追加订单记录格式示例

## 快速参考

### 格式规范

```
[原始开仓理由] | [加仓1] 时间 +数量@价格 理由:xxx | [加仓2] 时间 +数量@价格 理由:xxx
```

### 完整案例

#### 案例1：金字塔加仓（空单）

**交易流程**：
1. 12:45 BNB做空 @933，仓位0.01
2. 13:20 价格涨到938，加仓0.01
3. 14:05 价格涨到940，再加仓0.01

**CSV记录演变**：

```csv
# 初始开仓
BNB,空,2025-11-16 12:45:00,933,0.01,5,945,900,3.3,"Simple Pullback (Retrace 0.6%, Recover 65%) 信号分:95"

# 第一次加仓后
BNB,空,2025-11-16 12:45:00,935.5,0.02,5,945,895,3.0,"Simple Pullback (Retrace 0.6%, Recover 65%) 信号分:95 | [加仓1] 13:20 +0.01@938 理由:金字塔加仓+价格更优5.4%+信号分97"

# 第二次加仓后
BNB,空,2025-11-16 12:45:00,937,0.03,5,946,892,2.8,"Simple Pullback (Retrace 0.6%, Recover 65%) 信号分:95 | [加仓1] 13:20 +0.01@938 理由:金字塔加仓+价格更优5.4%+信号分97 | [加仓2] 14:05 +0.01@940 理由:趋势增强+突破阻力+信号分99"
```

**平均价计算**：
- 第1次加仓：(933×0.01 + 938×0.01) / 0.02 = **935.5**
- 第2次加仓：(935.5×0.02 + 940×0.01) / 0.03 = **937**

---

#### 案例2：分批平仓后补仓

**交易流程**：
1. 12:45 ETH做空 @3170，仓位0.037
2. 13:46 达目标，分批平仓50%，剩余0.018
3. 14:20 价格反弹到3180，AI建议再次做空，加仓0.019

**CSV记录演变**：

```csv
# 初始开仓（已完成分批平仓）
ETH,空,2025-11-16 12:45:00,3170,0.018,3,3195,3017,5.2,"Trend Inception 信号分:92 [剩余50%]"

# 补仓后
ETH,空,2025-11-16 12:45:00,3175,0.037,3,3200,3020,5.0,"Trend Inception 信号分:92 [剩余50%] | [加仓1] 14:20 +0.019@3180 理由:分批后补仓+价格更优0.3%+信号分94"
```

---

#### 案例3：趋势增强加仓（多单）

**交易流程**：
1. 10:30 BTC做多 @94500，仓位0.001
2. 11:15 价格跌到94200，但趋势增强，加仓0.001

**CSV记录**：

```csv
# 加仓后
BTC,多,2025-11-16 10:30:00,94350,0.002,5,93800,95500,1.8,"Swing Pullback 信号分:88 | [加仓1] 11:15 +0.001@94200 理由:趋势增强+RSI超卖+信号分93"
```

---

## AI回测解析示例

### 输入（CSV字段）

```
开仓理由 = "Simple Pullback 信号分:95 | [加仓1] 13:20 +0.01@938 理由:金字塔加仓+价格更优5.4%+信号分97 | [加仓2] 14:05 +0.01@940 理由:趋势增强+突破阻力+信号分99"
```

### 解析输出（JSON）

```json
{
  "original_reason": "Simple Pullback 信号分:95",
  "add_positions": [
    {
      "add_number": 1,
      "time": "13:20",
      "amount": 0.01,
      "price": 938.0,
      "reason": "金字塔加仓+价格更优5.4%+信号分97"
    },
    {
      "add_number": 2,
      "time": "14:05",
      "amount": 0.01,
      "price": 940.0,
      "reason": "趋势增强+突破阻力+信号分99"
    }
  ]
}
```

### AI学习分析

```python
# 分析加仓效果
parsed = parse_position_history(reason)

# 1. 提取加仓次数
add_count = len(parsed['add_positions'])  # 2次

# 2. 提取信号质量变化
original_score = 95
add1_score = 97  # 提升2.1%
add2_score = 99  # 提升4.2%

# 3. 提取价格改善
add1_improvement = 5.4%  # (938-933)/933
add2_improvement = 7.5%  # (940-933)/933

# 4. 关联最终盈亏
final_pnl = +2.5U  # 从同行其他字段读取

# 5. 学习结论
# - 加仓2次，总收益+2.5U
# - 信号质量持续提升时加仓，效果好
# - 金字塔加仓（价格更优）成功率高
```

---

## Bark通知示例

### 成功加仓通知

```
[通义千问]BNB加仓✅
空仓 加仓0.010个 @938
新平均价: 935.50
总仓位: 0.020个 (18.71U)
理由: 金字塔加仓+价格更优5.4%+信号分97
```

### 拒绝加仓通知

```
[通义千问]BNB加仓被拒❌
原因: 价格不优（928≤933）
空单加仓需价格更高
建议: 等待价格反弹或现有持仓平仓后再开
```

---

## 前端显示建议

### 持仓列表

```
币种: BNB
方向: 空
开仓价: 935.50 (平均)
数量: 0.02
当前盈亏: +1.2U

📝 持仓历史:
├─ 初始: 12:45 0.01@933 (Simple Pullback 信号分:95)
├─ 加仓1: 13:20 +0.01@938 (金字塔加仓+价格更优5.4%+信号分97)
└─ 加仓2: 14:05 +0.01@940 (趋势增强+突破阻力+信号分99)
```

### 交易历史详情

```
BNB 空单 | 盈亏: +2.5U | 持仓: 2小时15分

开仓记录:
12:45  0.01 @ 933   Simple Pullback 信号分:95
13:20  +0.01 @ 938  金字塔加仓 价格更优5.4% 信号分97
14:05  +0.01 @ 940  趋势增强+突破阻力 信号分99

平仓: 14:55  0.03 @ 930 (达止盈目标)
```

---

## 代码实现要点

### 1. 记录加仓时保留完整信息

```python
add_entry = (
    f" | [加仓{add_count}] {current_time} "
    f"+{new_amount:.3f}@{new_price:.2f} "
    f"理由:{add_type}+价格优{price_improvement_pct:.1f}%+信号分{signal_score}"
)
```

### 2. 解析时使用正则表达式

```python
pattern = r'\[加仓(\d+)\]\s+(\d{2}:\d{2})\s+\+([\d.]+)@([\d.]+)\s+理由:(.*)'
```

### 3. 回测时统计分析

```python
# 分组统计
with_add_trades = trades_df[trades_df['开仓理由'].str.contains('\[加仓')]
no_add_trades = trades_df[~trades_df['开仓理由'].str.contains('\[加仓')]

# 对比胜率
with_add_winrate = (with_add_trades['盈亏(U)'] > 0).mean()
no_add_winrate = (no_add_trades['盈亏(U)'] > 0).mean()
```

---

## 优势总结

1. **完整追踪**：保留每次开仓和加仓的完整信息
2. **易于解析**：使用 `|` 分隔符和固定格式，正则表达式可轻松解析
3. **向后兼容**：无加仓的记录格式不变
4. **AI友好**：回测时可以分析加仓策略的有效性
5. **人类可读**：CSV直接查看也能理解交易历史
6. **扩展性强**：可以继续添加更多字段（如市场环境、波动率等）

---

**版本**：V1.0
**创建日期**：2025-11-16

