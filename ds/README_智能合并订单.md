# 🔄 智能合并币安订单数据

## 功能说明

这个工具用于从币安API**智能合并和补充**本地订单数据，而不是完全覆盖。

### 主要功能

1. ✅ **补充缺失的开仓时间** - 为缺失开仓时间的订单从币安API查找并补充
2. ✅ **智能匹配订单** - 基于币种、方向、价格、数量多维度匹配
3. ✅ **保留本地字段** - 保留开仓理由、平仓理由、信号分数等本地特有数据
4. ✅ **自动备份** - 修改前自动备份原文件
5. ✅ **试运行模式** - 可以先检查不修改，确认无误后再执行

### 与 `restore_from_binance_papi.py` 的区别

| 功能 | restore脚本 | merge脚本 |
|------|------------|-----------|
| 工作模式 | **完全覆盖** | **智能合并** |
| 本地数据 | 丢弃 | 保留 |
| 开仓理由 | 丢失 | 保留 |
| 平仓理由 | 丢失 | 保留 |
| 适用场景 | 数据完全丢失/损坏 | 部分字段缺失/错误 |

## 使用方法

### 方式1：交互式运行（推荐）

```bash
cd /root/10-23-bot/ds
chmod +x merge_binance_trades.sh
./merge_binance_trades.sh
```

运行后会提示：
1. 是否试运行（只检查不修改）？
2. 处理哪个模型（deepseek/qwen/both）？

### 方式2：直接运行Python脚本

```bash
cd /root/10-23-bot/ds
python3 merge_binance_trades.py
```

## 使用场景

### ✅ 适合使用merge脚本的情况

1. **部分订单缺失开仓时间**
   - 示例：CSV中有订单，但开仓时间字段为空

2. **开仓时间错误**
   - 示例：时间明显不合理（如未来时间、过去太久等）

3. **保留本地分析数据**
   - 你已经添加了开仓理由、平仓理由、信号分数等
   - 只想补充时间信息，不想丢失这些分析数据

### ❌ 不适合使用merge脚本的情况

1. **数据完全丢失或损坏** - 应使用 `restore_from_binance_papi.py`
2. **想要完全重新开始** - 应使用 `restore_from_binance_papi.py`
3. **订单数量完全不匹配** - 应该先手动检查原因

## 智能匹配逻辑

脚本使用以下条件匹配本地订单和币安订单：

1. **币种必须相同** - 如 BTC、ETH
2. **方向必须相同** - 多或空
3. **价格相近** - 默认允许1%误差（可调整）
4. **数量相近** - 默认允许10%误差（可调整）

匹配度计算：
- 价格差异权重：1.0
- 数量差异权重：0.5
- 选择匹配度最高（误差最小）的订单

## 匹配容差调整

如果默认匹配太严格或太宽松，可以在脚本中调整：

```python
matched = match_order(
    trade, 
    binance_orders,
    tolerance_price=0.01,  # 价格容差1%
    tolerance_qty=0.1      # 数量容差10%
)
```

## 示例输出

### 试运行模式

```
========================================
🔄 处理 DEEPSEEK 数据
========================================
✅ deepseek: 已连接到币安API

📡 从币安API获取订单...
  BTC/USDT:USDT: 150 笔订单
  ETH/USDT:USDT: 120 笔订单
  ...
✅ 总计获取: 500 笔订单

📊 本地记录: 260 条
⚠️  缺失开仓时间: 12 条

🔧 开始补充和修复...
  ✓ 修复 BTC 空 @ 85540.6 → 2025-11-20 15:30:21
  ✓ 修复 ETH 多 @ 2843.8 → 2025-11-20 16:45:12
  ...

🔍 试运行模式 - 未写入文件
   将修复: 12 条记录
```

### 实际运行模式

```
========================================
🔄 处理 DEEPSEEK 数据
========================================
✅ deepseek: 已连接到币安API
✅ 已备份到: trades_history.csv.before_merge_20251121_120000

📡 从币安API获取订单...
✅ 总计获取: 500 笔订单

📊 本地记录: 260 条
⚠️  缺失开仓时间: 12 条

🔧 开始补充和修复...
  ✓ 修复 BTC 空 @ 85540.6 → 2025-11-20 15:30:21
  ✓ 修复 ETH 多 @ 2843.8 → 2025-11-20 16:45:12
  ...

✅ 已保存到: trades_history.csv
   ✓ 修复记录: 12 条
   ✓ 总记录数: 260 条
```

## 修复后的操作

1. **重启后端服务**
   ```bash
   cd /root/pythonc程序/my_project
   pkill -f "python.*每日壁纸更换.py"
   nohup python3 每日壁纸更换.py > nohup.out 2>&1 &
   ```

2. **刷新前端页面**
   - 使用硬刷新：`Ctrl + Shift + R` (Windows/Linux) 或 `Cmd + Shift + R` (Mac)

## 恢复备份

如果修复后发现问题，可以恢复备份：

```bash
# 查看备份文件
ls -la /root/10-23-bot/ds/trading_data/deepseek/trades_history.csv.before_merge*

# 恢复最新备份
cp /root/10-23-bot/ds/trading_data/deepseek/trades_history.csv.before_merge_XXXXXX \
   /root/10-23-bot/ds/trading_data/deepseek/trades_history.csv
```

## 注意事项

1. ⚠️ **必须配置币安API** - 需要 `.env` 和 `.env.qwen` 文件
2. ⚠️ **网络连接** - 需要能访问币安API
3. ⚠️ **API限流** - 大量请求可能触发限流，脚本已启用限速
4. ⚠️ **数据一致性** - 建议先试运行检查，确认无误后再执行

## 故障排查

### 问题：匹配不到订单

**可能原因：**
- 价格/数量差异太大
- 币安订单历史不够长（默认获取最近500笔）
- 方向判断错误（多空识别）

**解决方法：**
1. 增大容差：调整 `tolerance_price` 和 `tolerance_qty`
2. 增加订单数量：调整 `fetch_all_orders(exchange, limit=1000)`
3. 手动检查币安订单方向

### 问题：修复后仍缺失

**可能原因：**
- 订单太旧，不在币安API返回的范围内
- 订单被删除或不在该账户

**解决方法：**
- 手动补充这些订单的开仓时间
- 或者删除这些不完整的记录

## 技术细节

### 方向判断逻辑

```python
# 单向持仓模式
buy = 开多/平空
sell = 开空/平多

# 双向持仓模式
positionSide = LONG/SHORT 明确指示
```

### 匹配算法

```python
score = price_diff * 1.0 + qty_diff * 0.5
# 选择 score 最小的订单
```

## 相关文档

- [从币安恢复数据](README_从币安恢复数据.md) - 完全覆盖模式
- [订单格式问题修复](README_订单格式问题修复.md) - CSV格式修复
- [账户配置说明](账户配置说明.md) - API配置方法

