# V8.5.2 ä¿®å¤AIè¿‡æ—©å¹³ä»“å¯¼è‡´R:Rå´©æºƒ

## é—®é¢˜è¯Šæ–­ç»“æœ

### æ ¸å¿ƒé—®é¢˜

**å®é™…R:R(0.01)è¿œä½äºé¢„æœŸ(1.10)**

### æ•°æ®è¯æ®

```
é…ç½®å‚æ•°:
- Scalping min_risk_reward: 1.1
- Scalping atr_tp_multiplier: 1.5
- Scalping atr_stop_multiplier: 1.5

å®é™…äº¤æ˜“(105ç¬”):
- èƒœç‡: 57.1%ï¼ˆä¸ç®—ä½ï¼‰
- å¹³å‡ç›ˆäº: 0.014U/ç¬”ï¼ˆæä½ï¼‰
- æ€»ç›ˆäº: 1.43Uï¼ˆ105ç¬”æ‰èµš1.43Uï¼‰
- å®é™…R:R: 0.01:1ï¼ˆå´©æºƒï¼‰

å¼€ä»“è®¾ç½®:
- ç›ˆäºæ¯”: 5.3:1ï¼ˆçœ‹èµ·æ¥å¾ˆå¥½ï¼‰

å®é™…ç»“æœ:
- R:R: 0.01:1ï¼ˆå‡ ä¹æ²¡ç­‰åˆ°TPå°±å¹³ä»“äº†ï¼‰
```

### æ ¹æœ¬åŸå› 

**AIè¿‡æ—©å¹³ä»“ï¼Œå®Œå…¨æ— è§†ä¼˜åŒ–åçš„æ­¢ç›ˆç›®æ ‡**

AIè¢«è®¾è®¡ä¸º"çµæ´»åº”å¯¹å¸‚åœºå˜åŒ–"ï¼Œä½†è¿™å¯¼è‡´ï¼š
1. çœ‹åˆ°çŸ­æœŸåè½¬ä¿¡å·ï¼ˆå¦‚Bear Exhaustionï¼‰å°±ç«‹å³å¹³ä»“
2. çœ‹åˆ°15mçš„å°å¹…å›è°ƒå°±è®¤ä¸º"è¶‹åŠ¿åè½¬"
3. å®Œå…¨æ— è§†å›æµ‹ä¼˜åŒ–çš„TP/SLç­–ç•¥
4. ç»“æœï¼šèƒœç‡ä¸ä½ï¼Œä½†æ¯ç¬”ç›ˆåˆ©æå°‘

**å›æµ‹ vs å®ç›˜çš„å…³é”®å·®å¼‚ï¼š**

| é¡¹ç›® | å›æµ‹ | å®ç›˜ |
|------|------|------|
| **å¹³ä»“å†³ç­–** | å‡è®¾ä»·æ ¼è¾¾åˆ°TP | AIåŠ¨æ€å¹³ä»“ï¼ˆé¢‘ç¹è¿‡æ—©å¹³ä»“ï¼‰ |
| **å¹³å‡åˆ©æ¶¦** | 4.2% | 0.1% |
| **R:R** | 1.1:1 | 0.01:1 |

---

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šç¦æ­¢AIå› çŸ­æœŸä¿¡å·å¹³ä»“ï¼ˆæ¨èï¼‰

#### ä¿®æ”¹AI Promptï¼Œä¸¥æ ¼é™åˆ¶å¹³ä»“æ¡ä»¶

**æ–‡ä»¶**: `ds/qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py`, `ds/deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py`

**ä¿®æ”¹ä½ç½®**: AI Promptæ„å»ºéƒ¨åˆ†ï¼ˆçº¦ç¬¬13700-13800è¡Œï¼‰

**å¢å¼ºå¹³ä»“è§„åˆ™ï¼š**

```python
position_management_rules = f"""
## ğŸš¨ å¹³ä»“è§„åˆ™ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰

### âœ… å…è®¸çš„å¹³ä»“æ¡ä»¶ï¼ˆæ»¡è¶³ä»»ä¸€å³å¯å¹³ä»“ï¼‰ï¼š

1. **æ­¢ç›ˆè§¦å‘**ï¼šä»·æ ¼è¾¾åˆ°æˆ–è¶…è¿‡æ­¢ç›ˆç›®æ ‡ï¼ˆTPï¼‰
2. **æ­¢æŸè§¦å‘**ï¼šä»·æ ¼è§¦åŠæˆ–è·Œç ´æ­¢æŸçº¿ï¼ˆSLï¼‰
3. **æ—¶é—´æ­¢æŸ**ï¼šæŒä»“æ—¶é—´è¶…è¿‡max_holding_hours
   - Scalping: {scalp_hours}å°æ—¶
   - Swing: {swing_hours}å°æ—¶
4. **è¶‹åŠ¿å®Œå…¨åè½¬**ï¼š4H + 1H + 15mä¸‰ä¸ªæ—¶é—´æ¡†æ¶**åŒæ—¶**åè½¬ï¼ˆæå°‘è§ï¼‰

### âŒ ç¦æ­¢çš„å¹³ä»“ç†ç”±ï¼ˆä»¥ä¸‹æƒ…å†µä¸è¦å¹³ä»“ï¼‰ï¼š

1. âŒ **å•ä¸€æ—¶é—´æ¡†æ¶åè½¬ä¿¡å·**ï¼š
   - "15må‡ºç°Bear Exhaustion" â† ä¸è¶³ä»¥å¹³ä»“
   - "1Hå‡ºç°åè½¬Kçº¿" â† ä¸è¶³ä»¥å¹³ä»“
   - "çŸ­æœŸå›è°ƒ" â† æ­£å¸¸æ³¢åŠ¨

2. âŒ **ä¸»è§‚åˆ¤æ–­**ï¼š
   - "è§‰å¾—æ¶¨å¾—å¤Ÿå¤šäº†" â† å¿…é¡»ç­‰TP
   - "æ‹…å¿ƒåˆ©æ¶¦å›å" â† ç›¸ä¿¡TP/SLè®¾è®¡
   - "çœ‹åˆ°é˜»åŠ›ä½" â† å¼€ä»“æ—¶å·²è€ƒè™‘

3. âŒ **è¿‡æ—©æ­¢ç›ˆ**ï¼š
   - "å·²æœ‰æµ®ç›ˆï¼Œæå‰é”å®š" â† é”™è¯¯ï¼
   - "è¾¾åˆ°50%ç›®æ ‡" â† å¿…é¡»ç­‰100%
   - "åˆ†æ‰¹å¹³ä»“" â† ç›®å‰ä¸æ”¯æŒ

### ğŸ“ R:Rä¿æŠ¤æœºåˆ¶

**å½“å‰é…ç½®çš„æœ€å°R:R: {scalp_rr}:1**

è¿™æ„å‘³ç€ï¼š
- æ­¢ç›ˆè·ç¦» = ATR Ã— {scalp_tp}
- æ­¢æŸè·ç¦» = ATR Ã— {scalp_sl}
- **å¿…é¡»ç­‰ä»·æ ¼ç§»åŠ¨{scalp_tp}å€ATRæ‰èƒ½æ­¢ç›ˆ**
- **åªæœ‰ä»·æ ¼åå‘ç§»åŠ¨{scalp_sl}å€ATRæ‰è§¦å‘æ­¢æŸ**

**å›æµ‹æ•°æ®è¯æ˜**ï¼š
- å¦‚æœä½ ç­‰å¾…TPï¼Œå¹³å‡ç›ˆåˆ©ä¸º +4.2%
- å¦‚æœä½ è¿‡æ—©å¹³ä»“ï¼Œå®é™…ç›ˆåˆ©åªæœ‰ +0.1%
- **è¿‡æ—©å¹³ä»“ä¼šå¯¼è‡´R:Rä»1.1:1å´©æºƒåˆ°0.01:1**

### ğŸ¯ å†³ç­–æµç¨‹

å¯¹äºæ¯ä¸ªæŒä»“ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºæ£€æŸ¥ï¼š

```
1. æ£€æŸ¥æ­¢ç›ˆ: price >= TP? 
   âœ… æ˜¯ â†’ CLOSE (æ­¢ç›ˆè¾¾æˆ)
   âŒ å¦ â†’ ç»§ç»­

2. æ£€æŸ¥æ­¢æŸ: price <= SL?
   âœ… æ˜¯ â†’ CLOSE (æ­¢æŸè§¦å‘)
   âŒ å¦ â†’ ç»§ç»­

3. æ£€æŸ¥æŒä»“æ—¶é—´: holding_time > max_hours?
   âœ… æ˜¯ â†’ CLOSE (è¶…æ—¶å¹³ä»“)
   âŒ å¦ â†’ ç»§ç»­

4. æ£€æŸ¥ä¸‰å±‚æ¡†æ¶åè½¬: 4Håè½¬ AND 1Håè½¬ AND 15måè½¬?
   âœ… æ˜¯ â†’ CLOSE (è¶‹åŠ¿å®Œå…¨åè½¬)
   âŒ å¦ â†’ HOLD (ç»§ç»­æŒæœ‰)
```

### ğŸ“Š å†å²æ•™è®­

ä»è¿‡å»105ç¬”äº¤æ˜“çš„æ•°æ®åˆ†æï¼š
- **è¿‡æ—©å¹³ä»“**å¯¼è‡´å®é™…R:Råªæœ‰0.01:1ï¼ˆé¢„æœŸ1.1:1ï¼‰
- **å¹³å‡ç›ˆåˆ©**åªæœ‰0.014Uï¼ˆé¢„æœŸåº”è¯¥æ˜¯1.5U+ï¼‰
- **èƒœç‡**57%ä¸ä½ï¼Œä½†ç›ˆåˆ©æå°‘

**åŸå› **ï¼šAIé¢‘ç¹å› ä¸º"Bear Exhaustion"ã€"çŸ­æœŸå›è°ƒ"ç­‰ä¿¡å·æå‰å¹³ä»“

**ä¿®æ­£**ï¼šä¸¥æ ¼ç­‰å¾…TP/SLè§¦å‘ï¼Œä¸è¦è¢«çŸ­æœŸæ³¢åŠ¨è¿·æƒ‘

---

### ğŸ’¬ å¹³ä»“ç†ç”±æ ¼å¼è¦æ±‚

å¦‚æœå¿…é¡»å¹³ä»“ï¼Œç†ç”±æ ¼å¼ï¼š

```
ã€å¹³ä»“ç±»å‹ã€‘åŸå› æè¿° + æ•°æ®æ”¯æŒ

ç¤ºä¾‹ï¼š
âœ… "ã€æ­¢ç›ˆè¾¾æˆã€‘ä»·æ ¼$Xè¾¾åˆ°TPç›®æ ‡$Yï¼ŒR:R=1.2:1ï¼ŒæŒä»“3.5å°æ—¶"
âœ… "ã€æ­¢æŸè§¦å‘ã€‘ä»·æ ¼$Xè§¦åŠSL $Yï¼ŒR:R=-1.0:1ï¼Œé¿å…æ›´å¤§æŸå¤±"
âœ… "ã€è¶…æ—¶å¹³ä»“ã€‘æŒä»“12.5å°æ—¶è¶…è¿‡max_holding_hours(12h)ï¼Œå½“å‰æµ®ç›ˆ+0.5%"
âœ… "ã€è¶‹åŠ¿å®Œå…¨åè½¬ã€‘4H/1H/15mä¸‰å±‚æ¡†æ¶å…¨éƒ¨åè½¬ä¸ºå¤šå¤´ï¼Œç©ºå•é€€å‡º"

âŒ "ã€Bear Exhaustionã€‘15må‡ºç°é•¿ä¸‹å½±çº¿ï¼Œæå‰å¹³ä»“" â† é”™è¯¯ï¼
âŒ "ã€è¿‡æ—©æ­¢ç›ˆã€‘å·²æœ‰æµ®ç›ˆï¼Œé”å®šåˆ©æ¶¦" â† é”™è¯¯ï¼
âŒ "ã€ä¸»è§‚åˆ¤æ–­ã€‘è§‰å¾—æ¶¨å¾—å¤Ÿå¤šäº†" â† é”™è¯¯ï¼
```
"""
```

**æ’å…¥ä½ç½®ï¼š** åœ¨ç°æœ‰çš„`ai_portfolio_decision()`å‡½æ•°çš„Promptæ„å»ºéƒ¨åˆ†

---

### æ–¹æ¡ˆ2ï¼šç§»é™¤AIçš„ä¸»åŠ¨å¹³ä»“æƒé™ï¼ˆæ¿€è¿›ä½†æœ‰æ•ˆï¼‰

#### ä¿®æ”¹å¹³ä»“é€»è¾‘ï¼Œåªå…è®¸TP/SL/æ—¶é—´æ­¢æŸ

**æ€è·¯**ï¼š
1. ä¿ç•™AIçš„å¼€ä»“å†³ç­–æƒ
2. ä½†å¹³ä»“åªèƒ½ç”±ç³»ç»Ÿè§¦å‘ï¼š
   - TPè§¦å‘ â†’ å¹³ä»“
   - SLè§¦å‘ â†’ å¹³ä»“
   - è¶…è¿‡max_holding_hours â†’ å¹³ä»“
3. AIåªèƒ½ç›‘æ§ï¼Œä¸èƒ½ä¸»åŠ¨CLOSE

**å®ç°æ–¹å¼ï¼š**

ä¿®æ”¹ `monitor_positions_for_invalidation()` å‡½æ•°ï¼ˆçº¦ç¬¬16500è¡Œï¼‰ï¼š

```python
def monitor_positions_for_invalidation(market_data_list: list, current_positions: list) -> list:
    """
    ç›‘æ§æŒä»“ï¼Œåªåœ¨ä¸¥æ ¼æ¡ä»¶ä¸‹è§¦å‘å¹³ä»“
    
    V8.5.2: é™åˆ¶å¹³ä»“æ¡ä»¶ï¼Œé˜²æ­¢AIè¿‡æ—©å¹³ä»“
    """
    close_actions = []
    
    for pos in current_positions:
        symbol = pos["symbol"]
        side = pos["side"]
        entry_price = pos.get("entry_price", 0)
        current_price = pos.get("mark_price", 0)
        
        # è·å–æŒä»“ä¸Šä¸‹æ–‡
        entry_context = load_entry_context(symbol)
        if not entry_context:
            continue
        
        open_time = entry_context.get("entry_time", "")
        tp = entry_context.get("take_profit", 0)
        sl = entry_context.get("stop_loss", 0)
        max_hours = entry_context.get("max_holding_hours", 24)
        
        # è®¡ç®—æŒä»“æ—¶é—´
        holding_hours = calculate_holding_hours(open_time)
        
        close_reason = None
        
        # æ£€æŸ¥1ï¼šæ­¢ç›ˆè§¦å‘
        if side == "long" and current_price >= tp:
            close_reason = f"ã€æ­¢ç›ˆè¾¾æˆã€‘ä»·æ ¼${current_price:.2f}è¾¾åˆ°TP${tp:.2f}"
        elif side == "short" and current_price <= tp:
            close_reason = f"ã€æ­¢ç›ˆè¾¾æˆã€‘ä»·æ ¼${current_price:.2f}è¾¾åˆ°TP${tp:.2f}"
        
        # æ£€æŸ¥2ï¼šæ­¢æŸè§¦å‘
        elif side == "long" and current_price <= sl:
            close_reason = f"ã€æ­¢æŸè§¦å‘ã€‘ä»·æ ¼${current_price:.2f}è§¦åŠSL${sl:.2f}"
        elif side == "short" and current_price >= sl:
            close_reason = f"ã€æ­¢æŸè§¦å‘ã€‘ä»·æ ¼${current_price:.2f}è§¦åŠSL${sl:.2f}"
        
        # æ£€æŸ¥3ï¼šè¶…æ—¶å¹³ä»“
        elif holding_hours > max_hours:
            pnl_pct = calculate_pnl_pct(entry_price, current_price, side)
            close_reason = f"ã€è¶…æ—¶å¹³ä»“ã€‘æŒä»“{holding_hours:.1f}å°æ—¶è¶…è¿‡{max_hours}hï¼Œå½“å‰{pnl_pct:+.1f}%"
        
        # æ£€æŸ¥4ï¼šä¸‰å±‚æ¡†æ¶å®Œå…¨åè½¬ï¼ˆå¯é€‰ï¼Œè°¨æ…ä½¿ç”¨ï¼‰
        # elif check_full_trend_reversal(market_data_list, symbol, side):
        #     close_reason = f"ã€è¶‹åŠ¿å®Œå…¨åè½¬ã€‘4H/1H/15mä¸‰å±‚æ¡†æ¶å…¨éƒ¨åè½¬"
        
        if close_reason:
            close_actions.append({
                "action": "CLOSE",
                "symbol": symbol,
                "reason": close_reason
            })
    
    return close_actions
```

**ä¼˜ç‚¹**ï¼š
- å®Œå…¨æ¶ˆé™¤AIè¿‡æ—©å¹³ä»“çš„é—®é¢˜
- R:Rä¸¥æ ¼æŒ‰ç…§é…ç½®æ‰§è¡Œ
- å›æµ‹å’Œå®ç›˜å®Œå…¨ä¸€è‡´

**ç¼ºç‚¹**ï¼š
- å¤±å»çµæ´»æ€§
- æ— æ³•åº”å¯¹çªå‘äº‹ä»¶ï¼ˆå¦‚é‡å¤§æ–°é—»ï¼‰

---

### æ–¹æ¡ˆ3ï¼šæ·»åŠ R:Rä¿æŠ¤æœºåˆ¶ï¼ˆæŠ˜ä¸­ï¼‰

#### åœ¨AIå¹³ä»“å†³ç­–åå¢åŠ éªŒè¯

**ä¿®æ”¹ä½ç½®**: `_execute_single_close_action()` å‡½æ•°

```python
def _execute_single_close_action(action, current_positions):
    """
    æ‰§è¡Œå¹³ä»“æ“ä½œ
    
    V8.5.2: å¢åŠ R:Rä¿æŠ¤ï¼Œé˜²æ­¢è¿‡æ—©å¹³ä»“
    """
    symbol = action.get("symbol", "")
    close_reason = action.get("reason", "N/A")
    
    # ... ç°æœ‰ä»£ç  ...
    
    # ğŸ†• V8.5.2: R:Rä¿æŠ¤æœºåˆ¶
    if "æ­¢ç›ˆè¾¾æˆ" not in close_reason and "æ­¢æŸè§¦å‘" not in close_reason and "è¶…æ—¶å¹³ä»“" not in close_reason:
        # AIæƒ³ä¸»åŠ¨å¹³ä»“ï¼Œéœ€è¦éªŒè¯R:R
        entry_context = load_entry_context(symbol)
        if entry_context:
            entry_price = entry_context.get("entry_price", 0)
            current_price = current_pos.get("mark_price", 0)
            side = current_pos["side"]
            
            # è®¡ç®—å®é™…R:R
            pnl_pct = calculate_pnl_pct(entry_price, current_price, side)
            config = load_learning_config()
            min_rr = config.get('scalping_params', {}).get('min_risk_reward', 1.1)
            atr_sl = config.get('scalping_params', {}).get('atr_stop_multiplier', 1.5)
            
            # è®¡ç®—æœ€å°ç›ˆåˆ©è¦æ±‚ï¼ˆåŸºäºR:Rï¼‰
            min_profit_pct = min_rr * atr_sl * 0.5  # ATRçš„0.5%ä½œä¸ºæœ€å°å•ä½
            
            if pnl_pct < min_profit_pct:
                print(f"âš ï¸ R:Rä¿æŠ¤ï¼šå½“å‰ç›ˆåˆ©{pnl_pct:.2f}%ä½äºæœ€å°è¦æ±‚{min_profit_pct:.2f}%ï¼Œæ‹’ç»å¹³ä»“")
                send_bark_notification(
                    f"[è­¦å‘Š]{coin_name}æ‹’ç»è¿‡æ—©å¹³ä»“",
                    f"AIæƒ³å¹³ä»“ä½†ç›ˆåˆ©ä¸è¶³\nå½“å‰:{pnl_pct:.2f}%\nè¦æ±‚:{min_profit_pct:.2f}%\nç†ç”±:{close_reason[:50]}"
                )
                return  # æ‹’ç»å¹³ä»“
    
    # ç»§ç»­æ‰§è¡Œå¹³ä»“...
```

---

## å®æ–½å»ºè®®

### é˜¶æ®µ1ï¼šç«‹å³å®æ–½ï¼ˆæ–¹æ¡ˆ1ï¼‰

âœ… **å¢å¼ºAI Promptï¼Œä¸¥æ ¼é™åˆ¶å¹³ä»“æ¡ä»¶**

å·¥ä½œé‡ï¼šå°ï¼ˆåªéœ€ä¿®æ”¹Promptæ–‡æœ¬ï¼‰
æ•ˆæœï¼šä¸­ç­‰ï¼ˆä¾èµ–AIç†è§£å’Œéµå®ˆï¼‰
é£é™©ï¼šä½

### é˜¶æ®µ2ï¼šè§‚å¯Ÿ1-2å¤©

å¦‚æœæ–¹æ¡ˆ1æ•ˆæœä¸ä½³ï¼ˆAIä»ç„¶è¿‡æ—©å¹³ä»“ï¼‰ï¼Œå®æ–½æ–¹æ¡ˆ3

### é˜¶æ®µ3ï¼šå¦‚æœä»æ— æ•ˆ

å®æ–½æ–¹æ¡ˆ2ï¼ˆç§»é™¤AIä¸»åŠ¨å¹³ä»“æƒï¼‰ï¼Œå®Œå…¨è‡ªåŠ¨åŒ–

---

## éªŒè¯æ–¹æ³•

ä¿®å¤åï¼ŒæœŸå¾…çœ‹åˆ°ï¼š

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤åç›®æ ‡ |
|------|--------|-----------|
| å®é™…R:R | 0.01:1 | â‰¥1.0:1 |
| å¹³å‡ç›ˆäº | 0.014U | â‰¥1.0U |
| è¿‡æ—©å¹³ä»“ç‡ | 46% | <10% |
| 100ç¬”ç›ˆäº | +1.4U | +100U |

**æ£€æŸ¥æ–¹æ³•ï¼š**
```bash
# è§‚å¯Ÿæ–°çš„äº¤æ˜“è®°å½•
tail -n 20 /root/10-23-bot/ds/trading_data/qwen/trades_history.csv

# é‡æ–°è¿è¡Œè¯Šæ–­
bash ~/10-23-bot/è¯Šæ–­å›æµ‹å®ç›˜å·®å¼‚.sh
```

---

## æ€»ç»“

**é—®é¢˜**ï¼šAIè¿‡æ—©å¹³ä»“ï¼Œå¯¼è‡´å®é™…R:Rä»1.1:1å´©æºƒåˆ°0.01:1  
**åŸå› **ï¼šAIå¯¹çŸ­æœŸåè½¬ä¿¡å·è¿‡åº¦æ•æ„Ÿï¼Œæ— è§†ä¼˜åŒ–åçš„TP/SLç­–ç•¥  
**ä¿®å¤**ï¼šä¸¥æ ¼é™åˆ¶å¹³ä»“æ¡ä»¶ï¼Œåªå…è®¸TP/SL/è¶…æ—¶/å®Œå…¨åè½¬è§¦å‘å¹³ä»“  
**é¢„æœŸ**ï¼šå®é™…R:Ræ¢å¤åˆ°1.0:1+ï¼Œå¹³å‡ç›ˆåˆ©ä»0.014Uæå‡åˆ°1.0U+  
**ç‰ˆæœ¬**ï¼šV8.5.2

