# æ•°æ®ä¿®æ­£å¿«é€ŸæŒ‡å—

## ðŸš€ å¿«é€Ÿå¼€å§‹

### ä¸€é”®ä¿®æ­£ï¼ˆæŽ¨èï¼‰

```bash
cd /Users/mac-bauyu/Downloads/10-23-bot/ds
python3 fix_data_integrity.py
```

å·¥å…·ä¼š:
1. âœ… è‡ªåŠ¨å¤‡ä»½æ‰€æœ‰æ•°æ®
2. ðŸ” æ£€æŸ¥è®¢å•å®Œæ•´æ€§
3. ðŸ“Š é‡æ–°è®¡ç®—æ€»èµ„äº§
4. ðŸ”§ ä¿®æ­£æ•°æ®é”™è¯¯
5. ðŸ“ æ¢å¤ç¼ºå¤±è®¢å•

### ä»…æ£€æŸ¥ä¸ä¿®æ­£

```bash
python3 fix_data_integrity.py --check-only
```

## ðŸ“‹ ä¿®æ­£å†…å®¹

### 1. æ€»èµ„äº§ä¿®æ­£

**é—®é¢˜**: `system_status.json` ä¸­çš„ `æ€»èµ„äº§` å­—æ®µè®¡ç®—é”™è¯¯

**ä¿®æ­£æ–¹æ³•**: 
```
æ­£ç¡®æ€»èµ„äº§ = åˆå§‹èµ„é‡‘(100U) + å·²å®žçŽ°ç›ˆäº + æœªå®žçŽ°ç›ˆäº
```

æ•°æ®æ¥æº:
- **å·²å®žçŽ°ç›ˆäº**: ä»Ž `trades_history.csv` ä¸­æ‰€æœ‰å·²å¹³ä»“è®¢å•çš„ `ç›ˆäº(U)` å­—æ®µç´¯åŠ 
- **æœªå®žçŽ°ç›ˆäº**: ä»Ž `system_status.json` çš„ `æŒä»“è¯¦æƒ…` ä¸­ç´¯åŠ 

### 2. è®¢å•æ¢å¤

**é—®é¢˜**: `system_status.json` ä¸­æœ‰æŒä»“ï¼Œä½† `trades_history.csv` ç¼ºå°‘å¯¹åº”çš„å¼€ä»“è®°å½•

**ä¿®æ­£æ–¹æ³•**: 
ä»Ž `system_status.json` çš„ `æŒä»“è¯¦æƒ…` ä¸­æå–ä¿¡æ¯ï¼Œé‡å»ºè®¢å•è®°å½•å¹¶è¿½åŠ åˆ° `trades_history.csv`

## ðŸ“Š ä¿®æ­£ç¤ºä¾‹

### ä¿®æ­£å‰

**DeepSeek**:
```json
{
  "æ€»èµ„äº§": 95.50,  // âŒ é”™è¯¯
  "æŒä»“è¯¦æƒ…": [
    {"å¸ç§": "BTC", "æ–¹å‘": "å¤š", "ç›ˆäº": -2.5},
    {"å¸ç§": "ETH", "æ–¹å‘": "ç©º", "ç›ˆäº": 1.2}
  ]
}
```

**trades_history.csv**: 50æ¡å·²å¹³ä»“è®°å½•ï¼Œæ€»ç›ˆäº -5.3Uï¼Œä½†ç¼ºå°‘2æ¡å¼€ä»“è®°å½•

### ä¿®æ­£åŽ

**DeepSeek**:
```json
{
  "æ€»èµ„äº§": 93.40,  // âœ… æ­£ç¡® = 100 + (-5.3) + (-2.5 + 1.2)
  "æŒä»“è¯¦æƒ…": [
    {"å¸ç§": "BTC", "æ–¹å‘": "å¤š", "ç›ˆäº": -2.5},
    {"å¸ç§": "ETH", "æ–¹å‘": "ç©º", "ç›ˆäº": 1.2}
  ]
}
```

**trades_history.csv**: 52æ¡è®°å½•ï¼ˆ50æ¡å·²å¹³ä»“ + 2æ¡æœªå¹³ä»“ï¼‰

## âš ï¸  æ³¨æ„äº‹é¡¹

1. **æ•°æ®å¤‡ä»½**: ä¿®æ­£å‰ä¼šè‡ªåŠ¨å¤‡ä»½åˆ° `data_backup/` ç›®å½•
2. **åœæ­¢äº¤æ˜“**: å»ºè®®åœ¨ä¿®æ­£æ•°æ®æ—¶åœæ­¢äº¤æ˜“ç³»ç»Ÿ
3. **äºŒæ¬¡ç¡®è®¤**: å·¥å…·ä¼šæ˜¾ç¤ºä¿®æ­£æ–¹æ¡ˆï¼Œéœ€è¦æ‰‹åŠ¨ç¡®è®¤åŽæ‰æ‰§è¡Œ

## ðŸ” æ£€æŸ¥æŠ¥å‘Šç¤ºä¾‹

```
============================================================
ðŸ”§ æ•°æ®å®Œæ•´æ€§ä¿®æ­£å·¥å…·
============================================================

ã€æ­¥éª¤1ã€‘å¤‡ä»½åŽŸå§‹æ•°æ®

ðŸ“¦ å¤‡ä»½ deepseek æ•°æ®...
   âœ“ system_status.json
   âœ“ trades_history.csv
   âœ“ current_positions.csv
   âœ“ pnl_history.csv
âœ… å¤‡ä»½å®Œæˆ: /path/to/data_backup/20251120_143022

ðŸ“¦ å¤‡ä»½ qwen æ•°æ®...
   ...

ã€æ­¥éª¤2ã€‘æ£€æŸ¥è®¢å•å®Œæ•´æ€§

ðŸ” deepseek è®¢å•å®Œæ•´æ€§æ£€æŸ¥:
   æ€»è®¢å•æ•°: 157
   æœªå¹³ä»“: 3
   å·²å¹³ä»“: 154
   system_status.json æŒä»“æ•°: 3
   âœ“ æŒä»“è®°å½•ä¸€è‡´
   âœ“ è®¢å•ç¼–å·è¿žç»­ (1-157)

ðŸ” qwen è®¢å•å®Œæ•´æ€§æ£€æŸ¥:
   æ€»è®¢å•æ•°: 143
   æœªå¹³ä»“: 5
   å·²å¹³ä»“: 138
   system_status.json æŒä»“æ•°: 7
   âš ï¸  ä¸ä¸€è‡´! trades_historyæœªå¹³ä»“(5) != statusæŒä»“(7)
   âŒ trades_history.csvç¼ºå¤±çš„è®¢å•: {'SOL_å¤š', 'BNB_ç©º'}

ã€æ­¥éª¤3ã€‘é‡æ–°è®¡ç®—æ€»èµ„äº§

ðŸ“Š deepseek èµ„äº§æ ¸ç®—:
   åˆå§‹èµ„é‡‘: 100.00 U
   å·²å®žçŽ°ç›ˆäº: -8.45 U (154 ç¬”)
   æœªå®žçŽ°ç›ˆäº: 2.15 U (3 æŒä»“)
   ---
   æ—§è®°å½•æ€»èµ„äº§: 95.50 U
   æ­£ç¡®æ€»èµ„äº§: 93.70 U
   å·®å¼‚: -1.80 U

ðŸ“Š qwen èµ„äº§æ ¸ç®—:
   åˆå§‹èµ„é‡‘: 100.00 U
   å·²å®žçŽ°ç›ˆäº: 5.23 U (138 ç¬”)
   æœªå®žçŽ°ç›ˆäº: -1.85 U (7 æŒä»“)
   ---
   æ—§è®°å½•æ€»èµ„äº§: 102.00 U
   æ­£ç¡®æ€»èµ„äº§: 103.38 U
   å·®å¼‚: +1.38 U

============================================================
ðŸ“‹ ä¿®æ­£æ–¹æ¡ˆ:
============================================================

deepseek:
  å½“å‰è®°å½•: 95.50 U
  æ­£ç¡®å€¼: 93.70 U
  éœ€ä¿®æ­£: -1.80 U

qwen:
  å½“å‰è®°å½•: 102.00 U
  æ­£ç¡®å€¼: 103.38 U
  éœ€ä¿®æ­£: +1.38 U

============================================================
æ˜¯å¦æ‰§è¡Œä¿®æ­£? (y/n): 
```

## ðŸ› ï¸ æ‰‹åŠ¨ä¿®æ­£ï¼ˆé«˜çº§ï¼‰

å¦‚æžœè‡ªåŠ¨å·¥å…·æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œå‚è€ƒ `æ•°æ®ä¿®æ­£è¯´æ˜Ž.md` ä¸­çš„æ‰‹åŠ¨æ–¹æ¡ˆã€‚

## ðŸ“ž é—®é¢˜æŽ’æŸ¥

### é—®é¢˜1: å·¥å…·æç¤º"æ–‡ä»¶ä¸å­˜åœ¨"

**è§£å†³**: ç¡®ä¿åœ¨ `ds/` ç›®å½•ä¸‹è¿è¡Œï¼Œä¸” `trading_data/` ç›®å½•ç»“æž„å®Œæ•´

```bash
cd /Users/mac-bauyu/Downloads/10-23-bot/ds
ls -la trading_data/deepseek/
ls -la trading_data/qwen/
```

### é—®é¢˜2: ä¿®æ­£åŽæ€»èµ„äº§è¿˜æ˜¯ä¸å¯¹

**å¯èƒ½åŽŸå› **:
- åˆå§‹èµ„é‡‘ä¸æ˜¯100U
- å­˜åœ¨æ‰‹åŠ¨äº¤æ˜“æœªè®°å½•
- CSVæ–‡ä»¶ç¼–ç é—®é¢˜

**è§£å†³**: æ‰‹åŠ¨æ ¸å¯¹ `trades_history.csv` ä¸­çš„æ‰€æœ‰ç›ˆäºå€¼

```bash
# æ£€æŸ¥å·²å¹³ä»“äº¤æ˜“çš„æ€»ç›ˆäº
cd trading_data/deepseek
awk -F',' 'NR>1 && $7!="" {sum+=$9} END {print "æ€»ç›ˆäº:", sum, "U"}' trades_history.csv
```

### é—®é¢˜3: è®¢å•æ¢å¤åŽå‡ºçŽ°é‡å¤

**è§£å†³**: åˆ é™¤å¤‡ä»½ï¼Œé‡æ–°è¿è¡Œå·¥å…·ï¼ˆä¼šä»Žæœ€æ–°å¤‡ä»½è¿˜åŽŸï¼‰

```bash
# æŸ¥çœ‹å¤‡ä»½
ls -la data_backup/

# ä»Žå¤‡ä»½è¿˜åŽŸï¼ˆæ›¿æ¢TIMESTAMPï¼‰
cp data_backup/TIMESTAMP/* trading_data/deepseek/
cp data_backup/TIMESTAMP/* trading_data/qwen/
```

## ðŸ“š ç›¸å…³æ–‡æ¡£

- `æ•°æ®ä¿®æ­£è¯´æ˜Ž.md` - è¯¦ç»†æŠ€æœ¯æ–‡æ¡£
- `æ•°æ®æ–‡ä»¶è·¯å¾„è¯´æ˜Ž.md` - æ•°æ®ç»“æž„è¯´æ˜Ž
- `fix_data_integrity.py` - ä¿®æ­£å·¥å…·æºç 

## âœ… ä¿®æ­£å®ŒæˆåŽ

1. éªŒè¯æ•°æ®æ­£ç¡®æ€§
2. é‡å¯äº¤æ˜“ç³»ç»Ÿ
3. è§‚å¯Ÿæ˜¯å¦è¿˜æœ‰é—®é¢˜

```bash
# é‡å¯äº¤æ˜“ç³»ç»Ÿ
cd /Users/mac-bauyu/Downloads/10-23-bot/ds
killall python3
MANUAL_BACKTEST=true python3 run_with_memory_monitor.py > /tmp/backtest.txt 2>&1 &
tail -f /tmp/backtest.txt
```

