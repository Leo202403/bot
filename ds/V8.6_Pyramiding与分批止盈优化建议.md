# V8.6 PyramidingåŠ ä»“ + åˆ†æ‰¹æ­¢ç›ˆä¼˜åŒ–å»ºè®®

## å»ºè®®æ¥æº

ç”¨æˆ·æœ‹å‹çš„ä¸“ä¸šå»ºè®®ï¼Œä¸¤ä¸ªæ ¸å¿ƒç­–ç•¥ï¼š
1. **PyramidingåŠ ä»“**ï¼šåº•ä»“30% â†’ ç›ˆåˆ©ååŠ ä»“30% â†’ ç§»åŠ¨æ­¢æŸåˆ°Break-even
2. **åˆ†æ‰¹æ­¢ç›ˆ**ï¼šç¬¬ä¸€ç›®æ ‡ä½å¹³50% â†’ å‰©ä½™50%ç”¨Trailing Stop

---

## å»ºè®®1ï¼šPyramidingåŠ ä»“ç­–ç•¥

### å½“å‰ç³»ç»Ÿç°çŠ¶

**ä»“ä½è®¡ç®—**ï¼š`calculate_position_size_smart()`
```python
# å½“å‰é€»è¾‘ï¼šä¸€æ¬¡æ€§å…¨ä»“å¼€ä»“
base_ratio = 0.20  # åŸºç¡€20%
multiplier = 1.5 if quality == "HIGH" else 1.0  # ä¿¡å·è´¨é‡è°ƒæ•´
position = base_position * multiplier  # ä¸€æ¬¡æ€§è®¡ç®—ä»“ä½
```

**é—®é¢˜**ï¼š
- âœ… æœ‰åŠ¨æ€ä»“ä½è°ƒæ•´ï¼ˆåŸºäºsignal_qualityï¼‰
- âŒ **ç¼ºå°‘åˆ†æ‰¹åŠ ä»“æœºåˆ¶**
- âŒ ä¸€æ¬¡æ€§å…¨ä»“ï¼Œæ— æ³•åœ¨ç¡®è®¤è¶‹åŠ¿åå¢åŠ ä»“ä½
- âŒ é£é™©é›†ä¸­ï¼šå¦‚æœåˆ¤æ–­é”™è¯¯ï¼Œå…¨éƒ¨ä»“ä½å—æŸ

---

### å»ºè®®ç­–ç•¥ï¼šé¡ºåŠ¿åŠ ä»“ï¼ˆPyramidingï¼‰

**æ ¸å¿ƒç†å¿µ**ï¼š
> ç”¨å°ä»“ä½è¯•æ¢ï¼Œç¡®è®¤ç›ˆåˆ©å’Œè¶‹åŠ¿å»¶ç»­åï¼Œå†å¢åŠ ä»“ä½ã€‚æ°¸è¿œä¸åœ¨äºæŸæ—¶åŠ ä»“ã€‚

#### é˜¶æ®µ1ï¼šåº•ä»“ï¼ˆ30%ï¼‰
```python
# åˆå§‹å¼€ä»“ï¼šä¿å®ˆ
initial_position = base_position * 0.3  # ä»…30%åº•ä»“
stop_loss = entry_price - atr * 2.0    # åˆå§‹æ­¢æŸ
```

**è§¦å‘æ¡ä»¶**ï¼š
- ä¿¡å·æ»¡è¶³min_signal_score
- é€šè¿‡é£é™©é¢„ç®—æ£€æŸ¥
- æ­£å¸¸å¼€ä»“æµç¨‹

---

#### é˜¶æ®µ2ï¼šç¡®è®¤åŠ ä»“ï¼ˆ+30%ï¼‰

**è§¦å‘æ¡ä»¶**ï¼ˆå…¨éƒ¨æ»¡è¶³ï¼‰ï¼š
1. **ç›ˆåˆ©ç¡®è®¤**ï¼šåº•ä»“æµ®ç›ˆ â‰¥ 1.5% 
2. **è¶‹åŠ¿å»¶ç»­**ï¼š
   - 15mè¶‹åŠ¿ä»ä¸ºåŸæ–¹å‘ï¼ˆæœªè½¬å¼±ï¼‰
   - 4Hè¶‹åŠ¿æœªåè½¬
   - MACD histogramä¿æŒåŒå‘
3. **æ—¶é—´çª—å£**ï¼šæŒä»“2-6å°æ—¶å†…ï¼ˆè¶‹åŠ¿ä¸­æœŸï¼‰
4. **æ— é£é™©ä¿¡å·**ï¼šæœªè§¦åŠé˜»åŠ›ä½ã€æ— trend_exhaustion

**æ‰§è¡ŒåŠ¨ä½œ**ï¼š
```python
# åŠ ä»“30%
pyramid_position = base_position * 0.3
new_entry_price = current_price  # åŠ ä»“ä»·æ ¼

# ã€å…³é”®ã€‘ç§»åŠ¨æ­¢æŸåˆ°ç›ˆäºå¹³è¡¡ç‚¹ï¼ˆBreak-evenï¼‰
average_entry = (initial_entry * 0.3 + new_entry_price * 0.3) / 0.6
stop_loss = average_entry  # æˆ–ç•¥é«˜äºå¹³å‡æˆæœ¬ï¼ˆå¦‚+0.2%ï¼‰
```

**ä¼˜åŠ¿**ï¼š
- ğŸ¯ **é”å®šåˆ©æ¶¦**ï¼šæ­¢æŸç§»è‡³æˆæœ¬ï¼Œåº•ä»“åˆ©æ¶¦å·²é”å®š
- ğŸ¯ **é£é™©é™ä½**ï¼šå³ä½¿åè½¬ï¼Œæœ€å¤šç›ˆäºå¹³è¡¡
- ğŸ¯ **ä»“ä½ä¼˜åŒ–**ï¼šåœ¨è¶‹åŠ¿ç¡®è®¤åæ‰åŠ é‡ä»“ä½

---

#### é˜¶æ®µ3ï¼šæ½œåœ¨ç¬¬ä¸‰æ¬¡åŠ ä»“ï¼ˆ+20%ï¼Œå¯é€‰ï¼‰

**è§¦å‘æ¡ä»¶**ï¼ˆæ›´ä¸¥æ ¼ï¼‰ï¼š
1. å‰ä¸¤æ‰¹ä»“ä½æµ®ç›ˆ â‰¥ 3%
2. è¶‹åŠ¿å¼ºåŠ²ï¼ˆ4Hå¼ºåŠ¿å¤šå¤´/ç©ºå¤´ï¼‰
3. Volume Surgeï¼ˆæç«¯æ”¾é‡ï¼‰
4. æŒä»“6-12å°æ—¶å†…

**æ‰§è¡ŒåŠ¨ä½œ**ï¼š
```python
# ç¬¬ä¸‰æ‰¹åŠ ä»“20%
final_position = base_position * 0.2

# ç§»åŠ¨æ­¢æŸåˆ°é¦–æ‰¹åŠ ä»“æˆæœ¬
stop_loss = second_entry_price  # ä¿æŠ¤ç¬¬äºŒæ‰¹åˆ©æ¶¦
```

---

### å®æ–½æ–¹æ¡ˆ

#### æ•°æ®ç»“æ„è°ƒæ•´

**æŒä»“è®°å½•éœ€å¢åŠ å­—æ®µ**ï¼š
```python
position = {
    'entry_price': 90000,
    'quantity': 0.01,
    
    # ğŸ†• V8.6: Pyramidingå­—æ®µ
    'pyramid_stage': 1,  # 1=åº•ä»“, 2=é¦–æ¬¡åŠ ä»“, 3=äºŒæ¬¡åŠ ä»“
    'pyramid_entries': [
        {'stage': 1, 'price': 90000, 'quantity': 0.003, 'time': '...'},
        {'stage': 2, 'price': 91500, 'quantity': 0.003, 'time': '...'},
    ],
    'average_entry_price': 90750,  # åŠ æƒå¹³å‡
    'break_even_price': 90750,     # ç›ˆäºå¹³è¡¡ç‚¹
    'pyramid_enabled': True,       # æ˜¯å¦å¯ç”¨åŠ ä»“
}
```

---

#### æ ¸å¿ƒå‡½æ•°

**1. æ£€æŸ¥åŠ ä»“æ¡ä»¶**
```python
def check_pyramid_conditions(position, market_data, config):
    """
    æ£€æŸ¥æ˜¯å¦æ»¡è¶³åŠ ä»“æ¡ä»¶
    
    Returns:
        (can_pyramid: bool, reason: str, suggested_size: float)
    """
    # å½“å‰é˜¶æ®µ
    current_stage = position.get('pyramid_stage', 1)
    if current_stage >= 3:
        return False, "å·²è¾¾æœ€å¤§åŠ ä»“æ¬¡æ•°", 0
    
    # æµ®ç›ˆæ£€æŸ¥
    unrealized_pnl_pct = position.get('unrealized_pnl_pct', 0)
    min_profit = 1.5 if current_stage == 1 else 3.0
    if unrealized_pnl_pct < min_profit:
        return False, f"æµ®ç›ˆ{unrealized_pnl_pct:.2f}%æœªè¾¾{min_profit}%", 0
    
    # è¶‹åŠ¿å»¶ç»­æ£€æŸ¥
    side = position['side']
    trend_15m = market_data.get('trend_15m', '')
    trend_4h = market_data.get('trend_4h', '')
    
    if side == 'long':
        if 'ç©ºå¤´' in trend_15m or 'ç©ºå¤´' in trend_4h:
            return False, "è¶‹åŠ¿åè½¬ï¼Œä¸åŠ ä»“", 0
    else:
        if 'å¤šå¤´' in trend_15m or 'å¤šå¤´' in trend_4h:
            return False, "è¶‹åŠ¿åè½¬ï¼Œä¸åŠ ä»“", 0
    
    # æ—¶é—´çª—å£æ£€æŸ¥
    holding_minutes = (datetime.now() - position['entry_time']).total_seconds() / 60
    if current_stage == 1:
        if not (120 <= holding_minutes <= 360):  # 2-6å°æ—¶
            return False, f"æŒä»“{holding_minutes:.0f}minä¸åœ¨åŠ ä»“çª—å£(2-6h)", 0
    else:
        if not (360 <= holding_minutes <= 720):  # 6-12å°æ—¶
            return False, f"æŒä»“{holding_minutes:.0f}minä¸åœ¨ç¬¬äºŒæ¬¡åŠ ä»“çª—å£(6-12h)", 0
    
    # é£é™©ä¿¡å·æ£€æŸ¥
    if market_data.get('price_action', {}).get('trend_exhaustion'):
        return False, "æ£€æµ‹åˆ°è¶‹åŠ¿è¡°ç«­ä¿¡å·", 0
    
    # è®¡ç®—å»ºè®®åŠ ä»“å¤§å°
    if current_stage == 1:
        suggested_ratio = 0.3  # ç¬¬äºŒæ‰¹30%
    else:
        suggested_ratio = 0.2  # ç¬¬ä¸‰æ‰¹20%
    
    base_position = position.get('planned_position', 0) / 0.3  # åæ¨åŸºç¡€ä»“ä½
    suggested_size = base_position * suggested_ratio
    
    return True, f"æ»¡è¶³ç¬¬{current_stage+1}æ‰¹åŠ ä»“æ¡ä»¶", suggested_size
```

---

**2. æ‰§è¡ŒåŠ ä»“å¹¶ç§»åŠ¨æ­¢æŸ**
```python
def execute_pyramid_and_adjust_sl(position, pyramid_size, current_price, atr):
    """
    æ‰§è¡ŒåŠ ä»“å¹¶è°ƒæ•´æ­¢æŸåˆ°ç›ˆäºå¹³è¡¡ç‚¹
    """
    # è®°å½•æ–°æ‰¹æ¬¡
    new_entry = {
        'stage': position['pyramid_stage'] + 1,
        'price': current_price,
        'quantity': pyramid_size / current_price,
        'time': datetime.now().isoformat()
    }
    position['pyramid_entries'].append(new_entry)
    
    # æ›´æ–°æ€»ä»“ä½
    position['quantity'] += new_entry['quantity']
    position['pyramid_stage'] += 1
    
    # è®¡ç®—åŠ æƒå¹³å‡æˆæœ¬
    total_cost = sum(e['price'] * e['quantity'] for e in position['pyramid_entries'])
    total_qty = sum(e['quantity'] for e in position['pyramid_entries'])
    position['average_entry_price'] = total_cost / total_qty
    
    # ğŸ”‘ ç§»åŠ¨æ­¢æŸåˆ°ç›ˆäºå¹³è¡¡ç‚¹ï¼ˆBreak-evenï¼‰
    # å¯ä»¥ç•¥é«˜äºæˆæœ¬ï¼Œé¢„ç•™æ‰‹ç»­è´¹ç©ºé—´
    position['break_even_price'] = position['average_entry_price'] * 1.002  # +0.2%ç¼“å†²
    
    # æ›´æ–°æ­¢æŸ
    old_stop_loss = position['stop_loss']
    new_stop_loss = position['break_even_price']
    
    if position['side'] == 'long':
        position['stop_loss'] = max(new_stop_loss, old_stop_loss)  # åªèƒ½å‘ä¸Šç§»åŠ¨
    else:
        position['stop_loss'] = min(new_stop_loss, old_stop_loss)  # åªèƒ½å‘ä¸‹ç§»åŠ¨
    
    print(f"  ğŸ”º æ‰§è¡Œç¬¬{new_entry['stage']}æ‰¹åŠ ä»“:")
    print(f"     åŠ ä»“ä»·: {current_price:.2f}, æ•°é‡: {new_entry['quantity']:.6f}")
    print(f"     å¹³å‡æˆæœ¬: {position['average_entry_price']:.2f}")
    print(f"     æ­¢æŸç§»åŠ¨: {old_stop_loss:.2f} â†’ {position['stop_loss']:.2f} (Break-even)")
    
    return position
```

---

### Pyramidingç­–ç•¥ä¼˜åŠ¿

| æ–¹é¢ | ä¼ ç»Ÿå…¨ä»“ | PyramidingåŠ ä»“ |
|------|---------|---------------|
| **é£é™©** | é«˜ï¼ˆä¸€æ¬¡æ€§å…¨ä»“ï¼‰ | ä½ï¼ˆåˆ†æ‰¹è¯•æ¢ï¼‰ |
| **ç›ˆäºæ¯”** | å›ºå®š | åŠ¨æ€ä¼˜åŒ–ï¼ˆè¶‹åŠ¿ç¡®è®¤ååŠ é‡ï¼‰ |
| **å¿ƒç†å‹åŠ›** | å¤§ï¼ˆå…¨éƒ¨èµ„é‡‘å—æŸï¼‰ | å°ï¼ˆåº•ä»“ä¿æŠ¤ï¼‰ |
| **æ­¢æŸä¿æŠ¤** | å›ºå®šè·ç¦» | åŠ¨æ€ä¸Šç§»ï¼ˆBreak-evenï¼‰ |
| **è¶‹åŠ¿é€‚åº”** | è¢«åŠ¨ | ä¸»åŠ¨ï¼ˆé¡ºåŠ¿åŠ ä»“ï¼‰ |

---

### é£é™©æ§åˆ¶

**ç¦æ­¢è¡Œä¸º**ï¼š
1. âŒ **æ°¸è¿œä¸åœ¨äºæŸæ—¶åŠ ä»“**ï¼ˆé¿å…æ‘Šå¹³æˆæœ¬é™·é˜±ï¼‰
2. âŒ ä¸åœ¨è¶‹åŠ¿è¡°ç«­æ—¶åŠ ä»“
3. âŒ ä¸åœ¨ä¸´è¿‘é˜»åŠ›ä½æ—¶åŠ ä»“
4. âŒ ä¸åœ¨Volume Surgeåæ€¥é€Ÿå›è°ƒæ—¶åŠ ä»“

**ä¿æŠ¤æœºåˆ¶**ï¼š
1. âœ… æ¯æ¬¡åŠ ä»“åç«‹å³ç§»åŠ¨æ­¢æŸåˆ°ç›ˆäºå¹³è¡¡ç‚¹
2. âœ… æœ€å¤š3æ‰¹æ¬¡ï¼ˆ30%+30%+20%ï¼‰
3. âœ… ä¸¥æ ¼çš„æ—¶é—´çª—å£é™åˆ¶
4. âœ… å¤šé‡è¶‹åŠ¿ç¡®è®¤

---

## å»ºè®®2ï¼šåˆ†æ‰¹æ­¢ç›ˆç­–ç•¥

### å½“å‰ç³»ç»Ÿç°çŠ¶

**å·²æœ‰åŠŸèƒ½**ï¼š
- âœ… `trailing_stop_enabled`å‚æ•°
- âœ… `partial_take_profit`å‚æ•°
- âœ… åˆ†æ‰¹æ­¢ç›ˆè®°å½•æ”¯æŒï¼ˆ`åˆ†æ‰¹æ­¢ç›ˆè¯´æ˜.md`ï¼‰

**å½“å‰å®ç°**ï¼š
```python
# é…ç½®ä¸­æœ‰å‚æ•°
"partial_take_profit": True
"trailing_stop_trigger": 1.5  # ç›ˆåˆ©1.5%å¯åŠ¨

# ä½†å…·ä½“æ‰§è¡Œé€»è¾‘ä¸å¤Ÿæ˜ç¡®
```

**é—®é¢˜**ï¼š
- â“ æ²¡æœ‰æ˜ç¡®çš„"ç¬¬ä¸€ç›®æ ‡ä½å¹³50%"é€»è¾‘
- â“ Trailing Stopçš„è§¦å‘å’Œæ‰§è¡Œä¸å¤Ÿæ¸…æ™°
- â“ æ­¢ç›ˆæ‰¹æ¬¡å’Œæ¯”ä¾‹ä¸å¤Ÿçµæ´»

---

### å»ºè®®ç­–ç•¥ï¼šä¸¤é˜¶æ®µæ­¢ç›ˆ

#### é˜¶æ®µ1ï¼šç¬¬ä¸€ç›®æ ‡ä½ï¼ˆTP1ï¼‰- å¹³50%

**ç›®æ ‡ä»·è®¡ç®—**ï¼š
```python
# Scalping: 1.5-2x ATR
tp1 = entry_price + atr * 1.5

# Swing: 3-4x ATR
tp1 = entry_price + atr * 3.0

# æˆ–ä½¿ç”¨ç›ˆäºæ¯”
tp1 = entry_price + (entry_price - stop_loss) * 1.5  # 1.5R
```

**æ‰§è¡Œé€»è¾‘**ï¼š
```python
if current_price >= tp1:
    # å¹³ä»“50%
    close_quantity = position['quantity'] * 0.5
    execute_partial_close(position, close_quantity, tp1, "TP1-50%")
    
    # ğŸ”‘ ç§»åŠ¨æ­¢æŸåˆ°ç›ˆäºå¹³è¡¡ç‚¹
    position['stop_loss'] = position['entry_price'] * 1.002  # Break-even + ç¼“å†²
    
    print(f"  âœ… TP1è§¦å‘: å¹³ä»“50% @ {tp1:.2f}")
    print(f"  ğŸ›¡ï¸ æ­¢æŸç§»è‡³ç›ˆäºå¹³è¡¡ç‚¹: {position['stop_loss']:.2f}")
```

**ä¼˜åŠ¿**ï¼š
- ğŸ¯ **é”å®šåˆ©æ¶¦**ï¼š50%ä»“ä½å·²è·åˆ©é€€å‡º
- ğŸ¯ **é£é™©æ¶ˆé™¤**ï¼šæ­¢æŸç§»è‡³æˆæœ¬ï¼Œå‰©ä½™50%æ— é£é™©
- ğŸ¯ **å¿ƒç†ä¼˜åŠ¿**ï¼šå·²è·åˆ©ï¼Œå‰©ä½™ä»“ä½å¯ä»¥æ”¾å¿ƒæŒæœ‰

---

#### é˜¶æ®µ2ï¼šå‰©ä½™50% - Trailing Stop

**å¯åŠ¨æ¡ä»¶**ï¼š
- TP1å·²è§¦å‘ï¼ˆ50%å·²å¹³ä»“ï¼‰
- æ­¢æŸå·²ç§»è‡³ç›ˆäºå¹³è¡¡ç‚¹

**Trailing Stopé€»è¾‘**ï¼š
```python
# åŠ¨æ€è¿½è¸ªæœ€é«˜ç‚¹
if current_price > position['highest_price']:
    position['highest_price'] = current_price
    
    # è®¡ç®—Trailing Stopï¼ˆä»æœ€é«˜ç‚¹å›æ’¤ï¼‰
    trailing_distance = atr * 1.5  # Scalping: 1.5x ATR
    # trailing_distance = atr * 2.5  # Swing: 2.5x ATR
    
    new_stop = position['highest_price'] - trailing_distance
    
    # åªèƒ½å‘ä¸Šç§»åŠ¨ï¼ˆLongï¼‰
    if new_stop > position['stop_loss']:
        position['stop_loss'] = new_stop
        print(f"  ğŸ“ˆ Trailing Stopä¸Šç§»: {new_stop:.2f} (è·æœ€é«˜ç‚¹{trailing_distance:.2f})")
```

**é€€å‡ºè§¦å‘**ï¼š
```python
# è§¦å‘Trailing Stop
if current_price <= position['stop_loss']:
    # å¹³ä»“å‰©ä½™50%
    close_quantity = position['quantity']  # å‰©ä½™å…¨éƒ¨
    execute_partial_close(position, close_quantity, current_price, "Trailing-Stop-50%")
    
    print(f"  ğŸ Trailing Stopè§¦å‘: å¹³ä»“å‰©ä½™50% @ {current_price:.2f}")
    print(f"  ğŸ“Š æ€»åˆ©æ¶¦: TP1éƒ¨åˆ† + Trailingéƒ¨åˆ†")
```

---

### ä¸¤é˜¶æ®µæ­¢ç›ˆå®Œæ•´ç¤ºä¾‹

**åœºæ™¯**ï¼šBTCå¤šå•
```
å¼€ä»“: $90,000, ä»“ä½0.01 BTC, ATR=$500
æ­¢æŸ: $89,000 (SL)
TP1: $91,500 (ç¬¬ä¸€ç›®æ ‡ä½ï¼Œ1.5R)
```

**æ‰§è¡Œæµç¨‹**ï¼š

1. **ä»·æ ¼åˆ°è¾¾$91,500ï¼ˆTP1ï¼‰**
   ```
   åŠ¨ä½œ: å¹³ä»“50% (0.005 BTC) @ $91,500
   åˆ©æ¶¦: 0.005 Ã— ($91,500 - $90,000) = $7.5
   æ­¢æŸ: $89,000 â†’ $90,180 (Break-even + 0.2%)
   å‰©ä½™: 0.005 BTC, æ— é£é™©çŠ¶æ€
   ```

2. **ä»·æ ¼ç»§ç»­ä¸Šæ¶¨è‡³$93,000**
   ```
   æœ€é«˜ç‚¹: $93,000
   Trailing Stop: $93,000 - ($500 Ã— 1.5) = $92,250
   æ­¢æŸä¸Šç§»: $90,180 â†’ $92,250
   ```

3. **ä»·æ ¼å›è½è‡³$92,250**
   ```
   åŠ¨ä½œ: Trailing Stopè§¦å‘ï¼Œå¹³ä»“å‰©ä½™50% (0.005 BTC) @ $92,250
   åˆ©æ¶¦: 0.005 Ã— ($92,250 - $90,000) = $11.25
   æ€»åˆ©æ¶¦: $7.5 + $11.25 = $18.75
   ```

**ç»“æœå¯¹æ¯”**ï¼š

| ç­–ç•¥ | TPè§¦å‘ä»· | æ€»åˆ©æ¶¦ | é£é™©æš´éœ² |
|------|---------|-------|---------|
| **ä¼ ç»Ÿæ­¢ç›ˆ**ï¼ˆTP=$91,500ï¼‰ | $91,500 | $15.00 | å…¨ç¨‹æœ‰é£é™© |
| **åˆ†æ‰¹æ­¢ç›ˆ+Trailing** | $91,500 / $92,250 | $18.75 | TP1åæ— é£é™© |
| **æå‡** | - | **+25%** | **é£é™©é™ä½50%** |

---

### å®æ–½æ–¹æ¡ˆ

#### é…ç½®å‚æ•°

```python
"scalping_params": {
    # åˆ†æ‰¹æ­¢ç›ˆé…ç½®
    "partial_tp_enabled": True,
    "tp1_atr_multiplier": 1.5,      # TP1 = entry + 1.5Ã—ATR
    "tp1_close_pct": 50,            # TP1å¹³ä»“50%
    
    # Trailing Stopé…ç½®
    "trailing_stop_enabled": True,
    "trailing_start_after_tp1": True,  # TP1è§¦å‘åæ‰å¯åŠ¨
    "trailing_distance_atr": 1.5,      # è·æœ€é«˜ç‚¹1.5Ã—ATR
    
    # Break-evené…ç½®
    "move_sl_to_breakeven": True,      # TP1åç§»è‡³æˆæœ¬
    "breakeven_buffer_pct": 0.2,       # æˆæœ¬ä¸Šæ–¹0.2%
},

"swing_params": {
    # åˆ†æ‰¹æ­¢ç›ˆé…ç½®
    "partial_tp_enabled": True,
    "tp1_atr_multiplier": 3.0,      # TP1 = entry + 3Ã—ATR
    "tp1_close_pct": 50,            # TP1å¹³ä»“50%
    
    # Trailing Stopé…ç½®
    "trailing_stop_enabled": True,
    "trailing_start_after_tp1": True,
    "trailing_distance_atr": 2.5,      # è·æœ€é«˜ç‚¹2.5Ã—ATR
    
    # Break-evené…ç½®
    "move_sl_to_breakeven": True,
    "breakeven_buffer_pct": 0.3,       # æˆæœ¬ä¸Šæ–¹0.3%
}
```

---

#### æ ¸å¿ƒå‡½æ•°

**1. æ£€æŸ¥TP1è§¦å‘**
```python
def check_tp1_trigger(position, current_price, config):
    """
    æ£€æŸ¥ç¬¬ä¸€ç›®æ ‡ä½æ˜¯å¦è§¦å‘
    """
    if position.get('tp1_triggered'):
        return False, "TP1å·²è§¦å‘"
    
    tp1_price = position.get('tp1_price')
    if not tp1_price:
        return False, "TP1æœªè®¾ç½®"
    
    side = position['side']
    
    if side == 'long':
        if current_price >= tp1_price:
            return True, "TP1è§¦å‘ï¼ˆå¤šå¤´ï¼‰"
    else:
        if current_price <= tp1_price:
            return True, "TP1è§¦å‘ï¼ˆç©ºå¤´ï¼‰"
    
    return False, "æœªè¾¾TP1"
```

---

**2. æ‰§è¡ŒTP1åˆ†æ‰¹æ­¢ç›ˆ**
```python
def execute_tp1_partial_close(position, current_price, config):
    """
    æ‰§è¡ŒTP1åˆ†æ‰¹æ­¢ç›ˆï¼šå¹³50% + ç§»åŠ¨æ­¢æŸåˆ°Break-even
    """
    tp1_close_pct = config.get('tp1_close_pct', 50) / 100
    close_quantity = position['quantity'] * tp1_close_pct
    
    # æ‰§è¡Œå¹³ä»“
    pnl = (current_price - position['entry_price']) * close_quantity
    if position['side'] == 'short':
        pnl = (position['entry_price'] - current_price) * close_quantity
    
    # è®°å½•å¹³ä»“
    save_partial_close(position, close_quantity, current_price, pnl, "TP1-50%")
    
    # æ›´æ–°ä»“ä½
    position['quantity'] -= close_quantity
    position['tp1_triggered'] = True
    position['tp1_close_time'] = datetime.now()
    position['tp1_pnl'] = pnl
    
    # ğŸ”‘ ç§»åŠ¨æ­¢æŸåˆ°Break-even
    breakeven_buffer = config.get('breakeven_buffer_pct', 0.2) / 100
    if position['side'] == 'long':
        position['stop_loss'] = position['entry_price'] * (1 + breakeven_buffer)
    else:
        position['stop_loss'] = position['entry_price'] * (1 - breakeven_buffer)
    
    print(f"  âœ… TP1è§¦å‘ @ {current_price:.2f}")
    print(f"     å¹³ä»“: {tp1_close_pct*100:.0f}% ({close_quantity:.6f})")
    print(f"     åˆ©æ¶¦: ${pnl:.2f}")
    print(f"     æ­¢æŸç§»è‡³: {position['stop_loss']:.2f} (Break-even)")
    
    return position
```

---

**3. Trailing Stopæ›´æ–°**
```python
def update_trailing_stop(position, current_price, atr, config):
    """
    æ›´æ–°Trailing Stopï¼ˆä»…åœ¨TP1è§¦å‘åï¼‰
    """
    if not position.get('tp1_triggered'):
        return position  # TP1æœªè§¦å‘ï¼Œä¸å¯åŠ¨Trailing
    
    side = position['side']
    
    # æ›´æ–°æœ€é«˜ç‚¹/æœ€ä½ç‚¹
    if side == 'long':
        if current_price > position.get('highest_price_after_tp1', position['entry_price']):
            position['highest_price_after_tp1'] = current_price
            
            # è®¡ç®—æ–°çš„Trailing Stop
            trailing_distance = atr * config.get('trailing_distance_atr', 1.5)
            new_stop = current_price - trailing_distance
            
            # åªèƒ½å‘ä¸Šç§»åŠ¨
            if new_stop > position['stop_loss']:
                old_stop = position['stop_loss']
                position['stop_loss'] = new_stop
                print(f"  ğŸ“ˆ Trailing Stopä¸Šç§»: {old_stop:.2f} â†’ {new_stop:.2f}")
    
    else:  # short
        if current_price < position.get('lowest_price_after_tp1', position['entry_price']):
            position['lowest_price_after_tp1'] = current_price
            
            trailing_distance = atr * config.get('trailing_distance_atr', 1.5)
            new_stop = current_price + trailing_distance
            
            # åªèƒ½å‘ä¸‹ç§»åŠ¨
            if new_stop < position['stop_loss']:
                old_stop = position['stop_loss']
                position['stop_loss'] = new_stop
                print(f"  ğŸ“‰ Trailing Stopä¸‹ç§»: {old_stop:.2f} â†’ {new_stop:.2f}")
    
    return position
```

---

### åˆ†æ‰¹æ­¢ç›ˆç­–ç•¥ä¼˜åŠ¿

| æ–¹é¢ | ä¼ ç»Ÿå…¨ä»“æ­¢ç›ˆ | åˆ†æ‰¹æ­¢ç›ˆ + Trailing |
|------|-------------|-------------------|
| **åˆ©æ¶¦é”å®š** | å…¨æœ‰æˆ–å…¨æ—  | 50%å·²é”å®š |
| **é£é™©æš´éœ²** | å…¨ç¨‹æœ‰é£é™© | TP1åæ— é£é™© |
| **å¿ƒç†è´Ÿæ‹…** | å¤§ï¼ˆæ€•å›åï¼‰ | å°ï¼ˆå·²è·åˆ©ï¼‰ |
| **è¶‹åŠ¿æ•æ‰** | å›ºå®šç›®æ ‡ | åŠ¨æ€è¿½è¸ªï¼ˆè®©åˆ©æ¶¦å¥”è·‘ï¼‰ |
| **å¹³å‡åˆ©æ¶¦** | å›ºå®šR | 1.5R - 3Rï¼ˆåŠ¨æ€ä¼˜åŒ–ï¼‰ |

---

## ç»¼åˆå®æ–½å»ºè®®

### Phase 1ï¼šåˆ†æ‰¹æ­¢ç›ˆï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**åŸå› **ï¼š
- âœ… åŸºç¡€è®¾æ–½å·²å°±ç»ªï¼ˆtrailing_stopå‚æ•°å­˜åœ¨ï¼‰
- âœ… é£é™©ä½ï¼ˆåªå½±å“å¹³ä»“é€»è¾‘ï¼‰
- âœ… æ”¶ç›Šæ˜æ˜¾ï¼ˆåˆ©æ¶¦æå‡20-30%ï¼‰

**å®æ–½æ­¥éª¤**ï¼š
1. ä¿®æ”¹`calculate_unified_risk_reward_v2()`ï¼Œå¢åŠ TP1è®¡ç®—
2. å®ç°`check_tp1_trigger()`å’Œ`execute_tp1_partial_close()`
3. å®ç°`update_trailing_stop()`
4. åœ¨ä¸»å¾ªç¯ä¸­é›†æˆæ£€æŸ¥é€»è¾‘
5. å›æµ‹éªŒè¯ï¼ˆå¯¹æ¯”ä¼ ç»Ÿæ­¢ç›ˆvsåˆ†æ‰¹æ­¢ç›ˆï¼‰

---

### Phase 2ï¼šPyramidingåŠ ä»“ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

**åŸå› **ï¼š
- âš ï¸ éœ€è¦æŒä»“æ•°æ®ç»“æ„è°ƒæ•´
- âš ï¸ éœ€è¦æ–°å¢åŠ ä»“å†³ç­–é€»è¾‘
- âš ï¸ å¤æ‚åº¦è¾ƒé«˜ï¼ˆå¤šæ‰¹æ¬¡ç®¡ç†ï¼‰
- âœ… æ”¶ç›Šæ½œåŠ›å¤§ï¼ˆåœ¨å¼ºè¶‹åŠ¿ä¸­å€å¢åˆ©æ¶¦ï¼‰

**å®æ–½æ­¥éª¤**ï¼š
1. è°ƒæ•´æŒä»“æ•°æ®ç»“æ„ï¼ˆå¢åŠ pyramid_*å­—æ®µï¼‰
2. å®ç°åˆå§‹30%åº•ä»“é€»è¾‘
3. å®ç°`check_pyramid_conditions()`
4. å®ç°`execute_pyramid_and_adjust_sl()`
5. åœ¨æŒä»“ç›‘æ§å¾ªç¯ä¸­é›†æˆ
6. å°è§„æ¨¡æµ‹è¯•ï¼ˆä»…1-2ä¸ªå¸ç§ï¼‰
7. å›æµ‹éªŒè¯å¹¶å‚æ•°ä¼˜åŒ–

---

### é…ç½®æ–‡ä»¶è°ƒæ•´

**æ–°å¢é…ç½®æ®µ**ï¼š
```json
{
  "global": {
    "scalping_params": {
      // ... ç°æœ‰å‚æ•° ...
      
      // ğŸ†• V8.6: PyramidingåŠ ä»“
      "pyramiding_enabled": false,  // åˆæœŸç¦ç”¨ï¼Œå¾…æµ‹è¯•
      "pyramid_initial_pct": 30,    // åº•ä»“30%
      "pyramid_stage2_pct": 30,     // ç¬¬äºŒæ‰¹30%
      "pyramid_stage2_min_profit": 1.5,  // æµ®ç›ˆ1.5%æ‰åŠ ä»“
      "pyramid_stage3_pct": 20,     // ç¬¬ä¸‰æ‰¹20%ï¼ˆå¯é€‰ï¼‰
      "pyramid_stage3_min_profit": 3.0,
      
      // ğŸ†• V8.6: åˆ†æ‰¹æ­¢ç›ˆ
      "partial_tp_enabled": true,   // å¯ç”¨
      "tp1_atr_multiplier": 1.5,
      "tp1_close_pct": 50,
      "move_sl_to_breakeven": true,
      "breakeven_buffer_pct": 0.2,
      
      // ğŸ†• V8.6: Trailing Stop
      "trailing_stop_enabled": true,
      "trailing_start_after_tp1": true,
      "trailing_distance_atr": 1.5
    },
    
    "swing_params": {
      // ... ç±»ä¼¼è°ƒæ•´ ...
    }
  }
}
```

---

## é£é™©æç¤º

### Pyramidingé£é™©

1. **è¿‡åº¦åŠ ä»“**ï¼šè®¾ç½®æœ€å¤§æ‰¹æ¬¡é™åˆ¶ï¼ˆ3æ‰¹æ¬¡ï¼‰
2. **è¶‹åŠ¿è¯¯åˆ¤**ï¼šä¸¥æ ¼çš„è¶‹åŠ¿ç¡®è®¤æ¡ä»¶
3. **æˆæœ¬æ‹‰é«˜**ï¼šåŠ ä»“åå¹³å‡æˆæœ¬ä¸Šå‡ï¼Œéœ€è¦æ›´å¤§æ¶¨å¹…æ‰ç›ˆåˆ©
4. **æ»‘ç‚¹æˆæœ¬**ï¼šå¤šæ¬¡åŠ ä»“å¢åŠ äº¤æ˜“æˆæœ¬

---

### åˆ†æ‰¹æ­¢ç›ˆé£é™©

1. **è¿‡æ—©æ­¢ç›ˆ**ï¼šTP1è®¾ç½®è¿‡è¿‘ï¼Œé”™è¿‡å¤§è¡Œæƒ…
2. **Trailingè¿‡ç´§**ï¼šè·ç¦»è¿‡å°ï¼Œé¢‘ç¹è§¦å‘
3. **æ‰‹ç»­è´¹å¢åŠ **ï¼šåˆ†æ‰¹å¹³ä»“äº§ç”Ÿå¤šæ¬¡æ‰‹ç»­è´¹
4. **å¤æ‚åº¦æå‡**ï¼šéœ€è¦ç²¾ç¡®ç®¡ç†å¤šä¸ªå¹³ä»“è®¢å•

---

## å›æµ‹éªŒè¯æŒ‡æ ‡

### å¯¹æ¯”æµ‹è¯•ç»„

| ç»„åˆ« | é…ç½® |
|------|------|
| **å¯¹ç…§ç»„** | ä¼ ç»Ÿç­–ç•¥ï¼ˆå…¨ä»“å¼€ä»“+å›ºå®šæ­¢ç›ˆï¼‰ |
| **æµ‹è¯•ç»„A** | ä»…å¯ç”¨åˆ†æ‰¹æ­¢ç›ˆ |
| **æµ‹è¯•ç»„B** | ä»…å¯ç”¨Pyramiding |
| **æµ‹è¯•ç»„C** | åŒæ—¶å¯ç”¨ä¸¤è€… |

---

### å…³é”®æŒ‡æ ‡

1. **å¹³å‡ç›ˆäºæ¯”**
   - ç›®æ ‡ï¼šä»2.5æå‡è‡³3.5+
   
2. **æœ€å¤§å›æ’¤**
   - ç›®æ ‡ï¼šé™ä½20-30%ï¼ˆå› ä¸ºæœ‰Break-evenä¿æŠ¤ï¼‰

3. **èƒœç‡å˜åŒ–**
   - é¢„æœŸï¼šç•¥æœ‰ä¸‹é™ï¼ˆTP1æå‰å¹³ä»“ï¼‰
   - ä½†æ€»åˆ©æ¶¦åº”æå‡

4. **å•ç¬”å¹³å‡åˆ©æ¶¦**
   - ç›®æ ‡ï¼šæå‡30-50%ï¼ˆTrailingæ•æ‰æ›´å¤šåˆ©æ¶¦ï¼‰

5. **"è®©åˆ©æ¶¦å¥”è·‘"æ¡ˆä¾‹**
   - ç»Ÿè®¡ï¼šTP1åå‰©ä½™50%çš„å¹³å‡åˆ©æ¶¦
   - ç›®æ ‡ï¼šæ˜¾è‘—è¶…è¿‡TP1æ”¶ç›Š

---

## æ€»ç»“

### å»ºè®®ä»·å€¼è¯„ä¼°

| å»ºè®® | ä»·å€¼ | å¤æ‚åº¦ | ä¼˜å…ˆçº§ | é¢„æœŸæ”¶ç›Š |
|------|------|--------|--------|---------|
| **åˆ†æ‰¹æ­¢ç›ˆ** | â­â­â­â­â­ | â­â­ | é«˜ | +20-30%åˆ©æ¶¦ |
| **Pyramiding** | â­â­â­â­ | â­â­â­â­ | ä¸­ | +30-50%åˆ©æ¶¦ï¼ˆå¼ºè¶‹åŠ¿ï¼‰ |

---

### å®æ–½å»ºè®®

**ç«‹å³å®æ–½**ï¼š
1. âœ… åˆ†æ‰¹æ­¢ç›ˆï¼ˆTP1 50% + Trailing Stop 50%ï¼‰
   - åŸºç¡€è®¾æ–½å°±ç»ª
   - é£é™©å¯æ§
   - æ”¶ç›Šæ˜ç¡®

**é€æ­¥æµ‹è¯•**ï¼š
2. ğŸ”„ PyramidingåŠ ä»“ï¼ˆåº•ä»“30% â†’ åŠ ä»“30%ï¼‰
   - å…ˆåœ¨1-2ä¸ªå¸ç§æµ‹è¯•
   - è§‚å¯Ÿ3-6ä¸ªæœˆæ•°æ®
   - ç¡®è®¤æœ‰æ•ˆåå…¨é¢æ¨å¹¿

---

**æœ€åæ›´æ–°**ï¼š2025-01-22  
**çŠ¶æ€**ï¼šå»ºè®®åˆ†æå®Œæˆï¼Œå¾…å®æ–½å†³ç­–


