========================================================================
📦 V8.3.14.4.2 - _simulate_trade_with_params函数签名修复
========================================================================

🔍 问题诊断：
   ❌ TypeError: _simulate_trade_with_params() got an unexpected keyword argument 'signal_type'
   ❌ V8.3.12.1分离策略优化失败

🎯 修复内容：
   1. 添加缺失的函数参数：signal_type 和 market_data
   2. 实现V8.3.8波段SR优先逻辑
   3. 确保波段回测与实际交易逻辑一致

📊 技术细节：
   ✅ 函数签名扩展：
      - signal_type: 信号类型 'scalping' 或 'swing'
      - market_data: 市场数据（用于获取SR级别）
   
   ✅ 波段TP/SL优先级（V8.3.8逻辑）：
      多单：
      - 止损 = 最近支撑位 × 0.995（下方0.5%）
      - 止盈 = 最近阻力位 × 0.995（下方0.5%保守）
      
      空单：
      - 止损 = 最近阻力位 × 1.005（上方0.5%）
      - 止盈 = 最近支撑位 × 1.005（上方0.5%保守）
      
      Fallback: 如果SR不可用，使用ATR计算

========================================================================
🚀 立即部署步骤
========================================================================

第一步：上传文件到服务器
--------------------------------------------------
cd ~/10-23-bot/ds
rz  # 上传 deepseek_多币种智能版.py 和 qwen_多币种智能版.py

第二步：验证文件完整性
--------------------------------------------------
# 检查函数签名是否包含新参数
grep -A 3 "def _simulate_trade_with_params(" deepseek_多币种智能版.py | head -8
# 预期输出应包含：signal_type=None, market_data=None

# 检查SR优先逻辑是否存在
grep "【V8.3.8】波段交易优先使用SR级别" deepseek_多币种智能版.py
# 预期：找到该注释

# 同样检查qwen文件
grep -A 3 "def _simulate_trade_with_params(" qwen_多币种智能版.py | head -8
grep "【V8.3.8】波段交易优先使用SR级别" qwen_多币种智能版.py

第三步：停止现有进程
--------------------------------------------------
screen -ls | grep -E "ai-deepseek|ai-qwen" | awk '{print $1}' | xargs -I {} screen -S {} -X quit

第四步：启动服务（使用快速重启脚本）
--------------------------------------------------
bash 快速重启_修复版.sh restart-all

第五步：验证服务状态
--------------------------------------------------
# 查看进程是否正常运行
screen -ls

# 检查日志（等待1-2分钟后）
tail -50 logs/deepseek_trading.log
tail -50 logs/qwen_trading.log

# 关键验证点：
# ✅ "⚡ 优化超短线参数..." 出现
# ✅ "🔍 阶段2: Exit Analysis" 出现
# ❌ 没有 "TypeError: unexpected keyword argument" 错误

========================================================================
🔬 测试验证（可选）
========================================================================

# 手动触发回测以验证分离策略优化
bash 快速重启_修复版.sh backtest

# 预期结果：
# ✅ "【第4.6步：分离策略优化（V8.3.12）】" 成功执行
# ✅ "⚡ 优化超短线参数..." 完成
# ✅ "🌊 优化波段参数..." 完成
# ❌ 没有 "TypeError" 或 "_simulate_trade_with_params() got an unexpected" 错误

========================================================================
📊 关键文件变化
========================================================================

修改文件：
  ✅ deepseek_多币种智能版.py (Line ~17113-17190)
  ✅ qwen_多币种智能版.py (Line ~17113-17190)

Git提交：
  Commit: 2bb91e1
  Message: 🔧 V8.3.14.4.2 修复_simulate_trade_with_params函数签名

========================================================================
⚠️ 注意事项
========================================================================

1. 此修复是V8.3.12分离策略优化的必要前提
2. 修复后波段交易回测将更准确（使用SR级别而非单纯ATR）
3. 如果市场数据中没有SR级别，会自动fallback到ATR计算
4. 此修复同时影响deepseek和qwen两个模型

========================================================================
🔗 相关版本
========================================================================

依赖版本：
  ✅ V8.3.12 - 分离策略优化（需要此修复）
  ✅ V8.3.8 - 波段SR优先逻辑（此次重新实现）

后续版本：
  📌 V8.3.14.4.1 - 盈利扩大硬约束
  📌 V8.3.14.4 - 硬约束优化与OOM修复

========================================================================

