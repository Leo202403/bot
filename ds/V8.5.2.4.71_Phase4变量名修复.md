# V8.5.2.4.71 - Phase 4变量名修复

## 版本信息
- **版本号**: V8.5.2.4.71
- **日期**: 2025-11-19
- **类型**: Bug修复（关键）

---

## 问题描述

### V8.5.2.4.70回测结果

**✅ Phase 3首次成功！**
- 超短线: 捕获25.0%, 利润6.92% ✅
- 波段: 捕获100.0%, 利润5.85% ✅

**❌ Phase 4失败：变量名错误**
```
⚠️  Phase 4执行失败: name 'config' is not defined
NameError: name 'config' is not defined

File "/root/10-23-bot/ds/deepseek_多币种智能版.py", line 8026
    config['scalping_params'] = {
    ^^^^^^
```

---

## 根本原因

### V8.5.2.4.69的回退逻辑

在V8.5.2.4.69中添加了Phase 4回退逻辑，但**使用了错误的变量名**！

```python
# ❌ 错误：使用了不存在的config变量
config['scalping_params'] = {
    'atr_tp_multiplier': scalping_tp_sl.get('tp', ...),
    ...
}
```

**问题**：在`quick_global_search_v8316`函数中，变量名应该是`current_config`，而不是`config`！

---

## 修复方案

**文件**: `deepseek_多币种智能版.py`, `qwen_多币种智能版.py`

**位置**: deepseek第8026-8076行, qwen第8031-8081行

### 修复内容

将所有`config`改为`current_config`（共6处）：

```python
# 修改前
config['scalping_params'] = {  # ❌ 第8026行
config['swing_params'] = {     # ❌ 第8039行
print(f"TP={config['scalping_params']...")  # ❌ 第8052行
print(f"TP={config['swing_params']...")     # ❌ 第8053行
config['scalping_params'] = {  # ❌ 第8057行（保守默认值）
config['swing_params'] = {     # ❌ 第8067行（保守默认值）

# 修改后
current_config['scalping_params'] = {  # ✅
current_config['swing_params'] = {     # ✅
print(f"TP={current_config['scalping_params']...")  # ✅
print(f"TP={current_config['swing_params']...")     # ✅
current_config['scalping_params'] = {  # ✅
current_config['swing_params'] = {     # ✅
```

---

## 影响范围

### 受影响文件
- `deepseek_多币种智能版.py`（6处）✅
- `qwen_多币种智能版.py`（6处）✅

### 修复位置详情

#### deepseek文件
1. 第8026行：`current_config['scalping_params'] = {`
2. 第8039行：`current_config['swing_params'] = {`
3. 第8052行：打印超短线参数
4. 第8053行：打印波段参数
5. 第8057行：保守默认值（超短线）
6. 第8067行：保守默认值（波段）

#### qwen文件
1. 第8031行：`current_config['scalping_params'] = {`
2. 第8044行：`current_config['swing_params'] = {`
3. 第8057行：打印超短线参数
4. 第8058行：打印波段参数
5. 第8062行：保守默认值（超短线）
6. 第8072行：保守默认值（波段）

---

## 预期效果

### V8.5.2.4.70回测结果（已验证）

| 阶段 | 结果 | 数据 |
|------|------|------|
| **Phase 1** | ✅ 成功 | 4000个机会，利润16.18% |
| **Phase 2** | ✅ 成功 | 捕获62.4%，利润6.46% |
| **Phase 3** | ✅ **首次成功** | 超短线6.92%, 波段5.85% |
| **Phase 4** | ❌ 失败 | NameError: 'config' |

### V8.5.2.4.71预期结果

| 阶段 | 预期 | 说明 |
|------|------|------|
| **Phase 1** | ✅ 4000个机会 | 利润16% |
| **Phase 2** | ✅ 捕获62% | 利润6.46% |
| **Phase 3** | ✅ 成功 | 超短线6.92%, 波段5.85% |
| **Phase 4** | ✅ 验证通过/回退 | 回退参数正确显示 ✅ |

**预期Phase 4回退输出**：
```
📊 【Phase 4回退】已应用Phase 2参数:
   ⚡ 超短线: TP=19.4, SL=1.5, 持仓3.6h ✅
   🌊 波段: TP=22.2, SL=2.5, 持仓17.0h ✅
```

---

## 重大突破回顾

### V8.5.2.4.70的成就

虽然Phase 4有变量名Bug，但**Phase 3取得历史性突破**：

| 指标 | V8.5.2.4.69 | V8.5.2.4.70 | 提升 |
|------|-------------|-------------|------|
| **Phase 3超短线** | KeyError | **6.92%** | ✅ 首次成功 |
| **Phase 3波段** | KeyError | **5.85%** | ✅ 首次成功 |
| **调试日志** | 正常 | 正常 | ✅ 完善 |

**重要发现**：
1. ✅ 字段名修复（`profit_pct` → `actual_profit_pct`）完全生效
2. ✅ Phase 3不再出现负利润
3. ✅ 调试日志显示真实退出方式（`take_profit_amplitude`）

---

## 历史版本关系

```
V8.5.2.4.68: Phase 3固定TP/SL，优化筛选（负利润）
    ↓
V8.5.2.4.69: Phase 3利润计算修复 + Phase 4回退修复
    ├─ ✅ Phase 2: 6.40%利润
    ├─ ❌ Phase 3: KeyError 'profit_pct'
    └─ ❌ Phase 4: 回退逻辑不完整
        ↓
V8.5.2.4.70: Phase 3字段名修复
    ├─ ✅ Phase 2: 6.46%利润
    ├─ ✅ Phase 3: 6.92%/5.85%利润（首次成功！）
    └─ ❌ Phase 4: NameError 'config'
        ↓
V8.5.2.4.71: Phase 4变量名修复（本版本）
    └─ 🎯 预期：Phase 4正确回退，参数显示正常
```

---

## 修复清单

### V8.5.2.4.69修复的3个Bug ✅
1. ✅ Phase 3利润计算（使用真实数据）
2. ✅ Phase 2 baseline参数不完整
3. ✅ Phase 4回退未执行（但有变量名错误）

### V8.5.2.4.70修复的1个Bug ✅
4. ✅ Phase 3字段名错误

### V8.5.2.4.71修复的1个Bug（本版本）
5. ✅ Phase 4变量名错误（`config` → `current_config`）

---

## 总结

V8.5.2.4.71修复了V8.5.2.4.69遗留的变量名Bug，**仅需修改6处代码**：

```python
# deepseek_多币种智能版.py, qwen_多币种智能版.py
config → current_config  # 6处
```

**修改文件**：
- `deepseek_多币种智能版.py`（6处）
- `qwen_多币种智能版.py`（6处）

**下一步**：服务器回测验证V8.5.2.4.71

**预期效果**：
- Phase 3：超短线6.92%, 波段5.85% ✅
- Phase 4：验证失败时，正确回退并显示参数 ✅

---

## 附：V8.5.2.4.70回测关键数据

```
Phase 2成功：
  捕获率: 62.4% (1748个)
  平均利润: 6.46% ✅
  调试日志正常：
    - LTC: 9.36% → 9.22% ✅
    - SOL: 9.86% → 9.72% ✅

Phase 3首次成功：
  超短线: 捕获25.0%, 利润6.92% ✅
  波段: 捕获100.0%, 利润5.85% ✅

Phase 4失败：
  ⚠️  Phase 4执行失败: name 'config' is not defined ❌
```

**重要成就**：V8.5.2.4.70让Phase 3首次成功执行并产生正利润，标志着整个优化流程的完整性迈出了关键一步！

