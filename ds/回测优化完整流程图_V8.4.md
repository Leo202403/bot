# å›æµ‹ä¼˜åŒ–å®Œæ•´æµç¨‹å›¾ V8.4

## ğŸ“‹ ç›®å½•

1. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
2. [æ•°æ®å‡†å¤‡é˜¶æ®µ](#æ•°æ®å‡†å¤‡é˜¶æ®µ)
3. [æœºä¼šåˆ†æé˜¶æ®µ](#æœºä¼šåˆ†æé˜¶æ®µ)
4. [å‚æ•°ä¼˜åŒ–é˜¶æ®µ](#å‚æ•°ä¼˜åŒ–é˜¶æ®µ)
5. [ç»“æœåº”ç”¨é˜¶æ®µ](#ç»“æœåº”ç”¨é˜¶æ®µ)
6. [å…³é”®æ•°æ®ç»“æ„](#å…³é”®æ•°æ®ç»“æ„)
7. [å¸¸è§é—®é¢˜è¯Šæ–­](#å¸¸è§é—®é¢˜è¯Šæ–­)

---

## æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å›æµ‹ä¼˜åŒ–ç³»ç»Ÿ                          â”‚
â”‚                     (qwen/deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   ã€é˜¶æ®µ1ã€‘æ•°æ®å‡†å¤‡                      â”‚
        â”‚   - è¯»å–å†å²å¸‚åœºå¿«ç…§ (14å¤©)              â”‚
        â”‚   - åˆå¹¶æ‰€æœ‰å¸ç§æ•°æ®                     â”‚
        â”‚   è¾“å‡º: 9177æ¡å¸‚åœºå¿«ç…§è®°å½•               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   ã€é˜¶æ®µ2ã€‘æœºä¼šåˆ†æ                      â”‚
        â”‚   - éå†æ¯ä¸ªå¿«ç…§ç‚¹                       â”‚
        â”‚   - åˆ¤æ–­æ˜¯å¦æœ‰äº¤æ˜“ä¿¡å·                   â”‚
        â”‚   - æ¨¡æ‹Ÿæœªæ¥ä»·æ ¼èµ°åŠ¿                     â”‚
        â”‚   - è®¡ç®—ç†è®ºåˆ©æ¶¦ & å®é™…åˆ©æ¶¦              â”‚
        â”‚   è¾“å‡º: 3364ä¸ªäº¤æ˜“æœºä¼š                   â”‚
        â”‚         (è¶…çŸ­çº¿1364 + æ³¢æ®µ2000)          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   ã€é˜¶æ®µ3ã€‘å‚æ•°ä¼˜åŒ–                      â”‚
        â”‚   - V8.3.21å¢å¼ºä¼˜åŒ–å™¨                    â”‚
        â”‚   - æµ‹è¯•200ç»„å‚æ•°ç»„åˆ                    â”‚
        â”‚   - è¯„åˆ†å¹¶æ’åº                           â”‚
        â”‚   è¾“å‡º: æœ€ä¼˜å‚æ•°é…ç½®                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   ã€é˜¶æ®µ4ã€‘ç»“æœéªŒè¯                      â”‚
        â”‚   - ç”¨æœ€ä¼˜å‚æ•°é‡æ–°è®¡ç®—å®é™…åˆ©æ¶¦           â”‚
        â”‚   - å¯¹æ¯”ä¼˜åŒ–å‰åçš„æ•ˆæœ                   â”‚
        â”‚   è¾“å‡º: å‰åå¯¹æ¯”æŠ¥å‘Š                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   ã€é˜¶æ®µ5ã€‘åº”ç”¨æ–°å‚æ•°                    â”‚
        â”‚   - ä¿å­˜åˆ°learning_config.json           â”‚
        â”‚   - ä¸‹æ¬¡å®ç›˜äº¤æ˜“ä½¿ç”¨æ–°å‚æ•°               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•°æ®å‡†å¤‡é˜¶æ®µ

### **å…¥å£å‡½æ•°**ï¼š
`qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py` çš„ `æ‰‹åŠ¨å›æµ‹æ¨¡å¼`ï¼ˆçº¦ç¬¬19800è¡Œï¼‰

### **æ­¥éª¤1: è¯»å–å†å²å¸‚åœºå¿«ç…§**

**ä»£ç ä½ç½®**ï¼šçº¦ç¬¬19900-20000è¡Œ

```python
# è¯»å–è¿‡å»14å¤©çš„å¸‚åœºå¿«ç…§
for i in range(14):
    date_str = (datetime.now() - timedelta(days=i)).strftime('%Y%m%d')
    snapshot_file = f'market_snapshots/market_snapshot_{date_str}.csv'
    df = pd.read_csv(snapshot_file)
    all_snapshots.append(df)

# åˆå¹¶æ‰€æœ‰å¿«ç…§
combined_df = pd.concat(all_snapshots)
```

**è¾“å‡ºæ•°æ®**ï¼š
- `combined_df`ï¼šDataFrameï¼ŒåŒ…å«9177æ¡è®°å½•ï¼ˆ7ä¸ªå¸ç§ Ã— 14å¤© Ã— 96ä¸ª15åˆ†é’ŸKçº¿ï¼‰

**å…³é”®å­—æ®µ**ï¼š
```python
{
    'symbol': 'BTC/USDT:USDT',
    'timestamp': '2025-11-13 12:00:00',
    'close': 90500.0,
    'high': 90800.0,
    'low': 90200.0,
    'atr': 805.1,
    'signal_score': 72,           # ä¿¡å·è´¨é‡è¯„åˆ†ï¼ˆ0-100ï¼‰
    'consensus': 3,               # æ—§ç‰ˆå…±è¯†ï¼ˆ0-5ï¼‰
    'consensus_score': 45,        # ã€V8.4æ–°å¢ã€‘ç»¼åˆç¡®è®¤åº¦ï¼ˆ0-100ï¼‰
    'risk_reward': 2.5,           # ç†è®ºé£é™©æ”¶ç›Šæ¯”
    'trend_15m': 'å¤šå¤´',
    'trend_1h': 'å¤šå¤´',
    'trend_4h': 'å¤šå¤´',
    'support': 89800.0,
    'resistance': 91500.0,
    ...
}
```

---

## æœºä¼šåˆ†æé˜¶æ®µ

### **å…¥å£å‡½æ•°**ï¼š
`analyze_separated_opportunities()` ï¼ˆçº¦ç¬¬18500è¡Œï¼‰

### **æ­¥éª¤2: éå†å¿«ç…§ï¼Œè¯†åˆ«äº¤æ˜“æœºä¼š**

**ä»£ç ä½ç½®**ï¼šçº¦ç¬¬18500-18800è¡Œ

```python
def analyze_separated_opportunities(snapshots, symbols, signal_type='both'):
    """
    åˆ†æå†å²å¿«ç…§ï¼Œè¯†åˆ«äº¤æ˜“æœºä¼š
    
    Args:
        snapshots: DataFrameï¼Œ9177æ¡å¸‚åœºå¿«ç…§
        symbols: å¸ç§åˆ—è¡¨ï¼Œ['BTC/USDT:USDT', 'ETH/USDT:USDT', ...]
        signal_type: 'scalping' | 'swing' | 'both'
    
    Returns:
        {
            'scalping': {'opportunities': [...]},
            'swing': {'opportunities': [...]}
        }
    """
    
    opportunities = []
    
    # éå†æ¯ä¸ªå¿«ç…§ç‚¹
    for idx, snapshot in snapshots.iterrows():
        # 1. åˆ¤æ–­æ˜¯å¦æœ‰äº¤æ˜“ä¿¡å·
        has_signal = check_signal(snapshot)
        if not has_signal:
            continue
        
        # 2. æå–æœªæ¥ä»·æ ¼æ•°æ®ï¼ˆç”¨äºæ¨¡æ‹Ÿäº¤æ˜“ï¼‰
        future_data = extract_future_prices(snapshots, idx, max_hours=72)
        
        # 3. è®¡ç®—ç†è®ºåˆ©æ¶¦ï¼ˆobjective_profitï¼‰
        objective_profit = calculate_objective_profit(
            entry_price=snapshot['close'],
            direction='long' if snapshot['trend_1h'] == 'å¤šå¤´' else 'short',
            support=snapshot['support'],
            resistance=snapshot['resistance']
        )
        
        # 4. åˆ›å»ºæœºä¼šè®°å½•
        opp = {
            'coin': 'BTC',
            'timestamp': snapshot['timestamp'],
            'entry_price': snapshot['close'],
            'direction': 'long',
            'atr': snapshot['atr'],
            'signal_score': snapshot['signal_score'],
            'consensus': snapshot['consensus'],
            'consensus_score': snapshot['consensus_score'],  # ã€V8.4ã€‘
            'risk_reward': snapshot['risk_reward'],
            'objective_profit': objective_profit,  # ç†è®ºæœ€å¤§åˆ©æ¶¦
            'future_data': future_data,  # æœªæ¥72å°æ—¶çš„ä»·æ ¼æ•°æ®
            'signal_type': 'swing'
        }
        
        opportunities.append(opp)
    
    return {'swing': {'opportunities': opportunities}}
```

**å…³é”®é€»è¾‘**ï¼š

1. **åˆ¤æ–­ä¿¡å·**ï¼šæ£€æŸ¥`signal_score`ã€`consensus`ã€è¶‹åŠ¿å¯¹é½ç­‰æ¡ä»¶
2. **æå–æœªæ¥æ•°æ®**ï¼šä»å½“å‰æ—¶é—´ç‚¹å¾€åå–72å°æ—¶çš„ä»·æ ¼æ•°æ®
3. **è®¡ç®—ç†è®ºåˆ©æ¶¦**ï¼šåŸºäºæ”¯æ’‘/é˜»åŠ›ä½è®¡ç®—æœ€å¤§å¯èƒ½åˆ©æ¶¦

**è¾“å‡ºæ•°æ®**ï¼š
```python
{
    'scalping': {
        'opportunities': [
            {
                'coin': 'BTC',
                'timestamp': '2025-11-13 12:00:00',
                'entry_price': 90500.0,
                'direction': 'long',
                'atr': 805.1,
                'signal_score': 72,
                'consensus': 3,
                'consensus_score': 45,
                'risk_reward': 2.5,
                'objective_profit': 3.2,  # ç†è®ºåˆ©æ¶¦3.2%
                'future_data': {
                    'max_high': 91800.0,  # æœªæ¥72hæœ€é«˜ä»·
                    'min_low': 89500.0,   # æœªæ¥72hæœ€ä½ä»·
                    'final_close': 91200.0
                }
            },
            ...  # å…±1364ä¸ªè¶…çŸ­çº¿æœºä¼š
        ]
    },
    'swing': {
        'opportunities': [...]  # å…±2000ä¸ªæ³¢æ®µæœºä¼š
    }
}
```

---

### **æ­¥éª¤3: è®¡ç®—å®é™…åˆ©æ¶¦ï¼ˆactual_profit_pctï¼‰**

**ä»£ç ä½ç½®**ï¼š`calculate_actual_profit.py`ï¼ˆç¬¬153-170è¡Œï¼‰

**å‡½æ•°**ï¼š`calculate_actual_profit_batch()`

```python
def calculate_actual_profit_batch(opportunities, strategy_params, batch_size=100):
    """
    ã€V8.4.2å…³é”®ä¿®å¤ã€‘æ‰¹é‡è®¡ç®—å®é™…åˆ©æ¶¦
    
    Args:
        opportunities: æœºä¼šåˆ—è¡¨ï¼ˆä»é˜¶æ®µ2è¾“å‡ºï¼‰
        strategy_params: ç­–ç•¥å‚æ•° {
            'atr_stop_multiplier': 1.5,   # æ­¢æŸå€æ•°
            'atr_tp_multiplier': 3.0,     # æ­¢ç›ˆå€æ•°
            'max_holding_hours': 72       # æœ€å¤§æŒä»“æ—¶é—´
        }
    
    Returns:
        opportunitiesï¼ˆå·²æ·»åŠ actual_profit_pctå­—æ®µï¼‰
    """
    
    for opp in opportunities:
        # æ¨¡æ‹Ÿäº¤æ˜“æ‰§è¡Œ
        result = simulate_trade_execution(
            entry_price=opp['entry_price'],
            direction=opp['direction'],
            atr=opp['atr'],
            future_data=opp['future_data'],
            atr_stop_multiplier=strategy_params['atr_stop_multiplier'],  # ã€å…³é”®ã€‘ä½¿ç”¨å½“å‰å‚æ•°
            atr_tp_multiplier=strategy_params['atr_tp_multiplier'],      # ã€å…³é”®ã€‘ä½¿ç”¨å½“å‰å‚æ•°
            max_holding_hours=strategy_params['max_holding_hours']
        )
        
        # æ·»åŠ å®é™…åˆ©æ¶¦å­—æ®µ
        opp['actual_profit_pct'] = result['profit_pct']  # å®é™…åˆ©æ¶¦ï¼ˆæ‰£é™¤æ‰‹ç»­è´¹å’Œæ»‘ç‚¹ï¼‰
        opp['actual_risk_reward'] = result['actual_rr']  # å®é™…é£é™©æ”¶ç›Šæ¯”
        opp['exit_reason'] = result['exit_reason']       # 'tp', 'sl', 'time_exit'
    
    return opportunities
```

**å…³é”®ç‚¹**ï¼š

1. **åŠ¨æ€è®¡ç®—**ï¼š`actual_profit_pct`æ ¹æ®**å½“å‰æµ‹è¯•çš„ATRå€æ•°**åŠ¨æ€è®¡ç®—
2. **æ‰‹ç»­è´¹æ‰£é™¤**ï¼šå¼€ä»“+å¹³ä»“æ‰‹ç»­è´¹ = 0.2%
3. **æ»‘ç‚¹æ‰£é™¤**ï¼šæ»‘ç‚¹ = 0.05%
4. **é€€å‡ºç±»å‹**ï¼š
   - `tp`ï¼šè§¦å‘æ­¢ç›ˆ
   - `sl`ï¼šè§¦å‘æ­¢æŸ
   - `time_exit`ï¼šè¶…æ—¶å¹³ä»“ï¼ˆæœªè§¦å‘TP/SLï¼‰

**ç¤ºä¾‹**ï¼š

å‡è®¾ç­–ç•¥å‚æ•°ï¼š
```python
{
    'atr_stop_multiplier': 1.5,   # æ­¢æŸ = entry_price Â± 1.5Ã—ATR
    'atr_tp_multiplier': 3.0,     # æ­¢ç›ˆ = entry_price Â± 3.0Ã—ATR
}
```

å¯¹äºä¸€ä¸ªå¤šå¤´æœºä¼šï¼š
```python
entry_price = 90500
atr = 805.1
stop_loss = 90500 - 1.5 Ã— 805.1 = 89292  # æ­¢æŸä»·
take_profit = 90500 + 3.0 Ã— 805.1 = 92915  # æ­¢ç›ˆä»·

# æ¨¡æ‹Ÿæœªæ¥ä»·æ ¼èµ°åŠ¿
future_data = {
    'max_high': 91800,  # æœ€é«˜åˆ°91800ï¼Œæœªè§¦å‘TPï¼ˆ92915ï¼‰
    'min_low': 89500,   # æœ€ä½åˆ°89500ï¼Œæœªè§¦å‘SLï¼ˆ89292ï¼‰
    'final_close': 91200
}

# ç»“æœï¼štime_exitï¼ˆè¶…æ—¶å¹³ä»“ï¼‰
actual_profit_pct = (91200 - 90500) / 90500 - 0.002 - 0.0005 = 0.52%
exit_reason = 'time_exit'
```

**è¾“å‡ºæ•°æ®**ï¼š
```python
opportunities = [
    {
        'coin': 'BTC',
        'entry_price': 90500.0,
        'objective_profit': 3.2,      # ç†è®ºåˆ©æ¶¦
        'actual_profit_pct': 0.52,    # ã€æ–°å¢ã€‘å®é™…åˆ©æ¶¦ï¼ˆåŸºäºå½“å‰å‚æ•°ï¼‰
        'actual_risk_reward': 1.3,    # ã€æ–°å¢ã€‘å®é™…é£é™©æ”¶ç›Šæ¯”
        'exit_reason': 'time_exit',   # ã€æ–°å¢ã€‘é€€å‡ºåŸå› 
        ...
    },
    ...
]
```

**æ—¥å¿—è¾“å‡º**ï¼š
```bash
ğŸ“Š è¶…çŸ­çº¿å¯¹æ¯”:
   ç†è®ºåˆ©æ¶¦: 11.80%  â† æ‰€æœ‰æœºä¼šçš„objective_profitå¹³å‡å€¼
   å®é™…åˆ©æ¶¦: 0.56%   â† æ‰€æœ‰æœºä¼šçš„actual_profit_pctå¹³å‡å€¼
   å·®è·: 11.24%      â† ç†è®ºä¸å®é™…çš„å·®è·ï¼ˆä¸»è¦æ˜¯time_exitå¯¼è‡´ï¼‰
```

---

## å‚æ•°ä¼˜åŒ–é˜¶æ®µ

### **å…¥å£å‡½æ•°**ï¼š
`optimize_params_v8321_lightweight()` ï¼ˆ`backtest_optimizer_v8321.py`ï¼Œç¬¬506è¡Œï¼‰

### **æ­¥éª¤4: V8.3.21å¢å¼ºä¼˜åŒ–å™¨**

**ä»£ç ä½ç½®**ï¼š`backtest_optimizer_v8321.py`ï¼ˆç¬¬506-750è¡Œï¼‰

```python
def optimize_params_v8321_lightweight(
    opportunities,        # ä»é˜¶æ®µ2è¾“å‡ºçš„3364ä¸ªæœºä¼š
    current_params,       # å½“å‰å‚æ•°ï¼ˆbaselineï¼‰
    signal_type='swing',  # 'scalping' æˆ– 'swing'
    max_combinations=200  # æµ‹è¯•200ç»„å‚æ•°
):
    """
    ã€V8.3.21ã€‘è½»é‡çº§å‚æ•°ä¼˜åŒ–å™¨
    
    æµç¨‹ï¼š
    1. å®šä¹‰æœç´¢ç©ºé—´ï¼ˆGridï¼‰
    2. éšæœºé‡‡æ ·200ç»„å‚æ•°
    3. è¯„åˆ†å¹¶æ’åº
    4. è¿”å›æœ€ä¼˜é…ç½®
    """
    
    # ===== é˜¶æ®µ1: å®šä¹‰æœç´¢ç©ºé—´ =====
    grid = define_param_grid_v8321(signal_type)
    
    # grid = {
    #     'max_holding_hours': [48, 60, 72],
    #     'atr_tp_multiplier': [2.0, 3.0, 4.0],
    #     'atr_stop_multiplier': [1.5, 2.0],
    #     'min_risk_reward': [1.0, 1.5, 2.0],  # ã€V8.4.3ã€‘é™ä½èŒƒå›´
    #     'min_signal_score': [40, 50, 60],    # ã€V8.4.3ã€‘é™ä½èŒƒå›´
    #     'min_consensus_score': [0, 10, 20, 30],  # ã€V8.4.3ã€‘é™ä½èŒƒå›´
    # }
    
    # ===== é˜¶æ®µ2: éšæœºé‡‡æ ·Grid Search =====
    tested_configs = []
    
    for i in range(200):
        # éšæœºé€‰æ‹©ä¸€ç»„å‚æ•°
        params = {
            'max_holding_hours': random.choice(grid['max_holding_hours']),
            'atr_tp_multiplier': random.choice(grid['atr_tp_multiplier']),
            'atr_stop_multiplier': random.choice(grid['atr_stop_multiplier']),
            'min_risk_reward': random.choice(grid['min_risk_reward']),
            'min_signal_score': random.choice(grid['min_signal_score']),
            'min_consensus_score': random.choice(grid['min_consensus_score']),
        }
        
        # æµ‹è¯•è¿™ç»„å‚æ•°
        result = test_params_on_opportunities(opportunities, params)
        
        # è¯„åˆ†
        score = calculate_v8321_optimization_score(result)
        
        tested_configs.append({
            'params': params,
            'score': score,
            'metrics': result
        })
    
    # ===== é˜¶æ®µ3: æ’åºå¹¶è¿”å›æœ€ä¼˜é…ç½® =====
    tested_configs.sort(key=lambda x: x['score'], reverse=True)
    
    best_config = tested_configs[0]
    
    return {
        'optimized_params': best_config['params'],
        'top_10_configs': tested_configs[:10],
        'statistics': {...},
        'context_analysis': {...}
    }
```

---

### **æ­¥éª¤4.1: æµ‹è¯•å•ç»„å‚æ•°**

**å‡½æ•°**ï¼š`test_params_on_opportunities()`ï¼ˆç¬¬600-650è¡Œï¼‰

```python
def test_params_on_opportunities(opportunities, params):
    """
    ç”¨æŒ‡å®šå‚æ•°æµ‹è¯•æ‰€æœ‰æœºä¼š
    
    Args:
        opportunities: 3364ä¸ªæœºä¼šï¼ˆåŒ…å«actual_profit_pctï¼‰
        params: {
            'min_signal_score': 50,
            'min_consensus_score': 20,
            'min_risk_reward': 1.5,
            ...
        }
    
    Returns:
        {
            'captured': [...],  # é€šè¿‡è¿‡æ»¤çš„æœºä¼šåˆ—è¡¨
            'filtered_out': [...],  # è¢«è¿‡æ»¤æ‰çš„æœºä¼š
            'capture_rate': 0.6,
            'avg_profit': 1.2,
            'win_rate': 0.75
        }
    """
    
    captured = []
    filtered_out = []
    
    for opp in opportunities:
        # ã€å…³é”®ã€‘è¿‡æ»¤é€»è¾‘
        if passes_basic_filter(opp, params):
            captured.append(opp)
        else:
            filtered_out.append(opp)
    
    # ç»Ÿè®¡æŒ‡æ ‡ï¼ˆåŸºäºactual_profit_pctï¼‰
    if len(captured) > 0:
        # åªç»Ÿè®¡è§¦å‘TP/SLçš„äº¤æ˜“ï¼Œæ’é™¤time_exit
        valid_trades = [o for o in captured if o.get('exit_reason') in ['tp', 'sl']]
        
        avg_profit = sum(o['actual_profit_pct'] for o in valid_trades) / len(valid_trades)
        win_rate = sum(1 for o in valid_trades if o['actual_profit_pct'] > 0) / len(valid_trades)
    else:
        avg_profit = 0
        win_rate = 0
    
    return {
        'captured': captured,
        'filtered_out': filtered_out,
        'capture_rate': len(captured) / len(opportunities),
        'avg_profit': avg_profit,
        'win_rate': win_rate
    }
```

---

### **æ­¥éª¤4.2: è¿‡æ»¤é€»è¾‘ï¼ˆæ ¸å¿ƒï¼‰**

**å‡½æ•°**ï¼š`passes_basic_filter()`ï¼ˆç¬¬477-503è¡Œï¼‰

```python
def passes_basic_filter(opp: Dict, params: Dict) -> bool:
    """
    ã€V8.4ã€‘åŸºç¡€å‚æ•°è¿‡æ»¤
    
    åˆ¤æ–­ä¸€ä¸ªæœºä¼šæ˜¯å¦æ»¡è¶³å‚æ•°è¦æ±‚
    """
    
    # ä¼˜å…ˆä½¿ç”¨actual_risk_reward
    rr_value = opp.get('actual_risk_reward', opp.get('risk_reward', 0))
    
    # ã€V8.4ã€‘ä¼˜å…ˆä½¿ç”¨æ–°çš„consensus_scoreï¼ˆ0-100åˆ†ï¼‰
    if 'consensus_score' in opp and 'min_consensus_score' in params:
        # æ–°ç‰ˆè¿‡æ»¤
        return (
            opp['signal_score'] >= params.get('min_signal_score', 40) and
            opp['consensus_score'] >= params.get('min_consensus_score', 0) and
            rr_value >= params.get('min_risk_reward', 1.0)
        )
    else:
        # ã€å…¼å®¹æ€§ã€‘å›é€€åˆ°æ—§ç‰ˆè¿‡æ»¤
        consensus_value = opp.get('consensus', 0)
        return (
            opp['signal_score'] >= params.get('min_signal_score', 40) and
            consensus_value >= params.get('min_consensus', 0) and
            rr_value >= params.get('min_risk_reward', 1.0)
        )
```

**å…³é”®ç‚¹**ï¼š

è¿™ä¸ªå‡½æ•°å†³å®šäº†**å“ªäº›æœºä¼šä¼šè¢«æ•è·**ï¼Œå“ªäº›ä¼šè¢«è¿‡æ»¤æ‰ã€‚

**ç¤ºä¾‹**ï¼š

å‡è®¾å‚æ•°ï¼š
```python
params = {
    'min_signal_score': 50,
    'min_consensus_score': 20,
    'min_risk_reward': 1.5
}
```

å¯¹äºä¸€ä¸ªæœºä¼šï¼š
```python
opp = {
    'signal_score': 60,       # âœ… >= 50
    'consensus_score': 25,    # âœ… >= 20
    'actual_risk_reward': 1.8 # âœ… >= 1.5
}
# ç»“æœï¼šé€šè¿‡è¿‡æ»¤ï¼Œè¢«æ•è·
```

ä½†å¦‚æœï¼š
```python
opp = {
    'signal_score': 45,       # âŒ < 50
    'consensus_score': 25,    # âœ… >= 20
    'actual_risk_reward': 1.8 # âœ… >= 1.5
}
# ç»“æœï¼šè¢«è¿‡æ»¤æ‰
```

**ã€V8.4.3ä¿®å¤å‰çš„é—®é¢˜ã€‘**ï¼š

å¦‚æœå‚æ•°æ˜¯ï¼š
```python
params = {
    'min_signal_score': 70,    # å¤ªé«˜
    'min_consensus_score': 50, # å¤ªé«˜
    'min_risk_reward': 2.5     # å¤ªé«˜
}
```

é‚£ä¹ˆ**æ‰€æœ‰æœºä¼šéƒ½ä¼šè¢«è¿‡æ»¤æ‰**ï¼Œå¯¼è‡´`captured = []`ï¼Œ`æ•è·ç‡ = 0%`ï¼

---

### **æ­¥éª¤4.3: è¯„åˆ†å‡½æ•°**

**å‡½æ•°**ï¼š`calculate_v8321_optimization_score()`ï¼ˆç¬¬838-867è¡Œï¼‰

```python
def calculate_v8321_optimization_score(result: Dict) -> float:
    """
    ã€V8.3.21.15ã€‘ä¼˜åŒ–å™¨è¯„åˆ†å‡½æ•°
    
    æ ¹æ®æµ‹è¯•ç»“æœè®¡ç®—å¾—åˆ†
    
    Args:
        result: {
            'captured': [...],
            'avg_profit': 1.2,
            'win_rate': 0.75,
            'capture_rate': 0.6,
            'expectancy': 0.8
        }
    
    Returns:
        score: 0.0 ~ 1.0+
    """
    
    captured = result.get('captured', [])
    
    if len(captured) == 0:
        return 0.0  # æ²¡æœ‰æ•è·ä»»ä½•æœºä¼šï¼Œå¾—åˆ†ä¸º0
    
    # åªç»Ÿè®¡è§¦å‘TP/SLçš„äº¤æ˜“
    valid_trades = [o for o in captured if o.get('exit_reason') in ['tp', 'sl']]
    
    if len(valid_trades) == 0:
        return 0.0
    
    # è®¡ç®—å¹³å‡åˆ©æ¶¦ï¼ˆåŸºäºactual_profit_pctï¼‰
    avg_profit = sum(o['actual_profit_pct'] for o in valid_trades) / len(valid_trades)
    
    # ã€V8.3.21.15ã€‘æ”¾å®½çº¦æŸï¼Œå…è®¸è´Ÿåˆ©æ¶¦ä¹Ÿæœ‰åŒºåˆ†åº¦
    if avg_profit <= 0:
        # è´Ÿåˆ©æ¶¦ç»™ä½åˆ†ï¼Œä½†ä¸æ˜¯0ï¼ˆè®©ä¼˜åŒ–å™¨èƒ½åŒºåˆ†"æ›´ä¸å·®"çš„é…ç½®ï¼‰
        return 0.01 + avg_profit * 0.01  # ä¾‹å¦‚ -0.5% â†’ 0.005åˆ†
    
    # è®¡ç®—èƒœç‡
    win_rate = sum(1 for o in valid_trades if o['actual_profit_pct'] > 0) / len(valid_trades)
    
    # è®¡ç®—æœŸæœ›å€¼
    expectancy = avg_profit * win_rate
    
    # ç»¼åˆå¾—åˆ†
    score = (
        avg_profit * 0.4 +       # å¹³å‡åˆ©æ¶¦æƒé‡40%
        expectancy * 0.3 +       # æœŸæœ›å€¼æƒé‡30%
        win_rate * 0.2 +         # èƒœç‡æƒé‡20%
        capture_rate * 0.1       # æ•è·ç‡æƒé‡10%
    )
    
    return score
```

**å…³é”®ç‚¹**ï¼š

1. **ä¼˜å…ˆä½¿ç”¨actual_profit_pct**ï¼ˆä¸æ˜¯objective_profitï¼‰
2. **åªç»Ÿè®¡TP/SLäº¤æ˜“**ï¼ˆæ’é™¤time_exitï¼‰
3. **è´Ÿåˆ©æ¶¦ä¹Ÿæœ‰åˆ†æ•°**ï¼ˆ0.01-0.05ï¼‰ï¼Œè®©ä¼˜åŒ–å™¨èƒ½åŒºåˆ†"æ›´ä¸å·®"çš„é…ç½®

**ç¤ºä¾‹**ï¼š

é…ç½®Aï¼š
```python
{
    'avg_profit': 1.2%,
    'win_rate': 75%,
    'expectancy': 0.9%,
    'capture_rate': 60%
}
score = 1.2 * 0.4 + 0.9 * 0.3 + 0.75 * 0.2 + 0.6 * 0.1 = 0.999
```

é…ç½®Bï¼š
```python
{
    'avg_profit': -0.5%,
    'win_rate': 40%,
    'expectancy': -0.2%,
    'capture_rate': 80%
}
score = 0.01 + (-0.5) * 0.01 = 0.005
```

**ç»“æœ**ï¼šé…ç½®Aå¾—åˆ†æ›´é«˜ï¼Œä¼šè¢«é€‰ä¸ºæœ€ä¼˜é…ç½®ã€‚

---

### **æ­¥éª¤4.4: è¿”å›æœ€ä¼˜é…ç½®**

**è¾“å‡ºæ•°æ®**ï¼š

```python
{
    'optimized_params': {
        'max_holding_hours': 60,
        'atr_tp_multiplier': 3.0,
        'atr_stop_multiplier': 1.5,
        'min_risk_reward': 1.5,
        'min_signal_score': 50,
        'min_consensus_score': 10
    },
    'top_10_configs': [
        {
            'params': {...},
            'score': 0.399,
            'metrics': {
                'capture_rate': 0.76,
                'avg_profit': 1.8,
                'win_rate': 1.0
            }
        },
        ...  # Top 10é…ç½®
    ],
    'statistics': {
        'param_sensitivity': {...}  # å‚æ•°æ•æ„Ÿåº¦åˆ†æ
    },
    'context_analysis': {
        'key_insights': [...]  # å…³é”®æ´å¯Ÿ
    }
}
```

**æ—¥å¿—è¾“å‡º**ï¼š
```bash
âœ… V8.3.21ä¼˜åŒ–å®Œæˆ
   æœ€ä¼˜åˆ†æ•°: 0.399      â† æœ€é«˜åˆ†ï¼ˆæœŸæœ›>0.3ï¼‰
   æ•è·ç‡: 76%          â† æ•è·ç‡ï¼ˆæœŸæœ›>50%ï¼‰
   å¹³å‡åˆ©æ¶¦: 1.8%       â† å¹³å‡åˆ©æ¶¦ï¼ˆæœŸæœ›>0ï¼‰
   èƒœç‡: 100%           â† èƒœç‡ï¼ˆæœŸæœ›>60%ï¼‰
```

---

## ç»“æœåº”ç”¨é˜¶æ®µ

### **æ­¥éª¤5: é‡æ–°è®¡ç®—å‰åå¯¹æ¯”**

**ä»£ç ä½ç½®**ï¼š`qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py`ï¼ˆç¬¬20700-20736è¡Œï¼‰

**ã€V8.4.2å…³é”®ä¿®å¤ã€‘**ï¼š

```python
# ã€V8.4.2ä¿®å¤ã€‘é‡æ–°è®¡ç®—actual_profitä»¥ç¡®ä¿ä¸å‚æ•°ä¸€è‡´
print(f"\n  ğŸ“Š è®¡ç®—å‰åå¯¹æ¯”ï¼ˆä½¿ç”¨çœŸå®åˆ©æ¶¦ï¼‰...")

# å¯¼å…¥å®é™…åˆ©æ¶¦è®¡ç®—æ¨¡å—
from calculate_actual_profit import calculate_actual_profit_batch

# ä¸ºbaselineé‡æ–°è®¡ç®—actual_profit
print(f"     è®¡ç®—baselineï¼ˆå½“å‰å‚æ•°ï¼‰...")
baseline_opps_copy = [opp.copy() for opp in opportunities]
baseline_opps_updated = calculate_actual_profit_batch(
    opportunities=baseline_opps_copy,
    strategy_params=current_params,  # ã€å…³é”®ã€‘ä½¿ç”¨å½“å‰å‚æ•°
    batch_size=100
)

# ä¸ºoptimizedé‡æ–°è®¡ç®—actual_profit
print(f"     è®¡ç®—optimizedï¼ˆæ–°å‚æ•°ï¼‰...")
optimized_opps_copy = [opp.copy() for opp in opportunities]
optimized_opps_updated = calculate_actual_profit_batch(
    opportunities=optimized_opps_copy,
    strategy_params=v8321_result['optimized_params'],  # ã€å…³é”®ã€‘ä½¿ç”¨æ–°å‚æ•°
    batch_size=100
)

# è®¡ç®—ç»Ÿè®¡æ•°æ®ï¼ˆåªç»Ÿè®¡è§¦å‘TP/SLçš„äº¤æ˜“ï¼‰
baseline_trades = [o for o in baseline_opps_updated 
                 if o.get('exit_reason') in ['tp', 'sl']]
optimized_trades = [o for o in optimized_opps_updated 
                  if o.get('exit_reason') in ['tp', 'sl']]

baseline_result = {
    'avg_profit': sum(o['actual_profit_pct'] for o in baseline_trades) / len(baseline_trades)
}

optimized_result = {
    'avg_profit': sum(o['actual_profit_pct'] for o in optimized_trades) / len(optimized_trades)
}

print(f"\nâœ… æ³¢æ®µä¼˜åŒ–å®Œæˆ:")
print(f"   å¹³å‡åˆ©æ¶¦: {baseline_result['avg_profit']:.1f}% â†’ {optimized_result['avg_profit']:.1f}%")
```

**å…³é”®ç‚¹**ï¼š

åœ¨V8.4.2ä¹‹å‰ï¼Œ`simulate_params_on_opportunities`ä½¿ç”¨çš„æ˜¯**é¢„å…ˆè®¡ç®—çš„`actual_profit_pct`**ï¼ˆåŸºäºå›ºå®šATRå€æ•°ï¼‰ï¼Œå¯¼è‡´ä¼˜åŒ–å™¨å†…éƒ¨æ‰¾åˆ°çš„é…ç½®æ— æ³•æ­£ç¡®åæ˜ åˆ°æœ€ç»ˆå¯¹æ¯”ä¸­ã€‚

V8.4.2ä¿®å¤åï¼Œ**é‡æ–°è®¡ç®—**`actual_profit_pct`ï¼Œç¡®ä¿ä½¿ç”¨å½“å‰æµ‹è¯•çš„ATRå€æ•°ã€‚

**æ—¥å¿—è¾“å‡º**ï¼š
```bash
ğŸ“Š è®¡ç®—å‰åå¯¹æ¯”ï¼ˆä½¿ç”¨çœŸå®åˆ©æ¶¦ï¼‰...
   è®¡ç®—baselineï¼ˆå½“å‰å‚æ•°ï¼‰...
   âœ… å®é™…åˆ©æ¶¦è®¡ç®—å®Œæˆ: 2000ä¸ªæœºä¼š

   è®¡ç®—optimizedï¼ˆæ–°å‚æ•°ï¼‰...
   âœ… å®é™…åˆ©æ¶¦è®¡ç®—å®Œæˆ: 2000ä¸ªæœºä¼š

âœ… æ³¢æ®µä¼˜åŒ–å®Œæˆ:
   å¹³å‡åˆ©æ¶¦: 0.5% â†’ 1.8% (+1.3%)  â† åº”è¯¥ä¸V8.3.21æŠ¥å‘Šçš„1.8%ä¸€è‡´
```

---

## å…³é”®æ•°æ®ç»“æ„

### **1. æœºä¼šï¼ˆOpportunityï¼‰**

```python
{
    # åŸºç¡€ä¿¡æ¯
    'coin': 'BTC',
    'timestamp': '2025-11-13 12:00:00',
    'entry_price': 90500.0,
    'direction': 'long',  # 'long' æˆ– 'short'
    'signal_type': 'swing',  # 'scalping' æˆ– 'swing'
    
    # æŠ€æœ¯æŒ‡æ ‡
    'atr': 805.1,
    'signal_score': 72,           # ä¿¡å·è´¨é‡ï¼ˆ0-100ï¼‰
    'consensus': 3,               # æ—§ç‰ˆå…±è¯†ï¼ˆ0-5ï¼‰
    'consensus_score': 45,        # ã€V8.4ã€‘æ–°ç‰ˆå…±è¯†ï¼ˆ0-100ï¼‰
    'risk_reward': 2.5,           # ç†è®ºé£é™©æ”¶ç›Šæ¯”
    
    # åˆ©æ¶¦æ•°æ®
    'objective_profit': 3.2,      # ç†è®ºæœ€å¤§åˆ©æ¶¦ï¼ˆåŸºäºS/Rï¼‰
    'actual_profit_pct': 0.52,    # ã€å…³é”®ã€‘å®é™…åˆ©æ¶¦ï¼ˆåŸºäºATRå€æ•°ï¼‰
    'actual_risk_reward': 1.3,    # å®é™…é£é™©æ”¶ç›Šæ¯”
    
    # é€€å‡ºä¿¡æ¯
    'exit_reason': 'time_exit',   # 'tp', 'sl', 'time_exit'
    
    # æœªæ¥æ•°æ®ï¼ˆç”¨äºæ¨¡æ‹Ÿï¼‰
    'future_data': {
        'max_high': 91800.0,
        'min_low': 89500.0,
        'final_close': 91200.0
    }
}
```

---

### **2. ç­–ç•¥å‚æ•°ï¼ˆStrategy Paramsï¼‰**

```python
{
    # æŒä»“æ—¶é—´
    'max_holding_hours': 72,  # æœ€å¤§æŒä»“æ—¶é—´ï¼ˆå°æ—¶ï¼‰
    
    # ATRå€æ•°
    'atr_stop_multiplier': 1.5,   # æ­¢æŸ = entry Â± 1.5Ã—ATR
    'atr_tp_multiplier': 3.0,     # æ­¢ç›ˆ = entry Â± 3.0Ã—ATR
    
    # è¿‡æ»¤æ¡ä»¶
    'min_risk_reward': 1.5,       # æœ€ä½é£é™©æ”¶ç›Šæ¯”
    'min_signal_score': 50,       # æœ€ä½ä¿¡å·åˆ†æ•°
    'min_consensus_score': 20,    # ã€V8.4ã€‘æœ€ä½å…±è¯†åˆ†æ•°ï¼ˆ0-100ï¼‰
    'min_consensus': 2,           # ã€å…¼å®¹æ€§ã€‘æ—§ç‰ˆå…±è¯†ï¼ˆ0-5ï¼‰
    
    # å…¶ä»–è¿‡æ»¤
    'min_kline_bullish_ratio': 0.6,
    'min_price_chg_pct': 1.0,
    'allowed_mkt_struct': 'all',
    'min_trend_age_hours': 1.0,
    'max_sr_test_count': 999
}
```

---

### **3. ä¼˜åŒ–ç»“æœï¼ˆOptimization Resultï¼‰**

```python
{
    # æœ€ä¼˜å‚æ•°
    'optimized_params': {
        'max_holding_hours': 60,
        'atr_tp_multiplier': 3.0,
        ...
    },
    
    # Top 10é…ç½®
    'top_10_configs': [
        {
            'params': {...},
            'score': 0.399,
            'metrics': {
                'capture_rate': 0.76,
                'avg_profit': 1.8,
                'win_rate': 1.0,
                'expectancy': 1.8
            }
        },
        ...
    ],
    
    # ç»Ÿè®¡åˆ†æ
    'statistics': {
        'param_sensitivity': {
            'min_risk_reward': {'importance': 'high', 'avg_impact': +0.05},
            'atr_tp_multiplier': {'importance': 'medium', 'avg_impact': +0.03},
            ...
        }
    },
    
    # ä¸Šä¸‹æ–‡åˆ†æ
    'context_analysis': {
        'key_insights': [
            'é™ä½min_signal_scoreå¯æ•è·æ›´å¤šæœºä¼š',
            'å½“å‰å¸‚åœºé€‚åˆæ¿€è¿›TPç­–ç•¥'
        ]
    }
}
```

---

## å¸¸è§é—®é¢˜è¯Šæ–­

### **é—®é¢˜1: æ•è·ç‡0%**

**ç—‡çŠ¶**ï¼š
```bash
âœ… Grid Searchå®Œæˆ
   æœ€é«˜åˆ†: 0.000
   æ•è·ç‡: 0%
```

**åŸå› **ï¼š
- æœç´¢ç©ºé—´çš„è¿‡æ»¤é˜ˆå€¼å¤ªé«˜
- `min_signal_score`ã€`min_consensus_score`ã€`min_risk_reward`è¿‡ä¸¥

**è¯Šæ–­æ­¥éª¤**ï¼š

1. æ£€æŸ¥æ—¥å¿—ä¸­çš„"é”™è¿‡æœºä¼š"ï¼š
```bash
ğŸ“Œ é‡ç‚¹å…³æ³¨ï¼ˆé”™è¿‡çš„TOP3ï¼‰:
   BNB: ä¿¡å·åˆ†60 | ä¿¡å·åˆ†60<80  â† è¢«è¿‡æ»¤åŸå› 
```

2. æ£€æŸ¥æœç´¢ç©ºé—´å®šä¹‰ï¼ˆ`backtest_optimizer_v8321.py`ç¬¬270-296è¡Œï¼‰

3. ä¸´æ—¶é™ä½é˜ˆå€¼ï¼š
```python
'min_signal_score': [30, 40, 50],  # é™ä½
'min_consensus_score': [0, 5, 10], # é™ä½
'min_risk_reward': [0.8, 1.0, 1.2] # é™ä½
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- V8.4.3å·²é™ä½æœç´¢èŒƒå›´
- å¦‚æœä»ç„¶0%ï¼Œæ£€æŸ¥æ•°æ®ä¸­`signal_score`å’Œ`consensus_score`çš„å®é™…åˆ†å¸ƒ

---

### **é—®é¢˜2: å¹³å‡åˆ©æ¶¦æ˜¯è´Ÿæ•°**

**ç—‡çŠ¶**ï¼š
```bash
âœ… æ³¢æ®µä¼˜åŒ–å®Œæˆ:
   å¹³å‡åˆ©æ¶¦: 0.5% â†’ -0.6%
```

**åŸå› **ï¼š
- ATRå€æ•°å¤ªå°ï¼Œåˆ©æ¶¦ç©ºé—´ä¸è¶³ä»¥è¦†ç›–æ‰‹ç»­è´¹
- Time_exitæ¯”ä¾‹è¿‡é«˜
- æ•°æ®è´¨é‡é—®é¢˜

**è¯Šæ–­æ­¥éª¤**ï¼š

1. æ£€æŸ¥`actual_profit_pct`åˆ†å¸ƒï¼š
```bash
ğŸ“Š æ³¢æ®µå¯¹æ¯”:
   ç†è®ºåˆ©æ¶¦: 18.07%
   å®é™…åˆ©æ¶¦: 0.75%
   å·®è·: 17.32%  â† å¦‚æœå·®è·>80%ï¼Œè¯´æ˜å¤§éƒ¨åˆ†æ˜¯time_exit
```

2. æ£€æŸ¥ATRå€æ•°ï¼š
```bash
âœ… V8.3.21ä¼˜åŒ–å®Œæˆ
   æœ€ä¼˜å‚æ•°: atr_tp_multiplier=1.5  â† å¤ªå°
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æé«˜`atr_tp_multiplier`æœç´¢èŒƒå›´ï¼š`[3.0, 4.0, 5.0]`
- é™ä½æ‰‹ç»­è´¹ï¼ˆä»…ç”¨äºå›æµ‹éªŒè¯ï¼‰
- æ£€æŸ¥`calculate_actual_profit.py`çš„é€»è¾‘

---

### **é—®é¢˜3: ä¼˜åŒ–å™¨å†…éƒ¨åˆ©æ¶¦ä¸æœ€ç»ˆå¯¹æ¯”ä¸ä¸€è‡´**

**ç—‡çŠ¶**ï¼š
```bash
âœ… V8.3.21ä¼˜åŒ–å®Œæˆ
   å¹³å‡åˆ©æ¶¦: 1.8%  â† ä¼˜åŒ–å™¨å†…éƒ¨

âœ… æ³¢æ®µä¼˜åŒ–å®Œæˆ:
   å¹³å‡åˆ©æ¶¦: 0.5% â†’ -0.6%  â† æœ€ç»ˆå¯¹æ¯”ï¼ŒçŸ›ç›¾ï¼
```

**åŸå› **ï¼š
- V8.4.2ä¹‹å‰ï¼Œ`simulate_params_on_opportunities`ä½¿ç”¨é¢„å…ˆè®¡ç®—çš„`actual_profit_pct`ï¼ˆåŸºäºå›ºå®šATRï¼‰
- V8.4.2ä¿®å¤åï¼Œé‡æ–°è®¡ç®—`actual_profit_pct`

**è¯Šæ–­æ­¥éª¤**ï¼š

æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰ï¼š
```bash
ğŸ“Š è®¡ç®—å‰åå¯¹æ¯”ï¼ˆä½¿ç”¨çœŸå®åˆ©æ¶¦ï¼‰...  â† V8.4.2æ–°å¢
   è®¡ç®—baselineï¼ˆå½“å‰å‚æ•°ï¼‰...
   âœ… å®é™…åˆ©æ¶¦è®¡ç®—å®Œæˆ: 2000ä¸ªæœºä¼š
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®è®¤ä»£ç æ˜¯V8.4.2+ç‰ˆæœ¬
- ç¡®è®¤ä½¿ç”¨äº†`calculate_actual_profit_batch`é‡æ–°è®¡ç®—

---

### **é—®é¢˜4: ç†è®ºåˆ©æ¶¦ä¸å®é™…åˆ©æ¶¦å·®è·å·¨å¤§**

**ç—‡çŠ¶**ï¼š
```bash
ğŸ“Š æ³¢æ®µå¯¹æ¯”:
   ç†è®ºåˆ©æ¶¦: 18.07%
   å®é™…åˆ©æ¶¦: 0.75%
   å·®è·: 17.32%  â† å·®è·>90%
```

**åŸå› **ï¼š
- Time_exitæ¯”ä¾‹è¿‡é«˜ï¼ˆæœªè§¦å‘TP/SLï¼‰
- ATRå€æ•°è®¾ç½®ä¸åˆç†
- å¸‚åœºæ³¢åŠ¨æ€§ä¸è¶³

**è¯Šæ–­æ­¥éª¤**ï¼š

1. æ£€æŸ¥é€€å‡ºåŸå› åˆ†å¸ƒï¼š
```python
tp_count = sum(1 for o in opportunities if o['exit_reason'] == 'tp')
sl_count = sum(1 for o in opportunities if o['exit_reason'] == 'sl')
time_exit_count = sum(1 for o in opportunities if o['exit_reason'] == 'time_exit')

print(f"TP: {tp_count}, SL: {sl_count}, Time Exit: {time_exit_count}")
```

2. å¦‚æœ`time_exit_count > 80%`ï¼Œè¯´æ˜ATRå€æ•°å¤ªå¤§

**è§£å†³æ–¹æ¡ˆ**ï¼š
- é™ä½`atr_tp_multiplier`ï¼š`[1.5, 2.0, 2.5]`
- ç¼©çŸ­`max_holding_hours`ï¼š`[24, 36, 48]`

---

## æ€»ç»“ï¼šä»å¤´åˆ°å°¾çš„å®Œæ•´æ•°æ®æµ

```
ã€è¾“å…¥ã€‘14å¤©å†å²å¿«ç…§ï¼ˆ9177æ¡è®°å½•ï¼‰
   â†“
ã€é˜¶æ®µ1ã€‘è¯»å–å¹¶åˆå¹¶æ•°æ®
   â†“
ã€é˜¶æ®µ2ã€‘éå†å¿«ç…§ï¼Œè¯†åˆ«3364ä¸ªäº¤æ˜“æœºä¼š
   â”œâ”€ objective_profitï¼ˆç†è®ºåˆ©æ¶¦ï¼‰
   â”œâ”€ future_dataï¼ˆæœªæ¥ä»·æ ¼æ•°æ®ï¼‰
   â””â”€ signal_score, consensus, risk_reward
   â†“
ã€é˜¶æ®µ3ã€‘è®¡ç®—actual_profit_pctï¼ˆåŸºäºå›ºå®šATRï¼‰
   â”œâ”€ ä½¿ç”¨é»˜è®¤å‚æ•°ï¼ˆatr_tp=3.0, atr_stop=1.5ï¼‰
   â””â”€ æ‰£é™¤æ‰‹ç»­è´¹å’Œæ»‘ç‚¹
   â†“
ã€é˜¶æ®µ4ã€‘V8.3.21ä¼˜åŒ–å™¨
   â”œâ”€ å®šä¹‰æœç´¢ç©ºé—´ï¼ˆ200ç»„å‚æ•°ï¼‰
   â”œâ”€ éšæœºé‡‡æ ·Grid Search
   â”œâ”€ å¯¹æ¯ç»„å‚æ•°ï¼š
   â”‚   â”œâ”€ passes_basic_filterï¼ˆè¿‡æ»¤æœºä¼šï¼‰
   â”‚   â”œâ”€ ç»Ÿè®¡æ•è·çš„æœºä¼šçš„avg_profit
   â”‚   â””â”€ calculate_scoreï¼ˆè¯„åˆ†ï¼‰
   â”œâ”€ æ’åºå¹¶é€‰å‡ºæœ€ä¼˜é…ç½®
   â””â”€ è¾“å‡ºï¼šoptimized_params
   â†“
ã€é˜¶æ®µ5ã€‘é‡æ–°è®¡ç®—å‰åå¯¹æ¯”ï¼ˆV8.4.2ä¿®å¤ï¼‰
   â”œâ”€ baseline: ç”¨current_paramsé‡æ–°è®¡ç®—actual_profit
   â”œâ”€ optimized: ç”¨optimized_paramsé‡æ–°è®¡ç®—actual_profit
   â””â”€ å¯¹æ¯”ï¼šå¹³å‡åˆ©æ¶¦ X% â†’ Y%
   â†“
ã€è¾“å‡ºã€‘æœ€ä¼˜å‚æ•° + å‰åå¯¹æ¯”æŠ¥å‘Š
   â””â”€ ä¿å­˜åˆ°learning_config.json
```

---

**å…³é”®æˆåŠŸæŒ‡æ ‡**ï¼š

1. **æ•è·ç‡ > 50%**ï¼šä¼˜åŒ–å™¨èƒ½æ•è·è¶³å¤Ÿå¤šçš„æœºä¼š
2. **å¹³å‡åˆ©æ¶¦ > 0%**ï¼šä¼˜åŒ–åçš„å‚æ•°èƒ½ç›ˆåˆ©
3. **å‰åä¸€è‡´æ€§**ï¼šä¼˜åŒ–å™¨å†…éƒ¨æŠ¥å‘Šçš„åˆ©æ¶¦ä¸æœ€ç»ˆå¯¹æ¯”ä¸€è‡´
4. **ç†è®º/å®é™…å·®è· < 50%**ï¼šå¤§éƒ¨åˆ†äº¤æ˜“èƒ½è§¦å‘TP/SL

---

**æ—¥æœŸ**: 2025-11-14  
**ç‰ˆæœ¬**: V8.4.3  
**çŠ¶æ€**: å®Œæ•´æµç¨‹æ¢³ç†  
**é€‚ç”¨èŒƒå›´**: qwen/deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py + backtest_optimizer_v8321.py

