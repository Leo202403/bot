# K线数据诊断指南

**问题**: 前端有时看不到K线图，手动生成可以看到，但系统自动运行后又看不到了

---

## 🔍 问题分析

### 可能的原因

1. **数据不完整**
   - K线数据条数太少
   - 数据时间范围不够
   - 数据有间隔/断层

2. **数据格式错误**
   - JSON格式损坏
   - 缺少必需字段
   - 字段类型错误

3. **数据过时**
   - 最后更新时间太久
   - 数据没有实时更新

4. **前端问题**
   - 缓存问题
   - API请求失败
   - 组件渲染错误

---

## 🛠️ 诊断工具

### 1. 检查K线数据完整性

**运行命令**：
```bash
cd /root/10-23-bot/ds
python3 check_kline_data.py
```

**检查内容**：
- ✅ 文件是否存在
- ✅ 文件大小是否正常
- ✅ 数据条数是否足够
- ✅ 必需字段是否完整
- ✅ 时间范围是否合理
- ✅ 数据是否连续
- ✅ 价格数据是否合理
- ✅ 数据新鲜度

**输出示例**：
```
============================================================
检查 QWEN - BTC/USDT:USDT
============================================================
📁 文件大小: 245,678 bytes (239.92 KB)
🕐 最后修改: 2025-11-14 20:30:15
✅ 数据条数: 1440

📊 数据范围:
  第一条: {'timestamp': 1731571200000, 'open': 89500.0, ...}
  最后条: {'timestamp': 1731657600000, 'open': 90200.0, ...}

✅ 必需字段完整: ['timestamp', 'open', 'high', 'low', 'close', 'volume']

📅 时间范围:
  开始: 2025-11-13 20:30:00
  结束: 2025-11-14 20:30:00
  跨度: 1 day, 0:00:00
  数据新鲜度: 0:00:15 前
  ✅ 数据较新

🔍 数据连续性检查（前10条）:
  ✅ 前10条数据连续

💰 价格数据检查:
  ✅ 无0值数据
  ✅ high >= low 检查通过
  价格范围: 89500.00000000 ~ 90500.00000000
```

---

## 📋 诊断流程

### 步骤1：检查数据文件

```bash
cd /root/10-23-bot/ds
python3 check_kline_data.py
```

**观察**：
- 所有币种的数据是否正常？
- 数据新鲜度如何？
- 是否有异常币种？

---

### 步骤2：查看系统日志

**检查K线数据获取日志**：
```bash
# 查看最近的日志
tail -n 100 /root/10-23-bot/logs/qwen.log | grep -i "kline\|k线"

# 查看是否有错误
tail -n 100 /root/10-23-bot/logs/qwen.log | grep -i "error\|failed\|失败"
```

**关键信息**：
- K线数据获取是否成功？
- 是否有API错误？
- 是否有网络超时？

---

### 步骤3：检查前端日志

**打开浏览器控制台**（F12）：

1. **Console标签**：
   - 查看是否有JavaScript错误
   - 查看API请求是否成功

2. **Network标签**：
   - 查看K线数据API请求
   - 检查响应状态码（应该是200）
   - 检查响应内容是否有数据

**关键API**：
```
GET /api/kline_data?model=qwen&symbol=BTC/USDT:USDT
```

**正常响应**：
```json
{
  "success": true,
  "data": [
    {"timestamp": 1731571200000, "open": 89500.0, ...},
    ...
  ]
}
```

---

### 步骤4：对比手动生成和自动运行

**手动生成数据**：
```bash
# 手动触发K线数据更新
cd /root/10-23-bot
python3 -c "from ds.qwen_多币种智能版 import update_kline_data; update_kline_data()"
```

**对比**：
1. 手动生成后，运行`check_kline_data.py`
2. 记录数据条数、时间范围、文件大小
3. 等待系统自动运行后，再次运行`check_kline_data.py`
4. 对比两次结果的差异

**可能的差异**：
- 自动运行的数据条数更少
- 自动运行的时间范围更短
- 自动运行的数据有间隔

---

## 🔧 常见问题和解决方案

### 问题1：数据条数太少

**现象**：
```
✅ 数据条数: 50
⚠️  数据可能不足（建议至少1000条）
```

**原因**：
- K线数据获取时限制了条数
- API请求失败，只获取到部分数据

**解决方案**：
1. 检查代码中的K线数据获取逻辑
2. 增加获取的数据条数
3. 检查API限制

---

### 问题2：数据不连续

**现象**：
```
🔍 数据连续性检查（前10条）:
  ⚠️  第5条到第6条: 间隔15.0分钟
  ⚠️  第8条到第9条: 间隔30.0分钟
```

**原因**：
- 网络不稳定，部分数据获取失败
- API限流，部分请求被拒绝
- 系统运行中断，错过了某些时间点

**解决方案**：
1. 增加错误重试机制
2. 使用更可靠的数据源
3. 定期检查并补全缺失数据

---

### 问题3：数据过时

**现象**：
```
🕐 最后修改: 2025-11-14 18:30:15
数据新鲜度: 2:00:00 前
⚠️  数据可能过时（超过1小时）
```

**原因**：
- 系统没有定期更新K线数据
- 更新任务失败或被跳过

**解决方案**：
1. 检查定时任务是否正常运行
2. 手动触发更新
3. 重启服务

---

### 问题4：文件损坏

**现象**：
```
❌ JSON解析失败: Expecting value: line 1 column 1 (char 0)
文件可能损坏或格式错误
```

**原因**：
- 写入过程中被中断
- 磁盘空间不足
- 文件权限问题

**解决方案**：
```bash
# 删除损坏的文件
rm /root/10-23-bot/ds/trading_data/qwen/kline_data/BTC_USDT_USDT_1m.json

# 重启服务，触发重新获取
supervisorctl restart ai-bot:qwen
```

---

### 问题5：前端缓存

**现象**：
- 数据文件正常
- 后端API正常
- 但前端仍然看不到

**解决方案**：
1. **清除浏览器缓存**：
   - Chrome: Ctrl+Shift+Delete
   - 选择"缓存的图片和文件"
   - 点击"清除数据"

2. **强制刷新**：
   - Ctrl+F5（Windows）
   - Cmd+Shift+R（Mac）

3. **无痕模式测试**：
   - Ctrl+Shift+N（Chrome）
   - 查看是否能正常显示

---

## 📊 数据完整性标准

### 最低要求

| 指标 | 最低值 | 推荐值 |
|------|--------|--------|
| 数据条数 | 500条 | 1440条（24小时） |
| 时间跨度 | 8小时 | 24小时 |
| 数据新鲜度 | <30分钟 | <5分钟 |
| 连续性 | 间隔<5分钟 | 完全连续 |
| 文件大小 | >50KB | >200KB |

### 数据质量检查

- ✅ 无0值数据
- ✅ high >= low
- ✅ 价格在合理范围内
- ✅ 成交量>0
- ✅ 时间戳递增

---

## 🚀 预防措施

### 1. 增加数据验证

在保存K线数据前，添加验证：
```python
def validate_kline_data(data):
    if not data or len(data) < 500:
        raise ValueError("数据条数不足")
    
    # 检查时间连续性
    for i in range(len(data) - 1):
        gap = (data[i+1]['timestamp'] - data[i]['timestamp']) / 1000 / 60
        if gap > 5:
            raise ValueError(f"数据不连续: 第{i}条到第{i+1}条间隔{gap}分钟")
    
    return True
```

### 2. 增加错误重试

```python
def fetch_kline_with_retry(symbol, limit=1500, max_retries=3):
    for attempt in range(max_retries):
        try:
            data = exchange.fetch_ohlcv(symbol, '1m', limit=limit)
            if validate_kline_data(data):
                return data
        except Exception as e:
            if attempt == max_retries - 1:
                raise
            time.sleep(2 ** attempt)  # 指数退避
```

### 3. 定期检查和告警

```python
def check_kline_health():
    for model in ['qwen', 'deepseek']:
        for symbol in symbols:
            data = load_kline_data(model, symbol)
            if not validate_kline_data(data):
                send_alert(f"{model} - {symbol} K线数据异常")
```

---

## 📝 总结

### 诊断优先级

1. **第一优先**：运行`check_kline_data.py`检查数据文件
2. **第二优先**：查看系统日志，确认数据获取是否成功
3. **第三优先**：检查前端控制台，确认API请求是否正常
4. **第四优先**：对比手动生成和自动运行的差异

### 最可能的原因

根据你的描述（手动生成可以看到，自动运行看不到），最可能的原因是：

1. **自动运行时数据条数不够**
   - 可能限制了获取的条数
   - 或者只获取了增量数据

2. **自动运行时数据有间隔**
   - 网络不稳定导致部分数据缺失
   - 前端K线组件无法处理不连续的数据

3. **文件写入不完整**
   - 自动运行时可能被中断
   - 导致文件损坏或数据不完整

### 下一步

1. **立即运行诊断工具**：
   ```bash
   cd /root/10-23-bot/ds
   python3 check_kline_data.py
   ```

2. **查看结果并反馈**：
   - 哪些币种的数据异常？
   - 数据条数是多少？
   - 数据新鲜度如何？

3. **根据结果深入排查**：
   - 如果数据正常，问题在前端
   - 如果数据异常，问题在后端数据获取

