═══════════════════════════════════════════════════════════════
🔍 V8.3.14.2 诊断增强 - 立即部署指南
═══════════════════════════════════════════════════════════════

📅 日期: 2025-11-07
📦 版本: V8.3.14.2
🎯 目的: 诊断 "信号评分路由失败: 'captured_count'" 问题

═══════════════════════════════════════════════════════════════
🎯 本次目的
═══════════════════════════════════════════════════════════════

❌ 不是修复问题（因为不知道准确的错误位置）
✅ 而是增强诊断（让错误再次发生时能看到详细信息）

═══════════════════════════════════════════════════════════════
✅ 修改内容
═══════════════════════════════════════════════════════════════

【增强错误诊断】
位置: calculate_signal_score函数的except块
新增输出:
1. market_data的类型 (type)
2. market_data的keys (前10个)
3. 完整的错误堆栈 (traceback)

【新增输出示例】
⚠️ 信号评分路由失败: 'captured_count'
  调试信息: market_data类型=<class 'dict'>
  market_data keys: ['symbol', 'price', 'price_action', ...]
Traceback (most recent call last):
  File "...", line XXX, in calculate_signal_score
    ...
KeyError: 'captured_count'

═══════════════════════════════════════════════════════════════
🚀 立即部署步骤
═══════════════════════════════════════════════════════════════

【Step 1】拉取最新代码
cd ~/10-23-bot
git pull origin main

【Step 2】停止服务
screen -S ai-deepseek -X quit
screen -S ai-qwen -X quit

【Step 3】重启服务
screen -dmS ai-deepseek bash -c 'cd ~/10-23-bot/ds && set -a; source .env; set +a; exec venv/bin/python -u deepseek_多币种智能版.py 2>&1 | tee -a logs/deepseek_trading.log'

screen -dmS ai-qwen bash -c 'cd ~/10-23-bot/ds && set -a; source .env.qwen; set +a; exec venv/bin/python -u qwen_多币种智能版.py 2>&1 | tee -a logs/qwen_trading.log'

【Step 4】监控日志
tail -f ~/10-23-bot/ds/logs/deepseek_trading.log | grep -A 20 "信号评分路由失败"

═══════════════════════════════════════════════════════════════
📊 等待错误再次发生
═══════════════════════════════════════════════════════════════

【什么时候会看到错误】
- 当系统尝试评分一个交易信号时
- 如果market_data结构有问题
- 通常在AI决策后，准备开仓前

【需要收集的信息】
当错误再次出现时，完整复制以下内容：

1. ⚠️ 信号评分路由失败: XXX
2.   调试信息: market_data类型=XXX
3.   market_data keys: [...]
4. Traceback (most recent call last):
   ...
   (完整的错误堆栈)

═══════════════════════════════════════════════════════════════
📝 如何提供诊断信息
═══════════════════════════════════════════════════════════════

【方式1】完整复制日志
tail -100 ~/10-23-bot/ds/logs/deepseek_trading.log | grep -A 25 "信号评分路由失败"

【方式2】保存到文件
tail -100 ~/10-23-bot/ds/logs/deepseek_trading.log | grep -A 25 "信号评分路由失败" > error_diagnosis.txt
cat error_diagnosis.txt

【需要的关键信息】
✅ 错误信息（'captured_count'）
✅ market_data类型（应该是dict）
✅ market_data keys（看看有哪些字段）
✅ Traceback最后几行（准确的错误位置）

═══════════════════════════════════════════════════════════════
🎯 根据诊断信息修复
═══════════════════════════════════════════════════════════════

【场景1】market_data包含captured_count
说明: market_data被污染了，包含了优化/模拟结果
修复: 确保传入calculate_signal_score的是正确的市场数据

【场景2】Traceback指向某个嵌套访问
说明: 某行代码访问了嵌套字典但没有用.get()
修复: 将pa["xxx"]["yyy"]改为pa.get("xxx", {}).get("yyy", default)

【场景3】classify_signal_type出错
说明: 信号分类时访问了错误的字段
修复: 增强classify_signal_type的数据验证

═══════════════════════════════════════════════════════════════
⏰ 预计时间
═══════════════════════════════════════════════════════════════

【部署时间】
- 拉取代码: 10秒
- 重启服务: 30秒
- 总计: < 1分钟

【等待时间】
- 如果错误频繁: 几分钟内就会出现
- 如果错误偶发: 可能需要几小时或一天

【修复时间】
- 收集到诊断信息后: 10-30分钟
- 验证修复: 部署后等待1小时确认

═══════════════════════════════════════════════════════════════
📞 常见问题
═══════════════════════════════════════════════════════════════

【Q1】错误一直不出现怎么办？
A: 说明市场条件没有触发这个错误。可以：
   - 等待更多交易信号
   - 检查其他日志文件
   - 如果长时间不出现，可能问题已自动解决

【Q2】看到错误但没有完整的Traceback？
A: 增加日志输出行数：
tail -200 ~/10-23-bot/ds/logs/deepseek_trading.log | grep -A 30 "信号评分路由失败"

【Q3】market_data keys显示不全？
A: 正常，我们只显示前10个key。如果需要更多：
   - 修改代码中的[:10]为[:20]
   - 或者提供当前的10个key也足够定位问题

【Q4】两个模型都会出错吗？
A: 可能。因为代码同步了。
   - 建议同时监控deepseek和qwen的日志
   - 哪个先出错就先收集哪个的诊断信息

═══════════════════════════════════════════════════════════════
✅ 验证部署成功
═══════════════════════════════════════════════════════════════

【检查进程】
screen -ls
# 应该看到:
# 12345.ai-deepseek (Detached)
# 12346.ai-qwen (Detached)

【检查日志】
tail -50 ~/10-23-bot/ds/logs/deepseek_trading.log
# 应该看到正常的交易日志，没有启动错误

【确认版本】
grep "V8.3.14.2" ~/10-23-bot/ds/deepseek_多币种智能版.py
# 应该有输出，说明代码已更新

═══════════════════════════════════════════════════════════════
🎊 总结
═══════════════════════════════════════════════════════════════

【本次部署】
✅ 增强了错误诊断
✅ 可以看到market_data的详细信息
✅ 可以看到完整的错误堆栈
✅ 可以准确定位错误位置

【下一步】
1. 立即部署（< 1分钟）
2. 等待错误再次发生
3. 完整复制诊断信息
4. 根据诊断信息针对性修复
5. 验证修复效果

【关键点】
- 不要紧张，这只是增强诊断，不会影响现有功能
- 错误仍会被捕获，系统会继续运行（返回默认值50分）
- 唯一的区别是现在可以看到详细的诊断信息

═══════════════════════════════════════════════════════════════
开始部署吧！🚀
═══════════════════════════════════════════════════════════════

