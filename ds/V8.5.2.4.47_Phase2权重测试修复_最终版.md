# V8.5.2.4.47 Phase 2æƒé‡æµ‹è¯•ä¿®å¤ï¼ˆæœ€ç»ˆç‰ˆï¼‰

**ä¿®å¤æ—¶é—´**: 2025-11-19  
**ä¿®å¤ç±»å‹**: P0 - æ•°æ®ç»“æ„é—®é¢˜

---

## ğŸ” é—®é¢˜è¯Šæ–­æˆåŠŸ

é€šè¿‡DEBUGæ—¥å¿—æˆåŠŸå®šä½äº†é—®é¢˜æ ¹æºï¼š

```
ğŸ” ã€DEBUGã€‘è¶…çŸ­çº¿æœºä¼šæ•°æ®æ£€æŸ¥:
   æ€»æ•°: 1978
   ç¬¬ä¸€ä¸ªæœºä¼šå­—æ®µ: ['coin', 'timestamp', 'time', 'date', 'entry_price', ...]
   æ˜¯å¦æœ‰snapshot: False  â¬…ï¸ é—®é¢˜æ‰¾åˆ°äº†ï¼
```

### âŒ æ ¹æœ¬åŸå› 

**`confirmed_opportunities`è¿”å›çš„æœºä¼šæ•°æ®æ²¡æœ‰åŒ…å«`snapshot`å­—æ®µ**

è¿™å¯¼è‡´äº†ä¸€ç³»åˆ—è¿é”é—®é¢˜ï¼š

1. âœ… **Phase 2æƒé‡æµ‹è¯•å®Œå…¨å¤±è´¥ï¼ˆæ•è·0%ï¼‰**
   - `recalculate_signal_score_from_snapshot`éœ€è¦`snapshot`å‚æ•°
   - ä½†æœºä¼šæ•°æ®ä¸­æ²¡æœ‰`snapshot`å­—æ®µ
   - æ‰€ä»¥`for opp in scalping_opps: if snapshot:`æ¡ä»¶æ°¸è¿œæ˜¯False
   - å¯¼è‡´`recalc_count = 0`

2. âœ… **Phase 3å¤±è´¥**
   - ä¾èµ–Phase 2çš„æœ€ä¼˜æƒé‡
   - ä½†Phase 2æƒé‡æµ‹è¯•å¤±è´¥ï¼Œæ— æ³•è·å¾—æœ‰æ•ˆæƒé‡

3. âœ… **Phase 4è·³è¿‡**
   - ä¾èµ–Phase 3çš„å‚æ•°
   - ä½†Phase 3æ— æ•°æ®ï¼Œæ‰€ä»¥Phase 4è·³è¿‡éªŒè¯

### ğŸ“Š é—®é¢˜å½±å“é“¾

```
Phase 1 âœ… (æˆåŠŸç”Ÿæˆ1978ä¸ªè¶…çŸ­çº¿+1846ä¸ªæ³¢æ®µæœºä¼š)
   â†“
   â†“ è¿”å›confirmed_opportunitiesï¼ˆæ— snapshotå­—æ®µï¼‰
   â†“
Phase 2 âŒ (æƒé‡æµ‹è¯•æ•è·0%ï¼Œå› ä¸ºæ— æ³•é‡æ–°è®¡ç®—signal_score)
   â†“
   â†“ ä½¿ç”¨é»˜è®¤æƒé‡ï¼ˆæœªä¼˜åŒ–ï¼‰
   â†“
Phase 3 âŒ (å‚æ•°ä¼˜åŒ–å¤±è´¥ï¼Œå› ä¸ºä¿¡å·åˆ†æœªä¼˜åŒ–)
   â†“
   â†“ æ— æœ‰æ•ˆå‚æ•°
   â†“
Phase 4 â­ï¸  (è·³è¿‡éªŒè¯ï¼Œå› ä¸ºPhase 3æ— æ•°æ®)
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ä½ç½®

- `deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py`: ç¬¬22528è¡Œ
- `qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py`: ç¬¬22388è¡Œ

### ä¿®å¤å†…å®¹

åœ¨`analyze_separated_opportunities`å‡½æ•°ä¸­ï¼Œä¸ºè¿”å›çš„æœºä¼šæ•°æ®æ·»åŠ `snapshot`å­—æ®µï¼š

```python
opp_data_base = {
    'coin': coin,
    'timestamp': timestamp,
    'time': time_str,
    'date': date_str,
    'entry_price': entry_price,
    'direction': direction,
    'objective_profit': final_profit,
    'consensus': consensus,
    'risk_reward': risk_reward,
    'atr': atr,
    'signal_score': signal_score,
    'signal_type_csv': signal_type,
    'signal_name': signal_name,
    'future_data': future_summary,
    'kline_ctx_bullish_ratio': kline_ctx_bullish_ratio,
    'kline_ctx_price_chg_pct': kline_ctx_price_chg_pct,
    'mkt_struct_swing': mkt_struct_swing,
    'sr_hist_test_count': sr_hist_test_count,
    'sr_hist_avg_reaction': sr_hist_avg_reaction,
    # ã€V8.5.2.4.47ã€‘æ·»åŠ snapshotç”¨äºPhase 2æƒé‡æµ‹è¯•
    'snapshot': current.to_dict() if hasattr(current, 'to_dict') else dict(current)  # âœ… æ–°å¢
}
```

### å…³é”®ç‚¹

1. **`current`æ˜¯ä»€ä¹ˆï¼Ÿ**
   - æ˜¯pandas Serieså¯¹è±¡ï¼ˆ`coin_data.iloc[idx]`ï¼‰
   - åŒ…å«è¯¥è¡Œçš„æ‰€æœ‰CSVæ•°æ®ï¼ˆtrend_15mã€rsiã€emaã€priceç­‰ï¼‰

2. **ä¸ºä»€ä¹ˆç”¨`.to_dict()`ï¼Ÿ**
   - å°†pandas Seriesè½¬æ¢ä¸ºæ™®é€šPythonå­—å…¸
   - ç¡®ä¿æ•°æ®å¯åºåˆ—åŒ–å’Œå¯ä¼ é€’
   - ä½¿ç”¨`hasattr`æ£€æŸ¥é¿å…épandaså¯¹è±¡æŠ¥é”™

3. **snapshotåŒ…å«ä»€ä¹ˆï¼Ÿ**
   - æ‰€æœ‰åŸå§‹æŒ‡æ ‡æ•°æ®ï¼ˆtrend_15mã€trend_1hã€trend_4hï¼‰
   - æŠ€æœ¯æŒ‡æ ‡ï¼ˆrsiã€ema20_1hã€ema50_1hã€momentum_scoreï¼‰
   - ä»·æ ¼æ•°æ®ï¼ˆpriceã€closeã€highã€lowï¼‰
   - å…¶ä»–è®¡ç®—æ‰€éœ€çš„å­—æ®µ

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### ä¸‹æ¬¡å›æµ‹å°†æ˜¾ç¤º

```
ğŸ” ã€DEBUGã€‘è¶…çŸ­çº¿æœºä¼šæ•°æ®æ£€æŸ¥:
   æ€»æ•°: 1978
   ç¬¬ä¸€ä¸ªæœºä¼šå­—æ®µ: ['coin', 'timestamp', ..., 'snapshot']
   æ˜¯å¦æœ‰snapshot: True  âœ… ä¿®å¤æˆåŠŸï¼
   snapshotç±»å‹: <class 'dict'>

âš¡ æµ‹è¯•è¶…çŸ­çº¿æƒé‡å€™é€‰ï¼ˆå…±5ç»„ï¼‰...
   #1 é»˜è®¤ : æ•è·???/1978(??%) | åˆ©æ¶¦??% | å¾—åˆ†???  âœ… ä¸å†æ˜¯0%
   #2 åŠ¨é‡ä¼˜å…ˆ : æ•è·???/1978(??%) | åˆ©æ¶¦??% | å¾—åˆ†???
   ...
   âœ… è¶…çŸ­çº¿æœ€ä¼˜æƒé‡: ??? (å¾—åˆ†???)

ğŸ”„ ã€åº”ç”¨æœ€ä¼˜æƒé‡ã€‘ä½¿ç”¨æœ€ä¼˜æƒé‡é‡æ–°è®¡ç®—æ‰€æœ‰æœºä¼šçš„signal_score...
   âœ… é‡æ–°è®¡ç®—: 1978ä¸ªæœºä¼šçš„signal_score  âœ… ä¸å†æ˜¯0ä¸ª

ã€Phase 3ã€‘é£é™©æ§åˆ¶ä¸åˆ©æ¶¦æœ€å¤§åŒ–
   ...ï¼ˆæ­£å¸¸æ‰§è¡Œï¼‰

ã€Phase 4ã€‘å‚æ•°éªŒè¯ä¸è¿‡æ‹Ÿåˆæ£€æµ‹
   ...ï¼ˆæ­£å¸¸æ‰§è¡Œï¼‰
```

### Phase 2-4å°†æ¢å¤æ­£å¸¸

1. **Phase 2**: 
   - âœ… æƒé‡æµ‹è¯•æ•è·ç‡>0%
   - âœ… æ‰¾åˆ°æœ€ä¼˜æƒé‡ï¼ˆä¸å†æ˜¯é»˜è®¤ï¼‰
   - âœ… Top5å‚æ•°ç»„åˆæœ‰å®é™…æ„ä¹‰

2. **Phase 3**:
   - âœ… ä½¿ç”¨Phase 2ä¼˜åŒ–çš„æƒé‡
   - âœ… å¤šèµ·ç‚¹æœç´¢æ­£å¸¸æ‰§è¡Œ
   - âœ… åˆ†ç¦»ä¼˜åŒ–scalpingå’Œswingå‚æ•°

3. **Phase 4**:
   - âœ… ä½¿ç”¨Phase 3çš„å‚æ•°
   - âœ… å®Œæ•´çš„å‰å‘éªŒè¯
   - âœ… è¿‡æ‹Ÿåˆæ£€æµ‹

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### pandas Series â†’ dict è½¬æ¢

```python
# pandas Series (currentå˜é‡)
current = coin_data.iloc[idx]
# type: pandas.core.series.Series
# åŒ…å«: trend_15m, rsi, ema20_1h, price, etc.

# è½¬æ¢ä¸ºdict
snapshot = current.to_dict()
# type: dict
# {'trend_15m': 'bull', 'rsi': 65.3, 'ema20_1h': 91234.5, ...}
```

### ä¸ºä»€ä¹ˆéœ€è¦snapshotï¼Ÿ

**Phase 2æƒé‡æµ‹è¯•æµç¨‹**ï¼š

```python
# 1. éå†æœºä¼š
for opp in scalping_opps:
    snapshot = opp.get('snapshot')  # â¬…ï¸ éœ€è¦snapshotå­—æ®µ
    if snapshot:
        # 2. ä½¿ç”¨è‡ªå®šä¹‰æƒé‡é‡æ–°è®¡ç®—signal_score
        new_score = recalculate_signal_score_from_snapshot(
            snapshot_row=snapshot,  # â¬…ï¸ ä¼ å…¥snapshot
            signal_type='scalping',
            learning_config=learning_config
        )
        # 3. ä¿å­˜æ–°çš„signal_score
        opp['_weight_test_score'] = new_score
```

**ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ä½¿ç”¨`opp['signal_score']`ï¼Ÿ**
- `opp['signal_score']`æ˜¯Phase 1è®¡ç®—çš„ï¼Œä½¿ç”¨çš„æ˜¯é»˜è®¤æƒé‡
- Phase 2éœ€è¦æµ‹è¯•ä¸åŒçš„æƒé‡ç»„åˆ
- å¿…é¡»ä»åŸå§‹æ•°æ®ï¼ˆsnapshotï¼‰é‡æ–°è®¡ç®—

---

## ğŸ“‹ ä¿®æ”¹ç»Ÿè®¡

| æ–‡ä»¶ | ä¿®æ”¹è¡Œ | æ–°å¢å­—æ®µ | è¯´æ˜ |
|------|-------|---------|------|
| deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py | 22528 | snapshot | æ·»åŠ å¿«ç…§æ•°æ® |
| qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py | 22388 | snapshot | æ·»åŠ å¿«ç…§æ•°æ® |

---

## ğŸ“ ç»éªŒæ•™è®­

### 1. æ•°æ®ç»“æ„å®Œæ•´æ€§

**é—®é¢˜**ï¼š
- å‡½æ•°Aç”Ÿæˆæ•°æ® â†’ å‡½æ•°Bä½¿ç”¨æ•°æ®
- ä½†å‡½æ•°Aè¿”å›çš„æ•°æ®ç¼ºå°‘å­—æ®µ
- å‡½æ•°Bæ— æ³•æ­£å¸¸å·¥ä½œ

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ˜ç¡®å®šä¹‰æ•°æ®ç»“æ„ï¼ˆä½¿ç”¨dataclassæˆ–TypedDictï¼‰
- æ·»åŠ æ•°æ®éªŒè¯
- ä½¿ç”¨DEBUGæ—¥å¿—æ£€æŸ¥å…³é”®å­—æ®µ

### 2. è¯Šæ–­é©±åŠ¨çš„ä¿®å¤

**æ­£ç¡®æµç¨‹**ï¼š
1. âŒ çœ‹åˆ°é—®é¢˜ â†’ çŒœæµ‹åŸå›  â†’ ç›²ç›®ä¿®å¤
2. âœ… çœ‹åˆ°é—®é¢˜ â†’ æ·»åŠ è¯Šæ–­æ—¥å¿— â†’ å®šä½æ ¹æº â†’ ç²¾å‡†ä¿®å¤

**æœ¬æ¬¡æ¡ˆä¾‹**ï¼š
- V8.5.2.4.47ï¼ˆè¯Šæ–­ç‰ˆï¼‰ï¼šæ·»åŠ DEBUGæ—¥å¿—
- V8.5.2.4.47ï¼ˆæœ€ç»ˆç‰ˆï¼‰ï¼šæ ¹æ®DEBUGè¾“å‡ºä¿®å¤é—®é¢˜

### 3. è¿é”æ•…éšœåˆ†æ

**é—®é¢˜è¡¨è±¡**ï¼š
- Phase 2æƒé‡æµ‹è¯•æ•è·0%
- Phase 3å‚æ•°ä¼˜åŒ–å¤±è´¥
- Phase 4è·³è¿‡éªŒè¯

**æ ¹æœ¬åŸå› **ï¼š
- åªæœ‰ä¸€ä¸ªï¼šPhase 1è¿”å›æ•°æ®ç¼ºå°‘snapshotå­—æ®µ

**å¯ç¤º**ï¼š
- å¤šä¸ªç—‡çŠ¶å¯èƒ½åªæœ‰ä¸€ä¸ªæ ¹æº
- è¿½è¸ªæ•°æ®æµå‘æ˜¯å…³é”®
- ä¿®å¤æ ¹æºé—®é¢˜å³å¯è§£å†³æ‰€æœ‰ç—‡çŠ¶

---

## ğŸ”œ ä¸‹ä¸€æ­¥

### å¾…éªŒè¯é—®é¢˜

**æŒä»“æ—¶é—´ä»ç„¶å¼‚å¸¸**ï¼š
```
âš¡ è¶…çŸ­çº¿: å¹³å‡æŒä»“æ—¶é—´: 0.6å°æ—¶
ğŸŒŠ æ³¢æ®µ: å¹³å‡æŒä»“æ—¶é—´: 0.5å°æ—¶  â¬…ï¸ æ³¢æ®µåè€Œæ›´çŸ­ï¼
```

**å¯èƒ½åŸå› **ï¼š
1. æŒä»“æ—¶é—´è®¡ç®—é€»è¾‘ä»æœ‰é—®é¢˜ï¼ˆV8.5.2.4.47å·²ä¿®å¤ä¸€æ¬¡ï¼Œä½†å¯èƒ½ä¸å®Œæ•´ï¼‰
2. é˜ˆå€¼è®¾ç½®ä¸åˆç†ï¼ˆè¶…çŸ­çº¿5%ã€æ³¢æ®µ10%ï¼‰
3. è·Ÿè¸ªé€€å‡ºæ¡ä»¶å¤ªä¸¥æ ¼

**ä¸‹æ¬¡å›æµ‹éœ€è¦æ£€æŸ¥**ï¼š
- Phase 2æƒé‡æµ‹è¯•æ˜¯å¦æˆåŠŸï¼ˆæ•è·ç‡>0%ï¼‰
- Phase 3-4æ˜¯å¦æ­£å¸¸æ‰§è¡Œ
- æŒä»“æ—¶é—´æ˜¯å¦ä»ç„¶å¼‚å¸¸

### å¦‚æœæŒä»“æ—¶é—´ä»æœ‰é—®é¢˜

**æ·»åŠ æ›´è¯¦ç»†çš„DEBUGæ—¥å¿—**ï¼š
```python
print(f"  ğŸ” ã€DEBUGã€‘æŒä»“æ—¶é—´è®¡ç®—ï¼ˆè¶…çŸ­çº¿ï¼‰:")
print(f"     scalping_trigger_bar: {scalping_trigger_bar}")
print(f"     scalping_holding_bars: {scalping_holding_bars}")
print(f"     final_holding_bars: {final_holding_bars}")
print(f"     final_holding_hours: {final_holding_hours}")
```

---

**âœ… V8.5.2.4.47ä¿®å¤å®Œæˆï¼ç­‰å¾…ä¸‹æ¬¡å›æµ‹éªŒè¯ã€‚** ğŸš€

