# V8.5.2.4.62 - ä¿®å¤TP/SLå‚æ•°Noneå€¼Fallbacké—®é¢˜

**ç‰ˆæœ¬**: V8.5.2.4.62  
**æ—¥æœŸ**: 2025-11-19  
**ç±»å‹**: Bug Fix - Criticalï¼ˆä¿®å¤0.00%é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼‰  
**ä¼˜å…ˆçº§**: ğŸ”´ Critical

---

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

### V8.5.2.4.61å›æµ‹ç»“æœ

è°ƒè¯•æ—¥å¿—æ˜¾ç¤ºï¼š
```
ğŸ” è°ƒè¯•æœºä¼š#1/1736: LTC long
   Entry: 88.82, ATR: 0.42857143
   TP: Noneå€, SL: Noneå€    â† âŒ é—®é¢˜æ ¹æº
   future_dataå­˜åœ¨: True
   â†’ å®é™…åˆ©æ¶¦: 0.00%
```

**å…³é”®å‘ç°**ï¼š
- âœ… `future_data`å­˜åœ¨ï¼ˆTrueï¼‰
- âœ… `entry_price`æœ‰æ•ˆï¼ˆ88.82ï¼‰
- âœ… `ATR`æœ‰æ•ˆï¼ˆ0.42857143ï¼‰
- âŒ **TPå€æ•° = None**
- âŒ **SLå€æ•° = None**

å› ä¸ºTP/SLéƒ½æ˜¯Noneï¼Œ`calculate_actual_profit`æ— æ³•è®¡ç®—æ­¢ç›ˆæ­¢æŸï¼Œæ‰€ä»¥è¿”å›0.00%ã€‚

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜é“¾è·¯

#### 1. Line 7298-7305ï¼šåˆ›å»º`config_variant`

```python
config_variant = {
    'min_risk_reward': test_params['min_risk_reward'],
    'min_indicator_consensus': test_params['min_indicator_consensus'],
    'atr_stop_multiplier': test_params.get('atr_stop_multiplier'),    # â† è¿”å›None
    'atr_tp_multiplier': test_params.get('atr_tp_multiplier'),        # â† è¿”å›None
    'max_holding_hours': test_params.get('max_holding_hours'),        # â† è¿”å›None
    'min_signal_score': test_params.get('min_signal_score', 50)
}
```

**è¯´æ˜**ï¼š
- `test_params`æ˜¯å‚æ•°ç»„åˆæµ‹è¯•çš„27ç»„é…ç½®
- è¿™äº›é…ç½®**åªåŒ…å«**ï¼š`min_risk_reward`, `min_indicator_consensus`, `min_signal_score`
- **ä¸åŒ…å«**ï¼š`atr_tp_multiplier`, `atr_stop_multiplier`, `max_holding_hours`
- æ‰€ä»¥`.get()`è¿”å›`None`ï¼Œ`config_variant`ä¸­è¿™äº›å­—æ®µçš„å€¼æ˜¯`None`

#### 2. Line 7354ï¼ˆä¿®å¤å‰ï¼‰ï¼šå°è¯•è·å–TP/SL

```python
strategy_params = {
    **config_variant,
    'atr_tp_multiplier': config_variant.get('atr_tp_multiplier', default_tp),     # âŒ è¿”å›None
    'atr_stop_multiplier': config_variant.get('atr_stop_multiplier', default_sl), # âŒ è¿”å›None
    'max_holding_hours': config_variant.get('max_holding_hours', default_holding) # âŒ è¿”å›None
}
```

**Pythonçš„`.get()`é™·é˜±**ï¼š
```python
>>> d = {'key': None}
>>> d.get('key', 'default')
None  # â† ä¸æ˜¯'default'ï¼å› ä¸ºkeyå­˜åœ¨ï¼Œåªæ˜¯å€¼æ˜¯None
```

**`.get(key, default)`åªåœ¨keyä¸å­˜åœ¨æ—¶è¿”å›defaultï¼Œå¦‚æœkeyå­˜åœ¨ä½†å€¼æ˜¯Noneï¼Œä¼šç›´æ¥è¿”å›Noneï¼**

æ‰€ä»¥ï¼š
- `config_variant['atr_tp_multiplier']`å­˜åœ¨ï¼Œå€¼æ˜¯`None`
- `.get('atr_tp_multiplier', default_tp)`è¿”å›`None`ï¼Œ**ä¸ä¼š**fallbackåˆ°`default_tp`
- æœ€ç»ˆ`strategy_params`ä¸­TP/SLéƒ½æ˜¯`None`

#### 3. ç»“æœï¼šè®¡ç®—å¤±è´¥

`calculate_single_actual_profit`æ”¶åˆ°çš„`strategy_params`ï¼š
```python
{
    'atr_tp_multiplier': None,      # â† æ— æ³•è®¡ç®—æ­¢ç›ˆä»·æ ¼
    'atr_stop_multiplier': None,    # â† æ— æ³•è®¡ç®—æ­¢æŸä»·æ ¼
    'max_holding_hours': None
}
```

æ— æ³•è®¡ç®—TP/SLä»·æ ¼ â†’ æ— æ³•åˆ¤æ–­è§¦å‘ â†’ è¿”å›0.00%åˆ©æ¶¦

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä½¿ç”¨`or`æ“ä½œç¬¦å¤„ç†Noneå€¼

#### ä¿®å¤å‰ï¼ˆLine 7351-7357ï¼‰

```python
# åˆ›å»ºå·®å¼‚åŒ–çš„strategy_paramsï¼ˆä¼˜å…ˆä½¿ç”¨test_pointæŒ‡å®šçš„å€¼ï¼Œå…¶æ¬¡ä½¿ç”¨æœ€ä¼˜TP/SLï¼‰
strategy_params = {
    **config_variant,
    'atr_tp_multiplier': config_variant.get('atr_tp_multiplier', default_tp),     # âŒ æ— æ•ˆ
    'atr_stop_multiplier': config_variant.get('atr_stop_multiplier', default_sl), # âŒ æ— æ•ˆ
    'max_holding_hours': config_variant.get('max_holding_hours', default_holding) # âŒ æ— æ•ˆ
}
```

#### ä¿®å¤åï¼ˆV8.5.2.4.62ï¼‰

```python
# åˆ›å»ºå·®å¼‚åŒ–çš„strategy_paramsï¼ˆä¼˜å…ˆä½¿ç”¨test_pointæŒ‡å®šçš„å€¼ï¼Œå…¶æ¬¡ä½¿ç”¨æœ€ä¼˜TP/SLï¼‰
# ã€V8.5.2.4.62ã€‘ä½¿ç”¨ or æ“ä½œç¬¦å¤„ç†Noneå€¼ï¼Œç¡®ä¿fallbackåˆ°defaultå€¼
strategy_params = {
    **config_variant,
    'atr_tp_multiplier': config_variant.get('atr_tp_multiplier') or default_tp,     # âœ… ä¿®å¤
    'atr_stop_multiplier': config_variant.get('atr_stop_multiplier') or default_sl, # âœ… ä¿®å¤
    'max_holding_hours': config_variant.get('max_holding_hours') or default_holding # âœ… ä¿®å¤
}
```

**åŸç†**ï¼š
```python
>>> None or 'default'
'default'  # âœ… æ­£ç¡®fallback
>>> 30.0 or 'default'
30.0       # âœ… å¦‚æœæœ‰å€¼ï¼Œä½¿ç”¨åŸå€¼
```

---

## ğŸ“Š ä¿®å¤åé¢„æœŸç»“æœ

### è°ƒè¯•è¾“å‡ºï¼ˆé¢„æœŸï¼‰

```
ğŸ” è°ƒè¯•æœºä¼š#1/1736: LTC long
   Entry: 88.82, ATR: 0.42857143
   TP: 30.0å€, SL: 1.5å€    â† âœ… ä¿®å¤ï¼šä½¿ç”¨Phase 2æœ€ä¼˜å€¼
   future_dataå­˜åœ¨: True
   â†’ å®é™…åˆ©æ¶¦: 12.50%      â† âœ… ä¿®å¤ï¼šæ­£ç¡®è®¡ç®—åˆ©æ¶¦
```

### Phase 2å‚æ•°ç»„åˆæµ‹è¯•ï¼ˆé¢„æœŸï¼‰

| é…ç½® | æ•è·ç‡ | å¹³å‡åˆ©æ¶¦ | çŠ¶æ€ |
|------|--------|----------|------|
| è¶…å®½æ¾-ä½åˆ† | 62.0% | **~12%** | âœ… æ­£å¸¸ |
| è¶…å®½æ¾ | 51.7% | **~12%** | âœ… æ­£å¸¸ |
| æå®½æ¾ | 51.7% | **~12%** | âœ… æ­£å¸¸ |

**å¯¹æ¯”V8.5.2.4.61**ï¼š
- ä¿®å¤å‰ï¼šæ‰€æœ‰27ç»„éƒ½æ˜¯0.00% âŒ
- ä¿®å¤åï¼šåº”è¯¥æ¥è¿‘TP/SLæµ‹è¯•çš„12.40%/13.72% âœ…

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶

1. **ds/deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py**
   - Line 7351-7358: ä½¿ç”¨`or`æ“ä½œç¬¦å¤„ç†Noneå€¼

2. **ds/qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py**
   - Line 7356-7363: ä½¿ç”¨`or`æ“ä½œç¬¦å¤„ç†Noneå€¼

---

## ğŸ§ª éªŒè¯æ–¹æ³•

### å›æµ‹å‘½ä»¤

```bash
cd ~/10-23-bot/ds
MANUAL_BACKTEST=true python3 deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py backtest-deepseek
```

### éªŒè¯è¦ç‚¹

1. âœ… **è°ƒè¯•æ—¥å¿—æ˜¾ç¤ºTP/SLä¸å†æ˜¯None**
   ```
   TP: 30.0å€, SL: 1.5å€  â† åº”è¯¥æ˜¾ç¤ºå…·ä½“æ•°å€¼
   ```

2. âœ… **å‚æ•°ç»„åˆæµ‹è¯•åˆ©æ¶¦ä¸å†æ˜¯0.00%**
   ```
   #1 è¶…å®½æ¾-ä½åˆ†
      å¹³å‡åˆ©æ¶¦: 12.XX%     â† åº”è¯¥>0
   ```

3. âœ… **Phase 2 Baselineåˆ©æ¶¦æ¢å¤æ­£å¸¸**
   ```
   Phase 2 baseline: æ•è·2520ä¸ª (63.0%)
   å¹³å‡åˆ©æ¶¦: 12.XX%      â† åº”è¯¥æ¥è¿‘TP/SLæµ‹è¯•çš„12.40%
   ```

---

## ğŸ’¡ æŠ€æœ¯æ•™è®­

### Pythonçš„`.get()`æ–¹æ³•é™·é˜±

```python
# âŒ é”™è¯¯ï¼šå‡è®¾.get()ä¼šå¤„ç†Noneå€¼
d = {'key': None}
value = d.get('key', 'default')  # è¿”å›Noneï¼Œä¸æ˜¯'default'

# âœ… æ­£ç¡®ï¼šä½¿ç”¨oræ“ä½œç¬¦å¤„ç†None
value = d.get('key') or 'default'  # è¿”å›'default'

# æˆ–è€…ï¼šæ˜¾å¼æ£€æŸ¥None
value = d.get('key')
if value is None:
    value = 'default'
```

### æ•™è®­

1. **`.get(key, default)`åªå¤„ç†keyä¸å­˜åœ¨çš„æƒ…å†µ**
   - keyå­˜åœ¨ä½†å€¼æ˜¯Noneæ—¶ï¼Œä¸ä¼šè§¦å‘fallback
   
2. **å¤„ç†Noneå€¼çš„æ­£ç¡®æ–¹å¼**
   - ä½¿ç”¨`or`æ“ä½œç¬¦ï¼š`value or default`
   - æˆ–æ˜¾å¼æ£€æŸ¥ï¼š`value if value is not None else default`

3. **è°ƒè¯•æ—¶è¦æ£€æŸ¥å…·ä½“å€¼ï¼Œä¸åªæ˜¯æ£€æŸ¥å­˜åœ¨æ€§**
   - âœ… `future_dataå­˜åœ¨: True` â†’ åªçŸ¥é“keyå­˜åœ¨
   - âœ… `TP: Noneå€` â†’ æ­ç¤ºäº†çœŸæ­£çš„é—®é¢˜ï¼ˆå€¼æ˜¯Noneï¼‰

---

## âœ… æäº¤ä¿¡æ¯

```bash
git commit -m "fix: V8.5.2.4.62 ä¿®å¤TP/SLå‚æ•°Noneå€¼Fallbacké—®é¢˜

ã€æ ¹æœ¬åŸå› ã€‘
- config_variantä¸­TP/SLå­—æ®µå­˜åœ¨ä½†å€¼æ˜¯None
- .get(key, default)åœ¨keyå­˜åœ¨æ—¶ä¸ä¼šfallback
- å¯¼è‡´strategy_paramsçš„TP/SLéƒ½æ˜¯None
- calculate_actual_profitæ— æ³•è®¡ç®— â†’ 0.00%åˆ©æ¶¦

ã€ä¿®å¤æ–¹æ¡ˆã€‘
- ä½¿ç”¨ or æ“ä½œç¬¦ï¼šconfig_variant.get('key') or default
- æ­£ç¡®å¤„ç†Noneå€¼ï¼Œç¡®ä¿fallbackåˆ°Phase 2æœ€ä¼˜TP/SL

ã€ä¿®å¤ä½ç½®ã€‘
- deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py Line 7351-7358
- qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py Line 7356-7363

ã€é¢„æœŸæ•ˆæœã€‘
- å‚æ•°ç»„åˆæµ‹è¯•åˆ©æ¶¦ï¼š0.00% â†’ ~12%
- Phase 2 Baselineåˆ©æ¶¦ï¼š1.01% â†’ ~12%
- å›æµ‹åˆ©æ¶¦æ¥è¿‘TP/SLæµ‹è¯•ç»“æœï¼ˆ12.40%/13.72%ï¼‰"
```

