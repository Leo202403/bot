═══════════════════════════════════════════════════════════════
🔧 V8.3.14.1 字段访问修复 - 立即部署指南
═══════════════════════════════════════════════════════════════

📅 日期: 2025-11-07
📦 版本: V8.3.14.1
🎯 问题: Qwen max_tokens超限 + DeepSeek信号评分失败
✅ 修复: 21处字段访问安全性改进

═══════════════════════════════════════════════════════════════
🚨 问题现象
═══════════════════════════════════════════════════════════════

【Qwen】
AI决策失败: Error code: 400 - Range of max_tokens should be [1, 8192]

【DeepSeek】
⚠️ 信号评分路由失败: 'captured_count'
❌ scalping信号得分50 < 最低要求75，拒绝开仓

═══════════════════════════════════════════════════════════════
🔍 问题诊断
═══════════════════════════════════════════════════════════════

【问题1】Qwen max_tokens超限
- DeepSeek支持: max_tokens=16000
- Qwen限制: max_tokens=8192
- 导致: API调用失败

【问题2】DeepSeek字段访问错误
- 原因: market_data["field"] 硬编码访问
- 后果: 缺少字段时触发KeyError
- 影响: 信号评分崩溃，无法开仓

═══════════════════════════════════════════════════════════════
✅ 修复内容
═══════════════════════════════════════════════════════════════

【1】Qwen max_tokens限制 (1处)
Line 12048: 16000 → 8000

【2】安全字段访问 (20处)
calculate_scalping_score:
- price_action: market_data["xxx"] → market_data.get("xxx", {})
- support_resistance: market_data["xxx"] → market_data.get("xxx", {})
- rsi_14: market_data["rsi"]["rsi_14"] → market_data.get("rsi", {}).get("rsi_14", 50)

calculate_swing_score:
- 同样的修复模式

═══════════════════════════════════════════════════════════════
🚀 立即部署步骤（服务器）
═══════════════════════════════════════════════════════════════

【Step 1】拉取最新代码
cd ~/10-23-bot
git pull origin main

【Step 2】停止运行中的进程
screen -S ai-deepseek -X quit
screen -S ai-qwen -X quit

【Step 3】验证修复点（可选）
# 验证1: Qwen max_tokens已修改
grep -n "max_tokens=8000" ds/qwen_多币种智能版.py | head -1
# 应输出: 12048:            max_tokens=8000,

# 验证2: DeepSeek字段访问已修改
grep -n "market_data.get" ds/deepseek_多币种智能版.py | wc -l
# 应输出: > 10

【Step 4】重启服务
screen -dmS ai-deepseek bash -c 'cd ~/10-23-bot/ds && set -a; source .env; set +a; exec venv/bin/python -u deepseek_多币种智能版.py 2>&1 | tee -a logs/deepseek_trading.log'

screen -dmS ai-qwen bash -c 'cd ~/10-23-bot/ds && set -a; source .env.qwen; set +a; exec venv/bin/python -u qwen_多币种智能版.py 2>&1 | tee -a logs/qwen_trading.log'

【Step 5】验证运行
screen -ls
# 应该看到:
# 12345.ai-deepseek (Detached)
# 12346.ai-qwen (Detached)

【Step 6】查看日志验证
# Qwen日志 - 检查AI决策是否成功
tail -f ~/10-23-bot/ds/logs/qwen_trading.log | grep -E "(AI决策|Error|✓)"

# DeepSeek日志 - 检查信号评分是否正常
tail -f ~/10-23-bot/ds/logs/deepseek_trading.log | grep -E "(信号评分|路由失败|✓)"

═══════════════════════════════════════════════════════════════
🎯 预期结果
═══════════════════════════════════════════════════════════════

【Qwen】
✅ AI决策已解析 - 分析: ...
✅ 信号得分: XX/100 | 信号类型: ...
❌ 不再看到: Error code: 400 - max_tokens

【DeepSeek】
✅ ⚡ 超短线评分: XX | 仓位XX% | 杠杆Xx
✅ 🌊 波段评分: XX | 仓位XX% | 杠杆Xx
❌ 不再看到: ⚠️ 信号评分路由失败

═══════════════════════════════════════════════════════════════
📊 修复技术细节
═══════════════════════════════════════════════════════════════

【修改前】
pa = market_data["price_action"]  # KeyError if not exists
rsi = market_data["rsi"]["rsi_14"]  # KeyError if not exists
max_tokens=16000  # Qwen会报错

【修改后】
pa = market_data.get("price_action", {})  # 返回{}如果不存在
rsi_data = market_data.get("rsi", {})
rsi = rsi_data.get("rsi_14", 50)  # 默认50（中性值）
max_tokens=8000  # Qwen兼容

═══════════════════════════════════════════════════════════════
🔧 故障排除
═══════════════════════════════════════════════════════════════

【如果Qwen还是报max_tokens错误】
1. 检查是否还有其他地方使用16000
grep -n "max_tokens=16000" ds/qwen_多币种智能版.py
# 应该没有输出

2. 确认.env.qwen配置正确
cat .env.qwen | grep QWEN_API_KEY
# 应该显示你的API Key

【如果DeepSeek还是报字段错误】
1. 检查具体是哪个字段缺失
tail -100 ~/10-23-bot/ds/logs/deepseek_trading.log | grep "KeyError"

2. 确认市场数据获取正常
tail -100 ~/10-23-bot/ds/logs/deepseek_trading.log | grep "获取市场数据"

【如果进程启动失败】
1. 检查Python语法
cd ~/10-23-bot/ds
python3 -m py_compile deepseek_多币种智能版.py
python3 -m py_compile qwen_多币种智能版.py

2. 查看完整错误日志
cat logs/deepseek_trading.log | tail -50
cat logs/qwen_trading.log | tail -50

═══════════════════════════════════════════════════════════════
📈 性能影响
═══════════════════════════════════════════════════════════════

【性能】
✅ 几乎无影响
- .get() vs [] 性能差异可忽略
- 字典访问时间: O(1) → O(1)

【可靠性】
✅ 大幅提升
- 容错性: ❌ → ✅
- 崩溃风险: 高 → 低
- 日志可读性: 中 → 高

【API成本】
✅ 不变
- Qwen仍使用相同的max_tokens (8000)
- 调用次数不变

═══════════════════════════════════════════════════════════════
📝 后续建议
═══════════════════════════════════════════════════════════════

【1】更新配置差异文档
编辑: Qwen_DeepSeek_配置差异说明.md
添加: max_tokens差异（DeepSeek: 16000, Qwen: 8192）

【2】更新同步脚本
编辑: 完全同步deepseek到qwen.sh
添加: sed -i '' 's/max_tokens=16000/max_tokens=8000/g' qwen_多币种智能版.py

【3】全局搜索硬编码访问
cd ~/10-23-bot/ds
grep -n 'market_data\[' deepseek_多币种智能版.py
# 检查是否还有其他地方需要修复

═══════════════════════════════════════════════════════════════
🎊 总结
═══════════════════════════════════════════════════════════════

【修复前】
❌ Qwen无法调用AI（max_tokens超限）
❌ DeepSeek信号评分崩溃（KeyError）
❌ 无法正常开仓

【修复后】
✅ Qwen可正常获取AI决策
✅ DeepSeek信号评分稳定运行
✅ 系统容错性大幅提升
✅ 两个模型都可正常交易

【修改量】
- 文件: 2个（deepseek + qwen）
- 修改点: 21处（1处max_tokens + 20处字段访问）
- 代码行: ~40行修改

【影响范围】
- 🔧 兼容性修复（无功能变更）
- 🛡️ 防御性编程（提升稳定性）
- 📊 日志质量提升（更清晰的错误信息）

═══════════════════════════════════════════════════════════════
📞 联系方式
═══════════════════════════════════════════════════════════════

【遇到问题】
1. 查看日志: tail -f ~/10-23-bot/ds/logs/*.log
2. 查看文档: cat ~/10-23-bot/ds/V8.3.14.1_字段访问修复.md
3. Git提交: e59a962

【验证部署成功】
# 运行5分钟后，查看日志中是否有：
# Qwen: "✅ AI决策已解析"
# DeepSeek: "✓ 信号得分: XX/100"

═══════════════════════════════════════════════════════════════
✅ 部署完成！
═══════════════════════════════════════════════════════════════

记得：
- 监控日志前5分钟，确认无报错
- 检查邮件报告，确认参数正常显示
- 观察实际交易，确认信号评分正常工作

Good luck! 🚀
═══════════════════════════════════════════════════════════════

