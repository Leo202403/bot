# 📊 各阶段输出指标规范

**目的**: 确保每个阶段结束后都有明确的指标和结论，方便后续优化和迭代。

---

## Phase 1：客观机会识别

### 目标
识别所有客观存在的交易机会（不考虑参数限制）

### 输出指标

#### 1️⃣ 基础统计
```
✅ Phase 1 完成：客观机会识别
━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 超短线机会:
   - 总数: 2000个
   - 平均最大利润: 18.17%
   - 平均持仓时间: 4.5小时
   - 盈利机会: 1200个 (60%)

📊 波段机会:
   - 总数: 2000个
   - 平均最大利润: 18.17%
   - 平均持仓时间: 24小时
   - 盈利机会: 1100个 (55%)

💡 关键发现:
   - 总机会数: 4000个
   - 平均最大利润: 18.17%
   - 超短线/波段比例: 1:1
```

#### 2️⃣ 数据保存
- ✅ 机会列表保存到: `phase1_opportunities.json`
- ✅ 包含字段:
  - `symbol`: 币种
  - `timestamp`: 时间戳
  - `direction`: 方向 (long/short)
  - `entry_price`: 入场价格
  - `objective_profit`: 最大潜在利润%
  - `atr`: ATR值
  - `signal_score`: 信号评分
  - `consensus`: 共振数
  - `is_scalping`: 是否超短线

#### 3️⃣ Phase 1 Baseline（供后续对比）
```python
phase1_baseline = {
    'scalping': {
        'count': 2000,
        'avg_objective_profit': 18.17
    },
    'swing': {
        'count': 2000,
        'avg_objective_profit': 18.17
    }
}
```

---

## Phase 2：参数优化（捕获最大化）

### 目标
找到能捕获最多Phase 1机会的参数组合

### 输出指标

#### 1️⃣ 最优参数
```
✅ Phase 2 完成：参数优化
━━━━━━━━━━━━━━━━━━━━━━━━━━

🎯 最优参数配置:
   - min_risk_reward: 3.0
   - min_indicator_consensus: 3
   - atr_stop_multiplier: 2.50
   - atr_tp_multiplier: 6.0
   - max_holding_hours: 96
   - min_signal_score: 92
```

#### 2️⃣ 超短线表现
```
⚡ 超短线:
   - 捕获: 834/2000 (41.7%)
   - 平均利润: 2.36%（已扣除0.14%交易成本）
   - 胜率: 51.7%
   - 盈亏比: 2.1:1
```

#### 3️⃣ 波段表现
```
🌊 波段:
   - 捕获: 80/2000 (4.0%)
   - 平均利润: 3.85%（已扣除0.14%交易成本）
   - 胜率: 55.0%
   - 盈亏比: 2.8:1
```

#### 4️⃣ Phase 2 Baseline（供Phase 3使用）
```python
phase2_baseline = {
    'captured_count': 914,  # 834 + 80
    'capture_rate': 0.2285,  # 22.85%
    'avg_profit': 2.45,
    'params': {
        'min_risk_reward': 3.0,
        'min_indicator_consensus': 3,
        ...
    }
}
```

#### 5️⃣ 前向验证结果
```
🔍 前向验证:
   - 训练集表现: 2.50%
   - 验证集表现: 2.30%
   - 性能衰减: -8.0%
   - 判定: ✅ 通过（衰减<15%）
```

---

## Phase 3：风险控制优化

### 目标
在Phase 2基础上，加入风险控制约束，优化参数

### 约束条件
```
⚠️ 风险约束:
   - 捕获率 >= Phase 2的90%（不能牺牲太多机会）
   - 优化目标: 60%利润 + 40%风险指标
```

### 输出指标

#### 1️⃣ 优化后参数
```
✅ Phase 3 完成：风险控制优化
━━━━━━━━━━━━━━━━━━━━━━━━━━

🎯 优化后参数（vs Phase 2）:
   - min_risk_reward: 3.0 → 3.2 (+6.7%)
   - min_indicator_consensus: 3 → 3（不变）
   - atr_stop_multiplier: 2.50 → 2.30 (-8.0%)
   - min_signal_score: 92 → 94 (+2.2%)
```

#### 2️⃣ 超短线表现对比
```
⚡ 超短线:
   指标           Phase 2    Phase 3    变化
   ────────────────────────────────────────
   捕获率         41.7%      38.5%      -7.7%
   平均利润       2.36%      2.58%      +9.3%
   胜率           51.7%      54.2%      +4.8%
   风险得分       65/100     72/100     +10.8%
```

#### 3️⃣ 波段表现对比
```
🌊 波段:
   指标           Phase 2    Phase 3    变化
   ────────────────────────────────────────
   捕获率         4.0%       3.6%       -10.0%
   平均利润       3.85%      4.20%      +9.1%
   胜率           55.0%      58.3%      +6.0%
   风险得分       70/100     76/100     +8.6%
```

#### 4️⃣ 决策判断
```
💡 Phase 3判定:
   - 捕获率下降: 7.7%（<10%，✅ 符合约束）
   - 平均利润提升: 9.3%（✅ 良好）
   - 风险得分提升: 10.8%（✅ 显著改善）
   - 最终决策: ✅ 采用Phase 3参数
```

---

## Phase 4：参数验证与过拟合检测

### 目标
在全量历史数据上验证参数，检测过拟合

### 输出指标

#### 1️⃣ 全量数据测试（14天）
```
✅ Phase 4 完成：参数验证
━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 1️⃣ 全量数据测试:
   - 样本数: 4000个机会
   - 捕获: 2618个 (65.5%)
   - 平均利润: 0.94%
   - 胜率: 55.7%
```

#### 2️⃣ 分段测试（前50% vs 后50%）
```
📊 2️⃣ 分段测试:
   前期（1300个样本）:
   - 捕获: 1350个，利润: 1.05%，胜率: 57.2%
   
   后期（1318个样本）:
   - 捕获: 1268个，利润: 0.92%，胜率: 55.5%
   
   性能衰减:
   - 利润差异: 12.4%（✅ <30%阈值）
   - 胜率比例: 97.0%（✅ >80%阈值）
```

#### 3️⃣ 过拟合检测
```
🔍 3️⃣ 过拟合检测:
   - 利润差异: 12.4% ✅ （<30%）
   - 胜率比例: 97.0% ✅ （>80%）
   - 判定: ✅ PASSED
```

#### 4️⃣ 稳定性评分
```
📈 4️⃣ 稳定性评分:
   - 基础得分: 100
   - 利润波动扣分: -2.5
   - 胜率下降扣分: -0.7
   - 最终稳定性得分: 96.8/100 ✅
```

#### 5️⃣ 最终参数配置
```
🎯 最终可用参数:

⚡ 超短线参数:
{
    "min_risk_reward": 3.2,
    "min_indicator_consensus": 3,
    "atr_stop_multiplier": 2.30,
    "atr_tp_multiplier": 6.0,
    "max_holding_hours": 12,
    "min_signal_score": 94
}

🌊 波段参数:
{
    "min_risk_reward": 3.2,
    "min_indicator_consensus": 3,
    "atr_stop_multiplier": 2.30,
    "atr_tp_multiplier": 6.5,
    "max_holding_hours": 72,
    "min_signal_score": 94
}
```

#### 6️⃣ 异常检测结果
```
🔍 6️⃣ 异常检测:
   - 低胜率异常: 无
   - 高敏感度异常: 无
   - 低捕获异常: 无
   - 判定: ✅ 无异常
```

#### 7️⃣ 最终判定
```
🎯 5️⃣ 最终判定:
   - 状态: ✅ PASSED
   - 建议: 使用Phase 3参数
   - 预期表现: 捕获率65.5%，利润0.94%，胜率55.7%
```

---

## 输出文件清单

### Phase 1
- `phase1_opportunities.json`: 所有识别的机会
- `phase1_baseline.json`: Phase 1基准数据

### Phase 2
- `phase2_params.json`: 最优参数配置
- `phase2_baseline.json`: Phase 2基准数据
- `phase2_captured_opportunities.json`: 捕获的机会列表

### Phase 3
- `phase3_params.json`: 优化后的参数配置
- `phase3_comparison.json`: Phase 2 vs Phase 3对比

### Phase 4
- `phase4_validation.json`: 验证结果
- `phase4_final_params.json`: 最终参数配置

---

## 阶段间数据流

```
┌─────────────┐
│   Phase 1   │ → 识别4000个机会
│  客观识别   │ → 输出：phase1_baseline
└──────┬──────┘
       │
       ↓
┌─────────────┐
│   Phase 2   │ → 捕获914个(22.85%)
│  参数优化   │ → 输出：phase2_baseline + 最优参数
└──────┬──────┘
       │
       ↓
┌─────────────┐
│   Phase 3   │ → 加入风险约束
│  风险控制   │ → 捕获834个(20.85%)，利润↑9.3%
└──────┬──────┘         → 输出：优化参数
       │
       ↓
┌─────────────┐
│   Phase 4   │ → 全量验证
│  参数验证   │ → 捕获2618个(65.5%)，稳定性96.8/100
└──────┬──────┘         → 输出：最终参数
       │
       ↓
   ✅ 实盘应用
```

---

## 关键指标定义

### 捕获率（Capture Rate）
```
捕获率 = 实际捕获的机会数 / Phase 1识别的总机会数
```

**Phase 2目标**: 最大化捕获率
**Phase 3约束**: 捕获率 >= Phase 2的90%

### 平均利润（Average Profit）
```
平均利润 = Σ(actual_profit_pct) / 捕获数量
```

**注意**: 已扣除0.14%交易成本

### 胜率（Win Rate）
```
胜率 = 盈利交易数 / 总交易数
```

### 风险得分（Risk Score）
```
风险得分 = 100 - (利润波动扣分 + 胜率下降扣分 + 捕获不稳定扣分)
```

### 性能衰减（Performance Degradation）
```
性能衰减 = (训练集指标 - 验证集指标) / 训练集指标
```

**阈值**:
- <15%: ✅ 正常
- 15-30%: ⚠️ 轻微过拟合
- >30%: ❌ 严重过拟合

---

## 实施清单

### 当前实现状态

| 阶段 | 输出完整性 | 状态 |
|-----|-----------|------|
| Phase 1 | ⚠️ 60% | 缺少机会列表保存 |
| Phase 2 | ⚠️ 70% | 缺少详细对比表 |
| Phase 3 | ❌ 30% | 缺少大部分输出 |
| Phase 4 | ✅ 90% | 基本完整 |

### 待优化项

#### Phase 1
- [ ] 保存 `phase1_opportunities.json`
- [ ] 添加盈利机会占比统计
- [ ] 添加持仓时间分布

#### Phase 2
- [ ] 保存 `phase2_captured_opportunities.json`
- [ ] 添加捕获率对比（vs Phase 1）
- [ ] 添加各币种表现细分

#### Phase 3
- [ ] 添加 Phase 2 vs Phase 3 对比表
- [ ] 添加风险得分计算
- [ ] 保存 `phase3_comparison.json`

#### Phase 4
- [x] 修复前期样本太少bug（✅ 已修复）
- [ ] 添加异常类型细分
- [ ] 保存 `phase4_final_params.json`

---

**报告结束**

