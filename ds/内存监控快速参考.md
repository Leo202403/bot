# 内存监控快速参考卡片
V8.5.2.4.89.2

## 🚀 30秒快速开始

```bash
# 1. 安装依赖
pip3 install psutil

# 2. 一键集成
cd /root/10-23-bot/ds
python3 quick_add_memory_monitor.py

# 3. 运行回测
MANUAL_BACKTEST=true python3 deepseek_多币种智能版.py backtest-deepseek

# 4. 如果Killed，查看日志
tail -100 memory_monitor_*.log
```

**最后一个检查点 = OOM位置！**

---

## 📊 日志快速解读

```
[时间] [级别] [检查点] RSS=当前内存 (Δ总增长, +本次增长)
```

### 级别
- **INFO**: 正常（<800MB）
- **WARNING**: 警告（800-950MB）
- **CRITICAL**: 危险（>950MB）⚠️

### 关键指标
- **+本次增长** > 100MB → 🔥 问题点
- **RSS** > 900MB → ⚠️ 即将OOM

---

## 🔥 高危OOM点（重点关注）

| 检查点 | 正常增长 | 异常增长 | 位置 |
|--------|----------|----------|------|
| `加载config_AFTER` | <20MB | >100MB | 第10810行 |
| `创建old_config_AFTER` | <5MB | >50MB | 第10812行 |
| `Phase3_粗筛_START` | <100MB | >200MB | phase3优化器 |
| `邮件生成_START` | <20MB | >50MB | 邮件生成阶段 |

---

## 🔍 OOM分析3步法

1. **定位**：`tail -100 memory_monitor_*.log` → 找最后检查点
2. **分析**：查看"+本次增长"，找增长异常点
3. **优化**：在该位置添加gc.collect()或减少数据量

---

## 📝 日志示例（正常 vs 异常）

### ✅ 正常

```
[INFO] [Phase4_END] RSS=510MB (Δ+450MB, +15MB)
[INFO] [参数变化检测_BEFORE] RSS=512MB (Δ+452MB, +2MB)
[INFO] [加载config_AFTER] RSS=530MB (Δ+470MB, +18MB) ← 正常
[INFO] [创建old_config_AFTER] RSS=535MB (Δ+475MB, +5MB) ← 正常
[INFO] [程序结束] RSS=550MB (Δ+490MB, +15MB)
```

### ❌ 异常（会Killed）

```
[INFO] [Phase4_END] RSS=510MB (Δ+450MB, +15MB)
[INFO] [参数变化检测_BEFORE] RSS=512MB (Δ+452MB, +2MB)
[WARNING] [加载config_AFTER] RSS=850MB (Δ+790MB, +338MB) ← 异常增长！
[CRITICAL] ⚠️ 内存接近危险阈值！当前RSS=850MB
[CRITICAL] [后台监控] RSS=980MB (Δ+920MB)
Killed ← OOM发生在"加载config_AFTER"之后
```

**结论**：`加载config_AFTER`增长了338MB，说明`learning_config.json`过大！

---

## 🛠️ 常见OOM修复方案

| 问题 | 修复 |
|------|------|
| `learning_config.json`过大 | 清理历史数据或分文件存储 |
| `old_config` deepcopy过大 | 确保使用轻量级版本（V8.5.2.4.89.1） |
| Phase数据累积 | 及时释放不需要的变量 |
| 重复加载config | 复用内存中的config |

---

## 📁 文件位置

- **监控器**：`ds/memory_monitor.py`
- **集成脚本**：`ds/quick_add_memory_monitor.py`
- **日志文件**：`ds/memory_monitor_YYYYMMDD_HHMMSS.log`
- **完整文档**：`ds/内存监控集成指南.md`
- **部署指南**：`ds/服务器操作_内存监控部署.txt`

---

## ⚡ 无psutil？用tracemalloc

```python
import tracemalloc

# 启动
tracemalloc.start()

# 检查点
current, peak = tracemalloc.get_traced_memory()
print(f"RSS={current/1024/1024:.2f}MB")
```

---

## 🔄 还原操作

```bash
cd /root/10-23-bot/ds
mv deepseek_多币种智能版.py.monitor_backup deepseek_多币种智能版.py
rm -f memory_monitor_*.log
```

---

## 💡 Pro Tips

1. **实时监控**：`tail -f memory_monitor_*.log`
2. **查看Top增长点**：`grep "Top 10" memory_monitor_*.log -A 15`
3. **只看警告**：`grep "WARNING\|CRITICAL" memory_monitor_*.log`
4. **定位最后检查点**：`tail -20 memory_monitor_*.log | grep "\[INFO\]"`

---

**记住**：最后一个检查点 = OOM位置！🎯

