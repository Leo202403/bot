# V8.5.1.8.1 ä¿®å¤å¤‡ç”¨å¼€ä»“è·¯å¾„ç¼ºå¤±ä¿¡å·å­—æ®µ

## é—®é¢˜æ ¹æº

### å‘ç°è¿‡ç¨‹

æ£€æŸ¥CSVæ–‡ä»¶å‘ç°ï¼š
- 11-16æœ‰6æ¡åŸå§‹å¼€ä»“è®°å½•æ˜¾ç¤ºï¼šä¿¡å·åˆ†æ•°=100.0ï¼Œå…±æŒ¯æŒ‡æ ‡æ•°=0.0
- è¿™äº›å€¼æ˜æ˜¾ä¸å¯¹ï¼ˆåº”è¯¥æ˜¯72/3è¿™æ ·çš„å®é™…è®¡ç®—å€¼ï¼‰

### æ ¹æœ¬åŸå› 

ä»£ç ä¸­æœ‰**3ä¸ªåœ°æ–¹**è°ƒç”¨ `save_open_position()`ï¼š

1. âœ… **ä¸»è·¯å¾„**ï¼ˆç¬¬17939è¡Œï¼‰ï¼š`_execute_single_open_action_v55()` å‡½æ•°
   - åŒ…å« `"ä¿¡å·åˆ†æ•°": score`
   - åŒ…å« `"å…±æŒ¯æŒ‡æ ‡æ•°": indicator_consensus`

2. âŒ **å¤‡ç”¨è·¯å¾„1**ï¼ˆç¬¬18403è¡Œï¼‰ï¼š`execute_portfolio_actions()` å‡½æ•° - åšå¤šå¼€ä»“
   - âŒ ç¼ºå°‘ `"ä¿¡å·åˆ†æ•°"`
   - âŒ ç¼ºå°‘ `"å…±æŒ¯æŒ‡æ ‡æ•°"`

3. âŒ **å¤‡ç”¨è·¯å¾„2**ï¼ˆç¬¬18486è¡Œï¼‰ï¼š`execute_portfolio_actions()` å‡½æ•° - åšç©ºå¼€ä»“
   - âŒ ç¼ºå°‘ `"ä¿¡å·åˆ†æ•°"`
   - âŒ ç¼ºå°‘ `"å…±æŒ¯æŒ‡æ ‡æ•°"`

### ä¸ºä»€ä¹ˆæ˜¯100.0/0.0ï¼Ÿ

å½“ `trade_record` ç¼ºå°‘è¿™ä¸¤ä¸ªå­—æ®µæ—¶ï¼š
1. `save_open_position()` åˆ›å»º DataFrame
2. `df.reindex(columns=STANDARD_COLUMNS)` æ·»åŠ ç¼ºå¤±åˆ—
3. æ–°åˆ—é»˜è®¤å¡«å…… `NaN`
4. **ä½†CSVå†™å…¥æ—¶ï¼ŒæŸäº›NaNè¢«è½¬æ¢æˆäº†æµ®ç‚¹æ•°0.0**
5. **æˆ–è€…åœ¨æŸä¸ªåœ°æ–¹ç”¨äº†é»˜è®¤å€¼100.0/0.0**

## è§£å†³æ–¹æ¡ˆ

### ä¿®å¤æ–¹æ¡ˆ

åœ¨ `execute_portfolio_actions()` å‡½æ•°çš„ä¸¤å¤„å¼€ä»“é€»è¾‘ä¸­æ·»åŠ ä¿¡å·å­—æ®µã€‚

**ä½†é—®é¢˜æ˜¯**ï¼šè¿™ä¸ªå‡½æ•°æ²¡æœ‰ç›´æ¥è®¿é—® `market_data` å’Œ `score`ï¼

éœ€è¦ï¼š
1. æ‰¾åˆ°market_data
2. è®¡ç®—æˆ–è·å–scoreå’Œindicator_consensus
3. æ·»åŠ åˆ°trade_record

### ä»£ç ä½ç½®

**qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py** å’Œ **deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py**

#### ä½ç½®1ï¼šåšå¤šå¼€ä»“ï¼ˆç¬¬18386-18403è¡Œï¼‰

```python
# è®°å½•å¼€ä»“
trade_record = {
    "å¼€ä»“æ—¶é—´": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
    "å¹³ä»“æ—¶é—´": None,
    "å¸ç§": coin_name,
    "æ–¹å‘": "å¤š",
    "æ•°é‡": amount,
    "å¼€ä»“ä»·æ ¼": order.get("average", price) if order else price,
        "å¹³ä»“ä»·æ ¼": None,
    "ä»“ä½(U)": position_usd,
    "æ æ†ç‡": leverage,
    "æ­¢æŸ": action.get("stop_loss_price", 0),
    "æ­¢ç›ˆ": action.get("take_profit_price", 0),
    "ç›ˆäºæ¯”": risk_reward,
    "ç›ˆäº(U)": None,
    "å¼€ä»“ç†ç”±": action.get("reason", "N/A"),
    "å¹³ä»“ç†ç”±": None,
    # âŒ ç¼ºå°‘ï¼š
    # "ä¿¡å·åˆ†æ•°": ???,
    # "å…±æŒ¯æŒ‡æ ‡æ•°": ???,
}
save_open_position(trade_record)
```

#### ä½ç½®2ï¼šåšç©ºå¼€ä»“ï¼ˆç¬¬18469-18486è¡Œï¼‰

åŒæ ·çš„ç»“æ„ï¼Œç¼ºå°‘ä¿¡å·å­—æ®µã€‚

## ä¿®å¤ä»£ç 

### æ­¥éª¤1ï¼šæ‰¾åˆ°market_data

åœ¨ `execute_portfolio_actions()` å‡½æ•°ä¸­ï¼Œæ‰¾åˆ°å¯¹åº”å¸ç§çš„market_dataï¼š

```python
# åœ¨ç¬¬17977è¡Œï¼Œå‡½æ•°ç­¾åï¼š
def execute_portfolio_actions(
    action,
    market_data_list,  # â† è¿™é‡Œæœ‰market_data
    current_positions,
    total_assets,
    available_balance,
):
```

### æ­¥éª¤2ï¼šè®¡ç®—ä¿¡å·æ•°æ®

åœ¨å¼€ä»“å‰ï¼Œæ·»åŠ ï¼š

```python
# ğŸ†• V8.5.1.8.1: è·å–ä¿¡å·æ•°æ®
symbol = action.get("symbol", "")
market_data = next((m for m in market_data_list if m["symbol"] == symbol), None)

if market_data:
    score, _, _, _ = calculate_signal_score(market_data)
    indicator_consensus = market_data.get("indicator_consensus", 0)
else:
    score = 0
    indicator_consensus = 0
```

### æ­¥éª¤3ï¼šæ·»åŠ åˆ°trade_record

```python
trade_record = {
    # ... ç°æœ‰å­—æ®µ ...
    "å¼€ä»“ç†ç”±": action.get("reason", "N/A"),
    "å¹³ä»“ç†ç”±": None,
    "ä¿¡å·åˆ†æ•°": score,  # â† æ·»åŠ 
    "å…±æŒ¯æŒ‡æ ‡æ•°": indicator_consensus,  # â† æ·»åŠ 
}
```

## å®Œæ•´ä¿®å¤ä»£ç 

### qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py (ä½ç½®1: åšå¤š)

```python
# ç¬¬18370-18403è¡Œ
if operation == "OPEN_LONG":
    # ... ç°æœ‰ä»£ç  ...
    
    # ğŸ†• V8.5.1.8.1: è·å–ä¿¡å·æ•°æ®
    symbol = action.get("symbol", "")
    market_data = next((m for m in market_data_list if m["symbol"] == symbol), None)
    
    if market_data:
        score, _, _, _ = calculate_signal_score(market_data)
        indicator_consensus = market_data.get("indicator_consensus", 0)
    else:
        score = 0
        indicator_consensus = 0
    
    # è®°å½•å¼€ä»“
    trade_record = {
        "å¼€ä»“æ—¶é—´": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        "å¹³ä»“æ—¶é—´": None,
        "å¸ç§": coin_name,
        "æ–¹å‘": "å¤š",
        "æ•°é‡": amount,
        "å¼€ä»“ä»·æ ¼": order.get("average", price) if order else price,
            "å¹³ä»“ä»·æ ¼": None,
        "ä»“ä½(U)": position_usd,
        "æ æ†ç‡": leverage,
        "æ­¢æŸ": action.get("stop_loss_price", 0),
        "æ­¢ç›ˆ": action.get("take_profit_price", 0),
        "ç›ˆäºæ¯”": risk_reward,
        "ç›ˆäº(U)": None,
        "å¼€ä»“ç†ç”±": action.get("reason", "N/A"),
        "å¹³ä»“ç†ç”±": None,
        "ä¿¡å·åˆ†æ•°": score,  # ğŸ†• V8.5.1.8.1
        "å…±æŒ¯æŒ‡æ ‡æ•°": indicator_consensus,  # ğŸ†• V8.5.1.8.1
    }
    save_open_position(trade_record)
```

### qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py (ä½ç½®2: åšç©º)

```python
# ç¬¬18453-18486è¡Œ
if operation == "OPEN_SHORT":
    # ... ç°æœ‰ä»£ç  ...
    
    # ğŸ†• V8.5.1.8.1: è·å–ä¿¡å·æ•°æ®
    symbol = action.get("symbol", "")
    market_data = next((m for m in market_data_list if m["symbol"] == symbol), None)
    
    if market_data:
        score, _, _, _ = calculate_signal_score(market_data)
        indicator_consensus = market_data.get("indicator_consensus", 0)
    else:
        score = 0
        indicator_consensus = 0
    
    # è®°å½•å¼€ä»“
    trade_record = {
        "å¼€ä»“æ—¶é—´": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        "å¹³ä»“æ—¶é—´": None,
        "å¸ç§": coin_name,
        "æ–¹å‘": "ç©º",
        "æ•°é‡": amount,
        "å¼€ä»“ä»·æ ¼": order.get("average", price) if order else price,
            "å¹³ä»“ä»·æ ¼": None,
        "ä»“ä½(U)": position_usd,
        "æ æ†ç‡": leverage,
        "æ­¢æŸ": action.get("stop_loss_price", 0),
        "æ­¢ç›ˆ": action.get("take_profit_price", 0),
        "ç›ˆäºæ¯”": risk_reward,
        "ç›ˆäº(U)": None,
        "å¼€ä»“ç†ç”±": action.get("reason", "N/A"),
        "å¹³ä»“ç†ç”±": None,
        "ä¿¡å·åˆ†æ•°": score,  # ğŸ†• V8.5.1.8.1
        "å…±æŒ¯æŒ‡æ ‡æ•°": indicator_consensus,  # ğŸ†• V8.5.1.8.1
    }
    save_open_position(trade_record)
```

## å½±å“èŒƒå›´

- âœ… ä¿®å¤åï¼Œæ‰€æœ‰å¼€ä»“è·¯å¾„éƒ½ä¼šæ­£ç¡®ä¿å­˜ä¿¡å·æ•°æ®
- âœ… ä¸å½±å“ç°æœ‰ä»£ç é€»è¾‘
- âœ… å†å²æ•°æ®ä¿æŒä¸å˜ï¼ˆ100.0/0.0ä»åœ¨ï¼Œä½†æ–°æ•°æ®ä¼šæ­£ç¡®ï¼‰

## éªŒè¯æ–¹æ³•

1. éƒ¨ç½²ä»£ç 
2. ç­‰å¾…æ–°è®¢å•å¼€ä»“
3. æ£€æŸ¥CSVï¼š
```bash
tail -n 1 ds/trading_data/qwen/trades_history.csv | awk -F',' '{print "ä¿¡å·åˆ†æ•°:"$16, "å…±æŒ¯:"$17}'
```

é¢„æœŸè¾“å‡ºï¼š
```
ä¿¡å·åˆ†æ•°:72 å…±æŒ¯:3  # å®é™…è®¡ç®—çš„å€¼ï¼Œä¸å†æ˜¯100.0/0.0
```

## æ€»ç»“

**é—®é¢˜**ï¼šå¤‡ç”¨å¼€ä»“è·¯å¾„ç¼ºå°‘ä¿¡å·å­—æ®µä¿å­˜  
**åŸå› **ï¼š`execute_portfolio_actions()` å‡½æ•°ä¸­çš„å¼€ä»“é€»è¾‘ä¸å®Œæ•´  
**ä¿®å¤**ï¼šåœ¨è¯¥å‡½æ•°ä¸­æ·»åŠ ä¿¡å·æ•°æ®è·å–å’Œä¿å­˜é€»è¾‘  
**ç‰ˆæœ¬**ï¼šV8.5.1.8.1

