# 数据修正方案

## 问题描述

1. **总资产数量错误**: 系统记录的总资产与实际计算值不符
2. **订单记录丢失**: 部分订单未被正确保存到 `trades_history.csv`

## 根本原因分析

### 1. 总资产计算错误

可能原因:
- 平仓后未正确更新 `system_status.json` 中的总资产
- 盈亏累加逻辑有误
- 多次重复计算或遗漏某些交易

**正确的计算公式**:
```
总资产 = 初始资金 + 已实现盈亏 + 未实现盈亏
```

### 2. 订单记录丢失

可能原因:
- 开仓时文件写入失败但未捕获异常
- 程序异常终止导致缓存中的订单未写入
- 文件并发写入冲突
- `system_status.json` 中有持仓但 `trades_history.csv` 缺少对应记录

## 修正方案

### 方案1: 自动修正（推荐）

使用提供的修正工具自动检测和修复:

```bash
cd /Users/mac-bauyu/Downloads/10-23-bot/ds
python3 fix_data_integrity.py
```

工具功能:
1. **自动备份**: 备份所有关键数据文件
2. **完整性检查**: 检查订单记录完整性
3. **重新计算**: 重新计算正确的总资产
4. **自动修正**: 更新 `system_status.json` 中的总资产
5. **订单恢复**: 从持仓信息恢复缺失的订单记录

### 方案2: 手动验证

#### 步骤1: 备份数据

```bash
cd /Users/mac-bauyu/Downloads/10-23-bot/ds
mkdir -p data_backup/$(date +%Y%m%d_%H%M%S)
cp trading_data/deepseek/*.{csv,json} data_backup/$(date +%Y%m%d_%H%M%S)/
cp trading_data/qwen/*.{csv,json} data_backup/$(date +%Y%m%d_%H%M%S)/
```

#### 步骤2: 手动计算总资产

以 DeepSeek 为例:

```python
import json
import csv

# 1. 读取已平仓交易的盈亏
realized_pnl = 0
with open('trading_data/deepseek/trades_history.csv', 'r') as f:
    reader = csv.DictReader(f)
    for trade in reader:
        if trade['平仓时间']:  # 已平仓
            realized_pnl += float(trade['盈亏(U)'] or 0)

# 2. 读取未实现盈亏
with open('trading_data/deepseek/system_status.json', 'r') as f:
    status = json.load(f)
    unrealized_pnl = sum(p['盈亏'] for p in status['持仓详情'])

# 3. 计算总资产
initial_capital = 100.0
correct_total_assets = initial_capital + realized_pnl + unrealized_pnl

print(f"正确总资产: {correct_total_assets:.2f} U")
print(f"当前记录: {status['总资产']:.2f} U")
print(f"差异: {correct_total_assets - status['总资产']:.2f} U")
```

#### 步骤3: 更新 system_status.json

```python
status['总资产'] = correct_total_assets
status['total_assets'] = correct_total_assets

with open('trading_data/deepseek/system_status.json', 'w') as f:
    json.dump(status, f, ensure_ascii=False, indent=2)
```

## 预防措施

### 1. 增强文件写入可靠性

修改策略文件中的订单保存逻辑:

```python
def save_trade_safely(trade_record, trades_file):
    """安全保存交易记录"""
    import fcntl
    import tempfile
    
    try:
        # 使用文件锁防止并发写入
        with open(trades_file, 'a', encoding='utf-8', newline='') as f:
            fcntl.flock(f.fileno(), fcntl.LOCK_EX)
            writer = csv.DictWriter(f, fieldnames=trade_record.keys())
            
            # 如果文件为空，写入表头
            if f.tell() == 0:
                writer.writeheader()
            
            writer.writerow(trade_record)
            f.flush()
            os.fsync(f.fileno())  # 强制写入磁盘
            
            fcntl.flock(f.fileno(), fcntl.LOCK_UN)
        
        print(f"✅ 订单保存成功: {trade_record['订单编号']}")
        return True
        
    except Exception as e:
        print(f"❌ 订单保存失败: {e}")
        # 尝试写入临时备份
        backup_file = f"{trades_file}.backup.{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        with open(backup_file, 'a', encoding='utf-8', newline='') as bf:
            writer = csv.DictWriter(bf, fieldnames=trade_record.keys())
            writer.writerow(trade_record)
        print(f"⚠️  已保存到备份文件: {backup_file}")
        return False
```

### 2. 定期校验

添加定时任务定期校验数据完整性:

```bash
# 添加到 crontab
0 */6 * * * cd /Users/mac-bauyu/Downloads/10-23-bot/ds && python3 fix_data_integrity.py --check-only >> /tmp/data_check.log 2>&1
```

### 3. 数据一致性检查

在策略文件中添加启动时的数据校验:

```python
def validate_data_integrity():
    """启动时校验数据完整性"""
    # 1. 检查持仓数量是否一致
    with open(STATUS_FILE, 'r') as f:
        status = json.load(f)
    
    status_positions = len(status.get('持仓详情', []))
    
    with open(TRADES_FILE, 'r') as f:
        reader = csv.DictReader(f)
        open_trades = sum(1 for t in reader if not t.get('平仓时间'))
    
    if status_positions != open_trades:
        print(f"⚠️  数据不一致: status持仓({status_positions}) != trades未平仓({open_trades})")
        print("   建议运行: python3 fix_data_integrity.py")
        return False
    
    # 2. 校验总资产
    realized_pnl = 0
    with open(TRADES_FILE, 'r') as f:
        reader = csv.DictReader(f)
        for trade in reader:
            if trade['平仓时间']:
                realized_pnl += float(trade['盈亏(U)'] or 0)
    
    unrealized_pnl = sum(p['盈亏'] for p in status['持仓详情'])
    correct_total = 100.0 + realized_pnl + unrealized_pnl
    
    if abs(correct_total - status['总资产']) > 0.1:
        print(f"⚠️  总资产异常: 记录({status['总资产']:.2f}) vs 计算({correct_total:.2f})")
        return False
    
    print("✅ 数据完整性校验通过")
    return True
```

## 紧急恢复

如果修正工具无法解决问题:

### 完全重建交易历史

```python
# rebuild_history.py
import json
import csv
from pathlib import Path

def rebuild_from_scratch(model_name):
    """从市场快照和当前状态重建完整历史"""
    data_dir = Path(f"trading_data/{model_name}")
    
    # 1. 收集所有市场快照中的交易记录
    snapshots_dir = data_dir / "market_snapshots"
    all_trades = {}
    
    for snapshot_file in sorted(snapshots_dir.glob("*.csv")):
        with open(snapshot_file, 'r') as f:
            reader = csv.DictReader(f)
            for row in reader:
                order_id = row.get('订单编号')
                if order_id and order_id not in all_trades:
                    all_trades[order_id] = row
    
    # 2. 添加当前持仓
    with open(data_dir / "system_status.json", 'r') as f:
        status = json.load(f)
        for pos in status.get('持仓详情', []):
            order_id = pos.get('订单编号')
            if order_id and order_id not in all_trades:
                all_trades[order_id] = pos
    
    # 3. 重建trades_history.csv
    # ... (省略实现细节)
    
    print(f"✅ 已重建 {len(all_trades)} 条交易记录")
```

## 常见问题

### Q1: 修正后总资产还是不对?

**A**: 检查是否有以下情况:
- 初始资金设置错误（应为100U）
- 存在未记录的手动交易
- 盈亏计算公式有误

### Q2: 订单恢复后系统报错?

**A**: 检查恢复的订单字段是否完整，特别是:
- `订单编号`（必须唯一）
- `开仓时间`、`开仓价格`、`数量`、`杠杆`

### Q3: 修正工具运行失败?

**A**: 尝试手动方案或检查:
- Python版本（需要3.7+）
- 文件权限
- 磁盘空间

## 联系支持

如果问题仍未解决，请提供:
1. 备份文件
2. 修正工具的完整输出
3. 两个模型的 `system_status.json` 内容

