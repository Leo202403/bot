#!/bin/bash
# V8.5.2.4.66 é€€å‡ºæ–¹å¼ç»Ÿè®¡åˆ†æ - ä¸€é”®è¿è¡Œè„šæœ¬

set -e

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” V8.5.2.4.66 é€€å‡ºæ–¹å¼ç»Ÿè®¡åˆ†æ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# æ£€æŸ¥æ˜¯å¦æœ‰ç°æˆçš„å›æµ‹æ—¥å¿—
if [ -f "backtest_latest.log" ]; then
    echo "ğŸ“ å‘ç°ç°æœ‰å›æµ‹æ—¥å¿—: backtest_latest.log"
    read -p "æ˜¯å¦ä½¿ç”¨ç°æœ‰æ—¥å¿—ï¼Ÿ(y/n, é»˜è®¤n): " use_existing
    use_existing=${use_existing:-n}
else
    use_existing="n"
fi

if [ "$use_existing" != "y" ]; then
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“Š Step 1: è¿è¡Œå›æµ‹ï¼ˆçº¦5-8åˆ†é’Ÿï¼‰"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    # åœæ­¢æœåŠ¡
    echo "â¸ï¸  åœæ­¢AIæœåŠ¡..."
    supervisorctl stop deepseek qwen > /dev/null 2>&1 || true
    
    # è¿è¡Œå›æµ‹
    echo "ğŸš€ å¼€å§‹å›æµ‹..."
    MANUAL_BACKTEST=true python3 deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py backtest-deepseek 2>&1 | tee backtest_latest.log
    
    # é‡å¯æœåŠ¡
    echo ""
    echo "â–¶ï¸  é‡å¯AIæœåŠ¡..."
    supervisorctl start deepseek qwen > /dev/null 2>&1 || true
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” Step 2: æå–è°ƒè¯•ä¿¡æ¯"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# æå–é€€å‡ºæ–¹å¼æ•°æ®
echo "ğŸ“ æå–'é€€å‡ºæ–¹å¼'è°ƒè¯•è¾“å‡º..."
grep "é€€å‡ºæ–¹å¼" backtest_latest.log > exit_methods_raw.log 2>/dev/null || true

# æ£€æŸ¥æ˜¯å¦æå–åˆ°æ•°æ®
line_count=$(wc -l < exit_methods_raw.log)
echo "âœ… æå–åˆ° $line_count æ¡è°ƒè¯•è®°å½•"

if [ "$line_count" -eq 0 ]; then
    echo ""
    echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°è°ƒè¯•è¾“å‡º"
    echo "ğŸ’¡ å¯èƒ½åŸå› ï¼š"
    echo "   1. å›æµ‹æœªæ­£å¸¸è¿è¡Œ"
    echo "   2. V8.5.2.4.65è°ƒè¯•æ—¥å¿—æœªå¯ç”¨"
    echo "   3. æ—¥å¿—æ–‡ä»¶è·¯å¾„é”™è¯¯"
    echo ""
    echo "è¯·æ£€æŸ¥ backtest_latest.log æ–‡ä»¶å†…å®¹"
    exit 1
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š Step 3: ç»Ÿè®¡åˆ†æ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# è¿è¡Œåˆ†æ
cat exit_methods_raw.log | python3 analyze_exit_simple.py | tee exit_analysis_result.txt

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… åˆ†æå®Œæˆ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶ï¼š"
echo "   - backtest_latest.log       (å®Œæ•´å›æµ‹æ—¥å¿—)"
echo "   - exit_methods_raw.log      (é€€å‡ºæ–¹å¼åŸå§‹æ•°æ®)"
echo "   - exit_analysis_result.txt  (åˆ†æç»“æœ)"
echo ""
echo "ğŸ’¡ ä¸‹ä¸€æ­¥ï¼š"
echo "   1. æŸ¥çœ‹ exit_analysis_result.txt åˆ†æé—®é¢˜æ ¹æº"
echo "   2. æ ¹æ®ã€å‡†ç¡®ç‡ä¼°ç®—ã€‘åˆ¤æ–­æ³¢åŠ¨å¹…åº¦æ³•æ˜¯å¦æœ‰æ•ˆ"
echo "   3. å†³å®šä¿®å¤æ–¹æ¡ˆï¼ˆä¿®å¤/é™ä½TP/æ—¶é—´åºåˆ—ï¼‰"
echo ""

