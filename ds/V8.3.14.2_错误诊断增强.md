# V8.3.14.2 é”™è¯¯è¯Šæ–­å¢å¼º

**æ—¥æœŸ**: 2025-11-07  
**ç‰ˆæœ¬**: V8.3.14.2  
**é—®é¢˜**: "ä¿¡å·è¯„åˆ†è·¯ç”±å¤±è´¥: 'captured_count'" é—®é¢˜ä»ç„¶å­˜åœ¨  

---

## ğŸ” é—®é¢˜åˆ†æ

### é”™è¯¯ä¿¡æ¯

```
âš ï¸ ä¿¡å·è¯„åˆ†è·¯ç”±å¤±è´¥: 'captured_count'
âœ“ ä¿¡å·å¾—åˆ†: 50/100 | ä¿¡å·ç±»å‹: scalping (AIæŒ‡å®š)
âŒ scalpingä¿¡å·å¾—åˆ†50 < æœ€ä½è¦æ±‚75ï¼Œæ‹’ç»å¼€ä»“
```

### é—®é¢˜è¯Šæ–­

1. **é”™è¯¯ä½ç½®**: `calculate_signal_score` å‡½æ•°çš„ except å—
2. **é”™è¯¯ç±»å‹**: `KeyError('captured_count')`
3. **ç–‘é—®**: `captured_count` ä¸æ˜¯ `market_data` åº”è¯¥æœ‰çš„å­—æ®µ

**å¯èƒ½çš„åŸå› **:
- â“ `market_data` ç»“æ„å¼‚å¸¸ï¼ˆåŒ…å«äº†ä¼˜åŒ–/æ¨¡æ‹Ÿç»“æœçš„æ•°æ®ï¼‰
- â“ æŸä¸ªåµŒå¥—å­—å…¸è®¿é—®å‡ºé”™
- â“ `classify_signal_type` æˆ–è¯„åˆ†å‡½æ•°ä¸­çš„æŸä¸ªåœ°æ–¹è®¿é—®äº†é”™è¯¯çš„å­—æ®µ

---

## âœ… V8.3.14.2 ä¿®å¤å†…å®¹

### å¢å¼ºé”™è¯¯è¯Šæ–­

**ä¿®æ”¹ä½ç½®**: `calculate_signal_score` å‡½æ•°çš„ except å—ï¼ˆLine ~12859-12886ï¼‰

#### ä¿®æ”¹å‰
```python
except Exception as e:
    print(f"âš ï¸ ä¿¡å·è¯„åˆ†è·¯ç”±å¤±è´¥: {e}")
    # Fallbackï¼šè¿”å›é»˜è®¤å€¼
    signal_classification = classify_signal_type(market_data)
    signal_type = signal_classification.get('signal_type', 'swing')
    
    # æ ¹æ®ä¿¡å·ç±»å‹è¿”å›é»˜è®¤å€¼
    if signal_type == 'scalping':
        return 50, 0.15, 1, signal_classification
    else:
        return 50, 0.25, 2, signal_classification
```

#### ä¿®æ”¹å
```python
except Exception as e:
    print(f"âš ï¸ ä¿¡å·è¯„åˆ†è·¯ç”±å¤±è´¥: {e}")
    # ã€V8.3.14.2ã€‘å¢å¼ºé”™è¯¯è¯Šæ–­
    print(f"  è°ƒè¯•ä¿¡æ¯: market_dataç±»å‹={type(market_data)}")
    if isinstance(market_data, dict):
        print(f"  market_data keys: {list(market_data.keys())[:10]}")  # åªæ˜¾ç¤ºå‰10ä¸ª
    import traceback
    traceback.print_exc()
    
    # Fallbackï¼šè¿”å›é»˜è®¤å€¼
    try:
        signal_classification = classify_signal_type(market_data)
    except:
        # å¦‚æœclassify_signal_typeä¹Ÿå¤±è´¥ï¼Œä½¿ç”¨å®Œå…¨é»˜è®¤å€¼
        signal_classification = {
            'signal_type': 'swing',
            'signal_name': 'DEFAULT',
            'expected_holding_minutes': 120,
            'reason': 'è¯„åˆ†å¤±è´¥ï¼Œé»˜è®¤æ³¢æ®µ'
        }
    
    signal_type = signal_classification.get('signal_type', 'swing')
    
    # æ ¹æ®ä¿¡å·ç±»å‹è¿”å›é»˜è®¤å€¼
    if signal_type == 'scalping':
        return 50, 0.15, 1, signal_classification  # è¶…çŸ­çº¿é»˜è®¤å€¼
    else:
        return 50, 0.25, 2, signal_classification  # æ³¢æ®µé»˜è®¤å€¼
```

---

## ğŸ“Š è¯Šæ–­ä¿¡æ¯è¾“å‡º

### æ–°å¢è¾“å‡ºå†…å®¹

å½“é”™è¯¯å†æ¬¡å‘ç”Ÿæ—¶ï¼Œå°†è¾“å‡ºï¼š

```python
âš ï¸ ä¿¡å·è¯„åˆ†è·¯ç”±å¤±è´¥: 'captured_count'
  è°ƒè¯•ä¿¡æ¯: market_dataç±»å‹=<class 'dict'>
  market_data keys: ['symbol', 'price', 'price_action', 'support_resistance', ...]
Traceback (most recent call last):
  File "...", line XXX, in calculate_signal_score
    ...
KeyError: 'captured_count'
```

### è¯Šæ–­ç›®æ ‡

é€šè¿‡è¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šï¼š
1. **market_dataçš„ç±»å‹** - æ˜¯å¦æ˜¯å­—å…¸
2. **market_dataçš„keys** - åŒ…å«å“ªäº›å­—æ®µï¼ˆå‰10ä¸ªï¼‰
3. **å®Œæ•´çš„é”™è¯¯å †æ ˆ** - å‡†ç¡®å®šä½å‡ºé”™çš„ä»£ç è¡Œ

---

## ğŸš€ ç«‹å³éƒ¨ç½²

### æœåŠ¡å™¨éƒ¨ç½²æ­¥éª¤

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
cd ~/10-23-bot
git pull origin main

# 2. åœæ­¢æœåŠ¡
screen -S ai-deepseek -X quit
screen -S ai-qwen -X quit

# 3. é‡å¯æœåŠ¡
screen -dmS ai-deepseek bash -c 'cd ~/10-23-bot/ds && set -a; source .env; set +a; exec venv/bin/python -u deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py 2>&1 | tee -a logs/deepseek_trading.log'

screen -dmS ai-qwen bash -c 'cd ~/10-23-bot/ds && set -a; source .env.qwen; set +a; exec venv/bin/python -u qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py 2>&1 | tee -a logs/qwen_trading.log'

# 4. ç›‘æ§æ—¥å¿—ï¼Œç­‰å¾…é”™è¯¯å†æ¬¡å‡ºç°
tail -f ~/10-23-bot/ds/logs/deepseek_trading.log | grep -A 20 "ä¿¡å·è¯„åˆ†è·¯ç”±å¤±è´¥"
```

### é¢„æœŸè¾“å‡º

å¦‚æœé”™è¯¯å†æ¬¡å‘ç”Ÿï¼Œä½ ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„è¯¦ç»†è¾“å‡ºï¼š

```
âš ï¸ ä¿¡å·è¯„åˆ†è·¯ç”±å¤±è´¥: 'captured_count'
  è°ƒè¯•ä¿¡æ¯: market_dataç±»å‹=<class 'dict'>
  market_data keys: ['symbol', 'price', 'price_action', 'support_resistance', 'volume_analysis', 'rsi', 'macd', 'ytc_signals', 'long_term', 'mid_term']
Traceback (most recent call last):
  File "/home/admin/10-23-bot/ds/deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py", line 12847, in calculate_signal_score
    score, position_ratio, leverage = calculate_scalping_score(market_data)
  File "/home/admin/10-23-bot/ds/deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py", line 12XXX, in calculate_scalping_score
    some_value = market_data['price_action']['captured_count']
KeyError: 'captured_count'
```

---

## ğŸ“ åç»­å¤„ç†

### æ­¥éª¤1ï¼šæ”¶é›†è¯Šæ–­ä¿¡æ¯

å½“é”™è¯¯å†æ¬¡å‘ç”Ÿæ—¶ï¼Œ**å®Œæ•´å¤åˆ¶æ—¥å¿—è¾“å‡º**ï¼Œç‰¹åˆ«æ˜¯ï¼š
- âœ… market_dataçš„ç±»å‹
- âœ… market_dataçš„keysåˆ—è¡¨
- âœ… å®Œæ•´çš„Tracebackï¼ˆç‰¹åˆ«æ˜¯æœ€åå‡ è¡Œï¼‰

### æ­¥éª¤2ï¼šæ ¹æ®è¯Šæ–­ä¿¡æ¯ä¿®å¤

æ ¹æ®Tracebackï¼Œæˆ‘ä»¬å¯ä»¥ï¼š
1. **å®šä½å‡†ç¡®çš„é”™è¯¯è¡Œ** - çŸ¥é“æ˜¯å“ªä¸€è¡Œä»£ç å‡ºé”™
2. **äº†è§£æ•°æ®ç»“æ„** - çœ‹åˆ°market_dataå®é™…åŒ…å«ä»€ä¹ˆ
3. **é’ˆå¯¹æ€§ä¿®å¤** - ä¿®æ”¹å…·ä½“å‡ºé”™çš„é‚£ä¸€è¡Œ

### æ­¥éª¤3ï¼šéªŒè¯ä¿®å¤

ä¿®å¤åé‡æ–°éƒ¨ç½²ï¼Œç¡®è®¤é”™è¯¯ä¸å†å‡ºç°ã€‚

---

## ğŸ¯ å¯èƒ½çš„é—®é¢˜æ¥æº

åŸºäºå½“å‰çš„åˆ†æï¼Œå¯èƒ½çš„é—®é¢˜æ¥æºåŒ…æ‹¬ï¼š

### 1. åµŒå¥—å­—å…¸è®¿é—®é—®é¢˜

```python
# å¯èƒ½çš„é—®é¢˜ä»£ç 
pa = market_data.get("price_action", {})
volume_surge = pa["volume_surge"]  # å¦‚æœpa["volume_surge"]æ˜¯å­—ç¬¦ä¸²è€Œéå­—å…¸
surge_type = volume_surge["type"]  # ä¼šåœ¨è¿™é‡Œå‡ºé”™
```

**è§£å†³æ–¹æ¡ˆ**: å§‹ç»ˆä½¿ç”¨ `.get()` æ–¹æ³•
```python
volume_surge = pa.get("volume_surge", {})
surge_type = volume_surge.get("type", "")
```

### 2. market_dataè¢«æ±¡æŸ“

```python
# å¯èƒ½çš„é—®é¢˜åœºæ™¯
market_data = simulate_params_on_opportunities(...)  # è¿”å›åŒ…å«captured_countçš„ç»“æœ
# ç„¶åé”™è¯¯åœ°ä¼ ç»™äº†calculate_signal_score
score = calculate_signal_score(market_data)  # å‡ºé”™
```

**è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿ä¼ å…¥çš„æ˜¯æ­£ç¡®çš„å¸‚åœºæ•°æ®

### 3. classify_signal_typeä¸­çš„é—®é¢˜

```python
# classify_signal_typeä¸­å¯èƒ½çš„é—®é¢˜
kline_list = market_data.get("kline_data", [])
if kline_list:
    latest = kline_list[-1]
    high = latest["high"]  # å¦‚æœlatestä¸æ˜¯å­—å…¸ï¼Œä¼šå‡ºé”™
```

**è§£å†³æ–¹æ¡ˆ**: éªŒè¯æ•°æ®ç±»å‹
```python
if kline_list and isinstance(latest, dict):
    high = latest.get("high", 0)
```

---

## ğŸ”§ æ”¹è¿›ç‚¹

### 1. æ›´å¥å£®çš„é”™è¯¯å¤„ç†

- âœ… æ‰“å°market_dataçš„ç±»å‹
- âœ… æ‰“å°market_dataçš„keys
- âœ… å®Œæ•´çš„é”™è¯¯å †æ ˆ
- âœ… classify_signal_typeçš„fallbackå¤„ç†

### 2. æ•°æ®éªŒè¯

å»ºè®®åœ¨`calculate_signal_score`å¼€å¤´æ·»åŠ æ•°æ®éªŒè¯ï¼š

```python
def calculate_signal_score(market_data):
    # ã€å»ºè®®ã€‘æ·»åŠ æ•°æ®éªŒè¯
    if not isinstance(market_data, dict):
        print(f"âŒ market_dataç±»å‹é”™è¯¯: {type(market_data)}")
        return 50, 0.15, 1, {
            'signal_type': 'swing',
            'signal_name': 'INVALID_DATA',
            'expected_holding_minutes': 120,
            'reason': 'market_dataç±»å‹é”™è¯¯'
        }
    
    required_keys = ['price_action', 'support_resistance', 'volume_analysis']
    missing_keys = [k for k in required_keys if k not in market_data]
    if missing_keys:
        print(f"âš ï¸ market_dataç¼ºå°‘å­—æ®µ: {missing_keys}")
        # ç»§ç»­æ‰§è¡Œï¼Œä½†ä¼šä½¿ç”¨é»˜è®¤å€¼
    
    # ... åŸæœ‰ä»£ç  ...
```

---

## ğŸ“Š ç»Ÿè®¡

- **ä¿®æ”¹æ–‡ä»¶**: 2ä¸ªï¼ˆdeepseek + qwenï¼‰
- **ä¿®æ”¹å‡½æ•°**: 1ä¸ªï¼ˆcalculate_signal_scoreçš„exceptå—ï¼‰
- **æ–°å¢ä»£ç **: ~15è¡Œ
- **è¯Šæ–­è¾“å‡º**: 3é¡¹ï¼ˆç±»å‹ + keys + tracebackï¼‰

---

## ğŸŠ æ€»ç»“

### V8.3.14.2çš„ç›®æ ‡

- âœ… **ä¸æ˜¯ä¿®å¤é—®é¢˜**ï¼ˆå› ä¸ºæˆ‘ä»¬è¿˜ä¸çŸ¥é“å‡†ç¡®çš„é”™è¯¯ä½ç½®ï¼‰
- âœ… **è€Œæ˜¯å¢å¼ºè¯Šæ–­**ï¼ˆè®©é”™è¯¯å†æ¬¡å‘ç”Ÿæ—¶ï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°è¯¦ç»†ä¿¡æ¯ï¼‰

### ä¸‹ä¸€æ­¥

1. **éƒ¨ç½²V8.3.14.2** - å¢å¼ºé”™è¯¯è¯Šæ–­
2. **ç­‰å¾…é”™è¯¯å†æ¬¡å‘ç”Ÿ** - æ”¶é›†è¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯
3. **åˆ†æè¯Šæ–­ä¿¡æ¯** - å®šä½å‡†ç¡®çš„é”™è¯¯ä½ç½®
4. **é’ˆå¯¹æ€§ä¿®å¤** - ä¿®æ”¹å…·ä½“å‡ºé”™çš„ä»£ç 
5. **éªŒè¯ä¿®å¤** - ç¡®è®¤é—®é¢˜è§£å†³

---

**éƒ¨ç½²æ—¶é—´**: ç«‹å³  
**é¢„æœŸæ•ˆæœ**: å½“é”™è¯¯å†æ¬¡å‘ç”Ÿæ—¶ï¼Œå¯ä»¥çœ‹åˆ°è¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯  
**çŠ¶æ€**: âœ… å·²å‡†å¤‡å¥½éƒ¨ç½²  

---

