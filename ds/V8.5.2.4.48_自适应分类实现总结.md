# V8.5.2.4.48 è‡ªé€‚åº”åˆ†ç±»å®ç°æ€»ç»“

## ğŸ“‹ æ¦‚è¿°

å®ç°äº†åŸºäº**åˆ©æ¶¦å¯†åº¦**çš„ä¸‰é˜¶æ®µè‡ªé€‚åº”åˆ†ç±»ç³»ç»Ÿï¼Œå½»åº•è§£å†³äº†"å¿«é€Ÿå¤§æ¶¨å½’ç±»ä¸ºè¶…çŸ­çº¿ï¼Œç¼“æ…¢å°æ¶¨å½’ç±»ä¸ºæ³¢æ®µ"çš„çŸ›ç›¾ã€‚

---

## ğŸ¯ æ ¸å¿ƒåˆ›æ–°

### é—®é¢˜ï¼šå›ºå®šé˜ˆå€¼çš„çŸ›ç›¾

```
åœºæ™¯A: å¿«é€Ÿä¸Šæ¶¨åˆ°12% (1å°æ—¶) â†’ å›ºå®šé˜ˆå€¼: æ³¢æ®µ â†’ å®é™…: åº”ä¸ºè¶…çŸ­çº¿ âŒ
åœºæ™¯B: ç¼“æ…¢ä¸Šæ¶¨åˆ°7%  (6å°æ—¶) â†’ å›ºå®šé˜ˆå€¼: è¶…çŸ­çº¿ â†’ å®é™…: åº”ä¸ºæ³¢æ®µ âŒ
```

### è§£å†³æ–¹æ¡ˆï¼šåˆ©æ¶¦å¯†åº¦é©±åŠ¨

```python
profit_density = max_profit / holding_hours

# åˆ†ç±»é€»è¾‘ï¼š
- é«˜å¯†åº¦ (å¦‚12%/1h=12) â†’ è¶…çŸ­çº¿ âœ…
- ä½å¯†åº¦ (å¦‚7%/6h=1.2) â†’ æ³¢æ®µ âœ…
- åŠ¨æ€é˜ˆå€¼ï¼šæ ¹æ®å¸‚åœºæ³¢åŠ¨è‡ªåŠ¨è°ƒæ•´
```

---

## ğŸ“Š ä¸‰é˜¶æ®µæµç¨‹

### Phase 1.1: æ”¶é›†ç›ˆåˆ©æœºä¼šï¼ˆä¸åˆ†ç±»ï¼‰

```python
# ç»Ÿä¸€è·Ÿè¸ªï¼šåªè¦è¾¾åˆ°5%å°±è®°å½•
for each_snapshot:
    if profit >= 5%:
        holding_hours = bars_to_max_profit * 0.25
        profit_density = profit / holding_hours
        all_profit_opportunities.append({
            'profit': profit,
            'holding_hours': holding_hours,
            'profit_density': profit_density,
            # ... å…¶ä»–å­—æ®µ
        })
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä¸é¢„è®¾åˆ†ç±»ï¼Œé¿å…åè§
- âœ… è½»é‡çº§æ•°æ®ï¼Œå†…å­˜å‹å¥½
- âœ… æŒ‰å¸ç§å¤„ç†ï¼ŒåŠæ—¶é‡Šæ”¾

### Phase 1.2: ç»Ÿè®¡åˆ†æä¸åŠ¨æ€é˜ˆå€¼

```python
# è®¡ç®—åˆ†ä½æ•°
stats = {
    'profit': {'q25': 6%, 'median': 9%, 'q75': 14%},
    'holding_hours': {'q25': 0.5h, 'median': 1.5h, 'q75': 4h},
    'profit_density': {'q75': 8, 'q85': 15, 'q90': 25}
}

# è¯†åˆ«å¸‚åœºçŠ¶æ€
if avg_profit > 15%:
    market_state = 'high_volatility'
elif avg_profit > 10%:
    market_state = 'medium_volatility'
else:
    market_state = 'low_volatility'

# åŠ¨æ€ç¡®å®šé˜ˆå€¼
if market_state == 'high_volatility':
    thresholds = {
        'swing_min_profit': stats['profit']['q75'],      # 14%
        'swing_min_holding': stats['holding_hours']['median'],  # 1.5h
        'high_density_threshold': stats['profit_density']['q85']  # 15
    }
```

**ä¼˜åŠ¿**ï¼š
- âœ… è‡ªé€‚åº”å¸‚åœºæ³¢åŠ¨
- âœ… é«˜æ³¢åŠ¨å¸‚åœºï¼šæé«˜é˜ˆå€¼ï¼ˆé¿å…æŠŠå¿«é€Ÿå¤§æ¶¨è¯¯åˆ†ä¸ºæ³¢æ®µï¼‰
- âœ… ä½æ³¢åŠ¨å¸‚åœºï¼šé™ä½é˜ˆå€¼ï¼ˆç¡®ä¿æœ‰è¶³å¤Ÿæ ·æœ¬ï¼‰

### Phase 1.3: è‡ªé€‚åº”åˆ†ç±»

```python
for opp in all_profit_opportunities:
    # è§„åˆ™1ï¼šé«˜å¯†åº¦ â†’ è¶…çŸ­çº¿
    if density > high_density_threshold:
        signal_type = 'scalping'
        reason = f'é«˜å¯†åº¦{density:.1f}'
    
    # è§„åˆ™2ï¼šå¤§åˆ©æ¶¦+é•¿æ—¶é—´ â†’ æ³¢æ®µ
    elif profit >= swing_min_profit and holding_hours >= swing_min_holding:
        signal_type = 'swing'
        reason = f'å¤§åˆ©æ¶¦{profit:.1f}%+é•¿æŒä»“{holding_hours:.1f}h'
    
    # è§„åˆ™3ï¼šå…¶ä»– â†’ è·ç¦»åˆ¤æ–­
    else:
        scalping_distance = abs(density - high_density_threshold) / high_density_threshold
        swing_distance = (
            abs(profit - q75_profit) / q75_profit +
            abs(holding_hours - q75_holding) / q75_holding
        )
        signal_type = 'scalping' if scalping_distance < swing_distance else 'swing'
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¤šè§„åˆ™èåˆï¼Œé¿å…å•ä¸€æ ‡å‡†
- âœ… è·ç¦»åˆ¤æ–­ï¼šåŸºäºç‰¹å¾ç›¸ä¼¼åº¦
- âœ… è®°å½•åˆ†ç±»åŸå› ï¼Œä¾¿äºè°ƒè¯•

### Phase 1.4: éªŒè¯åˆ†ç±»è´¨é‡

```python
# æ£€æŸ¥1ï¼šæ ·æœ¬æ•°
if len(scalping_opps) >= 10 and len(swing_opps) >= 10:
    # æ£€æŸ¥2ï¼šç‰¹å¾å·®å¼‚
    checks = {
        'æ³¢æ®µåˆ©æ¶¦>è¶…çŸ­çº¿': swing_avg_profit > scalping_avg_profit,
        'æ³¢æ®µæ—¶é—´>è¶…çŸ­çº¿': swing_avg_hours > scalping_avg_hours,
        'è¶…çŸ­çº¿å¯†åº¦>æ³¢æ®µ': scalping_avg_density > swing_avg_density,
    }
    
    # è‡³å°‘é€šè¿‡2/3æ£€æŸ¥
    if sum(checks.values()) >= 2:
        print("âœ… åˆ†ç±»è´¨é‡åˆæ ¼")
    else:
        print("âš ï¸ åˆ†ç±»è´¨é‡ä¸ä½³ï¼Œä½†ç»§ç»­ä½¿ç”¨")
```

**ä¼˜åŠ¿**ï¼š
- âœ… è‡ªåŠ¨éªŒè¯åˆ†ç±»æœ‰æ•ˆæ€§
- âœ… ç¡®ä¿è¶…çŸ­çº¿/æ³¢æ®µæœ‰æ˜æ˜¾åŒºåˆ†
- âœ… æä¾›è´¨é‡åé¦ˆ

---

## ğŸ’¾ å†…å­˜ä¼˜åŒ–ç­–ç•¥

1. **æŒ‰å¸ç§å¤„ç†**ï¼šå¤„ç†å®Œä¸€ä¸ªå¸ç§ç«‹å³é‡Šæ”¾ DataFrame
2. **è½»é‡çº§æ•°æ®**ï¼šPhase 1.1åªè®°å½•å¿…è¦å­—æ®µ
3. **åŠæ—¶GC**ï¼šå…³é”®ä½ç½®è°ƒç”¨ `gc.collect()`
4. **ä¸é‡‡æ ·**ï¼šå…¨ç‚¹ä½åˆ†æï¼ˆä½†é€Ÿåº¦æ…¢ä¸€ç‚¹ï¼‰

```python
for coin in coins_list:
    # å¤„ç†è¯¥å¸ç§
    all_profit_opportunities.append(...)
    
    # ç«‹å³é‡Šæ”¾
    del coin_data
    gc.collect()
```

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | å›ºå®šé˜ˆå€¼ | è‡ªé€‚åº”åˆ†ç±» |
|------|---------|-----------|
| **è¶…çŸ­çº¿å¹³å‡åˆ©æ¶¦** | 6-8% | **7-10%** âœ… |
| **æ³¢æ®µå¹³å‡åˆ©æ¶¦** | 12-15% | **15-25%** âœ… |
| **è¶…çŸ­çº¿å¹³å‡æ—¶é—´** | 0.6h | **1-2h** âœ… |
| **æ³¢æ®µå¹³å‡æ—¶é—´** | 0.6hâŒ | **4-8h** âœ… |
| **åˆ©æ¶¦å…³ç³»** | æ³¢æ®µ>è¶…çŸ­çº¿ | **æ³¢æ®µ>è¶…çŸ­çº¿** âœ… |
| **æ—¶é—´å…³ç³»** | æ³¢æ®µ<è¶…çŸ­çº¿âŒ | **æ³¢æ®µ>è¶…çŸ­çº¿** âœ… |
| **å¸‚åœºé€‚åº”æ€§** | âŒ å›ºå®š | âœ… åŠ¨æ€è°ƒæ•´ |

---

## ğŸ”§ ä¿®æ”¹æ–‡ä»¶

### Deepseek (å·²å®Œæˆ âœ…)
- **æ–‡ä»¶**: `/Users/mac-bauyu/Downloads/10-23-bot/ds/deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py`
- **å‡½æ•°**: `analyze_separated_opportunities` (lines 22217-22756)
- **çŠ¶æ€**: âœ… å·²å®ç°ï¼Œæ— è¯­æ³•é”™è¯¯

### Qwen (è¿›è¡Œä¸­ ğŸ”„)
- **æ–‡ä»¶**: `/Users/mac-bauyu/Downloads/10-23-bot/ds/qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py`
- **å‡½æ•°**: `analyze_separated_opportunities` (lines 22082-22577)
- **çŠ¶æ€**: ğŸ”„ éœ€è¦åŒæ­¥

---

## ğŸš€ åŒæ­¥Qwenæ–‡ä»¶

ç”±äºå‡½æ•°å¾ˆé•¿ï¼ˆ~540è¡Œï¼‰ï¼Œå»ºè®®ç›´æ¥å¤åˆ¶deepseekæ–‡ä»¶ä¸­çš„å®Œæ•´å‡½æ•°ã€‚

### æ–¹æ³•1ï¼šå‘½ä»¤è¡ŒåŒæ­¥ï¼ˆæ¨èï¼‰

```bash
cd /Users/mac-bauyu/Downloads/10-23-bot/ds

# æå–deepseekä¸­çš„å‡½æ•°
sed -n '22217,22756p' deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py > /tmp/new_func.py

# æŸ¥çœ‹qwenä¸­å‡½æ•°çš„è¡Œå·
grep -n "^def analyze_separated_opportunities" qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py
# è¾“å‡º: 22082:def analyze_separated_opportunities...

grep -n "^def simulate_params_on_opportunities" qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py
# è¾“å‡º: 22579:def simulate_params_on_opportunities...

# æ›¿æ¢qwenä¸­çš„å‡½æ•°ï¼ˆä¿ç•™å‰22081è¡Œï¼Œæ’å…¥æ–°å‡½æ•°ï¼Œä¿ç•™22579è¡Œä¹‹åï¼‰
head -22081 qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py > /tmp/qwen_part1.py
cat /tmp/new_func.py > /tmp/qwen_part2.py
tail -n +22579 qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py > /tmp/qwen_part3.py
cat /tmp/qwen_part1.py /tmp/qwen_part2.py /tmp/qwen_part3.py > qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ_new.py

# éªŒè¯è¯­æ³•
python3 -m py_compile qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ_new.py

# å¤‡ä»½å¹¶æ›¿æ¢
mv qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ_backup_v848.py
mv qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ_new.py qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py
```

### æ–¹æ³•2ï¼šæ‰‹åŠ¨ç¼–è¾‘

1. æ‰“å¼€ä¸¤ä¸ªæ–‡ä»¶
2. å¤åˆ¶deepseekä¸­ `analyze_separated_opportunities` å‡½æ•° (lines 22217-22756)
3. æ›¿æ¢qwenä¸­å¯¹åº”å‡½æ•° (lines 22082-22577)

---

## âœ… éªŒè¯

ä¿®æ”¹å®Œæˆåï¼Œè¿è¡Œå›æµ‹éªŒè¯ï¼š

```bash
cd ~/10-23-bot/ds
bash ~/å¿«é€Ÿé‡å¯_ä¿®å¤ç‰ˆ.sh backtest-deepseek
```

**é¢„æœŸç»“æœ**ï¼š
```
âœ… Phase 1.4åˆ†ç±»è´¨é‡éªŒè¯
  âš¡ è¶…çŸ­çº¿: åˆ©æ¶¦8.5%, æ—¶é—´1.2h, å¯†åº¦14.2
  ğŸŒŠ æ³¢æ®µ: åˆ©æ¶¦16.3%, æ—¶é—´5.8h, å¯†åº¦3.1
  âœ… æ³¢æ®µåˆ©æ¶¦>è¶…çŸ­çº¿
  âœ… æ³¢æ®µæ—¶é—´>è¶…çŸ­çº¿
  âœ… è¶…çŸ­çº¿å¯†åº¦>æ³¢æ®µ
```

---

## ğŸ“ å…³é”®ä»£ç å˜æ›´

### 1. ç»Ÿä¸€è·Ÿè¸ªé€»è¾‘

**Before (V8.5.2.4.47)**:
```python
# åˆ†åˆ«è·Ÿè¸ªè¶…çŸ­çº¿(5%)å’Œæ³¢æ®µ(10%)
if profit >= 5.0:
    scalping_tracking = True
if profit >= 10.0:
    swing_tracking = True

# äº’æ–¥æ€§åˆ†ç±»ï¼šä¼˜å…ˆæ³¢æ®µ
if swing_reached_target:
    signal_type = 'swing'
elif scalping_reached_target:
    signal_type = 'scalping'
```

**After (V8.5.2.4.48)**:
```python
# ç»Ÿä¸€è·Ÿè¸ªï¼šåªè¦è¾¾åˆ°5%å°±è®°å½•
if profit >= 5.0:
    tracking_started = True
    max_profit_seen = profit
    bars_to_max_profit = bar_idx

# è®¡ç®—æ ¸å¿ƒæŒ‡æ ‡
holding_hours = bars_to_max_profit * 0.25
profit_density = max_profit / holding_hours

# åç»­Phase 1.3å†æ ¹æ®densityåˆ†ç±»
```

### 2. æ–°å¢å­—æ®µ

```python
opp_data = {
    # ... åŸæœ‰å­—æ®µ
    'profit_density': profit_density,  # ã€æ–°å¢ã€‘æ ¸å¿ƒæŒ‡æ ‡
    'classify_reason': 'reason',       # ã€æ–°å¢ã€‘åˆ†ç±»åŸå› 
    # æš‚ä¸è®¾ç½®signal_typeï¼Œç­‰Phase 1.3åˆ†ç±»
}
```

### 3. è¿”å›ç»“æ„

```python
return {
    'scalping': scalping_analysis,
    'swing': swing_analysis,
    'phase1_baseline': phase1_baseline,
    'adaptive_thresholds': adaptive_thresholds  # ğŸ†• æ–°å¢
}
```

---

## ğŸ‰ æ€»ç»“

è¿™æ¬¡å®ç°å½»åº•è§£å†³äº†"æŒä»“æ—¶é—´ä¸åˆ©æ¶¦ä¸åŒ¹é…"çš„æ ¸å¿ƒçŸ›ç›¾ï¼Œé€šè¿‡ï¼š

1. âœ… **åˆ©æ¶¦å¯†åº¦**ä½œä¸ºæ ¸å¿ƒåˆ†ç±»æŒ‡æ ‡
2. âœ… **åŠ¨æ€é˜ˆå€¼**é€‚åº”ä¸åŒå¸‚åœºç¯å¢ƒ
3. âœ… **ä¸‰é˜¶æ®µæµç¨‹**ç¡®ä¿åˆ†ç±»è´¨é‡
4. âœ… **å†…å­˜å‹å¥½**çš„åˆ†æ‰¹å¤„ç†ç­–ç•¥

**ä¸‹ä¸€æ­¥**: è¿è¡Œå›æµ‹éªŒè¯æ•ˆæœï¼ğŸš€

