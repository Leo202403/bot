#!/bin/bash
# V8.3.21 修复NaN错误补丁

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "V8.3.21 修复NaN错误"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

cd /root/10-23-bot/ds

# 备份文件
echo "📦 备份文件..."
cp qwen_多币种智能版.py qwen_多币种智能版.py.bak_nan_fix
cp deepseek_多币种智能版.py deepseek_多币种智能版.py.bak_nan_fix
echo "✅ 备份完成"

echo ""
echo "🔧 应用修复..."

# 在analyze_opportunities_with_new_params函数开始处添加NaN清理
python3 << 'EOF'
import sys

def fix_file(filename):
    with open(filename, 'r', encoding='utf-8') as f:
        content = f.read()
    
    # 查找函数定义位置
    search_text = '''    if market_snapshots is None or market_snapshots.empty:
        return {'all_opportunities': [], 'old_captured': [], 'new_captured': [], 'missed': [], 'stats': {}}
    
    all_opportunities = []'''
    
    replace_text = '''    if market_snapshots is None or market_snapshots.empty:
        return {'all_opportunities': [], 'old_captured': [], 'new_captured': [], 'missed': [], 'stats': {}}
    
    # 【V8.3.21修复】清理NaN值，避免类型转换错误
    market_snapshots = market_snapshots.copy()
    
    # 数值列填充NaN为0
    numeric_cols = market_snapshots.select_dtypes(include=[np.number]).columns
    market_snapshots[numeric_cols] = market_snapshots[numeric_cols].fillna(0)
    
    # 字符串列填充NaN为空字符串
    str_cols = market_snapshots.select_dtypes(include=['object']).columns
    market_snapshots[str_cols] = market_snapshots[str_cols].fillna('')
    
    all_opportunities = []'''
    
    if search_text in content:
        content = content.replace(search_text, replace_text)
        with open(filename, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"✅ 已修复: {filename}")
        return True
    else:
        print(f"⚠️  未找到目标代码: {filename}")
        return False

# 修复两个文件
success = True
success = fix_file('qwen_多币种智能版.py') and success
success = fix_file('deepseek_多币种智能版.py') and success

sys.exit(0 if success else 1)
EOF

if [ $? -eq 0 ]; then
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "✅ 修复完成！"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "📁 备份文件："
    ls -lh *.bak_nan_fix
    echo ""
    echo "💡 如需回滚："
    echo "   cp qwen_多币种智能版.py.bak_nan_fix qwen_多币种智能版.py"
    echo "   cp deepseek_多币种智能版.py.bak_nan_fix deepseek_多币种智能版.py"
else
    echo ""
    echo "❌ 修复失败，从备份恢复"
    cp qwen_多币种智能版.py.bak_nan_fix qwen_多币种智能版.py
    cp deepseek_多币种智能版.py.bak_nan_fix deepseek_多币种智能版.py
    exit 1
fi

