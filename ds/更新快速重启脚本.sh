#!/bin/bash
# V8.3.21 更新服务器快速重启脚本

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "V8.3.21 更新快速重启脚本"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# ==========================================
# 第1步：备份旧脚本
# ==========================================
echo "第1步：备份旧脚本"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

if [ -f ~/快速重启_修复版.sh ]; then
    cp ~/快速重启_修复版.sh ~/快速重启_修复版.sh.backup.$(date +%Y%m%d_%H%M%S)
    echo "✅ 已备份旧脚本到: ~/快速重启_修复版.sh.backup.*"
else
    echo "ℹ️  旧脚本不存在，跳过备份"
fi

# ==========================================
# 第2步：拉取最新代码
# ==========================================
echo ""
echo "第2步：拉取最新代码"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

cd /root/10-23-bot

echo "📍 当前版本："
git log --oneline -1

echo ""
echo "🔄 拉取更新..."
git pull origin main

echo ""
echo "📍 更新后版本："
git log --oneline -1

# ==========================================
# 第3步：复制新脚本到家目录
# ==========================================
echo ""
echo "第3步：复制新脚本到家目录"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

if [ -f /root/10-23-bot/ds/服务器快速重启_修复版.sh ]; then
    cp /root/10-23-bot/ds/服务器快速重启_修复版.sh ~/快速重启_修复版.sh
    chmod +x ~/快速重启_修复版.sh
    echo "✅ 新脚本已复制到: ~/快速重启_修复版.sh"
    echo "✅ 已添加执行权限"
else
    echo "❌ 新脚本文件不存在: /root/10-23-bot/ds/服务器快速重启_修复版.sh"
    exit 1
fi

# ==========================================
# 第4步：验证修复
# ==========================================
echo ""
echo "第4步：验证修复"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

if grep -q "export MANUAL_BACKTEST=true" ~/快速重启_修复版.sh; then
    echo "✅ 回测模式修复已应用（包含 MANUAL_BACKTEST=true）"
else
    echo "⚠️  警告：未发现 MANUAL_BACKTEST=true 环境变量"
fi

# ==========================================
# 第5步：显示用法
# ==========================================
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✅ 更新完成！"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

echo "💡 现在可以使用以下命令："
echo ""
echo "  # 运行回测（两个模型）"
echo "  bash ~/快速重启_修复版.sh backtest"
echo ""
echo "  # 重启Qwen"
echo "  bash ~/快速重启_修复版.sh qwen"
echo ""
echo "  # 重启DeepSeek"
echo "  bash ~/快速重启_修复版.sh deepseek"
echo ""
echo "  # 查看状态"
echo "  bash ~/快速重启_修复版.sh status"
echo ""
echo "  # 查看所有命令"
echo "  bash ~/快速重启_修复版.sh"
echo ""

echo "🔧 关键修复："
echo "  • backtest命令现在会正确设置 MANUAL_BACKTEST=true"
echo "  • 回测会依次运行Qwen和DeepSeek"
echo "  • 回测完成后显示退出状态和总结"
echo ""

