======================================================================
V8.5.2.4.89 - OOM完整修复部署指南
======================================================================

【修复内容】
1. Phase 3 方案C（两阶段分层测试）- 内存峰值-40%
2. Phase 3 分离优化只用最佳起点 - 测试组合32→8
3. 注释掉旧版错过机会分析 - 内存节省50%
4. 邮件生成合并重复加载 - 加载次数3→1

【预期效果】
- Phase 3 主搜索: 900MB → 540MB
- Phase 3 分离优化: 1200MB → 600MB
- 错过机会分析: 1100MB → 550MB
- 邮件生成: 1100MB → 900MB
- 最终峰值: <900MB (在1GB限制内)

======================================================================
部署步骤
======================================================================

# 1. 停止服务
cd /root/10-23-bot && supervisorctl stop deepseek qwen

# 2. 拉取最新代码
git pull

# 3. 运行回测（监控整个流程）
cd /root/10-23-bot/ds
MANUAL_BACKTEST=true python3 deepseek_多币种智能版.py backtest-deepseek

# 【关键观察点】
# ✅ Phase 1 完成 - 机会数限制在2000个/类型
# ✅ Phase 2 完成 - 测试组合数8组
# ✅ Phase 3 完成 - 查看日志：
#    - "⚡ 【第一阶段：粗筛】快速测试4组×4起点"
#    - "🏆 粗筛Top2起点: ..."
#    - "🔬 【第二阶段：精选】精细测试8组×2起点"
#    - "🏆 最终最佳起点: ..."
# ✅ Phase 3 分离优化 - 查看日志：
#    - "💡 【内存优化】分离优化只使用Phase 3找到的最佳起点（4→1起点）"
#    - "[1/1] 从'Phase3最佳'出发..." (而非 [1/4])
# ✅ 错过机会分析 - 查看日志：
#    - "ℹ️  跳过旧版错过机会分析（已由开仓时机分析V2模块完全替代）"
# ✅ Phase 4 完成 - 验证通过
# ✅ 邮件生成 - 查看日志：
#    - "[参数变化检测] config_changed = True"
#    - "[V8.5.2.4.81] 收集Phase数据..."
#    - "[V8.5.2.4.81] 邮件新表格生成成功"
#    - "✅ 邮件发送成功"
# ✅ Bark推送 - "[Bark推送] 推送完成: 成功 3/3"

# 【失败标志】
# ❌ 如果看到 "Killed" → 仍然OOM，需要进一步优化
# ❌ 如果卡在某个阶段 → 记录卡住位置，分析原因

# 4. 回测成功后重启服务
supervisorctl start deepseek qwen

# 5. 验证服务运行
supervisorctl status

======================================================================
预期日志样本（关键部分）
======================================================================

【Phase 3 两阶段搜索】
```
🎯 【两阶段多起点搜索】
   策略：先粗筛找Top2起点 → 再精选最优参数
   【V8.5.2.4.89方案C】分层测试，内存峰值更低，精度损失<5%
   候选起点: 4个

   ⚡ 【第一阶段：粗筛】快速测试4组×4起点
      [1/4] Phase2最优... ✓ 利润: 0.0%
      [2/4] Top1组合... ✓ 利润: 0.0%
      [3/4] Top2组合... ✓ 利润: 0.0%
      [4/4] Top3组合... ✓ 利润: 0.0%

   🏆 粗筛Top2起点:
      1. Phase2最优 (利润: 0.0%)
      2. Top1组合 (利润: 0.0%)

   🔬 【第二阶段：精选】精细测试8组×2起点
      [1/2] Phase2最优... ✓ 利润: 0.0%
      [2/2] Top1组合... ✓ 利润: 0.0%

   🏆 最终最佳起点: Phase2最优
```

【Phase 3 分离优化】
```
📊 【分离优化】
   分别为超短线和波段寻找最大利润参数...
   超短线机会: 0个
   波段机会: 1783个
   💡 【内存优化】分离优化只使用Phase 3找到的最佳起点（4→1起点，节省75%内存）

🎯 【SCALPING参数优化】
   机会数量: 0个
   [1/1] 从'Phase3最佳'出发...  ← 注意：只有1个起点，而非4个

🎯 【SWING参数优化】
   机会数量: 1783个
   [1/1] 从'Phase3最佳'出发...  ← 注意：只有1个起点，而非4个
```

【错过机会分析】
```
【错过机会分析】
ℹ️  跳过旧版错过机会分析（已由开仓时机分析V2模块完全替代）
```

【邮件生成】
```
[参数变化检测] config_changed = True
[V8.5.2.4.81] 收集Phase数据...
[V8.5.2.4.81] 邮件新表格生成成功
[邮件调试] compressed_insights 存在: True
✅ 邮件发送成功
[Bark推送] 推送完成: 成功 3/3
```

======================================================================
故障排查
======================================================================

【问题1】仍然在 Phase 3 第二阶段被 Killed
原因：粗筛阶段已通过，但精选阶段内存仍超标
解决：
  - 检查 phase3_enhanced_optimizer.py 第200行附近
  - 确认 top2_starting_points 只选择了2个起点
  - 确认第二阶段只测试 top2_starting_points (不是全部4个)

【问题2】仍然在分离优化被 Killed
原因：分离优化仍在使用多个起点
解决：
  - 检查 phase3_enhanced_optimizer.py 第407行/422行
  - 确认 starting_points=best_starting_point_list
  - 确认 best_starting_point_list 只包含1个元素 ('Phase3最佳')

【问题3】仍然在错过机会分析被 Killed
原因：旧函数未完全注释
解决：
  - 检查 deepseek_多币种智能版.py 第9817行
  - 确认整个 try-except 块都被注释掉
  - 确认最后有 pass 语句

【问题4】仍然在邮件生成被 Killed
原因：重复加载 config 未修复
解决：
  - 检查 deepseek_多币种智能版.py 第10865行
  - 确认该行的 config = load_learning_config() 已注释
  - 检查第12207行，确认使用 current_config = config

【问题5】卡住不动（无 Killed）
原因：可能在等待AI响应或网络超时
解决：
  - Ctrl+C 中断
  - 检查网络连接
  - 检查 API key 是否有效

======================================================================
验证成功标志
======================================================================

✅ 日志显示：
   - Phase 1-4 全部完成
   - "【V8.5.2.4.89方案C】分层测试" 出现
   - "💡 【内存优化】分离优化只使用Phase 3找到的最佳起点" 出现
   - "ℹ️  跳过旧版错过机会分析" 出现
   - "✅ 邮件发送成功"
   - "[Bark推送] 推送完成: 成功 3/3"
   - 无 "Killed" 错误

✅ 邮件内容：
   - 包含 Phase 1-4 汇总表
   - 包含参数对比表
   - 包含利润对比表
   - 包含 AI 洞察

✅ 服务重启：
   - supervisorctl status 显示 deepseek/qwen RUNNING

======================================================================
回滚方案（如果仍然失败）
======================================================================

# 如果修复后仍然OOM，执行回滚：
cd /root/10-23-bot
git log --oneline -5  # 查看最近5次提交
git reset --hard <上一个稳定版本的commit>  # 回滚到修复前版本
supervisorctl restart deepseek qwen

# 然后提交issue，包含：
# 1. Killed 出现的完整上下文（前后20行）
# 2. 服务器内存信息：free -h
# 3. 进程信息：ps aux | grep python

======================================================================
联系信息
======================================================================

如有问题，请提供：
1. 完整的回测日志（从开始到 Killed）
2. 服务器内存信息：free -h
3. Python进程信息：ps aux | grep python
4. git log --oneline -1  # 确认代码版本

文档版本: V8.5.2.4.89
最后更新: 2025-11-20

