# V8.5.2.4.60 - TP/SLå‚æ•°ä¼ é€’å®Œæ•´ä¿®å¤

**ç‰ˆæœ¬**: V8.5.2.4.60  
**æ—¥æœŸ**: 2025-11-19  
**ç±»å‹**: BugFix - å®Œæ•´ä¿®å¤TP/SLå‚æ•°ä¼ é€’é“¾è·¯  
**ä¼˜å…ˆçº§**: ğŸ”´ Critical

---

## ğŸ“‹ é—®é¢˜æ€»ç»“

å‘ç°**4ä¸ªTP/SLå‚æ•°ä¼ é€’é—®é¢˜**ï¼Œå¯¼è‡´Phase 2æµ‹è¯•çš„æœ€ä¼˜å€¼ï¼ˆTP=30/35, SL=1.5/2.5ï¼‰æœªè¢«åç»­é˜¶æ®µä½¿ç”¨ï¼š

| é—®é¢˜ | ä½ç½® | å½±å“ | ä¸¥é‡æ€§ |
|------|------|------|--------|
| âœ… Phase 2 Baseline | Line 7627 | Baselineåˆ©æ¶¦1.26% â†’ 12% | ğŸ”´ Critical |
| âœ… å‰å‘éªŒè¯ | Line 7764-7826 | è¿‡æ‹Ÿåˆæ£€æµ‹ä¸å‡†ç¡® | ğŸŸ¡ Medium |
| âœ… Phase 3çŸ©é˜µ | phase3 Line 210 | AIå†³ç­–åŸºäºé”™è¯¯æ•°æ® | ğŸŸ¡ Medium |
| âœ… Phase 3æœç´¢ç©ºé—´ | phase3 Line 639+ | æ— æ³•ç»§æ‰¿Phase 2æˆæœ | ğŸ”´ Critical |

---

## ğŸ”§ ä¿®å¤å†…å®¹

### 1. Phase 2 Baselineè®¡ç®—

**æ–‡ä»¶**: `deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py`, `qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py`  
**ä½ç½®**: Line 7627-7649 / 7632-7654

```python
# âŒ æ—§ä»£ç 
if signal_type == 'scalping':
    default_tp = scalping_params_range['atr_tp'][1]  # 2.0
    default_sl = scalping_params_range['atr_sl'][2]  # 1.5

# âœ… æ–°ä»£ç 
if signal_type == 'scalping':
    if best_scalping_tp_sl:
        default_tp = best_scalping_tp_sl['tp']  # 30.0
        default_sl = best_scalping_tp_sl['sl']  # 1.5
    else:
        default_tp = scalping_params_range['atr_tp'][1]
        default_sl = scalping_params_range['atr_sl'][2]
```

**é¢„æœŸæ”¹å–„**: Baselineåˆ©æ¶¦ 1.26% â†’ 12%+ (+850%)

---

### 2. å‰å‘éªŒè¯ï¼ˆè®­ç»ƒé›†/éªŒè¯é›†ï¼‰

**æ–‡ä»¶**: `deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py`, `qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py`  
**ä½ç½®**: Line 7760-7834 / 7765-7839

**ä¿®å¤ç‚¹**:
- éªŒè¯é›†actual_profitè®¡ç®—ï¼ˆLine 7760-7783ï¼‰
- è®­ç»ƒé›†actual_profitè®¡ç®—ï¼ˆLine 7811-7834ï¼‰

**å½±å“**: ç¡®ä¿è¿‡æ‹Ÿåˆæ£€æµ‹åŸºäºæ­£ç¡®çš„TP/SLå‚æ•°

---

### 3. learned_featuresä¼ é€’

**æ–‡ä»¶**: `deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py`, `qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py`  
**ä½ç½®**: Line 7687 / 7692

```python
# âœ… æ·»åŠ åˆ°learned_features
'learned_features': {
    ...
    'optimal_tp_sl': test_points_meta.get('optimal_tp_sl', {})  # æ–°å¢
}
```

**ä½œç”¨**: è®©Phase 3å¯ä»¥è®¿é—®Phase 2æµ‹è¯•çš„æœ€ä¼˜TP/SL

---

### 4. Phase 3ç»„åˆç­›é€‰çŸ©é˜µ

**æ–‡ä»¶**: `phase3_enhanced_optimizer.py`  
**ä½ç½®**: Line 206-222

```python
# âœ… ä»learned_featuresæå–æœ€ä¼˜TP/SL
optimal_tp_sl = learned_features.get('optimal_tp_sl', {})

if signal_type == 'scalping':
    scalping_optimal = optimal_tp_sl.get('scalping', {})
    default_tp = scalping_optimal.get('atr_tp_multiplier', 2.0)  # ä¼˜å…ˆä½¿ç”¨æœ€ä¼˜å€¼
    default_sl = scalping_optimal.get('atr_stop_multiplier', 1.5)
```

**å½±å“**: AIè¾…åŠ©å†³ç­–åŸºäºæ­£ç¡®çš„åˆ©æ¶¦æ•°æ®

---

### 5. Phase 3æœç´¢ç©ºé—´ï¼ˆæœ€å…³é”®ï¼‰

**æ–‡ä»¶**: `phase3_enhanced_optimizer.py`  
**ä½ç½®**: Line 644-710

#### Scalping (Line 647-678)

```python
# âœ… å›´ç»•Phase 2æœ€ä¼˜å€¼æ„å»ºæœç´¢ç©ºé—´
scalping_optimal = optimal_tp_sl.get('scalping', {})
optimal_tp = scalping_optimal.get('atr_tp_multiplier', 12.0)  # ä¾‹å¦‚ 30.0
optimal_sl = scalping_optimal.get('atr_stop_multiplier', 2.0)  # ä¾‹å¦‚ 1.5

param_grid = {
    'atr_tp_multiplier': [
        round(optimal_tp * 0.8, 1),  # -20% (ä¾‹å¦‚ 24.0)
        round(optimal_tp, 1),         # æœ€ä¼˜å€¼ (ä¾‹å¦‚ 30.0)
        round(optimal_tp * 1.2, 1),   # +20% (ä¾‹å¦‚ 36.0)
        round(optimal_tp * 1.5, 1)    # +50% (ä¾‹å¦‚ 45.0)
    ],
    'atr_stop_multiplier': [
        round(optimal_sl * 0.8, 1),
        round(optimal_sl, 1),
        round(optimal_sl * 1.2, 1)
    ],
    ...
}
```

#### Swing (Line 679-710)

```python
# âœ… åŒæ ·å›´ç»•Phase 2æœ€ä¼˜å€¼
swing_optimal = optimal_tp_sl.get('swing', {})
optimal_tp = swing_optimal.get('atr_tp_multiplier', 18.0)  # ä¾‹å¦‚ 35.0
optimal_sl = swing_optimal.get('atr_stop_multiplier', 2.5)

param_grid = {
    'atr_tp_multiplier': [
        round(optimal_tp * 0.8, 1),  # ä¾‹å¦‚ 28.0
        round(optimal_tp, 1),         # ä¾‹å¦‚ 35.0
        round(optimal_tp * 1.2, 1),   # ä¾‹å¦‚ 42.0
        round(optimal_tp * 1.5, 1)    # ä¾‹å¦‚ 52.5
    ],
    ...
}
```

**æ ¸å¿ƒæ”¹è¿›**:
- **Before**: Phase 3å›ºå®šä½¿ç”¨TP=[8,10,12,15]ï¼Œå¿½ç•¥Phase 2ç»“æœ
- **After**: Phase 3å›´ç»•Phase 2æœ€ä¼˜å€¼ï¼ˆ30/35ï¼‰åŠ¨æ€æ„å»ºæœç´¢ç©ºé—´
- **é¢„æœŸ**: Phase 3èƒ½å¤Ÿç»§æ‰¿Phase 2å­¦ä¹ æˆæœï¼Œåˆ©æ¶¦ä»-1.6%/-2.2% â†’ 8-12%

---

## ğŸ“Š é¢„æœŸæ•ˆæœå¯¹æ¯”

### Phase 2 Baseline

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æå‡ |
|------|--------|--------|------|
| TP/SLä½¿ç”¨ | 2.0/6.0ï¼ˆå›ºå®šï¼‰ | 30/35ï¼ˆæœ€ä¼˜ï¼‰ | âœ… |
| Baselineåˆ©æ¶¦ | 1.26% | ~12% | +850% |

### å‰å‘éªŒè¯

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| éªŒè¯TP/SL | 2.0/6.0 | 30/35 âœ… |
| è¿‡æ‹Ÿåˆæ£€æµ‹ | ä¸å‡†ç¡® | å‡†ç¡® âœ… |

### Phase 3

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æå‡ |
|------|--------|--------|------|
| æœç´¢ç©ºé—´TP | [8,10,12,15] | [24,30,36,45] | 2-3å€ |
| åŒ…å«æœ€ä¼˜å€¼ | âŒ | âœ… | - |
| çŸ©é˜µè®¡ç®—TP | 2.0/6.0 | 30/35 | âœ… |
| AIå†³ç­–æ•°æ® | é”™è¯¯ | æ­£ç¡® âœ… | - |
| é¢„æœŸåˆ©æ¶¦ | -1.6%/-2.2% | 8-12% | +400-600% |

---

## ğŸ¯ è®¾è®¡ä¿®å¤

### åŸå§‹è®¾è®¡æ„å›¾

```
Phase 1: è¯†åˆ«å®¢è§‚æœºä¼šï¼ˆ15-16%ï¼‰
   â†“
Phase 2: TP/SLæµ‹è¯• â†’ æ‰¾åˆ°æœ€ä¼˜TP=30/35 (12-13%)
   â†“
Phase 3: å›´ç»•Phase 2æœ€ä¼˜å€¼ç²¾ç»†åŒ–æœç´¢
   â†“
Phase 4: éªŒè¯ä¸è¿‡æ‹Ÿåˆæ£€æµ‹
```

### ä¿®å¤å‰å®é™…æƒ…å†µ

```
Phase 1: âœ… è¯†åˆ«å®¢è§‚æœºä¼šï¼ˆ15-16%ï¼‰
   â†“
Phase 2: âœ… TP/SLæµ‹è¯• â†’ TP=30/35 (12-13%)
   â†“ âŒ ä¼ é€’æ–­è£‚
Phase 3: âŒ å›ºå®šTP=[8,10,12,15]ï¼ˆå¿½ç•¥Phase 2ï¼‰
   â†“
Phase 4: âŒ åŸºäºé”™è¯¯çš„Phase 3ç»“æœ
```

### ä¿®å¤åå®é™…æƒ…å†µ

```
Phase 1: âœ… è¯†åˆ«å®¢è§‚æœºä¼šï¼ˆ15-16%ï¼‰
   â†“
Phase 2: âœ… TP/SLæµ‹è¯• â†’ TP=30/35 (12-13%)
   â†“ âœ… learned_featuresä¼ é€’
Phase 3: âœ… å›´ç»•TP=[24,30,36,45]æœç´¢
   â†“
Phase 4: âœ… éªŒè¯æ­£ç¡®çš„å‚æ•°
```

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶

1. **ds/deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py**
   - Line 7627-7649: Phase 2 Baseline TP/SL
   - Line 7687: learned_featuresæ·»åŠ optimal_tp_sl
   - Line 7760-7834: å‰å‘éªŒè¯TP/SL

2. **ds/qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py**
   - Line 7632-7654: Phase 2 Baseline TP/SL
   - Line 7692: learned_featuresæ·»åŠ optimal_tp_sl
   - Line 7765-7839: å‰å‘éªŒè¯TP/SL

3. **ds/phase3_enhanced_optimizer.py**
   - Line 206-222: ç»„åˆç­›é€‰çŸ©é˜µTP/SL
   - Line 644-710: æœç´¢ç©ºé—´åŠ¨æ€æ„å»º

---

## ğŸ§ª éªŒè¯æ–¹æ³•

```bash
cd /Users/mac-bauyu/Downloads/10-23-bot/ds
MANUAL_BACKTEST=true python3 deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py backtest-deepseek
```

**éªŒè¯ç‚¹**:
1. âœ… Phase 2 Baselineåˆ©æ¶¦ â‰ˆ 12% (æ¥è¿‘TP/SLæµ‹è¯•ç»“æœ)
2. âœ… Phase 3æœç´¢ç©ºé—´åŒ…å«Phase 2æœ€ä¼˜å€¼
3. âœ… æ—¥å¿—æ˜¾ç¤º"å›´ç»•Phase 2æœ€ä¼˜å€¼æ„å»ºæœç´¢ç©ºé—´"
4. âœ… Phase 3åˆ©æ¶¦æå‡åˆ°8-12%+

---

## ğŸ“ å…³è”ç‰ˆæœ¬

- **å‰ç½®**: V8.5.2.4.59 - ATRè®¡ç®—ä¿®å¤
- **æœ¬æ¬¡**: V8.5.2.4.60 - å®Œæ•´ä¿®å¤TP/SLå‚æ•°ä¼ é€’é“¾è·¯
- **åç»­**: æ ¹æ®å›æµ‹ç»“æœå†³å®š

---

## âœ… æäº¤ä¿¡æ¯

```bash
git commit -m "fix: V8.5.2.4.60 å®Œæ•´ä¿®å¤TP/SLå‚æ•°ä¼ é€’é“¾è·¯

ã€ä¿®å¤1ã€‘Phase 2 Baselineä½¿ç”¨TP/SLæµ‹è¯•æœ€ä¼˜å€¼ï¼ˆé¢„æœŸåˆ©æ¶¦+850%ï¼‰
ã€ä¿®å¤2ã€‘å‰å‘éªŒè¯ï¼ˆè®­ç»ƒé›†/éªŒè¯é›†ï¼‰ä½¿ç”¨æœ€ä¼˜TP/SL
ã€ä¿®å¤3ã€‘learned_featuresä¼ é€’optimal_tp_slåˆ°Phase 3
ã€ä¿®å¤4ã€‘Phase 3ç»„åˆç­›é€‰çŸ©é˜µä½¿ç”¨æœ€ä¼˜TP/SL
ã€ä¿®å¤5ã€‘Phase 3æœç´¢ç©ºé—´å›´ç»•Phase 2æœ€ä¼˜å€¼åŠ¨æ€æ„å»ºï¼ˆæœ€å…³é”®ï¼‰

é¢„æœŸæ•ˆæœï¼š
- Phase 2 Baseline: 1.26% â†’ 12%+ (+850%)
- Phase 3åˆ©æ¶¦: -1.6%/-2.2% â†’ 8-12%+ (+400-600%)
- å¤šé˜¶æ®µä¼˜åŒ–è®¾è®¡åˆè¡·å¾—ä»¥å®ç°"
```

