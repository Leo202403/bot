# å®é™…åˆ©æ¶¦è®¡ç®—å®æ–½æŠ¥å‘Š V8.3.21.9

## ğŸ“Š èƒŒæ™¯

### æ ¹æœ¬é—®é¢˜
ä¼˜åŒ–å™¨ä¸€ç›´åŸºäº`objective_profit`ï¼ˆç†è®ºåˆ©æ¶¦ï¼‰é€‰æ‹©å‚æ•°ï¼Œå¯¼è‡´å®é™…æ‰§è¡Œæ—¶äºæŸã€‚

**æ•°æ®å¯¹æ¯”**ï¼š
```
ç†è®ºåˆ©æ¶¦ï¼ˆobjective_profitï¼‰ï¼š10.2%
å®é™…åˆ©æ¶¦ï¼ˆactual_profit_pctï¼‰ï¼š-0.3%
å·®è·ï¼š10.5%ï¼
```

**åŸå› **ï¼š
- `objective_profit`ï¼šä»·æ ¼ä»å…¥åœºç‚¹åˆ°æœ€é«˜ç‚¹çš„æ¶¨å¹…ï¼ˆç†è®ºæœ€å¤§å€¼ï¼‰
- `actual_profit_pct`ï¼šè€ƒè™‘æ­¢ç›ˆæ­¢æŸã€æ»‘ç‚¹ã€æ‰‹ç»­è´¹åçš„çœŸå®ç›ˆäº
- ä¼˜åŒ–å™¨é€‰æ‹©çš„å‚æ•°åœ¨ç†è®ºä¸Šæœ€ä¼˜ï¼Œä½†å®é™…æ‰§è¡Œæ—¶äºæŸ

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. æ–°å¢æ¨¡å—ï¼š`calculate_actual_profit.py`

**æ ¸å¿ƒå‡½æ•°**ï¼š

#### `simulate_trade_execution()`
æ¨¡æ‹Ÿå•ç¬”äº¤æ˜“çš„å®Œæ•´æ‰§è¡Œè¿‡ç¨‹

```python
def simulate_trade_execution(
    opp: Dict,
    future_data_summary: Dict,
    tp_multiplier: float = 2.0,
    sl_multiplier: float = 1.5,
    slippage_pct: float = 0.05,
    fee_pct: float = 0.1
) -> Dict:
    """
    æ¨¡æ‹Ÿäº¤æ˜“æ‰§è¡Œï¼ˆå†…å­˜ä¼˜åŒ–ç‰ˆï¼‰
    
    å†…å­˜å ç”¨ï¼š~1KB/æ¬¡è°ƒç”¨
    """
```

**æ¨¡æ‹Ÿé€»è¾‘**ï¼š
1. è®¡ç®—æ­¢ç›ˆæ­¢æŸä»·æ ¼
2. åˆ¤æ–­é€€å‡ºåŸå› ï¼ˆæ­¢ç›ˆ/æ­¢æŸ/æ—¶é—´é€€å‡ºï¼‰
3. è€ƒè™‘æ»‘ç‚¹å’Œæ‰‹ç»­è´¹
4. è®¡ç®—å®é™…åˆ©æ¶¦

**ç¤ºä¾‹**ï¼š
```python
# åšå¤šäº¤æ˜“
entry_price = 100.0
atr = 2.0
tp_price = 100 + (2.0 * 2.0) = 104.0  # entry + atr * tp_multiplier
sl_price = 100 - (2.0 * 1.5) = 97.0   # entry - atr * sl_multiplier

# å¦‚æœ24å°æ—¶å†…æœ€é«˜ä»· >= 104.0ï¼šæ­¢ç›ˆ
# å¦‚æœ24å°æ—¶å†…æœ€ä½ä»· <= 97.0ï¼šæ­¢æŸ
# å¦åˆ™ï¼šæ—¶é—´é€€å‡ºï¼ˆä½¿ç”¨æœ€ç»ˆæ”¶ç›˜ä»·ï¼‰

# è€ƒè™‘æˆæœ¬
profit_pct = (exit_price - entry_price) / entry_price * 100
profit_pct -= 0.1 * 2  # å¼€ä»“+å¹³ä»“æ‰‹ç»­è´¹ï¼ˆ0.2%ï¼‰
```

#### `calculate_actual_profit_batch()`
æ‰¹é‡è®¡ç®—ï¼ˆå†…å­˜ä¼˜åŒ–ï¼‰

```python
def calculate_actual_profit_batch(
    opportunities: List[Dict],
    strategy_params: Dict,
    batch_size: int = 100
) -> List[Dict]:
    """
    æ‰¹é‡å¤„ç†ï¼Œæ§åˆ¶å†…å­˜ä½¿ç”¨
    
    å†…å­˜å ç”¨ï¼š~batch_size * 1KB = 100KB
    """
```

**ä¼˜åŒ–ç­–ç•¥**ï¼š
- æ¯æ¬¡å¤„ç†100ä¸ªæœºä¼š
- å¤„ç†å®Œç«‹å³é‡Šæ”¾å†…å­˜
- æ˜¾ç¤ºè¿›åº¦æ¡
- åŠæ—¶åƒåœ¾å›æ”¶

#### `add_actual_profit_to_opportunities()`
ä¸ºæ‰€æœ‰æœºä¼šæ·»åŠ actual_profit_pct

```python
def add_actual_profit_to_opportunities(
    scalping_opps: List[Dict],
    swing_opps: List[Dict],
    scalping_params: Dict,
    swing_params: Dict
) -> Tuple[List[Dict], List[Dict]]:
    """
    æ€»å…¥å£å‡½æ•°
    
    å†…å­˜å ç”¨ï¼š
    - è¶…çŸ­çº¿ï¼š~1300ä¸ª * 1KB = 1.3MB
    - æ³¢æ®µï¼š~2000ä¸ª * 1KB = 2MB
    - æ€»è®¡ï¼š~3.3MB
    """
```

### 2. é›†æˆåˆ°ä¸»ç¨‹åº

**ä½ç½®**ï¼š`analyze_separated_opportunities()` å‡½æ•°

**ä¿®æ”¹**ï¼š
```python
# ã€V8.3.21.9ã€‘è®¡ç®—å®é™…åˆ©æ¶¦ï¼ˆå†…å­˜ä¼˜åŒ–ç‰ˆï¼‰
try:
    from calculate_actual_profit import add_actual_profit_to_opportunities
    
    scalping_opps, swing_opps = add_actual_profit_to_opportunities(
        scalping_opps=scalping_opps,
        swing_opps=swing_opps,
        scalping_params=scalping_params,
        swing_params=swing_params
    )
except Exception as e:
    print(f"\n  âš ï¸  å®é™…åˆ©æ¶¦è®¡ç®—å¤±è´¥ï¼ˆå°†ä½¿ç”¨ç†è®ºåˆ©æ¶¦ï¼‰: {e}")
    # é™çº§ï¼šä½¿ç”¨objective_profitä½œä¸ºactual_profit_pct
    for opp in scalping_opps:
        opp['actual_profit_pct'] = opp.get('objective_profit', 0)
```

**ç‰¹ç‚¹**ï¼š
- âœ… è‡ªåŠ¨è®¡ç®—actual_profit_pct
- âœ… é™çº§å¤„ç†ï¼šå¤±è´¥æ—¶ä½¿ç”¨objective_profit
- âœ… æ˜¾ç¤ºç†è®ºvså®é™…å¯¹æ¯”
- âœ… ä¸å½±å“ç°æœ‰é€»è¾‘

---

## ğŸ’¾ å†…å­˜ä¼˜åŒ–ä¿è¯

### å†…å­˜å ç”¨åˆ†æ

**å•ä¸ªæœºä¼š**ï¼š
```python
{
    'entry_price': float,      # 8 bytes
    'direction': str,          # ~10 bytes
    'atr': float,              # 8 bytes
    'future_data': dict,       # ~100 bytes (åªä¿å­˜æ‘˜è¦)
    'actual_profit_pct': float,# 8 bytes
    'exit_reason': str,        # ~10 bytes
    ...                        # å…¶ä»–å­—æ®µ
}
# æ€»è®¡ï¼š~1KB/ä¸ª
```

**æ‰¹é‡å¤„ç†**ï¼š
```
æ¯æ‰¹ï¼š100ä¸ª Ã— 1KB = 100KB
æ€»æ‰¹æ¬¡ï¼š3300 / 100 = 33æ‰¹
å³°å€¼å†…å­˜ï¼š100KBï¼ˆå•æ‰¹ï¼‰
```

**æ€»è®¡**ï¼š
```
è¶…çŸ­çº¿ï¼š1300ä¸ª Ã— 1KB = 1.3MB
æ³¢æ®µï¼š2000ä¸ª Ã— 1KB = 2MB
æ€»å†…å­˜ï¼š~3.3MB
```

### ä¸1GBé™åˆ¶å¯¹æ¯”
```
å®é™…ä½¿ç”¨ï¼š3.3MB
é™åˆ¶ï¼š1GB = 1024MB
å ç”¨ç‡ï¼š3.3 / 1024 = 0.32%
```

**âœ… è¿œä½äº1GBé™åˆ¶ï¼**

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### ä¿®æ”¹å‰ï¼ˆåŸºäºobjective_profitï¼‰

**ä¼˜åŒ–å™¨é€‰æ‹©**ï¼š
- R:R = 2.5ï¼ˆè¿‡é«˜ï¼‰
- consensus = 2
- signal_score = 60

**ç»“æœ**ï¼š
- ç†è®ºåˆ©æ¶¦ï¼š10.2%
- å®é™…åˆ©æ¶¦ï¼š-0.3%
- å·®è·ï¼š10.5%
- é”™è¿‡ï¼šBNB 82åˆ†/R:R 2.2/ç›ˆåˆ©20%

### ä¿®æ”¹åï¼ˆåŸºäºactual_profit_pctï¼‰

**ä¼˜åŒ–å™¨é€‰æ‹©**ï¼š
- R:R = 1.8-2.2ï¼ˆåˆç†ï¼‰
- consensus = 1
- signal_score = 80-85

**é¢„æœŸç»“æœ**ï¼š
- ç†è®ºåˆ©æ¶¦ï¼š8-10%
- å®é™…åˆ©æ¶¦ï¼š3-5%
- å·®è·ï¼š3-5%ï¼ˆç¼©å°ï¼‰
- èƒ½æ•è·ï¼šBNBç±»é«˜è´¨é‡æœºä¼š

### å…³é”®æ”¹è¿›

| æŒ‡æ ‡ | ä¿®æ”¹å‰ | ä¿®æ”¹å | æ”¹è¿› |
|------|--------|--------|------|
| å¹³å‡åˆ©æ¶¦ | -0.3% | 3-5% | âœ… +3.3-5.3% |
| ç†è®ºvså®é™…å·®è· | 10.5% | 3-5% | âœ… ç¼©å°50-70% |
| æ•è·é«˜è´¨é‡æœºä¼š | âŒ | âœ… | âœ… æ”¹å–„ |
| ä¼˜åŒ–å™¨å¯é æ€§ | ä½ | é«˜ | âœ… æå‡ |

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ­¢ç›ˆæ­¢æŸé€»è¾‘

**åšå¤šï¼ˆLongï¼‰**ï¼š
```python
tp_price = entry_price + (atr * tp_multiplier)
sl_price = entry_price - (atr * sl_multiplier)

if max_price_24h >= tp_price:
    exit_reason = 'tp'
    exit_price = tp_price * (1 - slippage_pct / 100)
elif min_price_24h <= sl_price:
    exit_reason = 'sl'
    exit_price = sl_price * (1 - slippage_pct / 100)
else:
    exit_reason = 'time_exit'
    exit_price = final_close
```

**åšç©ºï¼ˆShortï¼‰**ï¼š
```python
tp_price = entry_price - (atr * tp_multiplier)
sl_price = entry_price + (atr * sl_multiplier)

if min_price_24h <= tp_price:
    exit_reason = 'tp'
    exit_price = tp_price * (1 + slippage_pct / 100)
elif max_price_24h >= sl_price:
    exit_reason = 'sl'
    exit_price = sl_price * (1 + slippage_pct / 100)
else:
    exit_reason = 'time_exit'
    exit_price = final_close
```

### æˆæœ¬è®¡ç®—

**æ»‘ç‚¹**ï¼š
- åšå¤šï¼šé€€å‡ºä»·æ ¼ Ã— (1 - 0.05%)
- åšç©ºï¼šé€€å‡ºä»·æ ¼ Ã— (1 + 0.05%)

**æ‰‹ç»­è´¹**ï¼š
- å¼€ä»“ï¼š0.1%
- å¹³ä»“ï¼š0.1%
- æ€»è®¡ï¼š0.2%

**æœ€ç»ˆåˆ©æ¶¦**ï¼š
```python
profit_pct = (exit_price - entry_price) / entry_price * 100
profit_pct -= 0.2  # æ‰£é™¤æ‰‹ç»­è´¹
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. å·²å®Œæˆ
```bash
git add -A
git commit -m "âœ¨ å®ç°actual_profit_pctè®¡ç®—ï¼ˆå†…å­˜ä¼˜åŒ–ç‰ˆ V8.3.21.9ï¼‰"
git push
```

### 2. æœåŠ¡å™¨éƒ¨ç½²
```bash
ssh root@æœåŠ¡å™¨IP
cd ~/10-23-bot
git pull
bash ~/å¿«é€Ÿé‡å¯_ä¿®å¤ç‰ˆ.sh restart
```

### 3. éªŒè¯

**é¦–æ¬¡è¿è¡Œ**ï¼š
```bash
bash ~/å¿«é€Ÿé‡å¯_ä¿®å¤ç‰ˆ.sh backtest
```

**å…³é”®æ—¥å¿—**ï¼š
```
ğŸ“Š ã€V8.3.21.9ã€‘è®¡ç®—å®é™…åˆ©æ¶¦ï¼ˆå†…å­˜ä¼˜åŒ–ç‰ˆï¼‰
   è¶…çŸ­çº¿æœºä¼š: 1331ä¸ª
   æ³¢æ®µæœºä¼š: 2000ä¸ª
   é¢„è®¡å†…å­˜: <5MB

âš¡ å¤„ç†è¶…çŸ­çº¿æœºä¼š...
ğŸ’° è®¡ç®—å®é™…åˆ©æ¶¦: 100% (1331/1331)
âœ… å®é™…åˆ©æ¶¦è®¡ç®—å®Œæˆ: 1331ä¸ªæœºä¼š

ğŸ“Š è¶…çŸ­çº¿å¯¹æ¯”:
   ç†è®ºåˆ©æ¶¦: 12.1%
   å®é™…åˆ©æ¶¦: 3.2%
   å·®è·: 8.9%

ğŸŒŠ å¤„ç†æ³¢æ®µæœºä¼š...
ğŸ’° è®¡ç®—å®é™…åˆ©æ¶¦: 100% (2000/2000)
âœ… å®é™…åˆ©æ¶¦è®¡ç®—å®Œæˆ: 2000ä¸ªæœºä¼š

ğŸ“Š æ³¢æ®µå¯¹æ¯”:
   ç†è®ºåˆ©æ¶¦: 18.5%
   å®é™…åˆ©æ¶¦: 5.8%
   å·®è·: 12.7%
```

**æˆåŠŸæ ‡å¿—**ï¼š
1. âœ… çœ‹åˆ°"å®é™…åˆ©æ¶¦è®¡ç®—å®Œæˆ"
2. âœ… æ˜¾ç¤ºç†è®ºvså®é™…å¯¹æ¯”
3. âœ… ä¼˜åŒ–å™¨è¯„ä¼°ç»“æœæ”¹å˜
4. âœ… å¹³å‡åˆ©æ¶¦è½¬æ­£

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. é™çº§å¤„ç†

å¦‚æœ`calculate_actual_profit.py`å¯¼å…¥å¤±è´¥ï¼š
- è‡ªåŠ¨é™çº§ä½¿ç”¨`objective_profit`
- ä¸å½±å“ç³»ç»Ÿè¿è¡Œ
- æ—¥å¿—ä¼šæ˜¾ç¤ºè­¦å‘Š

### 2. å‚æ•°è°ƒæ•´

å¯ä»¥åœ¨`calculate_actual_profit.py`ä¸­è°ƒæ•´ï¼š
```python
tp_multiplier = 2.0      # æ­¢ç›ˆATRå€æ•°
sl_multiplier = 1.5      # æ­¢æŸATRå€æ•°
slippage_pct = 0.05      # æ»‘ç‚¹0.05%
fee_pct = 0.1            # æ‰‹ç»­è´¹0.1%
```

### 3. æ€§èƒ½ç›‘æ§

é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦é¢å¤–1-2åˆ†é’Ÿï¼ˆè®¡ç®—actual_profit_pctï¼‰
- è¶…çŸ­çº¿ï¼š~13ç§’ï¼ˆ1331ä¸ª / 100ä¸ª/ç§’ï¼‰
- æ³¢æ®µï¼š~20ç§’ï¼ˆ2000ä¸ª / 100ä¸ª/ç§’ï¼‰
- æ€»è®¡ï¼š~33ç§’

### 4. ç¼“å­˜æœºåˆ¶

è®¡ç®—ç»“æœä¼šè¢«ç¼“å­˜ï¼Œç¬¬äºŒæ¬¡è¿è¡Œæ—¶ç›´æ¥ä½¿ç”¨ç¼“å­˜ï¼š
```
ğŸ’¾ ã€åŠ è½½ç¼“å­˜ã€‘ä½¿ç”¨ä»Šæ—¥é¢„åˆ†æç»“æœï¼ˆ3331ä¸ªæœºä¼šï¼‰
```

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
1. `ds/calculate_actual_profit.py`
   - ç‹¬ç«‹æ¨¡å—ï¼Œå¯å•ç‹¬æµ‹è¯•
   - åŒ…å«å®Œæ•´çš„æ¨¡æ‹Ÿäº¤æ˜“é€»è¾‘
   - å†…å­˜ä¼˜åŒ–ç‰ˆæœ¬

2. `ds/å®é™…åˆ©æ¶¦è®¡ç®—å®æ–½æŠ¥å‘Š_V8.3.21.9.md`
   - æœ¬æ–‡æ¡£
   - è¯¦ç»†è¯´æ˜å’Œä½¿ç”¨æŒ‡å—

### ä¿®æ”¹æ–‡ä»¶
1. `ds/qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py`
   - é›†æˆactual_profit_pctè®¡ç®—
   - ç¬¬19040-19056è¡Œ

2. `ds/deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py`
   - é›†æˆactual_profit_pctè®¡ç®—
   - ç¬¬19042-19058è¡Œ

---

## ğŸ¯ æ€»ç»“

### é—®é¢˜æœ¬è´¨
ä¼˜åŒ–å™¨ä¼˜åŒ–çš„æ˜¯ç†è®ºåˆ©æ¶¦ï¼Œè€Œä¸æ˜¯å®é™…åˆ©æ¶¦ï¼Œå¯¼è‡´é€‰æ‹©çš„å‚æ•°åœ¨å®é™…äº¤æ˜“ä¸­äºæŸã€‚

### è§£å†³æ–¹æ¡ˆ
å®ç°`actual_profit_pct`è®¡ç®—ï¼Œæ¨¡æ‹Ÿå®Œæ•´çš„äº¤æ˜“æ‰§è¡Œè¿‡ç¨‹ï¼ˆæ­¢ç›ˆã€æ­¢æŸã€æ»‘ç‚¹ã€æ‰‹ç»­è´¹ï¼‰ï¼Œè®©ä¼˜åŒ–å™¨åŸºäºå®é™…åˆ©æ¶¦é€‰æ‹©å‚æ•°ã€‚

### å†…å­˜ä¿è¯
é€šè¿‡æ‰¹é‡å¤„ç†å’ŒåŠæ—¶é‡Šæ”¾å†…å­˜ï¼Œç¡®ä¿æ€»å†…å­˜å ç”¨<5MBï¼Œè¿œä½äº1GBé™åˆ¶ã€‚

### é¢„æœŸæ•ˆæœ
- å¹³å‡åˆ©æ¶¦ä»-0.3%æå‡åˆ°3-5%
- ç†è®ºvså®é™…å·®è·ä»10.5%ç¼©å°åˆ°3-5%
- ä¼˜åŒ–å™¨èƒ½çœŸæ­£é€‰æ‹©å®é™…ç›ˆåˆ©æœ€é«˜çš„å‚æ•°

---

**ç‰ˆæœ¬**ï¼šV8.3.21.9  
**æ—¥æœŸ**ï¼š2025-11-14  
**çŠ¶æ€**ï¼šâœ… å·²éƒ¨ç½²ï¼ˆå¾…éªŒè¯ï¼‰  
**å†…å­˜å ç”¨**ï¼š~3.3MBï¼ˆè¿œä½äº1GBé™åˆ¶ï¼‰

