# 🖥️ 服务器诊断与优化报告

## 📅 日期：2025-11-09

---

## 🔴 问题诊断

### 核心问题：内存飙升导致服务器卡顿

**症状**
- 内存占用884MB/970MB（91%）
- Swap占用661MB（疯狂使用虚拟内存）
- SSH连接缓慢，操作响应延迟
- 服务器频繁卡死

**根本原因**
1. **数据导出进程失控**：多个`export_historical_data.py`进程同时运行
   - PID 1617：18.8%内存（D状态卡死，I/O堵塞）
   - PID 1688：32.6%内存
   - 合计占用51.4%内存

2. **前端服务重复启动**：3个前端进程同时运行
   - 2个gunicorn进程（旧+新）
   - 1个每日壁纸更换.py

3. **AI进程与数据导出进程冲突**
   - DeepSeek: 7.1%内存
   - Qwen: 4.9%内存
   - 同时运行导致总内存超过70%

---

## ✅ 优化方案

### 1. 清理重复进程

```bash
# 强制停止所有数据导出
pkill -9 -f export_historical_data

# 停止AI进程
pkill -f deepseek_多币种智能版
pkill -f qwen_多币种智能版

# 清理重复前端
pkill -f "python3 ../每日壁纸更换.py"
```

**效果**：内存从884MB降至230MB（释放654MB）

### 2. Supervisor配置说明

**配置文件**：`/etc/supervisor/conf.d/ai-bot.conf`

```ini
[program:deepseek]
command=/bin/bash -c "cd /home/admin/10-23-bot/ds && source .env && /home/admin/10-23-bot/ds/venv/bin/python -u deepseek_多币种智能版.py"
autostart=true
autorestart=true
startsecs=5
stdout_logfile=/home/admin/10-23-bot/ds/logs/deepseek_trading.log

[program:qwen]
command=/bin/bash -c "cd /home/admin/10-23-bot/ds && source .env.qwen && /home/admin/10-23-bot/ds/venv/bin/python -u qwen_多币种智能版.py"
autostart=true
autorestart=true
startsecs=5
stdout_logfile=/home/admin/10-23-bot/ds/logs/qwen_trading.log

[program:web]
command=/home/admin/python代码/my_project/venv/bin/gunicorn -c gunicorn.conf.py -w 1 "每日壁纸更换:app"
autostart=true
autorestart=true
startsecs=8
```

**说明**：
- ✅ `autostart=true`：系统启动时自动运行
- ✅ `autorestart=true`：崩溃后自动重启
- 这是**正常配置**，确保服务高可用

### 3. 定时任务

**Crontab配置**：
```bash
# 健康检查（每10分钟）
*/10 * * * * /home/admin/check_trading_health.sh >> /home/admin/logs/health_check.log 2>&1

# 定时回测（每天北京时间08:05 = UTC 00:05）
5 0 * * * cd /home/admin/10-23-bot/ds && bash 定时回测_安全版.sh >> logs/cron_backtest.log 2>&1
```

---

## 🛠️ 统一管理脚本

**新建脚本**：`服务器管理.sh`

### 功能说明

```bash
# 1. 查看服务器状态
bash 服务器管理.sh status

# 2. 停止所有服务（释放内存）
bash 服务器管理.sh stop

# 3. 启动所有服务
bash 服务器管理.sh start

# 4. 重启所有服务
bash 服务器管理.sh restart

# 5. 生成历史数据（安全模式）
bash 服务器管理.sh export 7   # 生成7天数据
bash 服务器管理.sh export 14  # 生成14天数据

# 6. 清理内存
bash 服务器管理.sh clean

# 7. 手动回测
bash 服务器管理.sh backtest           # DeepSeek
bash 服务器管理.sh backtest qwen      # Qwen
```

### 安全模式特性

**数据导出安全模式**：
1. 自动检测是否有其他导出进程
2. 临时停止AI服务释放内存
3. 导出完成后自动重启AI服务
4. 避免内存耗尽

---

## 📊 优化后状态

### 内存使用
```
优化前：884MB/970MB（91%）+ Swap 661MB
优化后：426MB/970MB（44%）+ Swap 104MB
```

### 运行进程
```
✅ deepseek    - RUNNING (17.2%内存)
✅ qwen        - RUNNING (9.2%内存)
✅ web         - RUNNING (2.7%内存)
❌ export      - 无（按需运行）
```

### 数据文件
```
✅ DeepSeek订单：61笔（+2.01U）
✅ Qwen订单：8笔（-1.56U）
✅ 市场快照：8天数据（11-02至11-09）
```

---

## ⚠️ 重要注意事项

### 1. 内存管理原则（1GB环境）
- ✅ AI服务：正常运行（30%内存）
- ✅ Web服务：正常运行（3%内存）
- ❌ **数据导出：不可与AI同时运行**（会占用50%+内存）

### 2. 数据导出最佳实践
```bash
# 推荐：使用服务器管理.sh（自动管理内存）
bash 服务器管理.sh export 7

# 不推荐：直接运行（可能导致OOM）
python3 export_historical_data.py 20251102 20251109
```

### 3. 回测建议
- 使用`服务器管理.sh backtest`会自动检测资源冲突
- 如有数据导出进程，会警告并询问是否继续

### 4. 问题排查
```bash
# 服务器卡顿时，先检查状态
bash 服务器管理.sh status

# 查看内存占用TOP5
ps aux --sort=-%mem | head -6

# 强制清理
bash 服务器管理.sh clean
```

---

## 📋 日常维护

### 每日操作
1. **早上08:05**：系统自动回测（定时任务）
2. **每10分钟**：健康检查（定时任务）
3. **按需**：查看状态 `bash 服务器管理.sh status`

### 每周操作
1. 检查磁盘空间：`df -h`
2. 查看日志文件大小：`du -sh logs/`
3. 清理旧日志（可选）

### 问题处理
| 问题 | 命令 |
|------|------|
| 服务器卡死 | `bash 服务器管理.sh clean` |
| 服务异常 | `bash 服务器管理.sh restart` |
| 数据过期 | `bash 服务器管理.sh export 7` |
| 手动回测 | `bash 服务器管理.sh backtest` |

---

## 🔧 技术细节

### 订单数据恢复

**问题**：之前DeepSeek和Qwen的订单数据完全相同

**原因**：`load_dotenv()`默认不覆盖已有环境变量

**修复**：
```python
# restore_orders_simple.py
load_dotenv(env_file, override=True)  # ⚠️ 必须override=True
```

**效果**：两个模型现在正确使用各自的币安账户

### 代码版本

**当前版本**：V8.3.16.8（稳定版本）

**核心特性**：
- ✅ 冷启动优化（无交易历史也可运行）
- ✅ 分离策略优化（超短线/波段独立）
- ✅ V8.3.16省流优化（减少内存占用）

---

## 📱 快速参考

### 常用命令
```bash
# 检查状态
bash 服务器管理.sh status

# 回测
bash 服务器管理.sh backtest

# 生成数据
bash 服务器管理.sh export 7

# 清理内存
bash 服务器管理.sh clean
```

### 前端地址
```
http://3.27.205.44:5001/
```

### 日志位置
```
AI日志：/home/admin/10-23-bot/ds/logs/
Web日志：/home/admin/python代码/my_project/logs/
Cron日志：/home/admin/logs/
```

---

## ✅ 总结

1. **问题根源**：数据导出进程失控导致内存耗尽
2. **解决方案**：清理进程 + 统一管理脚本
3. **当前状态**：健康（内存44%）
4. **后续维护**：使用`服务器管理.sh`进行所有操作

**🎯 核心原则**：在1GB内存环境下，数据导出和AI服务不可同时运行！

