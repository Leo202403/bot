# å†…å­˜ç›‘æ§é›†æˆæŒ‡å—
V8.5.2.4.89.2

## ğŸ¯ ç›®æ ‡

é€šè¿‡ç²¾ç¡®çš„å†…å­˜ç›‘æ§ï¼Œ**å®šä½OOMçš„å…·ä½“ä½ç½®**ï¼Œè§£å†³"ä»…é æ—¥å¿—åˆ¤æ–­ä¸å¤Ÿç²¾ç¡®"çš„é—®é¢˜ã€‚

---

## ğŸ“¦ æ–¹æ¡ˆé€‰æ‹©

### æ–¹æ¡ˆAï¼šè½»é‡çº§æ‰‹åŠ¨é›†æˆï¼ˆ**æ¨è**ï¼‰

**ä¼˜ç‚¹**ï¼š
- ç®€å•ã€å®‰å…¨ã€å¯æ§
- ä¸ä¿®æ”¹ç°æœ‰ä»£ç ç»“æ„
- æ˜“äºè°ƒè¯•å’Œç§»é™¤

**æ­¥éª¤**ï¼š

#### 1. å®‰è£…psutilï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰

```bash
pip3 install psutil
```

#### 2. å¤åˆ¶memory_monitor.pyåˆ°dsç›®å½•

æ–‡ä»¶å·²åˆ›å»ºåœ¨ï¼š`ds/memory_monitor.py`

#### 3. åœ¨å›æµ‹ä»£ç ä¸­æ·»åŠ ç›‘æ§ï¼ˆæ‰‹åŠ¨ï¼‰

åœ¨`deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py`å’Œ`qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py`ä¸­ï¼š

**3.1 å¯¼å…¥ç›‘æ§å™¨ï¼ˆåœ¨æ–‡ä»¶å¼€å¤´ï¼‰**

```python
# ã€V8.5.2.4.89.2ã€‘é›†æˆå†…å­˜ç›‘æ§
from memory_monitor import init_global_monitor, memory_checkpoint
```

**3.2 åˆå§‹åŒ–ç›‘æ§å™¨ï¼ˆåœ¨å›æµ‹å¼€å§‹å‰ï¼‰**

æ‰¾åˆ°å›æµ‹å¼€å§‹çš„åœ°æ–¹ï¼ˆå¤§çº¦ç¬¬9750è¡Œï¼Œ`if manual_backtest:`ï¼‰ï¼Œåœ¨å…¶åæ·»åŠ ï¼š

```python
if manual_backtest:
    # ã€V8.5.2.4.89.2ã€‘åˆå§‹åŒ–å†…å­˜ç›‘æ§
    from datetime import datetime
    bot_name = "deepseek"  # æˆ– "qwen"
    memory_monitor = init_global_monitor(
        name=f"{bot_name}_backtest",
        log_file=f"memory_monitor_{bot_name}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.log",
        warning_threshold_mb=800,  # 800MBè­¦å‘Š
        critical_threshold_mb=950   # 950MBå±é™©
    )
    memory_checkpoint("å›æµ‹å¯åŠ¨")
```

**3.3 åœ¨å…³é”®ä½ç½®æ·»åŠ æ£€æŸ¥ç‚¹**

åœ¨ä»¥ä¸‹ä½ç½®æ·»åŠ `memory_checkpoint()`è°ƒç”¨ï¼š

```python
# Phase 1 å¼€å§‹
print("ã€Phase 1: å®¢è§‚æœºä¼šè¯†åˆ«ã€‘")
memory_checkpoint("Phase1_START")

# Phase 1 ç»“æŸ
print("  âœ… å®¢è§‚æœºä¼šè¯†åˆ«å®Œæˆ")
memory_checkpoint("Phase1_END")

# Phase 2 å¼€å§‹
print("ã€ç¬¬2æ­¥ï¼šå¤šè½®è¿­ä»£å‚æ•°ä¼˜åŒ–ã€‘")
memory_checkpoint("Phase2_START")

# Phase 2 ç»“æŸï¼ˆä¿å­˜configä¹‹å‰ï¼‰
memory_checkpoint("Phase2_ä¿å­˜config_BEFORE")
save_learning_config(config)
memory_checkpoint("Phase2_ä¿å­˜config_AFTER")

# Phase 3 å¼€å§‹
print("ã€ğŸš€ Phase 3å¯åŠ¨ã€‘")
memory_checkpoint("Phase3_START")

# Phase 3 ç²—ç­›
print("     âš¡ ã€ç¬¬ä¸€é˜¶æ®µï¼šç²—ç­›ã€‘")
memory_checkpoint("Phase3_ç²—ç­›_START")
# ... ç²—ç­›é€»è¾‘ ...
memory_checkpoint("Phase3_ç²—ç­›_END")

# Phase 3 ç²¾é€‰
print("     ğŸ”¬ ã€ç¬¬äºŒé˜¶æ®µï¼šç²¾é€‰ã€‘")
memory_checkpoint("Phase3_ç²¾é€‰_START")
# ... ç²¾é€‰é€»è¾‘ ...
memory_checkpoint("Phase3_ç²¾é€‰_END")

# Phase 3 åˆ†ç¦»ä¼˜åŒ–
print("  ğŸ“Š ã€åˆ†ç¦»ä¼˜åŒ–ã€‘")
memory_checkpoint("Phase3_åˆ†ç¦»ä¼˜åŒ–_START")
# ... åˆ†ç¦»ä¼˜åŒ–é€»è¾‘ ...
memory_checkpoint("Phase3_åˆ†ç¦»ä¼˜åŒ–_END")

# Phase 4 å¼€å§‹
print("ã€âœ… Phase 4ï¼šå‚æ•°éªŒè¯ä¸è¿‡æ‹Ÿåˆæ£€æµ‹ã€‘")
memory_checkpoint("Phase4_START")

# Phase 4 ç»“æŸ
print("  âœ… Phase 4éªŒè¯é€šè¿‡")
memory_checkpoint("Phase4_END")

# ğŸ”¥ å…³é”®OOMç‚¹1ï¼šå‚æ•°å˜åŒ–æ£€æµ‹
memory_checkpoint("å‚æ•°å˜åŒ–æ£€æµ‹_BEFORE")
print("[å‚æ•°å˜åŒ–æ£€æµ‹] config_changed = True")
memory_checkpoint("å‚æ•°å˜åŒ–æ£€æµ‹_AFTER")

# ğŸ”¥ å…³é”®OOMç‚¹2ï¼šåŠ è½½configï¼ˆç¬¬10810è¡Œé™„è¿‘ï¼‰
memory_checkpoint("åŠ è½½config_BEFORE")
config = load_learning_config()
memory_checkpoint("åŠ è½½config_AFTER", f"configå¤§å°ä¼°è®¡~{len(str(config))//1024}KB")

# ğŸ”¥ å…³é”®OOMç‚¹3ï¼šåˆ›å»ºold_configï¼ˆç¬¬10812è¡Œé™„è¿‘ï¼‰
memory_checkpoint("åˆ›å»ºold_config_BEFORE")
old_config = {
    'global': copy.deepcopy(config.get('global', {})),
    'per_symbol': copy.deepcopy(config.get('per_symbol', {})),
    'scalping_params': copy.deepcopy(config.get('scalping_params', {})),
    'swing_params': copy.deepcopy(config.get('swing_params', {}))
}
memory_checkpoint("åˆ›å»ºold_config_AFTER")

# æ”¶é›†Phaseæ•°æ®
print("[V8.5.2.4.81] æ”¶é›†Phaseæ•°æ®...")
memory_checkpoint("æ”¶é›†Phaseæ•°æ®_START")

# æœºä¼šå¯¹æ¯”åˆ†æ
print("  ğŸ“Š [V8.5.2.4.47] ç”Ÿæˆæœºä¼šå¯¹æ¯”åˆ†æ...")
memory_checkpoint("æœºä¼šå¯¹æ¯”åˆ†æ_START")

# é‚®ä»¶ç”Ÿæˆ
memory_checkpoint("é‚®ä»¶ç”Ÿæˆ_START")
print("ğŸ“§ ç”Ÿæˆé‚®ä»¶ä¸»é¢˜...")
# ... é‚®ä»¶ç”Ÿæˆé€»è¾‘ ...
print("âœ… é‚®ä»¶å‘é€æˆåŠŸ")
memory_checkpoint("é‚®ä»¶ç”Ÿæˆ_END")

# ç¨‹åºç»“æŸ
memory_checkpoint("ç¨‹åºç»“æŸ")

# ç”Ÿæˆå†…å­˜ç›‘æ§æŠ¥å‘Š
if memory_monitor:
    report = memory_monitor.generate_report()
    print("\n" + report)
```

---

### æ–¹æ¡ˆBï¼šä½¿ç”¨tracemallocï¼ˆPythonå†…ç½®ï¼Œæ— éœ€é¢å¤–å®‰è£…ï¼‰

å¦‚æœä¸æƒ³å®‰è£…psutilï¼Œå¯ä»¥ç”¨Pythonå†…ç½®çš„tracemallocï¼š

```python
import tracemalloc
import sys

# åœ¨å›æµ‹å¼€å§‹å‰å¯åŠ¨
tracemalloc.start()

# åœ¨å…³é”®ä½ç½®è®°å½•å¿«ç…§
def memory_snapshot(name):
    current, peak = tracemalloc.get_traced_memory()
    print(f"[å†…å­˜] {name}: å½“å‰={current/1024/1024:.2f}MB, å³°å€¼={peak/1024/1024:.2f}MB")
    
    # è·å–Top 10å†…å­˜å ç”¨
    snapshot = tracemalloc.take_snapshot()
    top_stats = snapshot.statistics('lineno')
    print(f"  Top 3å†…å­˜å ç”¨:")
    for stat in top_stats[:3]:
        print(f"    {stat}")

# ä½¿ç”¨
memory_snapshot("Phase1_START")
# ... ä»£ç  ...
memory_snapshot("Phase1_END")
```

---

## ğŸ“Š ä½¿ç”¨æ–¹æ³•

### 1. è¿è¡Œå›æµ‹

```bash
cd /root/10-23-bot/ds
MANUAL_BACKTEST=true python3 deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py backtest-deepseek
```

### 2. æŸ¥çœ‹å®æ—¶ç›‘æ§ï¼ˆå¦ä¸€ä¸ªç»ˆç«¯ï¼‰

```bash
tail -f memory_monitor_deepseek_*.log
```

### 3. å¦‚æœå‡ºç°Killed

**ç«‹å³æŸ¥çœ‹æ—¥å¿—çš„æœ€åå‡ è¡Œ**ï¼š

```bash
tail -50 memory_monitor_deepseek_*.log
```

**æœ€åä¸€ä¸ªæ£€æŸ¥ç‚¹å³ä¸ºOOMå‘ç”Ÿä½ç½®**ï¼

ç¤ºä¾‹è¾“å‡ºï¼š

```
[2025-11-20 10:30:45] [INFO] [Phase4_END] RSS=510.23MB (Î”+450.12MB, +15.32MB)
[2025-11-20 10:30:46] [INFO] [å‚æ•°å˜åŒ–æ£€æµ‹_BEFORE] RSS=512.45MB (Î”+452.34MB, +2.22MB)
[2025-11-20 10:30:46] [INFO] [å‚æ•°å˜åŒ–æ£€æµ‹_AFTER] RSS=513.67MB (Î”+453.56MB, +1.22MB)
[2025-11-20 10:30:47] [INFO] [åŠ è½½config_BEFORE] RSS=515.89MB (Î”+455.78MB, +2.22MB)
[2025-11-20 10:30:48] [WARNING] [åŠ è½½config_AFTER] RSS=845.23MB (Î”+785.12MB, +329.34MB)  â† çœ‹è¿™é‡Œï¼
[2025-11-20 10:30:48] [CRITICAL] âš ï¸ å†…å­˜æ¥è¿‘å±é™©é˜ˆå€¼ï¼å½“å‰RSS=845.23MB (é˜ˆå€¼=950.00MB)
[2025-11-20 10:30:49] [åå°ç›‘æ§] RSS=980.45MB (Î”+920.34MB)  â† Killedå‘ç”Ÿåœ¨è¿™ä¹‹å
```

ä»è¿™ä¸ªä¾‹å­å¯ä»¥çœ‹å‡ºï¼š
- `åŠ è½½config_AFTER`å¢é•¿äº†**329MB**ï¼
- è¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨

### 4. æŸ¥çœ‹å®Œæ•´æŠ¥å‘Šï¼ˆå›æµ‹æˆåŠŸå®Œæˆåï¼‰

```bash
cat memory_monitor_deepseek_*.log | grep "å†…å­˜ç›‘æ§æŠ¥å‘Š" -A 50
```

æˆ–è€…åœ¨Pythonä¸­ï¼š

```python
from memory_monitor import get_global_monitor
monitor = get_global_monitor()
if monitor:
    print(monitor.generate_report())
```

---

## ğŸ” é«˜çº§ç”¨æ³•

### ç›‘æ§ç‰¹å®šä»£ç å—

```python
from memory_monitor import memory_context

with memory_context("åŠ è½½å¤§å‹æ•°æ®"):
    config = load_learning_config()
    # è‡ªåŠ¨åœ¨è¿›å…¥å’Œé€€å‡ºæ—¶è®°å½•å†…å­˜
```

### ç›‘æ§å‡½æ•°

```python
from memory_monitor import monitor_function

@monitor_function("phase3_optimizer")
def optimize_phase3():
    # å‡½æ•°æ‰§è¡Œå‰åè‡ªåŠ¨è®°å½•å†…å­˜
    pass
```

### åå°æŒç»­ç›‘æ§

åå°ç›‘æ§çº¿ç¨‹ä¼šæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡å†…å­˜ï¼Œå¦‚æœè¶…è¿‡è­¦å‘Šé˜ˆå€¼ä¼šè‡ªåŠ¨è®°å½•ï¼š

```python
# åˆå§‹åŒ–æ—¶é»˜è®¤å¼€å¯
monitor = init_global_monitor(
    warning_threshold_mb=800,
    check_interval=5.0  # æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
)

# æ‰‹åŠ¨åœæ­¢
monitor.stop_background_monitor()
```

---

## ğŸ“ˆ åˆ†æOOMçš„æµç¨‹

1. **è¿è¡Œå›æµ‹**ï¼ˆå¸¦å†…å­˜ç›‘æ§ï¼‰
2. **å¦‚æœKilled**ï¼š
   - æŸ¥çœ‹`memory_monitor_*.log`çš„æœ€å20-50è¡Œ
   - æ‰¾åˆ°æœ€åä¸€ä¸ªæ£€æŸ¥ç‚¹
   - æŸ¥çœ‹å†…å­˜å¢é•¿æœ€å¤§çš„æ£€æŸ¥ç‚¹ï¼ˆæŠ¥å‘Šä¸­çš„"Top 10å†…å­˜å¢é•¿ç‚¹"ï¼‰
3. **å®šä½é—®é¢˜**ï¼š
   - æœ€åä¸€ä¸ªæ£€æŸ¥ç‚¹ = OOMå‘ç”Ÿä½ç½®
   - å†…å­˜å¢é•¿æœ€å¤§çš„æ£€æŸ¥ç‚¹ = å¯ç–‘çš„å†…å­˜æ³„æ¼ç‚¹
4. **é’ˆå¯¹æ€§ä¼˜åŒ–**ï¼š
   - åœ¨è¯¥ä½ç½®æ·»åŠ `gc.collect()`
   - å‡å°‘æ•°æ®é‡
   - æ”¹ç”¨æµå¼å¤„ç†
   - åˆ é™¤ä¸å¿…è¦çš„æ·±æ‹·è´

---

## ğŸ¯ å¿«é€Ÿå¼€å§‹ï¼ˆæœ€å°åŒ–é›†æˆï¼‰

å¦‚æœåªæƒ³å¿«é€Ÿæµ‹è¯•ï¼Œåªéœ€æ·»åŠ 3å¤„ä»£ç ï¼š

```python
# 1. å¯¼å…¥ï¼ˆæ–‡ä»¶å¼€å¤´ï¼‰
from memory_monitor import init_global_monitor, memory_checkpoint

# 2. åˆå§‹åŒ–ï¼ˆå›æµ‹å¼€å§‹ï¼‰
if manual_backtest:
    from datetime import datetime
    memory_monitor = init_global_monitor(
        name="deepseek_backtest",
        log_file=f"memory_monitor_{datetime.now().strftime('%Y%m%d_%H%M%S')}.log",
        warning_threshold_mb=800,
        critical_threshold_mb=950
    )
    memory_checkpoint("å›æµ‹å¯åŠ¨")

# 3. åœ¨æ¯ä¸ªprint()åé¢æ·»åŠ checkpointï¼ˆå¯é€‰ï¼ŒåªåŠ å…³é”®ä½ç½®ï¼‰
print("ã€Phase 1: å®¢è§‚æœºä¼šè¯†åˆ«ã€‘")
memory_checkpoint("Phase1_START")
```

**å°±æ˜¯è¿™ä¹ˆç®€å•ï¼**

---

## â“ FAQ

### Q1: psutilå®‰è£…å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

ä½¿ç”¨æ–¹æ¡ˆBï¼ˆtracemallocï¼‰ï¼Œæ— éœ€å¤–éƒ¨ä¾èµ–ã€‚

### Q2: ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ

- æ£€æŸ¥ç‚¹è®°å½•ï¼šå‡ ä¹æ— å½±å“ï¼ˆ<0.1ms/æ¬¡ï¼‰
- åå°ç›‘æ§ï¼šå ç”¨<1% CPU
- æ€»ä½“å½±å“ï¼šå¯å¿½ç•¥ä¸è®¡

### Q3: æ—¥å¿—æ–‡ä»¶ä¼šå¾ˆå¤§å—ï¼Ÿ

é€šå¸¸<10MBï¼Œå¦‚æœæ‹…å¿ƒå¯ä»¥æ·»åŠ æ—¥å¿—è½®è½¬ï¼š

```python
import logging
from logging.handlers import RotatingFileHandler

handler = RotatingFileHandler(
    'memory_monitor.log',
    maxBytes=10*1024*1024,  # 10MB
    backupCount=3
)
```

### Q4: å¯ä»¥ç›‘æ§å­è¿›ç¨‹å—ï¼Ÿ

å¯ä»¥ï¼Œä½†éœ€è¦åœ¨æ¯ä¸ªå­è¿›ç¨‹ä¸­å•ç‹¬åˆå§‹åŒ–ç›‘æ§å™¨ã€‚

### Q5: å¦‚ä½•æ‰¾åˆ°å†…å­˜æ³„æ¼ï¼Ÿ

æŸ¥çœ‹æŠ¥å‘Šä¸­çš„"Top 10å†…å­˜å¢é•¿ç‚¹"ï¼Œå¢é•¿å¼‚å¸¸å¤§çš„æ£€æŸ¥ç‚¹å°±æ˜¯å¯ç–‘ç‚¹ã€‚

---

## ğŸ“ ç¤ºä¾‹ï¼šå®Œæ•´çš„æœ€å°é›†æˆ

```python
# ===== deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py =====

# 1. å¯¼å…¥ï¼ˆæ–‡ä»¶å¼€å¤´ï¼Œçº¦ç¬¬30è¡Œï¼‰
from memory_monitor import init_global_monitor, memory_checkpoint

# 2. åˆå§‹åŒ–ï¼ˆçº¦ç¬¬9750è¡Œï¼Œmanual_backtestå¼€å§‹å¤„ï¼‰
if manual_backtest:
    from datetime import datetime
    monitor = init_global_monitor(
        name="deepseek_backtest",
        log_file=f"memory_monitor_deepseek_{datetime.now().strftime('%Y%m%d_%H%M%S')}.log",
        warning_threshold_mb=800,
        critical_threshold_mb=950
    )
    memory_checkpoint("å›æµ‹å¯åŠ¨")
    
    # ... ç°æœ‰ä»£ç  ...

# 3. åœ¨å…³é”®ä½ç½®æ·»åŠ æ£€æŸ¥ç‚¹ï¼ˆæ ¹æ®ä¸Šé¢çš„åˆ—è¡¨ï¼‰

# 4. ç”ŸæˆæŠ¥å‘Šï¼ˆç¨‹åºç»“æŸå‰ï¼‰
if monitor:
    report = monitor.generate_report()
    print("\n" + report)
```

---

**å®Œæˆï¼ç°åœ¨ä½ å¯ä»¥ç²¾ç¡®å®šä½OOMçš„å…·ä½“ä½ç½®äº†ã€‚** ğŸ‰

