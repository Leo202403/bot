# 遗传算法权重进化器集成指南 V8.7.3

## 📋 更新摘要

基于交易员建议实现信号权重的自由进化，突破手动定义权重的局限性。

---

## 🎯 核心理念

### 传统方式的局限
- 手动定义5组权重（动量优先、放量优先...）
- 靠猜测哪组好，Grid Search测试
- **无法自适应市场状态变化**
- **"确定性陷阱"**：趋势越完美，分数越高（往往是行情末尾）

### 遗传算法方案
- 自动生成20组随机权重
- **适应度函数 = 高分必须对应高利润**
- 优胜劣汰进化10代
- **自动发现最适合当前市场的权重**

---

## 🔧 实施步骤

### 1. 立即生效：高盈亏比探索权重

已在 `deepseek_多币种智能版.py` 和 `qwen_多币种智能版.py` 中添加新权重候选：

#### 超短线权重特征
```python
{
    "momentum": 35,           # 极度看重动量（启动点）
    "volume": 20,             # 降低成交量权重
    "breakout": 20,           # 降低突破权重（假突破多）
    "pattern": 10,            # 形态次要
    "trend_align": 5,         # 几乎忽略趋势对齐（防止追高）
    "volatility": 25,         # 提高波动率（大行情特征）
    "momentum_accel": 30,     # 极度看重动量加速（爆发点）
    "space_factor": 35,       # 🆕 V8.7.3空间因子
    "position_factor": 25,    # 🆕 V8.7.3位置因子
    "name": "高盈亏比探索",
}
```

#### 波段权重特征
```python
{
    "momentum": 15,           # 降低动能权重（滞后指标）
    "volume": 15,             # 降低成交量权重
    "breakout": 15,           # 降低突破权重（假突破多）
    "trend_align": 10,        # 大幅降低趋势对齐（防止追高）
    "space_factor": 35,       # 🆕 极度看重空间因子
    "position_factor": 30,    # 🆕 极度看重位置因子（at_support）
    "freshness_factor": 20,   # 🆕 极度看重新鲜度（新趋势）
    "name": "高盈亏比探索",
}
```

**设计理念**：
- ❌ 降低：`trend_align`（防止追高）、`breakout`（假突破多）
- ✅ 提高：`momentum`、`space_factor`、`position_factor`
- 🎯 目标：抓住**启动点**而非**确认点**

### 2. 遗传算法进化器

新增文件：`ds/signal_weight_evolver.py`

#### 核心类：`SignalWeightEvolver`

```python
from ds.signal_weight_evolver import SignalWeightEvolver

# 初始化
evolver = SignalWeightEvolver(
    opportunities=phase1_opportunities,  # Phase 1识别的机会
    signal_type='scalping'  # 或 'swing'
)

# 运行进化
best_weights = evolver.evolve(
    generations=10,        # 进化代数
    population_size=20     # 种群大小
)
```

#### 适应度函数设计

```python
fitness = (top_20_profit × 2.0) + (correlation × 20) + (score_std × 0.5)
```

- **头部效应 (60%)**：分数最高的20%机会的平均利润
- **相关性 (30%)**：分数与利润的皮尔逊相关系数
- **区分度 (10%)**：分数的标准差（避免所有机会都80分）

---

## 📦 集成到优化流程

### 方案A：快速集成（推荐）

在 `backtest_optimizer_v8321.py` 的 `quick_global_search_v8316` 函数中，Phase 1之后插入：

```python
# Phase 1完成后...
phase1_baseline = {...}

# 🧬 【新增】Phase 1.5: 信号权重自由进化
from ds.signal_weight_evolver import integrate_evolver_to_phase2

scalping_weight_candidates, swing_weight_candidates = integrate_evolver_to_phase2(
    confirmed_opportunities=confirmed_opportunities,
    scalping_weight_candidates=scalping_weight_candidates,
    swing_weight_candidates=swing_weight_candidates,
    quick_evolve=True  # 快速模式：5代，适合在线优化
)

# Phase 2继续...
```

### 方案B：手动集成

```python
# 在 Phase 2 之前
if confirmed_opportunities and 'scalping' in confirmed_opportunities:
    train_opps = confirmed_opportunities['scalping']['opportunities']
    
    if len(train_opps) >= 20:  # 至少需要20个样本
        evolver = SignalWeightEvolver(train_opps, signal_type='scalping')
        best_scalping_weights = evolver.evolve(generations=5, population_size=20)
        
        # 将进化出的权重加入候选列表
        scalping_weight_candidates.append(best_scalping_weights)
        print(f"✅ AI_Evolved权重已加入候选池")
```

---

## 📊 预期效果

### 解决"确定性陷阱"

**传统逻辑**：
- 趋势越完美，分数越高
- 往往是行情末尾
- 利润低

**进化逻辑**：
- 如果历史数据显示，`volatility`（波动率）高的信号虽然趋势不完美，但利润最大
- 进化算法会自动**调高`volatility`权重**
- 自动**调低`trend_align`权重**

### 自动适应市场体制

**震荡市**：
- 进化算法发现`trend_align`高的信号都亏损
- 自动降低其权重
- 提高`pattern`（反转形态）权重

**单边市**：
- 进化算法发现`breakout`高的信号利润最大
- 自动提高突破权重

### 降低决策成本

- 优化后的`signal_score`直接代表**"获利概率+幅度"**
- AI在Phase 3/4不需要复杂推理
- 只需看分数是否超过80分
- **80分的定义已被进化算法修正为"大概率大肉签"**

---

## 🔬 参数调优建议

### 快速模式（在线优化）
```python
evolver.evolve(generations=5, population_size=20)
```
- 适用场景：实时优化，时间有限
- 进化速度：约30-60秒
- 适应度提升：60-80%

### 完整模式（离线研究）
```python
evolver.evolve(generations=15, population_size=30)
```
- 适用场景：深度回测，寻找极致权重
- 进化速度：约2-5分钟
- 适应度提升：90-95%

### 数据要求
- **最少样本**：20个机会（才能启动进化）
- **推荐样本**：50+机会（相关性更稳定）
- **理想样本**：100+机会（避免过拟合）

---

## ⚠️ 注意事项

### 1. 基因维度定义

进化器当前支持V8.7.3的新维度：

**超短线**：
- `momentum`, `volume`, `breakout`, `pattern`, `trend_align`
- `volatility`, `volume_pulse`, `momentum_accel`
- 🆕 `space_factor`, `position_factor`

**波段**：
- `momentum`, `volume`, `breakout`, `trend_align`
- `ema_divergence`, `trend_4h_strength`
- 🆕 `space_factor`, `position_factor`, `freshness_factor`

### 2. 快照数据要求

Phase 1的`snapshot`必须包含以下字段：

必需字段：
- `close`, `open`, `side`
- `volume_ratio`, `trend_4h`, `trend_1h`, `trend_15m`
- `breakout`, `pattern`, `atr_14`

新维度字段：
- `nearest_resistance`, `nearest_support`（空间因子）
- `position_status`（位置因子）
- `mkt_struct_age_candles`（新鲜度因子）

### 3. 过拟合风险

遗传算法可能过拟合训练数据，建议：

**训练集/测试集分离**：
```python
train_opps = opportunities[:int(len(opportunities) * 0.8)]
test_opps = opportunities[int(len(opportunities) * 0.8):]

# 在train_opps上进化
evolver = SignalWeightEvolver(train_opps, signal_type='swing')
best_weights = evolver.evolve()

# 在test_opps上验证
```

**多时期验证**：
- 用最近7天数据进化权重
- 在前7天数据上验证
- 确保适应度不显著下降

---

## 🚀 下一步优化方向

### 1. 多目标优化
当前适应度函数只优化利润，可扩展为：
- 最大化利润
- 最小化回撤
- 最大化夏普比率

### 2. 自适应进化
根据市场状态自动调整进化参数：
- 高波动期：增加`volatility`权重范围
- 趋势期：增加`trend_align`权重范围

### 3. 集成到实时系统
- 每周自动运行一次进化
- 根据最近14天数据更新权重
- 自动切换到表现最好的权重组合

---

## 📝 版本历史

**V8.7.3** (2025-11-23)
- 🆕 创建遗传算法进化器
- 🆕 添加"高盈亏比探索"权重候选
- ✅ 支持V8.7.3新维度（space_factor, position_factor, freshness_factor）

---

**致谢**：感谢交易员朋友的深度建议，成功将"确定性陷阱"转化为"期望型评分"！🎯

