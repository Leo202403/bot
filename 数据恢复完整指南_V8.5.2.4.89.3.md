# 数据恢复完整指南 V8.5.2.4.89.3

**时间**: 2025-11-20  
**版本**: V8.5.2.4.89.3  
**提交**: d4c2821  
**状态**: ✅ 所有Bug已修复，可以开始数据恢复

---

## 🎉 最新修复（V8.5.2.4.89.3）

### 关键Bug修复：DeepSeek回测错误使用Qwen API

**问题描述**:
```
⚠️  AI Call Failed: API key not found for qwen
```
在运行 DeepSeek 回测时出现 Qwen API 错误。

**根本原因**:
```python
# ds/deepseek_多币种智能版.py 第8026行
model_name = os.getenv("MODEL_NAME", "qwen")  # ❌ 错误！应该是 "deepseek"
```

**修复**:
```python
# 【V8.5.2.4.89.3】修复：DeepSeek回测应使用deepseek模型
model_name = os.getenv("MODEL_NAME", "deepseek")  # ✅ 正确
```

**影响**: 
- ✅ DeepSeek回测现在会正确使用DeepSeek API（如果配置了 `DEEPSEEK_API_KEY`）
- ✅ 如果未配置API密钥，会正确fallback到默认参数（不影响回测完成）

---

## 📊 当前状态总结

### ✅ 已修复的所有问题

| 版本 | 问题 | 状态 |
|------|------|------|
| V8.5.2.4.89 | iter_result 变量未定义 | ✅ 已修复 |
| V8.5.2.4.89.2 | Bark推送格式化错误 | ✅ 已修复 |
| V8.5.2.4.89.2 | Phase 4提示不清晰 | ✅ 已优化 |
| V8.5.2.4.89.2 | Phase 3提示不清晰 | ✅ 已优化 |
| V8.5.2.4.89.3 | **DeepSeek错用Qwen API** | ✅ **已修复** |

### ✅ 当前配置（内存优化版）

```python
lookback_days = 5         # 回测天数
max_opportunities = 300   # Phase 1机会数
max_combinations = 4      # Phase 2测试组合
sample_size = 400         # Phase 3采样数
```

**内存峰值**: 79.86MB（非常健康）

---

## 🎯 数据恢复路线图

### 目标：从 5天/300机会 → 14天/2000机会

#### 📈 恢复策略：保守三阶段

```
当前状态 → 阶段1 → 阶段2 → 阶段3（完全恢复）
79MB     400-500MB  500-700MB  700-900MB
```

---

## 🚀 阶段1：小幅增加（推荐第一步）

### 目标参数
```python
lookback_days = 5 → 7
max_opportunities = 300 → 500
max_combinations = 4 → 6
sample_size = 400 → 500
```

### 预计效果
- **内存峰值**: 400-500MB
- **数据量**: 增加40%
- **风险等级**: 🟢 低（保守）

### 操作步骤

#### 1️⃣ 上传文件到服务器
```bash
# 在本地终端（Mac）
cd ~/Downloads/10-23-bot
./upload_to_server.sh <服务器IP>
```

#### 2️⃣ SSH到服务器
```bash
ssh root@<服务器IP>
```

#### 3️⃣ 执行阶段1恢复
```bash
cd /root/10-23-bot/ds

# 恢复到阶段1
python3 restore_data_volume.py stage1

# 验证修改
grep -E "lookback_days|max_opportunities|max_combinations|sample_size" deepseek_多币种智能版.py | head -10

# 应该看到：
# lookback_days = 7
# max_opportunities = 500
# max_combinations = 6
# sample_size = 500
```

#### 4️⃣ 运行回测（带内存监控）
```bash
# 停止supervisor
supervisorctl stop deepseek qwen

# 运行回测
MANUAL_BACKTEST=true python3 run_with_memory_monitor.py > /tmp/backtest_stage1.txt 2>&1 &

# 实时查看输出
tail -f /tmp/backtest_stage1.txt
```

#### 5️⃣ 另开窗口监控内存
```bash
# SSH到服务器（新窗口）
ssh root@<服务器IP>

# 实时监控
watch -n 2 'free -h && echo "---" && tail -3 /root/10-23-bot/ds/memory_monitor_simple.log'
```

#### 6️⃣ 回测完成后评估
```bash
# 查看内存峰值
echo "=== 阶段1内存峰值 ==="
cat /root/10-23-bot/ds/memory_monitor_simple.log | awk -F',' '{print $2,$3}' | sort -n | tail -5

# 查看回测结果
tail -100 /tmp/backtest_stage1.txt
```

### 判定标准

| 内存峰值 | 判定 | 下一步 |
|---------|------|--------|
| < 400MB | 🟢 优秀 | 第二天继续阶段2 |
| 400-500MB | 🟢 成功 | 第二天继续阶段2 |
| 500-700MB | 🟡 可接受 | 保持阶段1，观察几天 |
| 700-800MB | 🟠 接近上限 | 回退到当前配置 |
| > 800MB 或 OOM | 🔴 失败 | 立即回退 |

---

## 🚀 阶段2：中等增加（如果阶段1成功）

### 目标参数
```python
lookback_days = 7 → 10
max_opportunities = 500 → 1000
max_combinations = 6 → 7
sample_size = 500 → 600
```

### 预计效果
- **内存峰值**: 500-700MB
- **数据量**: 增加100%（相比阶段1）
- **风险等级**: 🟡 中等

### 操作步骤

#### 1️⃣ 确认阶段1稳定（建议运行1-2天）

#### 2️⃣ 执行阶段2恢复
```bash
cd /root/10-23-bot/ds

# 恢复到阶段2
python3 restore_data_volume.py stage2

# 验证修改
grep -E "lookback_days|max_opportunities" deepseek_多币种智能版.py | head -10
```

#### 3️⃣ 运行回测（带内存监控）
```bash
supervisorctl stop deepseek qwen
MANUAL_BACKTEST=true python3 run_with_memory_monitor.py > /tmp/backtest_stage2.txt 2>&1 &
tail -f /tmp/backtest_stage2.txt
```

#### 4️⃣ 评估结果
```bash
echo "=== 阶段2内存峰值 ==="
cat /root/10-23-bot/ds/memory_monitor_simple.log | awk -F',' '{print $2,$3}' | sort -n | tail -5
```

### 判定标准

| 内存峰值 | 判定 | 下一步 |
|---------|------|--------|
| < 600MB | 🟢 优秀 | 第二天继续阶段3 |
| 600-700MB | 🟢 成功 | 第二天继续阶段3 |
| 700-800MB | 🟡 可接受 | **保持阶段2，长期运行** |
| > 800MB 或 OOM | 🔴 失败 | 回退到阶段1 |

**💡 建议**: 如果阶段2稳定在700MB以下，可以长期保持这个配置（10天/1000机会已经足够）。

---

## 🚀 阶段3：完全恢复（如果阶段2成功）

### 目标参数（原始配置）
```python
lookback_days = 10 → 14
max_opportunities = 1000 → 2000
max_combinations = 7 → 8
sample_size = 600 → 800
```

### 预计效果
- **内存峰值**: 700-900MB
- **数据量**: 增加100%（相比阶段2）
- **风险等级**: 🟠 较高

### 操作步骤

#### 1️⃣ 确认阶段2稳定（建议运行2-3天）

#### 2️⃣ 执行阶段3恢复
```bash
cd /root/10-23-bot/ds

# 完全恢复到14天/2000机会
python3 restore_data_volume.py stage3

# 验证修改
grep -E "lookback_days|max_opportunities" deepseek_多币种智能版.py | head -10
```

#### 3️⃣ 运行回测（带内存监控）
```bash
supervisorctl stop deepseek qwen
MANUAL_BACKTEST=true python3 run_with_memory_monitor.py > /tmp/backtest_stage3.txt 2>&1 &
tail -f /tmp/backtest_stage3.txt
```

#### 4️⃣ 评估结果
```bash
echo "=== 阶段3内存峰值（完全恢复）==="
cat /root/10-23-bot/ds/memory_monitor_simple.log | awk -F',' '{print $2,$3}' | sort -n | tail -5
```

### 判定标准

| 内存峰值 | 判定 | 下一步 |
|---------|------|--------|
| < 700MB | 🟢 完美 | 数据恢复完成，长期运行 |
| 700-900MB | 🟢 成功 | 数据恢复完成，长期运行 |
| > 900MB 或 OOM | 🔴 失败 | **回退到阶段2** |

**💡 重要**: 不必强求完全恢复到14天。阶段2（10天/1000机会）已经足够好！

---

## 🔄 回退操作（如果失败）

### 快速回退到上一阶段

#### 方法1：使用restore脚本
```bash
cd /root/10-23-bot/ds

# 回退到阶段1
python3 restore_data_volume.py stage1

# 或回退到阶段2
python3 restore_data_volume.py stage2
```

#### 方法2：使用Git
```bash
cd /root/10-23-bot
git checkout -- ds/deepseek_多币种智能版.py ds/qwen_多币种智能版.py
```

#### 方法3：使用备份文件
```bash
cd /root/10-23-bot/ds

# restore脚本会自动创建备份
ls -lh *.before_restore_*

# 恢复备份
cp deepseek_多币种智能版.py.before_restore_stage2 deepseek_多币种智能版.py
cp qwen_多币种智能版.py.before_restore_stage2 qwen_多币种智能版.py
```

#### 方法4：回退到最初配置（5天/300机会）
```bash
# 从GitHub拉取当前版本
cd /root/10-23-bot
git pull
git checkout d4c2821  # V8.5.2.4.89.3
```

---

## 📊 内存监控工具

### 实时监控
```bash
# 方法1：使用内存监控日志
tail -f /root/10-23-bot/ds/memory_monitor_simple.log

# 方法2：使用watch命令
watch -n 2 'free -h && echo "---" && tail -3 /root/10-23-bot/ds/memory_monitor_simple.log'

# 方法3：查看进程内存
watch -n 2 'ps aux | grep python3 | grep -v grep | awk "{print \$2, \$4, \$11}"'
```

### 事后分析
```bash
# 查看内存峰值
cat /root/10-23-bot/ds/memory_monitor_simple.log | awk -F',' '{print $2,$3}' | sort -n | tail -10

# 查看内存趋势
cat /root/10-23-bot/ds/memory_monitor_simple.log | tail -20

# 查看系统内存
free -h

# 查看swap使用
swapon --show
```

---

## 🔍 故障排查

### 问题1：仍然提示 "API key not found"

**原因**: DeepSeek API密钥未配置（可选功能）

**解决方案**:
```bash
# 1. 配置API密钥（可选）
export DEEPSEEK_API_KEY="sk-xxx..."
echo 'export DEEPSEEK_API_KEY="sk-xxx..."' >> ~/.bashrc

# 2. 或忽略（不影响回测完成）
# Phase 3会自动fallback到默认参数
```

### 问题2：内存峰值超过预期

**排查步骤**:
```bash
# 1. 检查是否有其他Python进程
ps aux | grep python3

# 2. 检查swap使用
free -h
swapon --show

# 3. 检查swappiness
cat /proc/sys/vm/swappiness
# 应该是80

# 4. 如果swappiness不是80
echo 80 > /proc/sys/vm/swappiness

# 5. 停止qwen释放内存
supervisorctl stop qwen
```

### 问题3：OOM Killer

**检测OOM**:
```bash
# 查看OOM日志
dmesg | grep -i "killed process" | tail -10
dmesg | grep -i "out of memory" | tail -10

# 查看系统日志
journalctl -xe | grep -i memory | tail -20
```

**解决方案**:
1. 立即回退到上一阶段
2. 确保swap可用
3. 停止qwen进程
4. 清理系统缓存：`echo 3 > /proc/sys/vm/drop_caches`

### 问题4：回测卡住

**排查步骤**:
```bash
# 1. 查看最后输出
tail -50 /tmp/backtest_*.txt

# 2. 查看进程状态
ps aux | grep python3 | grep deepseek

# 3. 如果确实卡住，强制停止
pkill -9 -f "python3.*deepseek.*多币种智能版"

# 4. 查看是否有僵尸进程
ps aux | grep defunct
```

---

## 📝 最佳实践

### ✅ 推荐做法

1. **逐步恢复**: 每天只测试一个阶段
2. **充分监控**: 始终使用 `run_with_memory_monitor.py`
3. **低峰测试**: 在凌晨或低峰期测试
4. **保留备份**: restore脚本会自动备份
5. **及时回退**: OOM立即回退，不要犹豫
6. **稳定优先**: 阶段2稳定就足够了

### ❌ 避免的错误

1. ❌ 一次性恢复到14天（风险太大）
2. ❌ 同时运行deepseek和qwen回测（内存翻倍）
3. ❌ 在高峰期测试（其他服务占用内存）
4. ❌ 忽略内存警告继续运行
5. ❌ 不备份就修改参数
6. ❌ swappiness设置为0（禁用swap）

---

## 🎯 推荐方案

### 方案A：保守型（推荐新手）

```
时间表：
Day 1: 测试阶段1 (7天/500机会)
Day 2-3: 观察阶段1稳定性
Day 4: 如果稳定，测试阶段2 (10天/1000机会)
Day 5-7: 观察阶段2稳定性
Day 8+: 长期运行阶段2

预期结果: 阶段2稳定运行（内存<700MB）
```

### 方案B：激进型（如果服务器内存充足）

```
时间表：
Day 1上午: 测试阶段1
Day 1下午: 如果成功，测试阶段2
Day 2上午: 如果成功，测试阶段3
Day 2下午+: 根据结果决定长期配置

预期结果: 最快2天完成评估
```

### 方案C：极度保守型（如果服务器内存紧张）

```
时间表：
Week 1: 保持当前配置 (5天/300机会)
Week 2: 测试阶段1，运行1周
Week 3: 如果稳定，测试阶段2
Week 4+: 长期运行最稳定的配置

预期结果: 最稳定，但需要更长时间
```

**💡 个人建议**: 从方案A开始，如果阶段1很稳定（< 400MB），可以加速到方案B。

---

## 📞 支持与文档

### 完整文档
- **快速开始**: `快速开始_V8.5.2.4.89.2.txt`
- **修复总结**: `V8.5.2.4.89.2_问题修复总结.md`
- **Bug修复方案**: `V8.5.2.4.89.2_Bug修复与恢复方案.md`
- **服务器操作**: `ds/服务器操作_V8.5.2.4.89.2_Bug修复与数据恢复.txt`
- **本文档**: `数据恢复完整指南_V8.5.2.4.89.3.md`

### 工具脚本
- **数据恢复**: `ds/restore_data_volume.py`
- **快速上传**: `upload_to_server.sh`
- **内存监控**: `ds/run_with_memory_monitor.py`

### GitHub仓库
- **最新代码**: commit `d4c2821`
- **所有更改已提交并推送**

---

## 🎊 开始恢复！

现在所有Bug都已修复，可以开始数据恢复了！

### 立即开始第一步

```bash
# 1. 上传文件
cd ~/Downloads/10-23-bot
./upload_to_server.sh <服务器IP>

# 2. SSH到服务器
ssh root@<服务器IP>

# 3. 开始阶段1
cd /root/10-23-bot/ds
python3 restore_data_volume.py stage1
supervisorctl stop deepseek qwen
MANUAL_BACKTEST=true python3 run_with_memory_monitor.py > /tmp/backtest_stage1.txt 2>&1 &
tail -f /tmp/backtest_stage1.txt
```

**祝数据恢复顺利！** 🚀

---

**版本**: V8.5.2.4.89.3  
**状态**: ✅ 准备就绪  
**最后更新**: 2025-11-20

