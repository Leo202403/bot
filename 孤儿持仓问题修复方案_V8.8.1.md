# ğŸ”§ å­¤å„¿æŒä»“é—®é¢˜ä¿®å¤æ–¹æ¡ˆ V8.8.1

## ğŸ“Š é—®é¢˜æ€»ç»“

### å‘ç°çš„é—®é¢˜

1. **å‰ç«¯æ˜¾ç¤ºå¼‚å¸¸**ï¼šé¢„è®¡æ­¢ç›ˆä»·ã€é¢„è®¡æ­¢æŸä»·ã€ç›ˆäºæ¯”éƒ½æ˜¾ç¤ºä¸º 0.00 æˆ– --
2. **å¼€ä»“æ—¶é—´ä¸å‡†ç¡®**ï¼šæ˜¾ç¤ºçš„æ—¶é—´æ¯”å®é™…å»¶åå¥½å‡ å¤©
3. **position_contexts.json ä¸ºç©º**ï¼šå¯¼è‡´æ— æ³•è·å–åŸå§‹çš„æ­¢ç›ˆæ­¢æŸè®¾ç½®
4. **trades_history.csv ä¸­çš„è®°å½•ä¸å‡†ç¡®**ï¼šåŒæ­¥è„šæœ¬æ·»åŠ çš„è®°å½•æ—¶é—´æœ‰è¯¯

### æ ¹æœ¬åŸå› 

1. `save_positions_snapshot` å‡½æ•°ä¾èµ–äº¤æ˜“æ‰€è¿”å›çš„æŒä»“æ•°æ®ï¼Œä½†äº¤æ˜“æ‰€API **ä¸è¿”å›**æ­¢ç›ˆæ­¢æŸä¿¡æ¯
2. éœ€è¦ä» `position_contexts.json` å’Œæ¡ä»¶è®¢å•ä¸­è¯»å–è¿™äº›ä¿¡æ¯
3. `restore_from_binance_papi.py` æ²¡æœ‰è·å–æ¡ä»¶è®¢å•ï¼ˆæ­¢ç›ˆæ­¢æŸè®¢å•ï¼‰

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šå¢å¼º `save_positions_snapshot` å‡½æ•°

**ç›®æ ‡**ï¼šä»å¤šä¸ªæ•°æ®æºç»„åˆè·å–å®Œæ•´çš„æŒä»“ä¿¡æ¯

**æ•°æ®æºä¼˜å…ˆçº§**ï¼š
1. äº¤æ˜“æ‰€APIï¼ˆæ•°é‡ã€å½“å‰ä»·æ ¼ã€ç›ˆäºï¼‰âœ… å·²æœ‰
2. `trades_history.csv`ï¼ˆå¼€ä»“æ—¶é—´ã€å¼€ä»“ä»·æ ¼ã€æ æ†ã€å¼€ä»“ç†ç”±ï¼‰
3. `position_contexts.json`ï¼ˆæ­¢ç›ˆæ­¢æŸã€ç›ˆäºæ¯”ï¼‰
4. æ¡ä»¶è®¢å•APIï¼ˆå½“å‰è®¾ç½®çš„æ­¢ç›ˆæ­¢æŸï¼‰

---

### ä¿®å¤2ï¼šä»äº¤æ˜“æ‰€è·å–æ­¢ç›ˆæ­¢æŸè®¢å•

**å®ç°**ï¼šåˆ›å»º `fetch_tpsl_orders_for_positions` å‡½æ•°

```python
def fetch_tpsl_orders_for_positions(symbol: str) -> dict:
    """è·å–æŒ‡å®šäº¤æ˜“å¯¹çš„æ­¢ç›ˆæ­¢æŸè®¢å•
    
    Returns:
        {
            'stop_loss': price or None,
            'take_profit': price or None
        }
    """
    try:
        # ä½¿ç”¨ papi ç«¯ç‚¹è·å–æ¡ä»¶å•
        import requests
        import hmac
        import hashlib
        from urllib.parse import urlencode
        
        binance_symbol = symbol.split("/")[0] + symbol.split(":")[0].split("/")[1]
        timestamp = int(time.time() * 1000)
        
        params = {
            "symbol": binance_symbol,
            "timestamp": timestamp,
        }
        
        query_string = urlencode(sorted(params.items()))
        signature = hmac.new(
            exchange.secret.encode("utf-8"),
            query_string.encode("utf-8"),
            hashlib.sha256,
        ).hexdigest()
        
        url = f"https://papi.binance.com/papi/v1/um/conditional/openOrders?{query_string}&signature={signature}"
        headers = {"X-MBX-APIKEY": exchange.apiKey}
        
        response = requests.get(url, headers=headers, timeout=10)
        
        if response.status_code == 200:
            orders = response.json()
            
            sl_price = None
            tp_price = None
            
            for order in orders:
                if order.get('reduceOnly') and order.get('symbol') == binance_symbol:
                    strategy_type = order.get('strategyType', '')
                    stop_price = float(order.get('stopPrice', 0))
                    
                    if strategy_type == 'STOP_MARKET' and stop_price > 0:
                        sl_price = stop_price
                    elif strategy_type == 'TAKE_PROFIT_MARKET' and stop_price > 0:
                        tp_price = stop_price
            
            return {
                'stop_loss': sl_price,
                'take_profit': tp_price
            }
    except Exception as e:
        print(f"âš ï¸ è·å–{symbol}æ­¢ç›ˆæ­¢æŸè®¢å•å¤±è´¥: {e}")
    
    return {'stop_loss': None, 'take_profit': None}
```

---

### ä¿®å¤3ï¼šæ”¹è¿› `save_positions_snapshot`

**æ–°é€»è¾‘**ï¼š

```python
def save_positions_snapshot(positions, total_value):
    """ä¿å­˜å½“å‰æŒä»“å¿«ç…§ï¼ˆä»å¤šä¸ªæ•°æ®æºç»„åˆå®Œæ•´ä¿¡æ¯ï¼‰
    
    æ•°æ®æºï¼š
    1. äº¤æ˜“æ‰€APIï¼ˆpositionså‚æ•°ï¼‰ï¼šæ•°é‡ã€ä»·æ ¼ã€ç›ˆäº
    2. trades_history.csvï¼šå¼€ä»“æ—¶é—´ã€å¼€ä»“ç†ç”±
    3. position_contexts.jsonï¼šæ­¢ç›ˆæ­¢æŸã€ç›ˆäºæ¯”
    4. æ¡ä»¶è®¢å•APIï¼šå½“å‰å®é™…çš„æ­¢ç›ˆæ­¢æŸ
    """
    try:
        # è¯»å– trades_history.csv
        trades_dict = {}
        if TRADES_FILE.exists():
            df = pd.read_csv(TRADES_FILE, encoding="utf-8")
            df.columns = df.columns.str.strip()
            open_trades = df[df["å¹³ä»“æ—¶é—´"].isna()]
            
            for _, row in open_trades.iterrows():
                coin = row.get("å¸ç§", "")
                side = row.get("æ–¹å‘", "")
                key = f"{coin}_{side}"
                trades_dict[key] = row.to_dict()
        
        # è¯»å– position_contexts.json
        model_name = os.getenv("MODEL_NAME", "deepseek")
        context_file = Path("trading_data") / model_name / "position_contexts.json"
        contexts = {}
        if context_file.exists():
            with open(context_file, encoding="utf-8") as f:
                contexts = json.load(f)
        
        records = []
        for pos in positions:
            coin = pos["symbol"].split("/")[0]
            side_cn = "å¤š" if pos["side"] == "long" else "ç©º"
            key = f"{coin}_{side_cn}"
            
            # ä» trades_history è·å–å¼€ä»“ä¿¡æ¯
            trade_info = trades_dict.get(key, {})
            open_time = trade_info.get("å¼€ä»“æ—¶é—´", "")
            open_reason = trade_info.get("å¼€ä»“ç†ç”±", "")[:100] if trade_info.get("å¼€ä»“ç†ç”±") else ""
            
            # ä» position_contexts è·å–æ­¢ç›ˆæ­¢æŸ
            context = contexts.get(coin, {})
            target_tp = context.get("target_tp", 0)
            target_sl = context.get("target_sl", 0)
            
            # å¦‚æœ context ä¸­æ²¡æœ‰ï¼Œå°è¯•ä»æ¡ä»¶è®¢å•è·å–
            if not target_tp and not target_sl:
                tpsl_orders = fetch_tpsl_orders_for_positions(pos["symbol"])
                target_tp = tpsl_orders.get('take_profit', 0)
                target_sl = tpsl_orders.get('stop_loss', 0)
            
            # è®¡ç®—ç›ˆäºæ¯”
            entry_price = pos["entry_price"]
            rr = 0
            if target_tp and target_sl and entry_price:
                if pos["side"] == "long":
                    profit_distance = abs(target_tp - entry_price)
                    loss_distance = abs(entry_price - target_sl)
                else:
                    profit_distance = abs(entry_price - target_tp)
                    loss_distance = abs(target_sl - entry_price)
                
                if loss_distance > 0:
                    rr = profit_distance / loss_distance
            
            records.append({
                "æ›´æ–°æ—¶é—´": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                "å¼€ä»“æ—¶é—´": open_time,
                "å¸ç§": coin,
                "æ–¹å‘": side_cn,
                "æ•°é‡": pos["size"],
                "å¼€ä»“ä»·": pos["entry_price"],
                "å½“å‰ç›ˆäº(U)": pos["unrealized_pnl"],
                "æ æ†": pos["leverage"],
                "ä¿è¯é‡‘(U)": pos.get("margin", abs(pos.get("notional", 0)) / pos["leverage"]),
                "æ­¢æŸ": target_sl if target_sl else 0,
                "æ­¢ç›ˆ": target_tp if target_tp else 0,
                "ç›ˆäºæ¯”": round(rr, 2) if rr else 0,
                "å¼€ä»“ç†ç”±": open_reason,
            })

        if records:
            df = pd.DataFrame(records)
            df.to_csv(POSITIONS_FILE, index=False, encoding="utf-8")
        else:
            # æ— æŒä»“æ—¶æ¸…ç©ºæ–‡ä»¶
            pd.DataFrame(
                columns=[
                    "æ›´æ–°æ—¶é—´", "å¼€ä»“æ—¶é—´", "å¸ç§", "æ–¹å‘", "æ•°é‡", "å¼€ä»“ä»·",
                    "å½“å‰ç›ˆäº(U)", "æ æ†", "ä¿è¯é‡‘(U)", "æ­¢æŸ", "æ­¢ç›ˆ", "ç›ˆäºæ¯”", "å¼€ä»“ç†ç”±",
                ]
            ).to_csv(POSITIONS_FILE, index=False, encoding="utf-8")

        print(f"âœ“ æŒä»“å¿«ç…§å·²æ›´æ–°: {POSITIONS_FILE}")
    except Exception as e:
        print(f"âœ— ä¿å­˜æŒä»“å¿«ç…§å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
```

---

### ä¿®å¤4ï¼šæ”¹è¿› `update_close_position` é”™è¯¯æç¤º

**ä¼˜åŒ–æŸ¥æ‰¾é€»è¾‘**ï¼š

```python
# åœ¨ update_close_position å‡½æ•°ä¸­ï¼ˆLine 3243-3248ï¼‰
if matching_rows.empty:
    print(f"âš ï¸ æœªæ‰¾åˆ° {coin_name} {side} çš„å¼€ä»“è®°å½•")
    
    # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å·²å¹³ä»“è®°å½•ï¼ˆå¯èƒ½æ˜¯é‡å¤å¹³ä»“æˆ–è¢«SL/TPè§¦å‘ï¼‰
    closed_mask = (
        (df["å¸ç§"] == coin_name)
        & (df["æ–¹å‘"] == side)
        & (df["å¹³ä»“æ—¶é—´"].notna())
    )
    recent_closed = df[closed_mask].tail(3)
    
    if not recent_closed.empty:
        print(f"   ğŸ’¡ å‘ç°æœ€è¿‘çš„å·²å¹³ä»“è®°å½•:")
        for idx, row in recent_closed.iterrows():
            print(f"      - {row['å¼€ä»“æ—¶é—´']} â†’ {row['å¹³ä»“æ—¶é—´']}: {row['å¹³ä»“ç†ç”±'][:50]}")
        print(f"   å¯èƒ½åŸå› : 1) å·²è¢«æ­¢ç›ˆ/æ­¢æŸè‡ªåŠ¨å¹³ä»“; 2) æŒä»“æ¥è‡ªå…¶ä»–ç¨‹åº; 3) é‡å¤å¹³ä»“")
    else:
        print(f"   ğŸ’¡ CSVä¸­æ— ä»»ä½• {coin_name} {side} è®°å½•ï¼Œå¯èƒ½æ˜¯ä»å…¶ä»–ç¨‹åºå¼€çš„ä»“")
    
    # é‡Šæ”¾é”
    fcntl.flock(lock_file.fileno(), fcntl.LOCK_UN)
    lock_file.close()
    return
```

---

### ä¿®å¤5ï¼šæ”¹è¿›åˆ†æ‰¹å¹³ä»“æ—¶çš„ä¿æŠ¤é‡è®¾

**åœ¨ `execute_ai_actions` ä¸­ä¿®æ”¹**ï¼ˆLine 25774-25807ï¼‰ï¼š

```python
# ğŸ†• V7.9.3: åˆ†æ‰¹å¹³ä»“åï¼Œä¸ºå‰©ä½™ä»“ä½é‡æ–°è®¾ç½®æ­¢ç›ˆæ­¢æŸ
if close_pct < 100:
    remaining_amount = real_pos["size"] - close_amount
    print(f"  ğŸ”§ ä¸ºå‰©ä½™ä»“ä½é‡è®¾ä¿æŠ¤: {remaining_amount:.3f}ä¸ª")

    try:
        # æ–¹æ¡ˆ1: ä» position_contexts è¯»å–åŸå§‹æ­¢ç›ˆæ­¢æŸ
        model_name = os.getenv("MODEL_NAME", "deepseek")
        context_file = Path("trading_data") / model_name / "position_contexts.json"
        original_sl = None
        original_tp = None

        if context_file.exists():
            with open(context_file, encoding="utf-8") as f:
                contexts = json.load(f)
                if coin_name in contexts:
                    original_sl = contexts[coin_name].get("target_sl")
                    original_tp = contexts[coin_name].get("target_tp")
        
        # æ–¹æ¡ˆ2: å¦‚æœ context ä¸­æ²¡æœ‰ï¼Œä»æ¡ä»¶è®¢å•è·å–
        if not original_sl and not original_tp:
            print(f"   ğŸ’¡ ä»æ¡ä»¶è®¢å•è·å–æ­¢ç›ˆæ­¢æŸ...")
            tpsl_orders = fetch_tpsl_orders_for_positions(symbol)
            original_sl = tpsl_orders.get('stop_loss')
            original_tp = tpsl_orders.get('take_profit')

        # å¦‚æœæœ‰åŸå§‹æ­¢ç›ˆæ­¢æŸï¼Œé‡æ–°è®¾ç½®
        if original_sl or original_tp:
            sl_ok, tp_ok = set_tpsl_orders_via_papi(
                symbol=symbol,
                side=real_pos["side"],
                amount=remaining_amount,
                stop_loss=original_sl,
                take_profit=original_tp,
                verbose=True,
            )
            if not (sl_ok or tp_ok):
                print("  âš ï¸ å‰©ä½™ä»“ä½ä¿æŠ¤è®¾ç½®å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥")
        else:
            print("  âš ï¸ æœªæ‰¾åˆ°åŸå§‹æ­¢ç›ˆæ­¢æŸ")
            print(f"     1) position_contexts.json ä¸­æ—  {coin_name} è®°å½•")
            print(f"     2) äº¤æ˜“æ‰€æ— æŒ‚å•")
            print(f"     ğŸ’¡ å»ºè®®: æ‰‹åŠ¨ä¸º {coin_name} {remaining_amount:.3f}ä¸ª è®¾ç½®æ­¢ç›ˆæ­¢æŸ")
    except Exception as e:
        print(f"  âš ï¸ å‰©ä½™ä»“ä½ä¿æŠ¤è®¾ç½®å¼‚å¸¸: {e}")
```

---

## ğŸ“ å®æ–½æ­¥éª¤

### æ­¥éª¤1: æ·»åŠ  fetch_tpsl_orders_for_positions å‡½æ•°

åœ¨ `deepseek_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py` çš„åˆé€‚ä½ç½®ï¼ˆå»ºè®®åœ¨ `save_positions_snapshot` å‡½æ•°ä¹‹å‰ï¼‰æ·»åŠ ä¸Šè¿°å‡½æ•°ã€‚

### æ­¥éª¤2: æ›¿æ¢ save_positions_snapshot å‡½æ•°

å®Œå…¨æ›¿æ¢ç°æœ‰çš„ `save_positions_snapshot` å‡½æ•°ï¼ˆLine 3341-3387ï¼‰ã€‚

### æ­¥éª¤3: æ”¹è¿› update_close_position é”™è¯¯æç¤º

ä¿®æ”¹ Line 3243-3248 çš„é”™è¯¯å¤„ç†é€»è¾‘ã€‚

### æ­¥éª¤4: æ”¹è¿›åˆ†æ‰¹å¹³ä»“ä¿æŠ¤é‡è®¾

ä¿®æ”¹ Line 25774-25807 çš„é€»è¾‘ã€‚

### æ­¥éª¤5: åŒæ­¥åˆ° qwen ç‰ˆæœ¬

å°†æ‰€æœ‰ä¿®æ”¹åŒæ­¥åˆ° `qwen_å¤šå¸ç§æ™ºèƒ½ç‰ˆ.py`ã€‚

### æ­¥éª¤6: æµ‹è¯•

1. æäº¤åˆ° GitHub
2. åœ¨æœåŠ¡å™¨ä¸Š `git pull`
3. é‡å¯ç¨‹åº
4. è§‚å¯Ÿå‰ç«¯æ˜¾ç¤ºæ˜¯å¦æ­£å¸¸

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

ä¿®å¤åï¼Œå‰ç«¯åº”è¯¥æ˜¾ç¤ºï¼š

```
å¸ç§  æ–¹å‘  å¼€ä»“æ—¶é—´        å¼€ä»“ä»·    é¢„è®¡æ­¢ç›ˆä»·  é¢„è®¡æ­¢æŸä»·  é¢„è®¡ç›ˆäºæ¯”  å½“å‰ç›ˆäº
XRP   å¤š    11-22 18:34    $2.02     $2.49       $1.88       3.4:1      +0.45U
ETH   ç©º    11-22 16:48    $2766.99  $1968.13    $2768.70    55.7:1     -3.47U
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¼€ä»“æ—¶é—´**ï¼šå¦‚æœ trades_history.csv ä¸­çš„è®°å½•æ—¶é—´ä¸å¯¹ï¼Œéœ€è¦æ‰‹åŠ¨ä¿®æ­£
2. **æ­¢ç›ˆæ­¢æŸ**ï¼šé¦–æ¬¡æ‰§è¡Œåï¼Œå¦‚æœè¿˜æ˜¯0.00ï¼Œè¯´æ˜äº¤æ˜“æ‰€ä¹Ÿæ²¡æœ‰æŒ‚å•ï¼Œéœ€è¦æ‰‹åŠ¨è®¾ç½®
3. **position_contexts.json**ï¼šæ–°å¼€ä»“æ—¶ä¼šè‡ªåŠ¨ä¿å­˜ï¼Œæ—§æŒä»“éœ€è¦æ‰‹åŠ¨åŒæ­¥æˆ–æ¥å—æ— æ•°æ®çš„çŠ¶æ€

---

## ğŸ”„ å¿«é€Ÿä¿®å¤å½“å‰å¼‚å¸¸æ•°æ®

å¦‚æœæƒ³å¿«é€Ÿä¿®æ­£å½“å‰çš„æ—¶é—´é—®é¢˜ï¼Œå¯ä»¥æ‰‹åŠ¨ç¼–è¾‘ï¼š

```bash
# ç¼–è¾‘ trades_history.csv
nano ~/10-23-bot/ds/trading_data/deepseek/trades_history.csv

# æ‰¾åˆ°æœ€å3è¡Œï¼ˆåˆšæ·»åŠ çš„ï¼‰ï¼Œä¿®æ­£å¼€ä»“æ—¶é—´ä¸ºæ­£ç¡®çš„æ—¶é—´
# ç„¶åä¿å­˜å¹¶é‡å¯ç¨‹åº
```

---

**ä¿®å¤æ–¹æ¡ˆå·²å‡†å¤‡å®Œæ¯•ï¼Œè¯·å‘Šè¯‰æˆ‘æ˜¯å¦å¼€å§‹å®æ–½ä»£ç ä¿®æ”¹ï¼** ğŸš€

