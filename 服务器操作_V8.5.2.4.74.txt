# 服务器回测指令 - V8.5.2.4.74

## 🎯 本次更新内容

1. **8维度筛选可选化**（默认关闭，启用移动止损）
   - Scalping捕获率：1.7% → 预期30-50%
   
2. **默认启用移动止损**
   - 平均利润：6-7% → 预期9-12%
   
3. **优化Phase 4验证标准**（容忍-10%利润下降）
   - Phase 4通过率：0% → 预期40-60%

---

## 📋 服务器操作步骤

### 步骤1：停止AI进程
```bash
supervisorctl stop deepseek qwen
```

### 步骤2：拉取最新代码
```bash
cd ~/10-23-bot
git reset --hard HEAD
git pull origin main
```

### 步骤3：验证版本
```bash
git log -1 --oneline
```
**预期输出**：
```
5c0e59a V8.5.2.4.74: 优化Phase3/4参数策略
```

### 步骤4：运行回测
```bash
cd ~/10-23-bot/ds
MANUAL_BACKTEST=true python3 deepseek_多币种智能版.py backtest-deepseek
```

### 步骤5：回测完成后重启AI
```bash
supervisorctl start deepseek qwen
```

---

## 📊 预期回测结果

### Phase 2（参数组合测试）
- **捕获率**：40-50%（与之前持平）
- **平均利润**：6-7%（与之前持平）
- **总利润**：2000-3000%

### Phase 3（分离优化）
- **Scalping捕获率**：30-50%（之前1.7%）✅ 大幅提升
- **Scalping平均利润**：9-12%（之前6.46%）✅ 移动止损效果
- **Swing捕获率**：90-100%（之前99.3%）
- **Swing平均利润**：9-12%（之前7.08%）✅ 移动止损效果

### Phase 4（验证）
- **Scalping状态**：PASSED 或 WARNING（之前FAILED）✅ 验证放宽
- **Swing状态**：PASSED 或 WARNING（之前FAILED）✅ 验证放宽
- **综合判定**：PASSED 或 WARNING（之前FAILED）✅

---

## 🔍 关键输出检查点

### 检查点1：8维度筛选状态
在Phase 3的输出中查找：
```
🎯 【V8.5.2.4.74】使用标准筛选+移动止损（5维度：基础+质量+TP）
```
✅ 如果看到这行，说明默认模式已生效

### 检查点2：移动止损启用
在Phase 3的输出中查找：
```
'trailing_stop_enabled': True
```
✅ 如果看到这行，说明移动止损已启用

### 检查点3：Phase 4判定
在Phase 4的输出中查找：
```
5️⃣ 最终判定: PASSED ✅
   原因: 参数泛化能力良好
```
或
```
5️⃣ 最终判定: WARNING ⚠️
   原因: 相对Phase 2下降X.X%（10-20%，可接受）
```
✅ 如果看到PASSED或WARNING，说明验证标准优化生效

### 检查点4：Scalping捕获率
在Phase 3的输出中查找：
```
✓ 找到优化参数！
   起点: Phase2最优
   捕获率: 30-50%（期望范围）
```
✅ 如果捕获率≥30%，说明8维度关闭生效

---

## ⚠️ 可能的异常情况

### 异常1：仍然显示8维度全开
**输出**：
```
🎨 【V8.5.2.4.73】K线形态: [False, True], 趋势强度: ['any', 'normal', 'strong']
```
**原因**：代码未更新或缓存
**解决**：重新执行步骤2（git pull）

### 异常2：移动止损未启用
**输出**：
```
'trailing_stop_enabled': False
```
**原因**：配置文件覆盖
**解决**：检查 `ds/trading_data/deepseek/learning_config.json`，确保没有手动设置`"trailing_stop_enabled": false`

### 异常3：Phase 4仍然FAILED
**输出**：
```
5️⃣ 最终判定: FAILED ❌
   原因: 参数测试出现亏损（-X.XX%）
```
**说明**：这是正常的，表示Phase 3参数确实出现了绝对亏损
**处理**：系统会自动回退到Phase 2参数，不影响使用

---

## 📈 成功标准

满足以下**任意2项**即可认为优化成功：

1. ✅ Scalping捕获率≥30%（之前1.7%）
2. ✅ Phase 3平均利润≥9%（之前6-7%）
3. ✅ Phase 4判定为PASSED或WARNING（之前FAILED）

---

## 🚀 可选：启用探索模式

如果想测试8维度全筛选，编辑配置文件：
```bash
vi ~/10-23-bot/ds/trading_data/deepseek/learning_config.json
```

添加以下内容：
```json
{
  "enable_advanced_filters": true
}
```

然后重新运行步骤4（回测）。

**注意**：探索模式会增加回测时间（约15-25分钟），但可能找到更高质量的参数。

---

**版本**：V8.5.2.4.74  
**日期**：2025-11-19  
**预计回测时间**：默认模式5-8分钟，探索模式15-25分钟

